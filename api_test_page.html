<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— äººæœºAPIæµ‹è¯•é¡µé¢</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .control-panel {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .stream-control-container {
            background-color: #f8f9fa;
            min-height: 200px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .gimbal-control {
            text-align: center;
            padding: 20px;
        }
        .gimbal-joystick {
            width: 200px;
            height: 200px;
            border: 2px solid #333;
            border-radius: 50%;
            position: relative;
            margin: 20px auto;
            background-color: #f0f0f0;
        }
        .gimbal-center {
            width: 20px;
            height: 20px;
            background-color: #333;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .log-container {
            height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .hms-item {
            margin-bottom: 12px;
            border-radius: 8px;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .hms-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .hms-item .badge {
            font-size: 10px;
            font-weight: 500;
            padding: 4px 8px;
        }
        .hms-level-warning {
            border-left-color: #dc3545 !important;
            background-color: #fdf2f2 !important;
        }
        .hms-level-caution {
            border-left-color: #ffc107 !important;
            background-color: #fffbf0 !important;
        }
        .hms-level-notice {
            border-left-color: #17a2b8 !important;
            background-color: #e8f6f8 !important;
        }
        .hms-container {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .api-test-panel {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .api-test-header {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }
        .api-test-body {
            padding: 15px;
        }
        .form-row {
            margin-bottom: 10px;
        }
        .btn-test {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .response-area {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .drc-control-panel {
            background-color: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
        }
        .simulation-panel {
            background-color: #fff8dc;
            border: 1px solid #ffd700;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
        }
        .drc-slider-container {
            margin-bottom: 10px;
        }
        .drc-slider-container label {
            font-size: 12px;
            font-weight: bold;
            color: #333;
        }
        .form-range {
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <h1 class="text-center mb-4">æ— äººæœºAPIæµ‹è¯•é¡µé¢</h1>
        
        <!-- é…ç½®åŒºåŸŸ -->
        <div class="control-panel">
            <h3>ç³»ç»Ÿé…ç½®</h3>
            <div class="row">
                <div class="col-md-3">
                    <label>APIåœ°å€:</label>
                    <input type="text" id="apiUrl" class="form-control" value="http://192.168.111.49:8000" />
                </div>
                <div class="col-md-3">
                    <label>Token:</label>
                    <input type="text" id="apiToken" class="form-control" placeholder="è¾“å…¥è®¤è¯Token" />
                </div>
                <div class="col-md-2">
                    <label>è®¾å¤‡SN:</label>
                    <input type="text" id="deviceSn" class="form-control" placeholder="è®¾å¤‡åºåˆ—å·" />
                </div>
                <div class="col-md-3">
                    <label>è®¾å¤‡ç±»å‹:</label>
                    <select id="deviceType" class="form-control">
                        <option value="">é€‰æ‹©è®¾å¤‡ç±»å‹</option>
                        <option value="0-67-1">DJI M3E (é£æœºç±»)</option>
                        <option value="0-89-1">DJI M3T (é£æœºç±»)</option>
                        <option value="0-90-1">DJI M3M (é£æœºç±»)</option>
                        <option value="1-142-2">DJI M30 (é£æœºç±»)</option>
                        <option value="1-142-3">DJI M30T (é£æœºç±»)</option>
                        <option value="0-92-1">DJI M300 RTK (é£æœºç±»)</option>
                        <option value="3-3-0" selected>DJI Dock (æœºåœºç±»)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary form-control" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
                </div>
            </div>
        </div>

        <!-- ç™»å½•åŒºåŸŸ -->
        <div class="control-panel">
            <h3>ç”¨æˆ·ç™»å½•</h3>
            <div class="row">
                <div class="col-md-3">
                    <label>ç”¨æˆ·å:</label>
                    <input type="text" id="loginUsername" class="form-control" placeholder="è¾“å…¥ç”¨æˆ·å" />
                </div>
                <div class="col-md-3">
                    <label>å¯†ç :</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="è¾“å…¥å¯†ç " />
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label>
                    <button class="btn btn-success form-control" onclick="login()">ç™»å½•</button>
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label>
                    <button class="btn btn-secondary form-control" onclick="logout()">ç™»å‡º</button>
                </div>
                <div class="col-md-2">
                    <label>ç™»å½•çŠ¶æ€:</label>
                    <div><span class="status-indicator status-offline" id="loginStatus"></span><span id="loginStatusText">æœªç™»å½•</span></div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- å·¦ä¾§ï¼šæ§åˆ¶é¢æ¿ -->
            <div class="col-md-4">
                <!-- ç›´æ’­æ¨æµæ§åˆ¶ -->
                <div class="control-panel">
                    <h4>ç›´æ’­æ¨æµæ§åˆ¶</h4>
                    <div id="selectedVideoInfo" class="mb-2" style="display: none;">
                        <div class="alert alert-success p-2">
                            <small><strong>å·²é€‰æ‹©è§†é¢‘æµï¼š</strong></small>
                            <div id="selectedVideoDetails" class="mt-1"></div>
                            <button class="btn btn-xs btn-outline-secondary mt-1" onclick="clearVideoSelection()">æ¸…é™¤é€‰æ‹©</button>
                        </div>
                    </div>
                    <div class="alert alert-info alert-sm p-2 mb-2">
                        <small><strong>è¯´æ˜ï¼š</strong>æ¨æµåˆ°RTMPæœåŠ¡å™¨ï¼Œæ”¯æŒé¡µé¢å†…ç›´æ’­å’ŒVLCæ’­æ”¾å™¨è§‚çœ‹ã€‚å…ˆä»ä¸‹æ–¹ç›´æ’­èƒ½åŠ›ä¸­é€‰æ‹©è§†é¢‘æµã€‚</small>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4">
                            <select id="streamType" class="form-control">
                                <option value="rtmp" selected>RTMP (æ¨è)</option>
                                <option value="webrtc">WebRTC</option>
                            </select>
                        </div>
                        <div class="col-4">
                            <select id="streamQuality" class="form-control">
                                <option value="0">è‡ªé€‚åº”</option>
                                <option value="1">æµç•…</option>
                                <option value="2">æ ‡æ¸…</option>
                                <option value="3">é«˜æ¸…</option>
                                <option value="4">è¶…æ¸…</option>
                            </select>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-primary btn-sm" onclick="startLivestreamWithSelected()">æ™ºèƒ½æ¨æµ</button>
                            <button class="btn btn-outline-success btn-sm" onclick="startLivestream()">æ‰‹åŠ¨æ¨æµ</button>
                            <button class="btn btn-danger btn-sm" onclick="stopLivestream()">åœæ­¢æ¨æµ</button>
                        </div>
                    </div>
                    <!-- ç›´æ’­é•œå¤´åˆ‡æ¢ -->
                    <div class="mb-2" id="lensChangeControl" style="display: none;">
                        <div class="row align-items-center mb-2">
                            <div class="col-6">
                                <small>ç›´æ’­é•œå¤´åˆ‡æ¢: </small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">å½“å‰: <span id="currentLensType">æœªçŸ¥</span></small>
                            </div>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="changeLens('normal')">é»˜è®¤</button>
                            <button class="btn btn-outline-primary" onclick="changeLens('wide')">å¹¿è§’</button>
                            <button class="btn btn-outline-primary" onclick="changeLens('zoom')">å˜ç„¦</button>
                            <button class="btn btn-outline-primary" onclick="changeLens('ir')">çº¢å¤–</button>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">æ¨æµä¸­å¯å®æ—¶åˆ‡æ¢é•œå¤´ç±»å‹ï¼Œæ”¯æŒé»˜è®¤/å¹¿è§’/å˜ç„¦/çº¢å¤–</small>
                        </div>
                    </div>
                    
                    <!-- åŠ¨æ€æ¸…æ™°åº¦åˆ‡æ¢ -->
                    <div class="mb-2" id="dynamicQualityControl" style="display: none;">
                        <div class="row align-items-center">
                            <div class="col-6">
                                <small>åŠ¨æ€åˆ‡æ¢æ¸…æ™°åº¦: </small>
                            </div>
                            <div class="col-6">
                                <select id="dynamicQuality" class="form-select form-select-sm" onchange="changeLiveQuality()">
                                    <option value="0">è‡ªé€‚åº”</option>
                                    <option value="1">æµç•… (512Kbps)</option>
                                    <option value="2">æ ‡æ¸… (1Mbps)</option>
                                    <option value="3">é«˜æ¸… (1.5Mbps)</option>
                                    <option value="4">è¶…æ¸… (8Mbps)</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">æ¨æµä¸­å¯å®æ—¶åˆ‡æ¢æ¸…æ™°åº¦ï¼Œæ— éœ€é‡å¯æ¨æµ</small>
                        </div>
                    </div>

                    <div class="stream-control-container">
                        <div id="streamInfo">
                            <h6 class="text-muted mb-3">æ¨æµä¿¡æ¯</h6>
                            <p class="mb-2"><strong>æ¨æµçŠ¶æ€:</strong> <span id="streamStatus">æœªå¯åŠ¨</span></p>
                            <p class="mb-2"><strong>æ¨æµåè®®:</strong> <span id="streamProtocol">-</span></p>
                            <p class="mb-2"><strong>æ¨æµåœ°å€ (push_url):</strong></p>
                            <div class="bg-light p-2 border rounded" style="max-height: 100px; overflow-y: auto;">
                                <code id="vlcUrl" class="text-break">ç­‰å¾…æ¨æµå¯åŠ¨...</code>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">å¤åˆ¶ä¸Šè¿°åœ°å€åˆ°VLCæ’­æ”¾å™¨ä¸­è§‚çœ‹ç›´æ’­</small>
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="copyVlcUrl()">å¤åˆ¶åœ°å€</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearStreamInfo()">æ¸…ç©ºä¿¡æ¯</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç›´æ’­èƒ½åŠ›æŸ¥è¯¢ -->
                <div class="control-panel">
                    <h4>ç›´æ’­èƒ½åŠ›æŸ¥è¯¢</h4>
                    <div class="text-center mb-3">
                        <button class="btn btn-info btn-sm" onclick="getLivestreamCapacity()">è·å–æ‰€æœ‰è®¾å¤‡ç›´æ’­èƒ½åŠ›</button>
                        <button class="btn btn-outline-info btn-sm" onclick="getDeviceLivestreamCapacity()">è·å–å½“å‰è®¾å¤‡ç›´æ’­èƒ½åŠ›</button>
                    </div>
                    <div class="livestream-capacity-info">
                        <div class="card">
                            <div class="card-body p-2">
                                <h6 class="text-muted mb-2">ç›´æ’­èƒ½åŠ›ä¿¡æ¯</h6>
                                <div id="livestreamCapacityResult" class="small">
                                    <div class="text-muted">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–ç›´æ’­èƒ½åŠ›ä¿¡æ¯</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ç›¸æœºæ§åˆ¶ -->
                <div class="control-panel">
                    <h4>ç›¸æœºæ§åˆ¶</h4>
                    
                    <!-- ç›¸æœºæ¨¡å¼åˆ‡æ¢ -->
                    <div class="mb-3">
                        <h6>ç›¸æœºæ¨¡å¼</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <select class="form-control" id="cameraMode">
                                    <option value="0">æ™®é€šæ‹ç…§</option>
                                    <option value="1">å½•åƒ</option>
                                    <option value="2">æ™ºèƒ½ä½å…‰</option>
                                    <option value="3">å…¨æ™¯æ‹ç…§</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary btn-test w-100" onclick="switchCameraMode()">åˆ‡æ¢æ¨¡å¼</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ‹ç…§/å½•åƒæ§åˆ¶ -->
                    <div class="text-center">
                        <button class="btn btn-info btn-test" onclick="takePhoto()">æ‹ç…§</button>
                        <button class="btn btn-primary btn-test" onclick="startRecording()">å¼€å§‹å½•åƒ</button>
                        <button class="btn btn-secondary btn-test" onclick="stopRecording()">åœæ­¢å½•åƒ</button>
                    </div>
                </div>

                <!-- äº‘å°æ§åˆ¶ -->
                <div class="control-panel">
                    <h4>äº‘å°æ§åˆ¶</h4>
                    
                    <!-- æ–¹å‘æ§åˆ¶æŒ‰é’® -->
                    <div class="mb-3">
                        <h6>æ–¹å‘æ§åˆ¶</h6>
                        <div class="gimbal-direction-control">
                            <div class="text-center mb-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="gimbalDirectionControl('down')">â–² ä¸Š</button>
                            </div>
                            <div class="d-flex justify-content-center gap-2 mb-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="gimbalDirectionControl('left')">â—„ å·¦</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="gimbalStop()">åœæ­¢</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="gimbalDirectionControl('right')">â–º å³</button>
                            </div>
                            <div class="text-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="gimbalDirectionControl('up')">â–¼ ä¸‹</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ç²¾ç¡®è§’åº¦æ§åˆ¶ -->
                    <div class="mb-3">
                        <h6>ç²¾ç¡®è§’åº¦æ§åˆ¶</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">ä¿¯ä»°è§’(Pitch):</label>
                                <input type="number" class="form-control form-control-sm" id="gimbalPitch" placeholder="-90 åˆ° 30" min="-90" max="30" step="1">
                            </div>
                            <div class="col-6">
                                <label class="form-label">åèˆªè§’(Yaw):</label>
                                <input type="number" class="form-control form-control-sm" id="gimbalYaw" placeholder="-180 åˆ° 180" min="-180" max="180" step="1">
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary mt-2" onclick="gimbalSetAngle()">è®¾ç½®è§’åº¦</button>
                    </div>
                    
                    <!-- æ‹–æ‹½é€Ÿåº¦æ§åˆ¶ -->
                    <div class="mb-3">
                        <h6>æ‹–æ‹½é€Ÿåº¦æ§åˆ¶</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">ä¿¯ä»°é€Ÿåº¦: <span id="pitchSpeedValue">0</span></label>
                                <input type="range" class="form-range" min="-100" max="100" value="0" id="pitchSpeedSlider" onchange="updateSpeedValue('pitch')">
                            </div>
                            <div class="col-6">
                                <label class="form-label">åèˆªé€Ÿåº¦: <span id="yawSpeedValue">0</span></label>
                                <input type="range" class="form-range" min="-100" max="100" value="0" id="yawSpeedSlider" onchange="updateSpeedValue('yaw')">
                            </div>
                        </div>
                        <div class="text-center mt-2">
                            <button class="btn btn-sm btn-success" onclick="startGimbalDrag()">å¼€å§‹æ‹–æ‹½</button>
                            <button class="btn btn-sm btn-danger" onclick="stopGimbalDrag()">åœæ­¢æ‹–æ‹½</button>
                        </div>
                    </div>
                    
                    <!-- Look At åæ ‡æ§åˆ¶ -->
                    <div class="mb-3">
                        <h6>Look At åæ ‡æ§åˆ¶</h6>
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label">çº¬åº¦:</label>
                                <input type="number" class="form-control form-control-sm" id="lookAtLat" placeholder="çº¬åº¦" step="0.000001">
                            </div>
                            <div class="col-4">
                                <label class="form-label">ç»åº¦:</label>
                                <input type="number" class="form-control form-control-sm" id="lookAtLng" placeholder="ç»åº¦" step="0.000001">
                            </div>
                            <div class="col-4">
                                <label class="form-label">é«˜åº¦:</label>
                                <input type="number" class="form-control form-control-sm" id="lookAtAlt" placeholder="é«˜åº¦(m)" step="0.1">
                            </div>
                        </div>
                        <button class="btn btn-sm btn-info mt-2" onclick="gimbalLookAt()">Look At</button>
                    </div>
                    
                    <!-- åŸºç¡€æ§åˆ¶ -->
                    <div class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="gimbalReset()">å¤ä½</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="gimbalStop()">åœæ­¢</button>
                        <button class="btn btn-sm btn-outline-info" onclick="getGimbalStatus()">è·å–çŠ¶æ€</button>
                        <button class="btn btn-sm btn-outline-success" onclick="showCurrentCameraIndex()">æ˜¾ç¤ºCameraç´¢å¼•</button>
                    </div>
                    
                    <!-- äº‘å°çŠ¶æ€æ˜¾ç¤º -->
                    <div class="mt-3">
                        <h6>äº‘å°çŠ¶æ€</h6>
                        <pre id="gimbalStatusDisplay" class="bg-light p-2 small" style="max-height: 100px; overflow-y: auto;">ç‚¹å‡»"è·å–çŠ¶æ€"æŸ¥çœ‹</pre>
                    </div>
                </div>

                <!-- DRCæ— äººæœºæ§åˆ¶ -->
                <div class="control-panel">
                    <h4>DRCæ— äººæœºæ§åˆ¶</h4>
                    
                    <!-- DRCæ¨¡å¼æ§åˆ¶ -->
                    <div class="mb-3">
                        <h6>DRCæ¨¡å¼</h6>
                        <div class="d-flex gap-2 mb-2">
                            <button class="btn btn-sm btn-success" onclick="enterDrcMode()">è¿›å…¥DRCæ¨¡å¼</button>
                            <button class="btn btn-sm btn-danger" onclick="exitDrcMode()">é€€å‡ºDRCæ¨¡å¼</button>
                            <button class="btn btn-sm btn-info" onclick="getDrcStatus()">è·å–çŠ¶æ€</button>
                        </div>
                        <div class="alert alert-info alert-sm p-2 mb-2">
                            <small><strong>DRCçŠ¶æ€:</strong> <span id="drcStatus">æœªçŸ¥</span></small>
                        </div>
                    </div>
                    
                    <!-- ç®€åŒ–é£è¡Œæ§åˆ¶ -->
                    <div class="mb-3" id="drcSimpleControl" style="display: none;">
                        <h6>ç®€åŒ–é£è¡Œæ§åˆ¶</h6>
                        <div class="alert alert-warning alert-sm p-2 mb-2">
                            <small><strong>è¯´æ˜:</strong> ç›´è§‚çš„å‰åå·¦å³ä¸Šä¸‹æ§åˆ¶ï¼Œè‡ªåŠ¨è½¬æ¢ä¸ºDJIæ†é‡æ•°æ®</small>
                        </div>
                        
                        <!-- æ–¹å‘æ§åˆ¶æŒ‰é’® -->
                        <div class="drc-direction-control mb-3">
                            <div class="text-center mb-2">
                                <button class="btn btn-sm btn-primary" 
                                        onmousedown="startDrcControl('forward', 0.5)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">â–² å‰è¿›</button>
                            </div>
                            <div class="d-flex justify-content-center gap-2 mb-2">
                                <button class="btn btn-sm btn-primary" 
                                        onmousedown="startDrcControl('left', 0.5)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">â—„ å·¦ç§»</button>
                                <button class="btn btn-sm btn-secondary" onclick="emergencyStop()">ç´§æ€¥åœæ­¢</button>
                                <button class="btn btn-sm btn-primary" 
                                        onmousedown="startDrcControl('right', 0.5)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">â–º å³ç§»</button>
                            </div>
                            <div class="text-center mb-2">
                                <button class="btn btn-sm btn-primary" 
                                        onmousedown="startDrcControl('backward', 0.5)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">â–¼ åé€€</button>
                            </div>
                            <div class="d-flex justify-content-center gap-2">
                                <button class="btn btn-sm btn-success" 
                                        onmousedown="startDrcControl('up', 0.5)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">â†‘ ä¸Šå‡</button>
                                <button class="btn btn-sm btn-warning" 
                                        onmousedown="startDrcControl('down', 0.5)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">â†“ ä¸‹é™</button>
                                <button class="btn btn-sm btn-info" 
                                        onmousedown="startDrcControl('turn_left', 0.3)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">â†º å·¦è½¬</button>
                                <button class="btn btn-sm btn-info" 
                                        onmousedown="startDrcControl('turn_right', 0.3)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">â†» å³è½¬</button>
                            </div>
                        </div>
                        
                        <!-- ç²¾ç¡®é€Ÿåº¦æ§åˆ¶ -->
                        <div class="mb-3">
                            <h6>ç²¾ç¡®é€Ÿåº¦æ§åˆ¶</h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label">å‰åé€Ÿåº¦: <span id="forwardSpeedValue">0</span></label>
                                    <input type="range" class="form-range" min="-1" max="1" value="0" step="0.1" id="forwardSpeedSlider" onchange="updateDrcSpeedValue('forward')">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">å·¦å³é€Ÿåº¦: <span id="rightSpeedValue">0</span></label>
                                    <input type="range" class="form-range" min="-1" max="1" value="0" step="0.1" id="rightSpeedSlider" onchange="updateDrcSpeedValue('right')">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">å‡é™é€Ÿåº¦: <span id="upSpeedValue">0</span></label>
                                    <input type="range" class="form-range" min="-1" max="1" value="0" step="0.1" id="upSpeedSlider" onchange="updateDrcSpeedValue('up')">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">æ—‹è½¬é€Ÿåº¦: <span id="turnSpeedValue">0</span></label>
                                    <input type="range" class="form-range" min="-1" max="1" value="0" step="0.1" id="turnRightSpeedSlider" onchange="updateDrcSpeedValue('turn_right')">
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <button class="btn btn-sm btn-success" onclick="sendDrcControl()">å‘é€æ§åˆ¶æŒ‡ä»¤</button>
                                <button class="btn btn-sm btn-secondary" onclick="resetDrcSpeeds()">é‡ç½®é€Ÿåº¦</button>
                            </div>
                        </div>
                        
                        <!-- æ§åˆ¶çŠ¶æ€æ˜¾ç¤º -->
                        <div class="mt-3">
                            <h6>æ§åˆ¶çŠ¶æ€</h6>
                            <pre id="drcControlStatus" class="bg-light p-2 small" style="max-height: 100px; overflow-y: auto;">ç­‰å¾…æ§åˆ¶æŒ‡ä»¤...</pre>
                        </div>
                    </div>
                </div>

                
            </div>

            <!-- ä¸­é—´ï¼šAPIæµ‹è¯•åŒºåŸŸ -->
            <div class="col-md-4">
                <!-- è®¾å¤‡ç®¡ç†APIæµ‹è¯• -->
                <div class="api-test-panel">
                    <div class="api-test-header">è®¾å¤‡ç®¡ç†API</div>
                    <div class="api-test-body">
                        <button class="btn btn-sm btn-primary btn-test" onclick="testGetDevices()">è·å–è®¾å¤‡åˆ—è¡¨</button>
                        <button class="btn btn-sm btn-info btn-test" onclick="testGetDeviceStatus()">è·å–è®¾å¤‡çŠ¶æ€</button>
                        <button class="btn btn-sm btn-secondary btn-test" onclick="testDeviceCount()">è®¾å¤‡æ€»æ•°</button>
                        <div class="response-area" id="deviceApiResponse">APIå“åº”æ˜¾ç¤ºåŒºåŸŸ</div>
                    </div>
                </div>

                <!-- èˆªçº¿ä»»åŠ¡APIæµ‹è¯• -->
                <div class="api-test-panel">
                    <div class="api-test-header">èˆªçº¿ä»»åŠ¡å®Œæ•´æµç¨‹æµ‹è¯•</div>
                    <div class="api-test-body">
                        <div class="form-row mb-2">
                            <input type="text" id="workspaceId" class="form-control" placeholder="å·¥ä½œç©ºé—´ID" value="1">
                        </div>
                        
                        <!-- ç¬¬ä¸€æ­¥ï¼šèˆªçº¿æ–‡ä»¶ä¸Šä¼  -->
                        <div class="wayline-step mb-3">
                            <h6 class="text-primary">ğŸ“ æ­¥éª¤1: èˆªçº¿æ–‡ä»¶ä¸Šä¼ </h6>
                            <div class="mb-2">
                                <input type="file" id="waylineFile" class="form-control form-control-sm" accept=".kmz">
                                <small class="text-muted">è¯·é€‰æ‹©ä»å¸ç©º2å¯¼å‡ºçš„.kmzèˆªçº¿æ–‡ä»¶</small>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-8">
                                    <input type="text" id="waylineName" class="form-control form-control-sm" placeholder="èˆªçº¿åç§°">
                                </div>
                                <div class="col-4">
                                    <select id="droneModelKey" class="form-select form-select-sm">
                                        <option value="0-67-1">DJI M3E</option>
                                        <option value="0-89-1">DJI M3T</option>
                                        <option value="0-90-1">DJI M3M</option>
                                        <option value="1-142-2">DJI M30</option>
                                        <option value="1-142-3">DJI M30T</option>
                                        <option value="0-92-1">DJI M300 RTK</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="uploadWaylineFile()">ä¸Šä¼ èˆªçº¿æ–‡ä»¶</button>
                            <button class="btn btn-sm btn-info" onclick="getWaylineFiles()">æŸ¥çœ‹å·²ä¸Šä¼ æ–‡ä»¶</button>
                        </div>
                        
                        <!-- ç¬¬äºŒæ­¥ï¼šåˆ›å»ºä»»åŠ¡ -->
                        <div class="wayline-step mb-3">
                            <h6 class="text-primary">ğŸš€ æ­¥éª¤2: åˆ›å»ºèˆªçº¿ä»»åŠ¡</h6>
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <select id="waylineFileSelect" class="form-select form-select-sm">
                                        <option value="">é€‰æ‹©èˆªçº¿æ–‡ä»¶...</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <select id="taskType" class="form-select form-select-sm">
                                        <option value="0">ç«‹å³æ‰§è¡Œ</option>
                                        <option value="1">å®šæ—¶æ‰§è¡Œ</option>
                                        <option value="2">æ¡ä»¶æ‰§è¡Œ</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="createWaylineJob()">åˆ›å»ºä»»åŠ¡</button>
                            <button class="btn btn-sm btn-info" onclick="testGetWaylineJobs()">æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨</button>
                        </div>
                        
                        <!-- ç¬¬ä¸‰æ­¥ï¼šä»»åŠ¡æ‰§è¡Œ -->
                        <div class="wayline-step mb-3">
                            <h6 class="text-primary">â–¶ï¸ æ­¥éª¤3: ä»»åŠ¡æ‰§è¡Œæ§åˆ¶</h6>
                            <div class="mb-2">
                                <select id="jobSelect" class="form-select form-select-sm">
                                    <option value="">é€‰æ‹©è¦æ‰§è¡Œçš„ä»»åŠ¡...</option>
                                </select>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-success" onclick="executeWaylineJob()">æ‰§è¡Œä»»åŠ¡</button>
                                <button class="btn btn-warning" onclick="pauseWaylineJob()">æš‚åœä»»åŠ¡</button>
                                <button class="btn btn-danger" onclick="cancelWaylineJob()">å–æ¶ˆä»»åŠ¡</button>
                            </div>
                        </div>
                        
                        <!-- ç¬¬å››æ­¥ï¼šä»»åŠ¡ç›‘æ§ -->
                        <div class="wayline-step">
                            <h6 class="text-primary">ğŸ“Š æ­¥éª¤4: ä»»åŠ¡çŠ¶æ€ç›‘æ§</h6>
                            
                            <!-- ä»»åŠ¡çŠ¶æ€ç›‘æ§é¢æ¿ -->
                            <div class="card mb-3" id="taskMonitorPanel">
                                <div class="card-header py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 text-success">å®æ—¶ä»»åŠ¡ç›‘æ§</h6>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="queryTaskStatus()">æŸ¥è¯¢çŠ¶æ€</button>
                                            <button class="btn btn-outline-secondary" onclick="toggleAutoRefresh()" id="autoRefreshBtn">å¯åŠ¨è‡ªåŠ¨åˆ·æ–°</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body py-2">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="mb-2">
                                                <small class="text-muted">å½“å‰ä»»åŠ¡ID:</small><br>
                                                <span id="currentJobId" class="badge bg-secondary fs-6">æš‚æ— ä»»åŠ¡</span>
                                            </div>
                                            <div class="mb-2">
                                                <small class="text-muted">ä»»åŠ¡çŠ¶æ€:</small><br>
                                                <span id="currentJobStatus" class="badge bg-info fs-6">å¾…æ‰§è¡Œ</span>
                                            </div>
                                            <div class="mb-2">
                                                <small class="text-muted">æ‰§è¡Œæ—¶é—´:</small><br>
                                                <span id="executeTime" class="text-sm">-</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-2">
                                                <small class="text-muted">æ‰§è¡Œè¿›åº¦:</small><br>
                                                <div class="progress" style="height: 24px;">
                                                    <div id="taskProgressBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                        <span id="progressText">0%</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <small class="text-muted">åª’ä½“æ–‡ä»¶:</small>
                                                <span id="mediaFileCount" class="ms-1 badge bg-light text-dark">0</span>
                                                <small class="text-muted">å®Œæˆæ—¶é—´:</small>
                                                <span id="completedTime" class="text-sm">-</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <small class="text-muted">ä»»åŠ¡è¯¦æƒ…:</small><br>
                                            <div id="taskDetails" class="text-sm bg-light p-2 rounded" style="min-height: 60px; max-height: 120px; overflow-y: auto;">
                                                <div class="text-center text-muted">æš‚æ— ä»»åŠ¡æ‰§è¡Œ - è¯·å…ˆåˆ›å»ºå¹¶æ‰§è¡Œèˆªçº¿ä»»åŠ¡</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2" id="taskActions" style="display: none;">
                                        <div class="col-12">
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-warning" onclick="pauseCurrentTask()" id="pauseTaskBtn">æš‚åœä»»åŠ¡</button>
                                                <button class="btn btn-success" onclick="resumeCurrentTask()" id="resumeTaskBtn" style="display: none;">æ¢å¤ä»»åŠ¡</button>
                                                <button class="btn btn-danger" onclick="cancelCurrentTask()" id="cancelTaskBtn">å–æ¶ˆä»»åŠ¡</button>
                                                <button class="btn btn-info" onclick="setMediaPriority()" id="mediaPriorityBtn">åª’ä½“ä¼˜å…ˆä¸Šä¼ </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-info" onclick="getJobDetail()">è·å–ä»»åŠ¡è¯¦æƒ…</button>
                                <button class="btn btn-secondary" onclick="refreshJobList()">åˆ·æ–°ä»»åŠ¡çŠ¶æ€</button>
                            </div>
                        </div>
                        
                        <div class="simulation-panel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-warning mb-0">æ¨¡æ‹Ÿé£è¡Œæµ‹è¯•</h6>
                                <button class="btn btn-sm btn-success" onclick="getDeviceCoordinates()">
                                    <small>è·å–æœºåœºåæ ‡</small>
                                </button>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="enableSimulation" checked onchange="updateTakeoffButtonText()">
                                <label class="form-check-label">å¯ç”¨æ¨¡æ‹Ÿé£è¡Œæ¨¡å¼ (å®¤å†…æµ‹è¯•)</label>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">æœºåœºçº¬åº¦:</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="simLatitude" class="form-control" value="22.1223" step="0.0001">
                                        <span class="input-group-text" id="latStatus">æ‰‹åŠ¨</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">æœºåœºç»åº¦:</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="simLongitude" class="form-control" value="113.2222" step="0.0001">
                                        <span class="input-group-text" id="lngStatus">æ‰‹åŠ¨</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">æœºåœºé«˜åº¦(m):</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="simAltitude" class="form-control" value="66.6" step="0.1">
                                        <span class="input-group-text" id="altStatus">æ‰‹åŠ¨</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">æœ€å¤§é€Ÿåº¦(m/s):</label>
                                    <input type="number" id="maxSpeed" class="form-control form-control-sm" value="10" min="1" max="15">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-info d-block" id="coordinateInfo">ç‚¹å‡»â€œè·å–æœºåœºåæ ‡â€è‡ªåŠ¨å¡«å…¥å½“å‰æœºåœºä½ç½®</small>
                                </div>
                            </div>
                            <div class="row mt-2" id="dockStatusPanel" style="display: none;">
                                <div class="col-12">
                                    <div class="card card-body py-2 bg-light">
                                        <h6 class="card-title mb-2 text-primary">æœºåœºçŠ¶æ€ä¿¡æ¯</h6>
                                        <div class="row text-sm">
                                            <div class="col-6">
                                                <small><strong>æœºåœºçŠ¶æ€:</strong> <span id="dockModeStatus">-</span></small><br>
                                                <small><strong>ä»»åŠ¡çŠ¶æ€:</strong> <span id="dockTaskStatus">-</span></small><br>
                                                <small><strong>é£è¡Œå™¨:</strong> <span id="droneInDockStatus">-</span></small>
                                            </div>
                                            <div class="col-6">
                                                <small><strong>GPSçŠ¶æ€:</strong> <span id="gpsStatusDetail">-</span></small><br>
                                                <small><strong>èˆ±ç›–çŠ¶æ€:</strong> <span id="coverStateStatus">-</span></small><br>
                                                <small><strong>ç´¯è®¡ä½œä¸š:</strong> <span id="jobNumberStatus">-</span></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-sm btn-info me-2" id="takeoffButton" onclick="testSimulateTakeoff()">æ¨¡æ‹Ÿä¸€é”®èµ·é£</button>
                                <button class="btn btn-sm btn-primary" id="flyToButton" onclick="testSimulateFlyTo()">æ¨¡æ‹Ÿé£å‘ç›®æ ‡ç‚¹</button>
                            </div>
                            <small class="text-muted d-block mt-2" id="simulationDescription">æ¨¡æ‹Ÿæ¨¡å¼ä¸‹é£è¡Œå™¨ä¸ä¼šå®é™…èµ·é£ï¼Œä½†ä¼šæ­£å¸¸æ‰§è¡Œå‡†å¤‡å·¥ä½œ</small>
                        </div>
                        
                        <div class="response-area" id="waylineApiResponse">APIå“åº”æ˜¾ç¤ºåŒºåŸŸ</div>
                    </div>
                </div>

                <!-- åª’ä½“ç®¡ç†APIæµ‹è¯• -->
                <div class="api-test-panel">
                    <div class="api-test-header">åª’ä½“ç®¡ç†API</div>
                    <div class="api-test-body">
                        <button class="btn btn-sm btn-primary btn-test" onclick="testGetMediaFiles()">è·å–åª’ä½“åˆ—è¡¨</button>
                        <button class="btn btn-sm btn-info btn-test" onclick="testMediaStatistics()">åª’ä½“ç»Ÿè®¡</button>
                        <button class="btn btn-sm btn-secondary btn-test" onclick="testStorageHealth()">å­˜å‚¨å¥åº·æ£€æŸ¥</button>
                        <div class="form-row">
                            <input type="file" id="mediaFile" class="form-control">
                            <button class="btn btn-sm btn-success mt-1" onclick="testUploadMedia()">ä¸Šä¼ æ–‡ä»¶</button>
                        </div>
                        <div class="response-area" id="mediaApiResponse">APIå“åº”æ˜¾ç¤ºåŒºåŸŸ</div>
                    </div>
                </div>
                
                <!-- DRCæ§åˆ¶é¢æ¿ -->
                <div class="control-panel">
                    <h4>ğŸ® DRCæŒ‡ä»¤é£è¡Œæ§åˆ¶</h4>
                    
                    <!-- DRCä¼šè¯ç®¡ç† -->
                    <div class="mb-3">
                        <h6>DRCä¼šè¯ç®¡ç†</h6>
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <button class="btn btn-sm btn-success" onclick="enterDrcMode()">è¿›å…¥DRCæ¨¡å¼</button>
                                <button class="btn btn-sm btn-danger" onclick="exitDrcMode()">é€€å‡ºDRCæ¨¡å¼</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-sm btn-info" onclick="getDrcStatus()">æŸ¥çœ‹DRCçŠ¶æ€</button>
                                <button class="btn btn-sm btn-warning" onclick="drcEmergencyStop()">DRCç´§æ€¥åœæ­¢</button>
                            </div>
                        </div>
                        
                        <!-- DRCé…ç½® -->
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <label class="form-label">OSDé¢‘ç‡(Hz):</label>
                                <select id="drcOsdFreq" class="form-select form-select-sm">
                                    <option value="5">5Hz</option>
                                    <option value="10" selected>10Hz</option>
                                    <option value="20">20Hz</option>
                                    <option value="30">30Hz</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">HSIé¢‘ç‡(Hz):</label>
                                <select id="drcHsiFreq" class="form-select form-select-sm">
                                    <option value="2">2Hz</option>
                                    <option value="4" selected>4Hz</option>
                                    <option value="6">6Hz</option>
                                    <option value="10">10Hz</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- DRCçŠ¶æ€æ˜¾ç¤º -->
                        <div class="alert alert-secondary p-2 mb-2">
                            <small><strong>DRCçŠ¶æ€:</strong> <span id="drcSessionStatus" class="badge bg-secondary">æœªæ¿€æ´»</span></small><br>
                            <small><strong>ä¼šè¯ID:</strong> <span id="drcSessionId">-</span></small><br>
                            <small><strong>æœ€åå¿ƒè·³:</strong> <span id="drcLastHeartbeat">-</span></small>
                        </div>
                    </div>
                    
                    <!-- DRCæ†é‡æ§åˆ¶ -->
                    <div class="drc-control-panel mb-3">
                        <h6>ğŸ•¹ï¸ æ†é‡æ§åˆ¶ (DJIæ ‡å‡†æ ¼å¼)</h6>
                        <div class="row g-2">
                            <!-- å·¦ä¾§æ‘‡æ† (æ²¹é—¨+åèˆª) -->
                            <div class="col-6">
                                <div class="card">
                                    <div class="card-header py-1">
                                        <small><strong>å·¦æ‘‡æ†</strong> (æ²¹é—¨+åèˆª)</small>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="drc-slider-container">
                                            <label>å‡é™(Throttle): <span id="throttleValue">1024</span></label>
                                            <input type="range" class="form-range" min="364" max="1684" value="1024" id="throttleSlider" oninput="updateDrcValue('throttle')">
                                        </div>
                                        <div class="drc-slider-container">
                                            <label>åèˆª(Yaw): <span id="yawValue">1024</span></label>
                                            <input type="range" class="form-range" min="364" max="1684" value="1024" id="yawSlider" oninput="updateDrcValue('yaw')">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- å³ä¾§æ‘‡æ† (ä¿¯ä»°+æ¨ªæ»š) -->
                            <div class="col-6">
                                <div class="card">
                                    <div class="card-header py-1">
                                        <small><strong>å³æ‘‡æ†</strong> (ä¿¯ä»°+æ¨ªæ»š)</small>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="drc-slider-container">
                                            <label>ä¿¯ä»°(Pitch): <span id="pitchValue">1024</span></label>
                                            <input type="range" class="form-range" min="364" max="1684" value="1024" id="pitchSlider" oninput="updateDrcValue('pitch')">
                                        </div>
                                        <div class="drc-slider-container">
                                            <label>æ¨ªæ»š(Roll): <span id="rollValue">1024</span></label>
                                            <input type="range" class="form-range" min="364" max="1684" value="1024" id="rollSlider" oninput="updateDrcValue('roll')">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- æ§åˆ¶æŒ‰é’® -->
                        <div class="text-center mt-3">
                            <button class="btn btn-primary btn-sm" onclick="sendStickControl()">å‘é€æ†é‡æ§åˆ¶</button>
                            <button class="btn btn-secondary btn-sm" onclick="resetAllSticks()">é‡ç½®æ‰€æœ‰æ‘‡æ†</button>
                            <button class="btn btn-info btn-sm" onclick="testStickControl()">æµ‹è¯•æ¨¡å¼</button>
                        </div>
                        
                        <!-- å¿«æ·æ§åˆ¶é¢„è®¾ -->
                        <div class="mt-2">
                            <small class="text-muted">å¿«æ·é¢„è®¾:</small><br>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success" onclick="presetTakeoff()">èµ·é£</button>
                                <button class="btn btn-outline-primary" onclick="presetHover()">æ‚¬åœ</button>
                                <button class="btn btn-outline-info" onclick="presetLand()">é™è½</button>
                                <button class="btn btn-outline-warning" onclick="presetRotateLeft()">å·¦è½¬</button>
                                <button class="btn btn-outline-warning" onclick="presetRotateRight()">å³è½¬</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DRCå®æ—¶æ•°æ®ç›‘æ§ -->
                    <div class="mb-3">
                        <h6>ğŸ“Š å®æ—¶æ•°æ®ç›‘æ§</h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="card">
                                    <div class="card-header py-1">
                                        <small><strong>OSDæ•°æ®</strong> (é«˜é¢‘)</small>
                                    </div>
                                    <div class="card-body p-2">
                                        <div style="font-size: 11px;">
                                            <div>ä½ç½®: <span id="drcPosition">ç­‰å¾…æ•°æ®...</span></div>
                                            <div>é«˜åº¦: <span id="drcHeight">-</span>m</div>
                                            <div>å§¿æ€: <span id="drcAttitude">-</span>Â°</div>
                                            <div>é€Ÿåº¦: <span id="drcVelocity">-</span>m/s</div>
                                            <div>äº‘å°: P:<span id="drcGimbalP">-</span>Â° Y:<span id="drcGimbalY">-</span>Â°</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card">
                                    <div class="card-header py-1">
                                        <small><strong>HSIæ•°æ®</strong> (é¿éšœ)</small>
                                    </div>
                                    <div class="card-body p-2">
                                        <div style="font-size: 11px;">
                                            <div>ä¸Šæ–¹: <span id="hsiUp" class="badge bg-success">æ­£å¸¸</span></div>
                                            <div>ä¸‹æ–¹: <span id="hsiDown" class="badge bg-success">æ­£å¸¸</span></div>
                                            <div>å‰æ–¹: <span id="hsiFront" class="badge bg-success">æ­£å¸¸</span></div>
                                            <div>åæ–¹: <span id="hsiBack" class="badge bg-success">æ­£å¸¸</span></div>
                                            <div>å·¦å³: <span id="hsiSide" class="badge bg-success">æ­£å¸¸</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å»¶æ—¶ä¿¡æ¯ -->
                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header py-1">
                                        <small><strong>å»¶æ—¶ç›‘æ§</strong></small>
                                    </div>
                                    <div class="card-body p-2">
                                        <div style="font-size: 11px;">
                                            <div class="row">
                                                <div class="col-6">æŒ‡ä»¤å»¶æ—¶: <span id="cmdDelay" class="badge bg-info">-</span>ms</div>
                                                <div class="col-6">è§†é¢‘å»¶æ—¶: <span id="videoDelay" class="badge bg-info">-</span>ms</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DRC WebSocketè¿æ¥çŠ¶æ€ -->
                    <div class="mb-3">
                        <h6>ğŸ”— WebSocketè¿æ¥</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-sm btn-success" onclick="connectDrcWebSocket()">è¿æ¥WebSocket</button>
                                <button class="btn btn-sm btn-danger" onclick="disconnectDrcWebSocket()">æ–­å¼€è¿æ¥</button>
                            </div>
                            <div class="col-6">
                                <small>è¿æ¥çŠ¶æ€: <span id="wsConnectionStatus" class="badge bg-secondary">æœªè¿æ¥</span></small><br>
                                <small>æ¶ˆæ¯è®¡æ•°: <span id="wsMessageCount">0</span></small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DRCæ“ä½œæ—¥å¿— -->
                    <div class="mb-3">
                        <h6>ğŸ“ DRCæ“ä½œæ—¥å¿—</h6>
                        <div class="log-container" id="drcLogContainer" style="height: 150px;">
                            <div class="text-muted">DRCæ“ä½œæ—¥å¿—å°†åœ¨è¿™é‡Œæ˜¾ç¤º...</div>
                        </div>
                        <div class="text-center mt-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearDrcLog()">æ¸…ç©ºæ—¥å¿—</button>
                            <button class="btn btn-sm btn-outline-info" onclick="exportDrcLog()">å¯¼å‡ºæ—¥å¿—</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šHMSå¥åº·ç›‘æ§å’Œæ—¥å¿— -->
            <div class="col-md-4">
                <!-- HMSå¥åº·ç›‘æ§ -->
                <div class="control-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h4 class="mb-1">HMSå¥åº·ç›‘æ§</h4>
                            <div id="hmsCount">
                                <span class="badge bg-secondary">0</span>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="refreshHMS()">åˆ·æ–°</button>
                    </div>
                    <div id="hmsContainer" class="hms-container" style="max-height: 250px; overflow-y: auto;">
                        <div class="text-muted text-center">æš‚æ— è­¦å‘Šä¿¡æ¯</div>
                    </div>
                    <div class="d-flex gap-2 mt-2">
                        <button class="btn btn-sm btn-success" onclick="markHMSRead()">æ ‡è®°å·²è¯»</button>
                        <button class="btn btn-sm btn-outline-secondary" id="hmsViewToggle" onclick="toggleHMSView()">æŸ¥çœ‹æ‰€æœ‰</button>
                    </div>
                </div>

                <!-- æœºåœºç¯å¢ƒç›‘æ§ -->
                <div class="control-panel">
                    <h4>æœºåœºç¯å¢ƒç›‘æ§ 
                        <button class="btn btn-sm btn-secondary float-end" onclick="refreshEnvironmentData()">åˆ·æ–°</button>
                    </h4>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <div class="card bg-primary text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1">ç¯å¢ƒæ¸©åº¦</h6>
                                    <div class="h5 mb-0" id="environmentTemp">--Â°C</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-info text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1">èˆ±å†…æ¸©åº¦</h6>
                                    <div class="h5 mb-0" id="dockTemp">--Â°C</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-4">
                            <div class="card bg-success text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1 small">é£é€Ÿ</h6>
                                    <div class="h6 mb-0" id="windSpeed">-- m/s</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-warning text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1 small">æ¹¿åº¦</h6>
                                    <div class="h6 mb-0" id="humidity">--%</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-secondary text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1 small">é™é›¨</h6>
                                    <div class="h6 mb-0" id="rainfall">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <div class="card bg-dark text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1 small">å……ç”µçŠ¶æ€</h6>
                                    <div class="h6 mb-0" id="chargeStatus">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-success text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1 small">ç”µæ± ç”µé‡</h6>
                                    <div class="h6 mb-0" id="batteryLevel">--%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-muted small text-center">
                        <span id="environmentLastUpdate">æš‚æ— æ•°æ®</span>
                    </div>
                </div>
                <!-- é£è¡Œæ§åˆ¶ -->
                <div class="control-panel">
                    <h4>é£è¡Œæ§åˆ¶</h4>
                    
                    <!-- æƒé™æ§åˆ¶ -->
                    <div class="mb-3">
                        <h6>æ§åˆ¶æƒç®¡ç†</h6>
                        <div class="text-center mb-2">
                            <button class="btn btn-sm btn-success" onclick="grabFlightAuthority()">è·å–é£è¡Œæ§åˆ¶æƒ</button>
                            <button class="btn btn-sm btn-success" onclick="grabPayloadAuthority()">è·å–è´Ÿè½½æ§åˆ¶æƒ</button>
                        </div>
                        <div class="text-center mb-2">
                            <button class="btn btn-sm btn-warning" onclick="releaseFlightAuthority()">é‡Šæ”¾é£è¡Œæ§åˆ¶æƒ</button>
                            <button class="btn btn-sm btn-warning" onclick="releasePayloadAuthority()">é‡Šæ”¾è´Ÿè½½æ§åˆ¶æƒ</button>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-sm btn-info" onclick="checkAuthorityStatus()">æŸ¥çœ‹æƒé™çŠ¶æ€</button>
                        </div>
                    </div>
                    
                    <!-- é£è¡Œæ“ä½œ -->
                    <div class="text-center">
                        <!-- <button class="btn btn-success btn-test" onclick="takeoff()">èµ·é£</button> -->
                        <button class="btn btn-warning btn-test" onclick="returnHome()">è¿”èˆª</button>
                        <button class="btn btn-danger btn-test" onclick="emergencyStop()">ç´§æ€¥åœæ­¢</button>
                    </div>
                    
                    <!-- æƒé™çŠ¶æ€æ˜¾ç¤º -->
                    <div class="mt-3">
                        <h6>æƒé™çŠ¶æ€</h6>
                        <pre id="authorityStatusDisplay" class="bg-light p-2 small" style="max-height: 150px; overflow-y: auto;">ç‚¹å‡»"æŸ¥çœ‹æƒé™çŠ¶æ€"æŸ¥çœ‹</pre>
                    </div>
                </div>
                <!-- å·¥ä½œç©ºé—´APIæµ‹è¯• -->
                <div class="api-test-panel">
                    <div class="api-test-header">å·¥ä½œç©ºé—´ç®¡ç†API</div>
                    <div class="api-test-body">
                        <button class="btn btn-sm btn-primary btn-test" onclick="testGetWorkspaces()">è·å–å·¥ä½œç©ºé—´</button>
                        <button class="btn btn-sm btn-success btn-test" onclick="testCreateWorkspace()">åˆ›å»ºå·¥ä½œç©ºé—´</button>
                        <!-- <button class="btn btn-sm btn-info btn-test" onclick="testBindDevice()">ç»‘å®šè®¾å¤‡</button> -->
                        <div class="response-area" id="workspaceApiResponse">APIå“åº”æ˜¾ç¤ºåŒºåŸŸ</div>
                    </div>
                </div>

                <!-- ç³»ç»Ÿæ—¥å¿— -->
                <div class="control-panel">
                    <h4>ç³»ç»Ÿæ—¥å¿—</h4>
                    <div id="logContainer" class="log-container">
                        <div class="text-muted">ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…æ“ä½œ...</div>
                    </div>
                    <button class="btn btn-sm btn-secondary mt-2" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                </div>
            </div>
        </div>
    </div>

    <!-- è§†é¢‘ç›´æ’­åŒºåŸŸ - å…¨å®½æ˜¾ç¤º -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-video me-2"></i>å®æ—¶è§†é¢‘ç›´æ’­
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshVideo()">
                                <i class="fas fa-sync-alt me-1"></i>åˆ·æ–°
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()">
                                <i class="fas fa-expand me-1"></i>å…¨å±
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="stopVideoPlayback()">
                                <i class="fas fa-stop me-1"></i>åœæ­¢
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="video-player-container position-relative">
                            <video id="livestreamVideo" 
                                   style="width: 100%; height: 400px; background: #000;" 
                                   controls 
                                   muted 
                                   autoplay 
                                   playsinline>
                                æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè§†é¢‘æ’­æ”¾
                            </video>
                            <div id="videoOverlay" class="position-absolute top-50 start-50 translate-middle text-white text-center" style="pointer-events: none;">
                                <div class="bg-dark bg-opacity-75 p-4 rounded">
                                    <i class="fas fa-play-circle fa-3x mb-3"></i>
                                    <h6>ç­‰å¾…ç›´æ’­å¯åŠ¨...</h6>
                                    <small class="text-muted">è¯·å…ˆåœ¨ä¸Šæ–¹"ç›´æ’­æ¨æµæ§åˆ¶"åŒºåŸŸå¯åŠ¨æ¨æµ</small>
                                </div>
                            </div>
                        </div>
                        <div class="px-3 py-2 bg-light border-top d-flex justify-content-between align-items-center">
                            <div>
                                <strong>çŠ¶æ€:</strong> 
                                <span id="videoInfo" class="ms-1">è¯·å…ˆå¯åŠ¨æ¨æµ</span>
                            </div>
                            <div class="text-muted">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    é€šè¿‡SRSæœåŠ¡å™¨è½¬æ¢RTMPæµä¸ºWebRTCæ’­æ”¾
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let currentVideoId = null;
        let hmsRefreshInterval = null;
        
        // é…ç½®ç®¡ç†
        function saveConfig() {
            const config = {
                apiUrl: document.getElementById('apiUrl').value,
                apiToken: document.getElementById('apiToken').value,
                deviceSn: document.getElementById('deviceSn').value,
                deviceType: document.getElementById('deviceType').value
            };
            localStorage.setItem('droneApiConfig', JSON.stringify(config));
            log('é…ç½®å·²ä¿å­˜', 'success');
            
            // ç”Ÿæˆvideo_id
            if (config.deviceSn) {
                currentVideoId = generateVideoId(config.deviceSn);
                log(`å·²ç”Ÿæˆvideo_id: ${currentVideoId}`, 'info');
                
                // å°è¯•è‡ªåŠ¨è·å–æœºåœºåæ ‡
                setTimeout(() => {
                    getDeviceCoordinates();
                }, 1000);
            }
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            const config = localStorage.getItem('droneApiConfig');
            if (config) {
                const parsed = JSON.parse(config);
                document.getElementById('apiUrl').value = parsed.apiUrl || 'http://192.168.111.49:8000';
                document.getElementById('apiToken').value = parsed.apiToken || '';
                document.getElementById('deviceSn').value = parsed.deviceSn || '';
                document.getElementById('deviceType').value = parsed.deviceType || 'dock';
                
                if (parsed.deviceSn) {
                    currentVideoId = generateVideoId(parsed.deviceSn);
                }
            }
        }

        // ç”Ÿæˆvideo_id
        function generateVideoId(deviceSn) {
            if (!deviceSn) return null;
            
            const deviceType = document.getElementById('deviceType').value;
            let cameraIndex, videoIndex;
            
            if (deviceType === 'dock') {
                cameraIndex = '165-0-7';  // æœºåœºFPVç›¸æœº
                videoIndex = 'normal-0';  // æ­£å¸¸é•œå¤´
            } else {
                cameraIndex = '39-0-7';   // é£è¡Œå™¨FPVç›¸æœº
                videoIndex = 'normal-0';   // æ­£å¸¸é•œå¤´
            }
            
            return `${deviceSn}/${cameraIndex}/${videoIndex}`;
        }

        // æ­¤å‡½æ•°å·²ä¸å†éœ€è¦ï¼Œç›´æ¥æ˜¾ç¤ºpush_url
        
        // å¤åˆ¶æ¨æµåœ°å€
        function copyVlcUrl() {
            const vlcUrl = document.getElementById('vlcUrl').textContent;
            if (vlcUrl && vlcUrl !== 'ç­‰å¾…æ¨æµå¯åŠ¨...' && vlcUrl !== 'åå°æœªè¿”å›æ¨æµåœ°å€') {
                navigator.clipboard.writeText(vlcUrl).then(() => {
                    log('æ¨æµåœ°å€å·²å¤åˆ¶åˆ°å‰ªåˆ‡æ¿', 'success');
                }).catch(() => {
                    log('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                });
            } else {
                log('æš‚æ— å¯å¤åˆ¶çš„æ¨æµåœ°å€', 'warning');
            }
        }
        
        // æ¸…ç©ºæ¨æµä¿¡æ¯
        function clearStreamInfo() {
            document.getElementById('streamStatus').textContent = 'æœªå¯åŠ¨';
            document.getElementById('streamProtocol').textContent = '-';
            document.getElementById('vlcUrl').textContent = 'ç­‰å¾…æ¨æµå¯åŠ¨...';
            log('æ¨æµä¿¡æ¯å·²æ¸…ç©º', 'info');
        }

        // APIè¯·æ±‚å‡½æ•°
        async function apiRequest(endpoint, method = 'GET', data = null) {
            let apiUrl = document.getElementById('apiUrl').value || 'http://192.168.111.49:8000';
            
            // ç¡®ä¿URLæ ¼å¼æ­£ç¡®
            if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
                apiUrl = 'http://' + apiUrl;
            }
            
            // ç§»é™¤æœ«å°¾çš„æ–œæ 
            apiUrl = apiUrl.replace(/\/$/, '');
            
            const token = document.getElementById('apiToken').value;
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const config = {
                method,
                headers
            };
            
            if (data && method !== 'GET') {
                config.body = JSON.stringify(data);
            }
            
            try {
                const fullUrl = `${apiUrl}${endpoint}`;
                console.log(`APIè¯·æ±‚: ${method} ${fullUrl}`);
                
                const response = await fetch(fullUrl, config);
                const result = await response.json();
                
                // å¤„ç†è®¤è¯é”™è¯¯
                if (response.status === 401) {
                    log('è®¤è¯å¤±è´¥ï¼šè¯·å…ˆç™»å½•æˆ–æ£€æŸ¥Tokenæ˜¯å¦æœ‰æ•ˆ', 'error');
                    if (result.detail && result.detail.includes('æ— æ³•éªŒè¯å‡­æ®')) {
                        log('æç¤ºï¼šç‚¹å‡»å·¦ä¸Šè§’çš„"ç™»å½•"æŒ‰é’®è¿›è¡Œèº«ä»½éªŒè¯', 'warning');
                    }
                    throw new Error(`è®¤è¯å¤±è´¥ (${response.status}): ${result.detail || 'æ— æ³•éªŒè¯å‡­æ®'}`);
                }
                
                // å¤„ç†å…¶ä»–HTTPé”™è¯¯
                if (!response.ok) {
                    const errorMsg = result.detail || result.message || `HTTP ${response.status}`;
                    log(`APIè¯·æ±‚å¤±è´¥ (${response.status}): ${errorMsg}`, 'error');
                    throw new Error(errorMsg);
                }
                
                return result;
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    log(`ç½‘ç»œè¯·æ±‚å¤±è´¥: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ ${apiUrl}`, 'error');
                    throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦è¿è¡Œ');
                }
                throw error;
            }
        }

        // ç™»å½•ç›¸å…³
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                log('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
                return;
            }
            
            try {
                const data = new FormData();
                data.append('username', username);
                data.append('password', password);
                
                const response = await fetch(`${document.getElementById('apiUrl').value}/api/v1/login/access-token`, {
                    method: 'POST',
                    body: data
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('apiToken').value = result.access_token;
                    document.getElementById('loginStatus').className = 'status-indicator status-online';
                    document.getElementById('loginStatusText').textContent = 'å·²ç™»å½•';
                    log('ç™»å½•æˆåŠŸ', 'success');
                } else {
                    log(`ç™»å½•å¤±è´¥: ${result.detail || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                log(`ç™»å½•è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function logout() {
            document.getElementById('apiToken').value = '';
            document.getElementById('loginStatus').className = 'status-indicator status-offline';
            document.getElementById('loginStatusText').textContent = 'æœªç™»å½•';
            log('å·²ç™»å‡º', 'info');
        }

        // ç›´æ’­æ§åˆ¶
        async function startLivestream() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            if (!currentVideoId) {
                currentVideoId = generateVideoId(deviceSn);
                log(`ä½¿ç”¨video_id: ${currentVideoId}`, 'info');
            }
            
            const streamType = document.getElementById('streamType').value;
            const quality = document.getElementById('streamQuality').value;
            
            // RTMP = 1, WebRTC = 4
            const urlType = streamType === 'rtmp' ? 1 : 4;
            
            try {
                log(`å¼€å§‹${streamType.toUpperCase()}æ¨æµ...`, 'info');
                
                const result = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/livestream/start`, 'POST', {
                    url_type: urlType,
                    video_id: currentVideoId,
                    video_quality: parseInt(quality),
                    url: null  // å¯é€‰å­—æ®µï¼Œç”±åå°è‡ªåŠ¨ç”Ÿæˆ
                });
                
                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                document.getElementById('streamStatus').textContent = 'æ¨æµä¸­';
                document.getElementById('streamProtocol').textContent = streamType.toUpperCase();
                
                // æ˜¾ç¤ºåå°è¿”å›çš„æ¨æµåœ°å€
                if (result.push_url) {
                    document.getElementById('vlcUrl').textContent = result.push_url;
                    log(`æ¨æµåœ°å€: ${result.push_url}`, 'success');
                    
                    // è‡ªåŠ¨å¯åŠ¨è§†é¢‘æ’­æ”¾
                    startVideoPlayback(result.push_url, streamType);
                } else {
                    document.getElementById('vlcUrl').textContent = 'åå°æœªè¿”å›æ¨æµåœ°å€';
                    log('åå°æœªè¿”å›push_url', 'warning');
                }
                
                log('æ¨æµå¯åŠ¨æˆåŠŸ', 'success');
                log(`æ¨æµID: ${result.bid || 'N/A'}`, 'info');
                
                // æ˜¾ç¤ºåŠ¨æ€æ¸…æ™°åº¦åˆ‡æ¢æ§åˆ¶
                document.getElementById('dynamicQualityControl').style.display = 'block';
                document.getElementById('dynamicQuality').value = quality;
                
                // æ˜¾ç¤ºé•œå¤´åˆ‡æ¢æ§åˆ¶
                document.getElementById('lensChangeControl').style.display = 'block';
                document.getElementById('currentLensType').textContent = 'é»˜è®¤';
                
                // æ˜¾ç¤ºå®Œæ•´å“åº”
                displayResponse('streamApiResponse', result);
            } catch (error) {
                log(`æ¨æµå¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('streamStatus').textContent = 'å¯åŠ¨å¤±è´¥';
            }
        }

        async function stopLivestream() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            if (!currentVideoId) {
                log('è¯·å…ˆå¯åŠ¨æ¨æµ', 'warning');
                return;
            }
            
            try {
                log('åœæ­¢æ¨æµ...', 'info');
                
                const result = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/livestream/stop`, 'POST', {
                    video_id: currentVideoId
                });
                
                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                document.getElementById('streamStatus').textContent = 'å·²åœæ­¢';
                document.getElementById('streamProtocol').textContent = '-';
                document.getElementById('vlcUrl').textContent = 'æ¨æµå·²åœæ­¢';
                
                // åœæ­¢è§†é¢‘æ’­æ”¾
                stopVideoPlayback();
                
                // éšè—åŠ¨æ€æ¸…æ™°åº¦åˆ‡æ¢æ§åˆ¶
                document.getElementById('dynamicQualityControl').style.display = 'none';
                
                // éšè—é•œå¤´åˆ‡æ¢æ§åˆ¶
                document.getElementById('lensChangeControl').style.display = 'none';
                
                log('æ¨æµå·²åœæ­¢', 'success');
                log(`åœæ­¢ID: ${result.bid || 'N/A'}`, 'info');
                
                displayResponse('streamApiResponse', result);
            } catch (error) {
                log(`åœæ­¢æ¨æµå¤±è´¥: ${error.message}`, 'error');
                document.getElementById('streamStatus').textContent = 'åœæ­¢å¤±è´¥';
            }
        }

        // åˆ‡æ¢ç›´æ’­é•œå¤´
        async function changeLens(lensType) {
            const deviceSn = document.getElementById('deviceSn').value;
            
            if (!deviceSn) {
                log('è¯·å…ˆè¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            if (!currentVideoId) {
                log('è¯·å…ˆå¯åŠ¨ç›´æ’­æ¨æµ', 'error');
                return;
            }
            
            const lensNames = {
                'normal': 'é»˜è®¤',
                'wide': 'å¹¿è§’', 
                'zoom': 'å˜ç„¦',
                'ir': 'çº¢å¤–'
            };
            
            try {
                log(`æ­£åœ¨åˆ‡æ¢é•œå¤´åˆ°: ${lensNames[lensType]}...`, 'info');
                
                const result = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/livestream/lens-change`, 'POST', {
                    video_id: currentVideoId,
                    video_type: lensType
                });
                
                // æ›´æ–°å½“å‰é•œå¤´çŠ¶æ€æ˜¾ç¤º
                document.getElementById('currentLensType').textContent = lensNames[lensType];
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€ - é«˜äº®å½“å‰é€‰ä¸­çš„é•œå¤´
                const buttons = document.querySelectorAll('#lensChangeControl .btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                log(`é•œå¤´å·²åˆ‡æ¢åˆ°: ${lensNames[lensType]}`, 'success');
                log(`åˆ‡æ¢ID: ${result.bid || 'N/A'}`, 'info');
                
                displayResponse('streamApiResponse', result);
            } catch (error) {
                log(`é•œå¤´åˆ‡æ¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åŠ¨æ€åˆ‡æ¢ç›´æ’­æ¸…æ™°åº¦
        async function changeLiveQuality() {
            const deviceSn = document.getElementById('deviceSn').value;
            const newQuality = parseInt(document.getElementById('dynamicQuality').value);
            
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            if (!currentVideoId) {
                log('è¯·å…ˆå¯åŠ¨ç›´æ’­æ¨æµ', 'error');
                return;
            }
            
            const qualityNames = {
                0: 'è‡ªé€‚åº”',
                1: 'æµç•… (512Kbps)',
                2: 'æ ‡æ¸… (1Mbps)', 
                3: 'é«˜æ¸… (1.5Mbps)',
                4: 'è¶…æ¸… (8Mbps)'
            };
            
            try {
                log(`æ­£åœ¨åˆ‡æ¢æ¸…æ™°åº¦åˆ°: ${qualityNames[newQuality]}...`, 'info');
                
                const result = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/livestream/set-quality`, 'POST', {
                    video_id: currentVideoId,
                    video_quality: newQuality
                });
                
                log(`æ¸…æ™°åº¦å·²åˆ‡æ¢åˆ°: ${qualityNames[newQuality]}`, 'success');
                log(`åˆ‡æ¢ID: ${result.bid || 'N/A'}`, 'info');
                
                displayResponse('streamApiResponse', result);
            } catch (error) {
                log(`æ¸…æ™°åº¦åˆ‡æ¢å¤±è´¥: ${error.message}`, 'error');
                // å‘ç”Ÿé”™è¯¯æ—¶é‡ç½®é€‰æ‹©æ¡†åˆ°ä¹‹å‰çš„å€¼
                const currentQuality = document.getElementById('streamQuality').value;
                document.getElementById('dynamicQuality').value = currentQuality;
            }
        }

        // å½•åƒæ§åˆ¶
        async function startRecording() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/camera/recording/start`, 'POST', {
                    payload_index: payloadIndex
                });
                log('å½•åƒå·²å¼€å§‹', 'success');
                displayResponse('recordingApiResponse', result);
            } catch (error) {
                log(`å¼€å§‹å½•åƒå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function stopRecording() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/camera/recording/stop`, 'POST', {
                    payload_index: payloadIndex
                });
                log('å½•åƒå·²åœæ­¢', 'success');
                displayResponse('recordingApiResponse', result);
            } catch (error) {
                log(`åœæ­¢å½•åƒå¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function switchCameraMode() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            const cameraMode = parseInt(document.getElementById('cameraMode').value);
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/camera/mode`, 'POST', {
                    payload_index: payloadIndex,
                    camera_mode: cameraMode
                });
                log(`ç›¸æœºæ¨¡å¼å·²åˆ‡æ¢åˆ°: ${document.getElementById('cameraMode').options[document.getElementById('cameraMode').selectedIndex].text}`, 'success');
                displayResponse('recordingApiResponse', result);
            } catch (error) {
                log(`åˆ‡æ¢ç›¸æœºæ¨¡å¼å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function takePhoto() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/camera/photo`, 'POST', {
                    payload_index: payloadIndex
                });
                log('æ‹ç…§æˆåŠŸ', 'success');
                displayResponse('recordingApiResponse', result);
            } catch (error) {
                log(`æ‹ç…§å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–æ‰€æœ‰è®¾å¤‡ç›´æ’­èƒ½åŠ›
        async function getLivestreamCapacity() {
            try {
                log('è·å–æ‰€æœ‰è®¾å¤‡ç›´æ’­èƒ½åŠ›...', 'info');
                
                const result = await apiRequest('/api/v1/livestream/capacity', 'GET');
                
                // æ ¼å¼åŒ–æ˜¾ç¤ºç»“æœ
                let html = `<div class="mb-2"><strong>ç›´æ’­èƒ½åŠ›ç»Ÿè®¡</strong></div>`;
                html += `<div class="row mb-2">`;
                html += `<div class="col-4"><small>è®¾å¤‡æ•°: ${result.total_devices}</small></div>`;
                html += `<div class="col-4"><small>æ‘„åƒå¤´: ${result.total_cameras}</small></div>`;
                html += `<div class="col-4"><small>è§†é¢‘æµ: ${result.total_videos}</small></div>`;
                html += `</div>`;
                
                if (result.available_devices.length > 0) {
                    html += `<div class="mb-2"><strong>å¯ç›´æ’­è®¾å¤‡:</strong></div>`;
                    result.available_devices.forEach(device => {
                        html += `<div class="card mb-2">`;
                        html += `<div class="card-body p-2">`;
                        html += `<div class="d-flex justify-content-between align-items-center mb-1">`;
                        html += `<small><strong>${device.sn}</strong></small>`;
                        html += `<small class="text-muted">è§†é¢‘æµ: ${device.available_video_number}/${device.coexist_video_number_max}</small>`;
                        html += `</div>`;
                        
                        device.camera_list.forEach(camera => {
                            html += `<div class="border-left pl-2 ml-2 mb-1">`;
                            html += `<div class="d-flex justify-content-between align-items-center">`;
                            html += `<small class="text-primary">ğŸ“¹ ${camera.camera_index}</small>`;
                            html += `<small class="text-muted">${camera.available_video_number}/${camera.coexist_video_number_max}</small>`;
                            html += `</div>`;
                            html += `<div class="ml-2">`;
                            camera.video_list.forEach(video => {
                                const videoId = `${device.sn}/${camera.camera_index}/${video.video_index}`;
                                html += `<div class="d-flex justify-content-between align-items-center mb-1">`;
                                html += `<small>â€¢ ${video.video_index} (${video.video_type})</small>`;
                                html += `<button class="btn btn-xs btn-outline-success" onclick="selectVideoForLivestream('${videoId}', '${device.sn}', '${camera.camera_index}', '${video.video_index}', '${video.video_type}')" style="font-size: 10px; padding: 1px 6px;">é€‰æ‹©ç›´æ’­</button>`;
                                html += `</div>`;
                                if (video.switchable_video_types.length > 1) {
                                    html += `<small class="text-muted d-block ml-3">å¯åˆ‡æ¢: ${video.switchable_video_types.join(', ')}</small>`;
                                }
                            });
                            html += `</div></div>`;
                        });
                        
                        html += `</div></div>`;
                    });
                } else {
                    html += `<div class="text-muted">æš‚æ— å¯ç›´æ’­è®¾å¤‡</div>`;
                }
                
                document.getElementById('livestreamCapacityResult').innerHTML = html;
                log('ç›´æ’­èƒ½åŠ›è·å–æˆåŠŸ', 'success');
                
            } catch (error) {
                log(`è·å–ç›´æ’­èƒ½åŠ›å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('livestreamCapacityResult').innerHTML = 
                    `<div class="text-danger">è·å–å¤±è´¥: ${error.message}</div>`;
            }
        }

        // è·å–å½“å‰è®¾å¤‡ç›´æ’­èƒ½åŠ›
        async function getDeviceLivestreamCapacity() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                log(`è·å–è®¾å¤‡ ${deviceSn} ç›´æ’­èƒ½åŠ›...`, 'info');
                
                const result = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/capacity`, 'GET');
                
                let html = `<div class="mb-2"><strong>è®¾å¤‡: ${deviceSn}</strong></div>`;
                
                if (result.capacity) {
                    html += `<div class="row mb-2">`;
                    html += `<div class="col-6"><small>æ‘„åƒå¤´æ•°: ${result.camera_count}</small></div>`;
                    html += `<div class="col-6"><small>è§†é¢‘æµæ•°: ${result.video_count}</small></div>`;
                    html += `</div>`;
                    
                    html += `<div class="mb-2"><small>å¯ç”¨è§†é¢‘æµ: ${result.capacity.available_video_number}/${result.capacity.coexist_video_number_max}</small></div>`;
                    
                    if (result.capacity.camera_list.length > 0) {
                        html += `<div class="mb-2"><strong>æ‘„åƒå¤´åˆ—è¡¨:</strong></div>`;
                        result.capacity.camera_list.forEach(camera => {
                            html += `<div class="card mb-2">`;
                            html += `<div class="card-body p-2">`;
                            html += `<div class="mb-1"><small><strong>ğŸ“¹ ${camera.camera_index}</strong></small></div>`;
                            html += `<div class="ml-2">`;
                            camera.video_list.forEach(video => {
                                const videoId = `${deviceSn}/${camera.camera_index}/${video.video_index}`;
                                html += `<div class="d-flex justify-content-between align-items-center mb-1">`;
                                html += `<small>â€¢ ${video.video_index} (${video.video_type})</small>`;
                                html += `<button class="btn btn-xs btn-outline-success" onclick="selectVideoForLivestream('${videoId}', '${deviceSn}', '${camera.camera_index}', '${video.video_index}', '${video.video_type}')" style="font-size: 10px; padding: 1px 6px;">é€‰æ‹©ç›´æ’­</button>`;
                                html += `</div>`;
                                if (video.switchable_video_types.length > 1) {
                                    html += `<small class="text-muted d-block ml-3">å¯åˆ‡æ¢: ${video.switchable_video_types.join(', ')}</small>`;
                                }
                            });
                            html += `</div></div></div>`;
                        });
                    } else {
                        html += `<div class="text-muted">æ— å¯ç”¨æ‘„åƒå¤´</div>`;
                    }
                } else {
                    html += `<div class="text-warning">${result.message}</div>`;
                }
                
                document.getElementById('livestreamCapacityResult').innerHTML = html;
                log('è®¾å¤‡ç›´æ’­èƒ½åŠ›è·å–æˆåŠŸ', 'success');
                
            } catch (error) {
                log(`è·å–è®¾å¤‡ç›´æ’­èƒ½åŠ›å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('livestreamCapacityResult').innerHTML = 
                    `<div class="text-danger">è·å–å¤±è´¥: ${error.message}</div>`;
            }
        }

        // é€‰æ‹©è§†é¢‘æµè¿›è¡Œç›´æ’­
        function selectVideoForLivestream(videoId, deviceSn, cameraIndex, videoIndex, videoType) {
            // è·å–å½“å‰ç½‘å…³è®¾å¤‡SN (ä¸æ”¹å˜)
            const gatewayDeviceSn = document.getElementById('deviceSn').value;
            
            // å­˜å‚¨é€‰æ‹©çš„è§†é¢‘æµä¿¡æ¯ï¼Œä½†ä½¿ç”¨ç½‘å…³è®¾å¤‡SN
            window.selectedVideoStream = {
                videoId: videoId,
                sourceDeviceSn: deviceSn,  // è§†é¢‘æµæ¥æºè®¾å¤‡
                deviceSn: gatewayDeviceSn,  // ç½‘å…³è®¾å¤‡SN (ç”¨äºæ§åˆ¶)
                cameraIndex: cameraIndex,
                videoIndex: videoIndex,
                videoType: videoType
            };
            
            // ä¸æ›´æ–°è®¾å¤‡SNè¾“å…¥æ¡†ï¼Œä¿æŒæœºåœºç½‘å…³SN
            
            // æ˜¾ç¤ºé€‰ä¸­çš„è§†é¢‘æµä¿¡æ¯
            const detailsHtml = `
                <small class="d-block"><strong>è§†é¢‘æºè®¾å¤‡:</strong> ${deviceSn}</small>
                <small class="d-block"><strong>æ§åˆ¶ç½‘å…³:</strong> ${gatewayDeviceSn}</small>
                <small class="d-block"><strong>æ‘„åƒå¤´:</strong> ${cameraIndex}</small>
                <small class="d-block"><strong>è§†é¢‘æµ:</strong> ${videoIndex} (${videoType})</small>
                <small class="d-block"><strong>Video ID:</strong> ${videoId}</small>
                <small class="d-block text-info"><strong>ğŸ’¡ æç¤º:</strong> äº‘å°æ§åˆ¶å°†ä½¿ç”¨æ­¤æ‘„åƒå¤´ (${cameraIndex})</small>
            `;
            
            document.getElementById('selectedVideoDetails').innerHTML = detailsHtml;
            document.getElementById('selectedVideoInfo').style.display = 'block';
            
            log(`å·²é€‰æ‹©è§†é¢‘æµ: ${videoId} (æ¥æº: ${deviceSn}, æ§åˆ¶: ${gatewayDeviceSn})`, 'info');
        }

        // æ¸…é™¤è§†é¢‘æµé€‰æ‹©
        function clearVideoSelection() {
            window.selectedVideoStream = null;
            document.getElementById('selectedVideoInfo').style.display = 'none';
            log('å·²æ¸…é™¤è§†é¢‘æµé€‰æ‹©', 'info');
        }

        // å¢å¼ºçš„å¼€å§‹ç›´æ’­å‡½æ•°
        async function startLivestreamWithSelected() {
            if (!window.selectedVideoStream) {
                log('è¯·å…ˆé€‰æ‹©è¦ç›´æ’­çš„è§†é¢‘æµ', 'error');
                return;
            }
            
            const deviceSn = window.selectedVideoStream.deviceSn;
            const videoId = window.selectedVideoStream.videoId;
            const streamType = document.getElementById('streamType').value;
            const quality = parseInt(document.getElementById('streamQuality').value);
            
            try {
                log(`å¼€å§‹${streamType.toUpperCase()}æ¨æµ: ${videoId}`, 'info');
                
                const payload = {
                    video_id: videoId,
                    video_quality: quality,
                    url_type: streamType === 'rtmp' ? 1 : 4
                };
                
                const result = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/livestream/start`, 'POST', payload);
                
                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                document.getElementById('streamStatus').textContent = 'æ¨æµä¸­';
                document.getElementById('streamProtocol').textContent = streamType.toUpperCase();
                
                // æ˜¾ç¤ºåå°è¿”å›çš„æ¨æµåœ°å€
                if (result.push_url) {
                    document.getElementById('vlcUrl').textContent = result.push_url;
                    log(`æ¨æµåœ°å€: ${result.push_url}`, 'success');
                    
                    // è‡ªåŠ¨å¯åŠ¨è§†é¢‘æ’­æ”¾
                    startVideoPlayback(result.push_url, streamType);
                } else {
                    document.getElementById('vlcUrl').textContent = 'åå°æœªè¿”å›æ¨æµåœ°å€';
                }
                
                currentVideoId = videoId;
                log('æ¨æµå¯åŠ¨æˆåŠŸ', 'success');
                log(`æ¨æµID: ${result.bid || 'N/A'}`, 'info');
                
                // æ˜¾ç¤ºåŠ¨æ€æ¸…æ™°åº¦åˆ‡æ¢æ§åˆ¶  
                document.getElementById('dynamicQualityControl').style.display = 'block';
                document.getElementById('dynamicQuality').value = quality.toString();
                
                // æ˜¾ç¤ºé•œå¤´åˆ‡æ¢æ§åˆ¶
                document.getElementById('lensChangeControl').style.display = 'block';
                document.getElementById('currentLensType').textContent = 'é»˜è®¤';
                
                displayResponse('streamApiResponse', result);
            } catch (error) {
                log(`æ¨æµå¯åŠ¨å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('streamStatus').textContent = 'å¯åŠ¨å¤±è´¥';
            }
        }

        // è·å–äº‘å°æ§åˆ¶ä½¿ç”¨çš„ payload_index (ä¼˜å…ˆä½¿ç”¨é€‰æ‹©çš„æ‘„åƒå¤´)
        async function getGimbalPayloadIndex(deviceSn) {
            // ä¼˜å…ˆä½¿ç”¨é€‰æ‹©çš„æ‘„åƒå¤´çš„camera_index
            if (window.selectedVideoStream && window.selectedVideoStream.cameraIndex) {
                log(`ä½¿ç”¨é€‰æ‹©çš„æ‘„åƒå¤´ç´¢å¼•: ${window.selectedVideoStream.cameraIndex}`, 'info');
                return window.selectedVideoStream.cameraIndex;
            }
            
            // å¦‚æœæ²¡æœ‰é€‰æ‹©æ‘„åƒå¤´ï¼Œåˆ™è‡ªåŠ¨è·å–
            try {
                const statusResult = await apiRequest(`/api/v1/control/devices/${deviceSn}/status`, 'GET');
                
                // ä»è®¾å¤‡çŠ¶æ€ä¸­æŸ¥æ‰¾æ‘„åƒå¤´ä¿¡æ¯
                if (statusResult.data && statusResult.data.cameras) {
                    const cameras = statusResult.data.cameras;
                    
                    // è·å–ç¬¬ä¸€ä¸ªå¯ç”¨çš„camera_indexä½œä¸ºäº‘å°æ§åˆ¶ç´¢å¼•
                    for (const cameraIndex in cameras) {
                        const camera = cameras[cameraIndex];
                        if (camera && camera.camera_index) {
                            log(`è‡ªåŠ¨è·å–æ‘„åƒå¤´ç´¢å¼•: ${camera.camera_index}`, 'info');
                            return camera.camera_index;
                        }
                    }
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ‘„åƒå¤´ï¼Œå°è¯•ä»ç›´æ’­èƒ½åŠ›ä¸­è·å–
                try {
                    const capacityResult = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/capacity`, 'GET');
                    if (capacityResult.data && capacityResult.data.cameras && capacityResult.data.cameras.length > 0) {
                        const firstCamera = capacityResult.data.cameras[0];
                        log(`ä»ç›´æ’­èƒ½åŠ›è·å–æ‘„åƒå¤´ç´¢å¼•: ${firstCamera.camera_index}`, 'info');
                        return firstCamera.camera_index;
                    }
                } catch (capacityError) {
                    log(`è·å–ç›´æ’­èƒ½åŠ›å¤±è´¥: ${capacityError.message}`, 'warning');
                }
                
                // å¦‚æœéƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤å€¼
                log('æœªæ‰¾åˆ°æ‘„åƒå¤´ç´¢å¼•ï¼Œä½¿ç”¨é»˜è®¤camera_index', 'warning');
                return "52-0-0";
                
            } catch (error) {
                log(`è·å–camera_indexå¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼: ${error.message}`, 'warning');
                return "52-0-0";
            }
        }

        // äº‘å°æ§åˆ¶
        async function gimbalReset() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/reset`, 'POST', {
                    payload_index: payloadIndex
                });
                log('äº‘å°å·²å¤ä½', 'success');
                displayResponse('gimbalApiResponse', result);
            } catch (error) {
                log(`äº‘å°å¤ä½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function gimbalStop() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/stop`, 'POST', {
                    payload_index: payloadIndex
                });
                log('äº‘å°å·²åœæ­¢', 'success');
                displayResponse('gimbalApiResponse', result);
            } catch (error) {
                log(`äº‘å°åœæ­¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // äº‘å°æ–¹å‘æ§åˆ¶
        async function gimbalDirectionControl(direction) {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/direction-control`, 'POST', {
                    payload_index: payloadIndex,
                    direction: direction
                });
                log(`äº‘å°${direction}æ§åˆ¶æˆåŠŸ`, 'success');
                displayResponse('gimbalApiResponse', result);
            } catch (error) {
                log(`äº‘å°${direction}æ§åˆ¶å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç²¾ç¡®è§’åº¦æ§åˆ¶
        async function gimbalSetAngle() {
            const deviceSn = document.getElementById('deviceSn').value;
            const pitch = document.getElementById('gimbalPitch').value;
            const yaw = document.getElementById('gimbalYaw').value;
            
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            if (!pitch && !yaw) {
                log('è¯·è¾“å…¥ä¿¯ä»°è§’æˆ–åèˆªè§’', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const resetData = {
                    payload_index: payloadIndex
                };
                
                if (pitch !== '') {
                    resetData.pitch = parseInt(pitch);
                }
                if (yaw !== '') {
                    resetData.yaw = parseInt(yaw);
                }
                
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/reset`, 'POST', resetData);
                log(`äº‘å°è§’åº¦è®¾ç½®æˆåŠŸ: pitch=${pitch}Â°, yaw=${yaw}Â°`, 'success');
                displayResponse('gimbalApiResponse', result);
            } catch (error) {
                log(`äº‘å°è§’åº¦è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ‹–æ‹½é€Ÿåº¦æ»‘å—æ›´æ–°
        function updateSpeedValue(type) {
            const slider = document.getElementById(`${type}SpeedSlider`);
            const valueSpan = document.getElementById(`${type}SpeedValue`);
            valueSpan.textContent = slider.value;
        }

        // äº‘å°æ‹–æ‹½æ§åˆ¶å˜é‡
        let gimbalDragInterval = null;

        // å¼€å§‹äº‘å°æ‹–æ‹½æ§åˆ¶
        async function startGimbalDrag() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            if (gimbalDragInterval) {
                log('äº‘å°æ‹–æ‹½æ§åˆ¶å·²åœ¨è¿è¡Œä¸­', 'warning');
                return;
            }
            
            // è·å–payload_index
            const payloadIndex = await getGimbalPayloadIndex(deviceSn);
            log('å¼€å§‹äº‘å°æ‹–æ‹½æ§åˆ¶', 'success');
            
            // æ¯100mså‘é€ä¸€æ¬¡æ§åˆ¶æŒ‡ä»¤
            gimbalDragInterval = setInterval(async () => {
                const pitchSpeed = parseInt(document.getElementById('pitchSpeedSlider').value);
                const yawSpeed = parseInt(document.getElementById('yawSpeedSlider').value);
                
                if (pitchSpeed === 0 && yawSpeed === 0) {
                    return; // é€Ÿåº¦ä¸º0æ—¶ä¸å‘é€æŒ‡ä»¤
                }
                
                try {
                    await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/drag-control`, 'POST', {
                        payload_index: payloadIndex,
                        pitch_speed: pitchSpeed,
                        yaw_speed: yawSpeed
                    });
                } catch (error) {
                    log(`äº‘å°æ‹–æ‹½æ§åˆ¶å¤±è´¥: ${error.message}`, 'error');
                }
            }, 100);
        }

        // åœæ­¢äº‘å°æ‹–æ‹½æ§åˆ¶
        function stopGimbalDrag() {
            if (gimbalDragInterval) {
                clearInterval(gimbalDragInterval);
                gimbalDragInterval = null;
                log('äº‘å°æ‹–æ‹½æ§åˆ¶å·²åœæ­¢', 'info');
                
                // é‡ç½®é€Ÿåº¦æ»‘å—
                document.getElementById('pitchSpeedSlider').value = 0;
                document.getElementById('yawSpeedSlider').value = 0;
                updateSpeedValue('pitch');
                updateSpeedValue('yaw');
            }
        }

        // Look At åæ ‡æ§åˆ¶
        async function gimbalLookAt() {
            const deviceSn = document.getElementById('deviceSn').value;
            const latitude = document.getElementById('lookAtLat').value;
            const longitude = document.getElementById('lookAtLng').value;
            const altitude = document.getElementById('lookAtAlt').value;
            
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            if (!latitude || !longitude || !altitude) {
                log('è¯·è¾“å…¥å®Œæ•´çš„åæ ‡ä¿¡æ¯ï¼ˆçº¬åº¦ã€ç»åº¦ã€é«˜åº¦ï¼‰', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/look-at`, 'POST', {
                    payload_index: payloadIndex,
                    target_latitude: parseFloat(latitude),
                    target_longitude: parseFloat(longitude),
                    target_altitude: parseFloat(altitude)
                });
                log(`äº‘å°Look AtæˆåŠŸ: (${latitude}, ${longitude}, ${altitude})`, 'success');
                displayResponse('gimbalApiResponse', result);
            } catch (error) {
                log(`äº‘å°Look Atå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–äº‘å°çŠ¶æ€
        async function getGimbalStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/status`, 'GET');
                log('äº‘å°çŠ¶æ€è·å–æˆåŠŸ', 'success');
                document.getElementById('gimbalStatusDisplay').textContent = JSON.stringify(result.data, null, 2);
            } catch (error) {
                log(`è·å–äº‘å°çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('gimbalStatusDisplay').textContent = `è·å–å¤±è´¥: ${error.message}`;
            }
        }

        // æ˜¾ç¤ºå½“å‰ä½¿ç”¨çš„camera_index
        async function showCurrentCameraIndex() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const cameraIndex = await getGimbalPayloadIndex(deviceSn);
                log(`å½“å‰äº‘å°æ§åˆ¶ä½¿ç”¨çš„Cameraç´¢å¼•: ${cameraIndex}`, 'info');
                document.getElementById('gimbalStatusDisplay').textContent = `å½“å‰ä½¿ç”¨çš„Cameraç´¢å¼•: ${cameraIndex}`;
            } catch (error) {
                log(`è·å–Cameraç´¢å¼•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–é£è¡Œæ§åˆ¶æƒ
        async function grabFlightAuthority() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/flight`, 'POST');
                log('é£è¡Œæ§åˆ¶æƒè·å–æˆåŠŸ', 'success');
                displayResponse('authorityStatusDisplay', result);
            } catch (error) {
                log(`è·å–é£è¡Œæ§åˆ¶æƒå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è·å–è´Ÿè½½æ§åˆ¶æƒ
        async function grabPayloadAuthority() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/payload`, 'POST', {
                    payload_index: payloadIndex
                });
                log(`è´Ÿè½½æ§åˆ¶æƒè·å–æˆåŠŸ: ${payloadIndex}`, 'success');
                displayResponse('authorityStatusDisplay', result);
            } catch (error) {
                log(`è·å–è´Ÿè½½æ§åˆ¶æƒå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é‡Šæ”¾é£è¡Œæ§åˆ¶æƒ
        async function releaseFlightAuthority() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/flight`, 'DELETE');
                log('é£è¡Œæ§åˆ¶æƒé‡Šæ”¾æˆåŠŸ', 'success');
                displayResponse('authorityStatusDisplay', result);
            } catch (error) {
                log(`é‡Šæ”¾é£è¡Œæ§åˆ¶æƒå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // é‡Šæ”¾è´Ÿè½½æ§åˆ¶æƒ
        async function releasePayloadAuthority() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/payload/${payloadIndex}`, 'DELETE');
                log(`è´Ÿè½½æ§åˆ¶æƒé‡Šæ”¾æˆåŠŸ: ${payloadIndex}`, 'success');
                displayResponse('authorityStatusDisplay', result);
            } catch (error) {
                log(`é‡Šæ”¾è´Ÿè½½æ§åˆ¶æƒå¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æŸ¥çœ‹æƒé™çŠ¶æ€
        async function checkAuthorityStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority`, 'GET');
                log('æƒé™çŠ¶æ€è·å–æˆåŠŸ', 'success');
                
                // æ ¼å¼åŒ–æ˜¾ç¤ºæƒé™ä¿¡æ¯
                let authorityInfo = '=== è®¾å¤‡æƒé™çŠ¶æ€ ===\n';
                
                // é£è¡Œæ§åˆ¶æƒ
                if (result.data.flight_authority) {
                    const flight = result.data.flight_authority;
                    authorityInfo += `é£è¡Œæ§åˆ¶æƒ: ${flight.username} (${flight.user_id})\n`;
                    authorityInfo += `è·å–æ—¶é—´: ${new Date(flight.obtained_at * 1000).toLocaleString()}\n`;
                } else {
                    authorityInfo += 'é£è¡Œæ§åˆ¶æƒ: æ— äººå ç”¨\n';
                }
                
                // è´Ÿè½½æ§åˆ¶æƒ
                authorityInfo += '\nè´Ÿè½½æ§åˆ¶æƒ:\n';
                if (result.data.payload_authorities && Object.keys(result.data.payload_authorities).length > 0) {
                    for (const [payloadIndex, payload] of Object.entries(result.data.payload_authorities)) {
                        authorityInfo += `  ${payloadIndex}: ${payload.username} (${payload.user_id})\n`;
                        authorityInfo += `  è·å–æ—¶é—´: ${new Date(payload.obtained_at * 1000).toLocaleString()}\n`;
                    }
                } else {
                    authorityInfo += '  æ— è´Ÿè½½è¢«å ç”¨\n';
                }
                
                document.getElementById('authorityStatusDisplay').textContent = authorityInfo;
            } catch (error) {
                log(`è·å–æƒé™çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('authorityStatusDisplay').textContent = `è·å–æƒé™çŠ¶æ€å¤±è´¥: ${error.message}`;
            }
        }

        // è§†é¢‘æ’­æ”¾å™¨æ§åˆ¶
        let currentStreamUrl = '';
        
        // å¯åŠ¨è§†é¢‘æ’­æ”¾
        async function startVideoPlayback(streamUrl, streamType) {
            const video = document.getElementById('livestreamVideo');
            const overlay = document.getElementById('videoOverlay');
            const videoInfo = document.getElementById('videoInfo');
            
            currentStreamUrl = streamUrl;
            
            // æ˜¾ç¤ºæ­£åœ¨è¿æ¥çŠ¶æ€
            overlay.style.display = 'block';
            overlay.innerHTML = `
                <div class="bg-dark bg-opacity-75 p-3 rounded">
                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                    æ­£åœ¨è¿æ¥è§†é¢‘æµ...
                    <div class="mt-2"><small>æµåœ°å€: ${streamUrl}</small></div>
                    <div><small>ç±»å‹: ${streamType.toUpperCase()}</small></div>
                </div>
            `;
            
            // æ ¹æ®æµç±»å‹æ’­æ”¾è§†é¢‘æµï¼Œæ”¯æŒé‡è¯•
            let retryCount = 0;
            const maxRetries = 3;
            
            while (retryCount <= maxRetries) {
                try {
                    if (retryCount > 0) {
                        // æ˜¾ç¤ºé‡è¯•çŠ¶æ€
                        overlay.innerHTML = `
                            <div class="bg-dark bg-opacity-75 p-3 rounded">
                                <div class="spinner-border spinner-border-sm text-warning me-2"></div>
                                æ­£åœ¨é‡è¯•è¿æ¥è§†é¢‘æµ... (${retryCount}/${maxRetries})
                                <div class="mt-2"><small>æµåœ°å€: ${streamUrl}</small></div>
                                <div><small>ç±»å‹: ${streamType.toUpperCase()}</small></div>
                            </div>
                        `;
                        
                        // ç­‰å¾…2ç§’åé‡è¯•
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        log(`ç¬¬${retryCount}æ¬¡é‡è¯•WebRTCè¿æ¥...`, 'info');
                    }
                    
                    await playWebRTCStream(video, streamUrl);
                    
                    // æˆåŠŸè¿æ¥
                    overlay.style.display = 'none';
                    videoInfo.innerHTML = `
                        <div class="text-success mb-1">âœ“ è§†é¢‘æµæ’­æ”¾ä¸­</div>
                        <div><small>æµåœ°å€: ${streamUrl}</small></div>
                        <div><small>ç±»å‹: ${streamType.toUpperCase()}</small></div>
                        ${retryCount > 0 ? `<div><small>é‡è¯•${retryCount}æ¬¡åæˆåŠŸ</small></div>` : ''}
                    `;
                    log(`WebRTCæµè¿æ¥æˆåŠŸ: ${streamUrl}${retryCount > 0 ? ` (é‡è¯•${retryCount}æ¬¡)` : ''}`, 'success');
                    return; // æˆåŠŸåé€€å‡ºå¾ªç¯
                    
                } catch (error) {
                    retryCount++;
                    log(`WebRTCæ’­æ”¾å¤±è´¥ (å°è¯•${retryCount}/${maxRetries + 1}): ${error.message}`, 'warning');
                    
                    if (retryCount > maxRetries) {
                        // æœ€ç»ˆå¤±è´¥
                        log(`WebRTCæ’­æ”¾æœ€ç»ˆå¤±è´¥: ${error.message}`, 'error');
                        showPlaybackError(overlay, videoInfo, `WebRTCæ’­æ”¾å¤±è´¥: ${error.message}ã€‚å·²é‡è¯•${maxRetries}æ¬¡`);
                        return;
                    }
                }
            }
        }
        
        // æ£€æŸ¥æµæ˜¯å¦å­˜åœ¨
        async function checkStreamExists(streamUrl) {
            try {
                const apiUrl = await findSrsApiUrl(streamUrl);
                const streamName = extractStreamName(streamUrl);
                
                // æ£€æŸ¥SRS streams API
                const streamsResponse = await fetch(`${apiUrl}/api/v1/streams/`);
                if (streamsResponse.ok) {
                    const streamsData = await streamsResponse.json();
                    console.log('å½“å‰æ´»è·ƒæµåˆ—è¡¨:', streamsData);
                    
                    if (streamsData.streams && Array.isArray(streamsData.streams)) {
                        const activeStream = streamsData.streams.find(stream => 
                            stream.name === streamName || stream.url === streamUrl
                        );
                        
                        if (activeStream) {
                            console.log('æ‰¾åˆ°æ´»è·ƒæµ:', activeStream);
                            return true;
                        } else {
                            console.warn(`æµ ${streamName} ä¸åœ¨æ´»è·ƒæµåˆ—è¡¨ä¸­`);
                            return false;
                        }
                    }
                }
                
                return false;
            } catch (error) {
                console.warn('æ£€æŸ¥æµçŠ¶æ€å¤±è´¥:', error);
                return false; // æ£€æŸ¥å¤±è´¥æ—¶å‡è®¾æµä¸å­˜åœ¨
            }
        }

        // WebRTCæµæ’­æ”¾
        let pc = null;
        
        async function playWebRTCStream(video, streamUrl) {
            // å¦‚æœæ˜¯RTMPæµï¼Œè½¬æ¢ä¸ºWebRTCæ’­æ”¾åœ°å€
            let webrtcUrl;
            if (streamUrl.startsWith('rtmp://')) {
                webrtcUrl = convertRtmpToWebrtc(streamUrl);
            } else {
                webrtcUrl = streamUrl;
            }
            
            // å…ˆæ£€æŸ¥æµæ˜¯å¦å­˜åœ¨
            console.log('æ£€æŸ¥æµæ˜¯å¦å­˜åœ¨...');
            const streamExists = await checkStreamExists(streamUrl);
            if (!streamExists) {
                throw new Error('æµä¸å­˜åœ¨æˆ–å°šæœªå¼€å§‹æ¨é€ã€‚è¯·ç¡®ä¿è®¾å¤‡æ­£åœ¨æ¨æµï¼Œç„¶åé‡è¯•');
            }
            
            // å…³é—­ä¹‹å‰çš„è¿æ¥
            if (pc) {
                pc.close();
                pc = null;
            }
            
            // åˆ›å»ºRTCPeerConnection
            pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });
            
            // å¤„ç†è¿œç¨‹æµ
            return new Promise(async (resolve, reject) => {
                let hasResolved = false;
                
                pc.ontrack = (e) => {
                    console.log('æ”¶åˆ°è¿œç¨‹æµ:', e.streams[0]);
                    video.srcObject = e.streams[0];
                    video.play().catch(err => console.error('æ’­æ”¾å¤±è´¥:', err));
                };
                
                // ICEè¿æ¥çŠ¶æ€ç›‘å¬
                pc.oniceconnectionstatechange = () => {
                    console.log('ICEè¿æ¥çŠ¶æ€:', pc.iceConnectionState);
                    if (pc.iceConnectionState === 'connected' && !hasResolved) {
                        hasResolved = true;
                        resolve();
                    } else if (pc.iceConnectionState === 'failed' && !hasResolved) {
                        hasResolved = true;
                        reject(new Error('WebRTCè¿æ¥å¤±è´¥'));
                    }
                };
                
                try {
                    // åˆ›å»ºoffer
                    const offer = await pc.createOffer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: true
                    });
                    
                    await pc.setLocalDescription(offer);
                    
                    // æ‰¾åˆ°å¯ç”¨çš„SRS APIåœ°å€
                    const apiUrl = await findSrsApiUrl(webrtcUrl);
                    console.log('SRS APIåœ°å€:', apiUrl);
                    console.log('WebRTCæ’­æ”¾åœ°å€:', webrtcUrl);
                    
                    console.log('å‘é€åˆ°SRSçš„è¯·æ±‚ä½“:', {
                        sdp: offer.sdp,
                        streamurl: webrtcUrl
                    });
                    
                    const response = await fetch(`${apiUrl}/rtc/v1/play/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sdp: offer.sdp,
                            streamurl: webrtcUrl
                        })
                    });
                    
                    console.log('SRSå“åº”çŠ¶æ€:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('SRSæœåŠ¡å™¨é”™è¯¯å“åº”:', errorText);
                        throw new Error(`SRSæœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status} - ${response.statusText}. å“åº”å†…å®¹: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    console.log('SRSå®Œæ•´å“åº”æ•°æ®:', JSON.stringify(data, null, 2));
                    
                    if (data.code !== 0) {
                        throw new Error(`SRSé”™è¯¯(code:${data.code}): ${data.msg || data.message || 'æœªçŸ¥é”™è¯¯'}`);
                    }
                    
                    // éªŒè¯SDPæ•°æ®
                    if (!data.sdp) {
                        console.error('SRSå“åº”ç»“æ„:', Object.keys(data));
                        console.error('å®Œæ•´å“åº”å†…å®¹:', data);
                        throw new Error(`SRSè¿”å›çš„æ•°æ®ä¸­æ²¡æœ‰SDPä¿¡æ¯ã€‚å“åº”åŒ…å«çš„å­—æ®µ: ${Object.keys(data).join(', ')}`);
                    }
                    
                    // æ£€æŸ¥SDPæ ¼å¼
                    if (!data.sdp.startsWith('v=')) {
                        console.error('æ— æ•ˆçš„SDPæ ¼å¼:', data.sdp);
                        throw new Error('SRSè¿”å›çš„SDPæ ¼å¼æ— æ•ˆï¼Œç¼ºå°‘v=è¡Œ');
                    }
                    
                    console.log('æ¥æ”¶åˆ°çš„SDP:', data.sdp);
                    
                    // è®¾ç½®è¿œç¨‹æè¿°
                    try {
                        await pc.setRemoteDescription({
                            type: 'answer',
                            sdp: data.sdp
                        });
                        console.log('è¿œç¨‹SDPè®¾ç½®æˆåŠŸ');
                    } catch (sdpError) {
                        console.error('SDPè®¾ç½®å¤±è´¥:', sdpError);
                        console.error('é—®é¢˜SDPå†…å®¹:', data.sdp);
                        throw new Error(`SDPè®¾ç½®å¤±è´¥: ${sdpError.message}`);
                    }
                    
                    console.log('WebRTCè¿æ¥å»ºç«‹æˆåŠŸ');
                    
                    // è®¾ç½®è¶…æ—¶
                    setTimeout(() => {
                        if (!hasResolved) {
                            hasResolved = true;
                            reject(new Error('è¿æ¥è¶…æ—¶'));
                        }
                    }, 10000);
                    
                } catch (error) {
                    if (!hasResolved) {
                        hasResolved = true;
                        reject(error);
                    }
                }
            });
        }
        
        // æ ¹æ®APIåœ°å€è°ƒæ•´ç›®æ ‡æœåŠ¡å™¨åœ°å€ï¼ˆé€šç”¨å‡½æ•°ï¼‰
        function adjustServerAddress(originalUrl, targetProtocol = null, targetPort = null) {
            try {
                // è·å–å½“å‰APIåœ°å€ä½œä¸ºç›®æ ‡æœåŠ¡å™¨
                const apiUrl = document.getElementById('apiUrl').value || 'http://192.168.111.49:8000';
                const apiUrlObj = new URL(apiUrl);
                const targetServer = apiUrlObj.hostname;
                
                // è§£æåŸå§‹URL
                const originalUrlObj = new URL(originalUrl);
                
                // æ„å»ºæ–°URL
                const protocol = targetProtocol || originalUrlObj.protocol.slice(0, -1); // ç§»é™¤å†’å·
                const port = targetPort || originalUrlObj.port || '';
                const portStr = port ? `:${port}` : '';
                const pathname = originalUrlObj.pathname;
                const search = originalUrlObj.search;
                
                const newUrl = `${protocol}://${targetServer}${portStr}${pathname}${search}`;
                
                if (originalUrlObj.hostname !== targetServer) {
                    console.log(`æœåŠ¡å™¨åœ°å€è°ƒæ•´: ${originalUrl} -> ${newUrl}`);
                }
                
                return newUrl;
            } catch (error) {
                console.error('æœåŠ¡å™¨åœ°å€è°ƒæ•´å¤±è´¥:', error);
                return originalUrl;
            }
        }

        // è½¬æ¢RTMPåœ°å€ä¸ºWebRTCåœ°å€ - æ ¹æ®APIåœ°å€åŠ¨æ€è°ƒæ•´
        function convertRtmpToWebrtc(rtmpUrl) {
            try {
                // è§£æRTMP URL: rtmp://server:port/app/stream
                const url = new URL(rtmpUrl);
                const pathParts = url.pathname.split('/').filter(part => part.length > 0);
                
                if (pathParts.length < 2) {
                    // ä½¿ç”¨é€šç”¨å‡½æ•°è°ƒæ•´æœåŠ¡å™¨åœ°å€ï¼ŒWebRTCç«¯å£æ˜¯8000
                    return adjustServerAddress('webrtc://placeholder:8000/live/stream', 'webrtc', '8000');
                }
                
                // æ„å»ºåŸºç¡€WebRTC URLç„¶åè°ƒæ•´æœåŠ¡å™¨åœ°å€
                const app = pathParts[0];
                const stream = pathParts.slice(1).join('/');
                const baseWebrtcUrl = `webrtc://${url.hostname}:8000/${app}/${stream}`;
                
                // ä½¿ç”¨é€šç”¨å‡½æ•°è°ƒæ•´æœåŠ¡å™¨åœ°å€ï¼ŒWebRTCç«¯å£æ˜¯8000
                const webrtcUrl = adjustServerAddress(baseWebrtcUrl, 'webrtc', '8000');
                console.log(`RTMPè½¬WebRTC: ${rtmpUrl} -> ${webrtcUrl}`);
                
                return webrtcUrl;
            } catch (error) {
                console.error('RTMPåœ°å€è½¬æ¢å¤±è´¥:', error);
                // ç®€å•æ›¿æ¢ä½œä¸ºåå¤‡æ–¹æ¡ˆï¼ŒWebRTCç«¯å£æ˜¯8000
                return rtmpUrl.replace('rtmp://', 'webrtc://').replace(':1935', ':8000');
            }
        }
        
        // æ„å»ºSRS APIåœ°å€ - æ ¹æ®APIåœ°å€åŠ¨æ€è°ƒæ•´ï¼Œæ”¯æŒå¤šç«¯å£å°è¯•
        function buildSrsApiUrl(webrtcUrl) {
            // è·å–ç›®æ ‡æœåŠ¡å™¨åœ°å€
            const apiUrl = document.getElementById('apiUrl').value || 'http://192.168.111.49:8000';
            const apiUrlObj = new URL(apiUrl);
            const targetServer = apiUrlObj.hostname;
            
            // è¿”å›ä¸»è¦çš„APIåœ°å€ï¼ˆé€šå¸¸æ˜¯1985ç«¯å£ï¼‰
            return `http://${targetServer}:1985`;
        }
        
        // å°è¯•å¤šä¸ªSRS APIç«¯å£
        async function findSrsApiUrl(webrtcUrl) {
            const apiUrl = document.getElementById('apiUrl').value || 'http://192.168.111.49:8000';
            const apiUrlObj = new URL(apiUrl);
            const targetServer = apiUrlObj.hostname;
            
            // å¸¸è§çš„SRS APIç«¯å£
            const possiblePorts = [1985, 8080, 8000, 1990];
            
            for (const port of possiblePorts) {
                const testUrl = `http://${targetServer}:${port}`;
                try {
                    console.log(`å°è¯•SRS APIç«¯å£: ${port}`);
                    // æµ‹è¯•ç«¯å£æ˜¯å¦å¯ç”¨
                    const response = await fetch(`${testUrl}/api/v1/summaries`, { 
                        method: 'GET',
                        timeout: 2000
                    });
                    
                    if (response.ok) {
                        console.log(`æ‰¾åˆ°å¯ç”¨çš„SRS APIç«¯å£: ${port}`);
                        return testUrl;
                    }
                } catch (error) {
                    console.log(`ç«¯å£ ${port} ä¸å¯ç”¨:`, error.message);
                }
            }
            
            // å¦‚æœéƒ½ä¸å¯ç”¨ï¼Œè¿”å›é»˜è®¤çš„1985ç«¯å£
            console.warn('æœªæ‰¾åˆ°å¯ç”¨çš„SRS APIç«¯å£ï¼Œä½¿ç”¨é»˜è®¤1985');
            return `http://${targetServer}:1985`;
        }
        
        // æ˜¾ç¤ºæ’­æ”¾é”™è¯¯
        function showPlaybackError(overlay, videoInfo, errorMessage) {
            overlay.style.display = 'block';
            overlay.innerHTML = `
                <div class="bg-dark bg-opacity-75 p-3 rounded">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2 text-warning"></i>
                    <div>${errorMessage}</div>
                    <small class="text-muted mt-2 d-block">è¯·æ£€æŸ¥SRSæœåŠ¡å™¨é…ç½®æˆ–ä½¿ç”¨VLCæ’­æ”¾å™¨</small>
                </div>
            `;
            videoInfo.textContent = 'æ’­æ”¾å¤±è´¥';
            log(errorMessage, 'error');
        }
        
        // åœæ­¢è§†é¢‘æ’­æ”¾
        function stopVideoPlayback() {
            const video = document.getElementById('livestreamVideo');
            const overlay = document.getElementById('videoOverlay');
            const videoInfo = document.getElementById('videoInfo');
            
            video.pause();
            video.src = '';
            video.load();
            
            overlay.style.display = 'block';
            overlay.innerHTML = `
                <div class="bg-dark bg-opacity-75 p-3 rounded">
                    <i class="fas fa-stop-circle fa-2x mb-2"></i>
                    <div>ç›´æ’­å·²åœæ­¢</div>
                </div>
            `;
            videoInfo.textContent = 'ç›´æ’­å·²åœæ­¢';
            currentStreamUrl = '';
            
            log('è§†é¢‘æ’­æ”¾å·²åœæ­¢', 'info');
        }
        
        // ä»RTMP URLä¸­æå–æµåç§°
        function extractStreamName(rtmpUrl) {
            // ä»ç±»ä¼¼ "rtmp://localhost:1935/live/stream123" ä¸­æå– "stream123"
            const parts = rtmpUrl.split('/');
            return parts[parts.length - 1] || 'default';
        }
        
        // åˆ·æ–°è§†é¢‘
        function refreshVideo() {
            if (currentStreamUrl) {
                const streamType = document.getElementById('streamType').value;
                startVideoPlayback(currentStreamUrl, streamType);
                log('è§†é¢‘æµå·²åˆ·æ–°', 'info');
            } else {
                log('æ²¡æœ‰å¯åˆ·æ–°çš„è§†é¢‘æµ', 'warning');
            }
        }
        
        // å…¨å±æ’­æ”¾
        function toggleFullscreen() {
            const video = document.getElementById('livestreamVideo');
            
            if (video.requestFullscreen) {
                video.requestFullscreen();
            } else if (video.webkitRequestFullscreen) {
                video.webkitRequestFullscreen();
            } else if (video.msRequestFullscreen) {
                video.msRequestFullscreen();
            } else {
                log('æµè§ˆå™¨ä¸æ”¯æŒå…¨å±åŠŸèƒ½', 'warning');
            }
        }

        // æ›´æ–°èµ·é£æŒ‰é’®æ–‡å­—å’Œæè¿°
        function updateTakeoffButtonText() {
            const enableSim = document.getElementById('enableSimulation').checked;
            const takeoffButton = document.getElementById('takeoffButton');
            const flyToButton = document.getElementById('flyToButton');
            const description = document.getElementById('simulationDescription');
            
            if (enableSim) {
                takeoffButton.textContent = 'æ¨¡æ‹Ÿä¸€é”®èµ·é£';
                flyToButton.textContent = 'æ¨¡æ‹Ÿé£å‘ç›®æ ‡ç‚¹';
                description.textContent = 'æ¨¡æ‹Ÿæ¨¡å¼ä¸‹é£è¡Œå™¨ä¸ä¼šå®é™…èµ·é£ï¼Œä½†ä¼šæ­£å¸¸æ‰§è¡Œå‡†å¤‡å·¥ä½œ';
            } else {
                takeoffButton.textContent = 'ä¸€é”®èµ·é£';
                flyToButton.textContent = 'é£å‘ç›®æ ‡ç‚¹';
                description.textContent = 'çœŸå®é£è¡Œæ¨¡å¼ï¼šé£è¡Œå™¨å°†å®é™…æ‰§è¡Œèµ·é£å’Œé£è¡Œä»»åŠ¡';
            }
        }

        // é£è¡Œæ§åˆ¶
        async function takeoff() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/takeoff-to-point`, 'POST', {
                    height: 50  // é»˜è®¤é«˜åº¦50ç±³
                });
                log('èµ·é£æŒ‡ä»¤å·²å‘é€', 'success');
                displayResponse('flightApiResponse', result);
            } catch (error) {
                log(`èµ·é£å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function returnHome() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                // å…ˆå°è¯•è·å–é£è¡Œæ§åˆ¶æƒ
                try {
                    log('å°è¯•è·å–é£è¡Œæ§åˆ¶æƒ...', 'info');
                    await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/flight`, 'POST');
                    log('é£è¡Œæ§åˆ¶æƒè·å–æˆåŠŸ', 'success');
                } catch (authError) {
                    log(`è·å–é£è¡Œæ§åˆ¶æƒå¤±è´¥: ${authError.message}ï¼Œç»§ç»­å°è¯•è¿”èˆª...`, 'warning');
                }
                
                // æ‰§è¡Œè¿”èˆª
                log('å‘é€è¿”èˆªæŒ‡ä»¤...', 'info');
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/return-home`, 'POST');
                log('è¿”èˆªæŒ‡ä»¤å·²å‘é€', 'success');
                displayResponse('flightApiResponse', result);
            } catch (error) {
                log(`è¿”èˆªå¤±è´¥: ${error.message}`, 'error');
                
                // å¦‚æœæ˜¯æƒé™é—®é¢˜ï¼Œæä¾›è§£å†³å»ºè®®
                if (error.message.includes('æƒé™') || error.message.includes('authority')) {
                    log('å»ºè®®ï¼šè¯·å…ˆç‚¹å‡»"è·å–é£è¡Œæ§åˆ¶æƒ"æŒ‰é’®ï¼Œç„¶åå†å°è¯•è¿”èˆª', 'warning');
                }
            }
        }

        async function emergencyStop() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/emergency-stop`, 'POST');
                log('ç´§æ€¥åœæ­¢æŒ‡ä»¤å·²å‘é€', 'success');
                displayResponse('flightApiResponse', result);
            } catch (error) {
                log(`ç´§æ€¥åœæ­¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // APIæµ‹è¯•å‡½æ•°
        async function testGetDevices() {
            try {
                const result = await apiRequest('/api/v1/devices/');
                log('è·å–è®¾å¤‡åˆ—è¡¨æˆåŠŸ', 'success');
                displayResponse('deviceApiResponse', result);
            } catch (error) {
                log(`è·å–è®¾å¤‡åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testGetDeviceStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/status`);
                log('è·å–è®¾å¤‡çŠ¶æ€æˆåŠŸ', 'success');
                displayResponse('deviceApiResponse', result);
            } catch (error) {
                log(`è·å–è®¾å¤‡çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testDeviceCount() {
            try {
                const result = await apiRequest('/api/v1/devices/count/total');
                log('è·å–è®¾å¤‡æ€»æ•°æˆåŠŸ', 'success');
                displayResponse('deviceApiResponse', result);
            } catch (error) {
                log(`è·å–è®¾å¤‡æ€»æ•°å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // èˆªçº¿ä»»åŠ¡APIæµ‹è¯•
        async function testGetWaylineJobs() {
            const workspaceId = document.getElementById('workspaceId').value;
            if (!workspaceId) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´ID', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs`);
                log('è·å–ä»»åŠ¡åˆ—è¡¨æˆåŠŸ', 'success');
                displayResponse('waylineApiResponse', result);
                
                // æ›´æ–°ä»»åŠ¡é€‰æ‹©ä¸‹æ‹‰æ¡†
                updateJobSelectDropdown(result);
                
            } catch (error) {
                log(`è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testCreateWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const deviceSn = document.getElementById('deviceSn').value;
            
            if (!workspaceId || !deviceSn) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´IDå’Œè®¾å¤‡SN', 'error');
                return;
            }
            
            const enableSim = document.getElementById('enableSimulation').checked;
            const taskData = {
                name: `æµ‹è¯•ä»»åŠ¡_${Date.now()}`,
                dock_sn: deviceSn,
                wayline_id: 1,  // ç¤ºä¾‹èˆªçº¿ID
                task_type: 0,   // 0:ç«‹å³æ‰§è¡Œ
                max_speed: parseInt(document.getElementById('maxSpeed').value)
            };
            
            // å¦‚æœå¯ç”¨æ¨¡æ‹Ÿé£è¡Œ
            if (enableSim) {
                taskData.simulate_mission = {
                    is_enable: 1,
                    latitude: parseFloat(document.getElementById('simLatitude').value),
                    longitude: parseFloat(document.getElementById('simLongitude').value),
                    altitude: parseFloat(document.getElementById('simAltitude').value)
                };
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/flight-tasks`, 'POST', taskData);
                log(`åˆ›å»ºä»»åŠ¡æˆåŠŸ${enableSim ? ' (æ¨¡æ‹Ÿé£è¡Œæ¨¡å¼)' : ''}`, 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`åˆ›å»ºä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testPauseWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const jobId = prompt('è¯·è¾“å…¥ä»»åŠ¡ID:');
            
            if (!workspaceId || !jobId) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´IDå’Œä»»åŠ¡ID', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}/pause`, 'POST');
                log('æš‚åœä»»åŠ¡æˆåŠŸ', 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`æš‚åœä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testStopWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const jobId = prompt('è¯·è¾“å…¥ä»»åŠ¡ID:');
            
            if (!workspaceId || !jobId) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´IDå’Œä»»åŠ¡ID', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}/stop`, 'POST');
                log('åœæ­¢ä»»åŠ¡æˆåŠŸ', 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`åœæ­¢ä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åª’ä½“ç®¡ç†APIæµ‹è¯•
        async function testGetMediaFiles() {
            try {
                const result = await apiRequest('/api/v1/media/files');
                log('è·å–åª’ä½“åˆ—è¡¨æˆåŠŸ', 'success');
                displayResponse('mediaApiResponse', result);
            } catch (error) {
                log(`è·å–åª’ä½“åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testMediaStatistics() {
            try {
                const result = await apiRequest('/api/v1/media/statistics');
                log('è·å–åª’ä½“ç»Ÿè®¡æˆåŠŸ', 'success');
                displayResponse('mediaApiResponse', result);
            } catch (error) {
                log(`è·å–åª’ä½“ç»Ÿè®¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testStorageHealth() {
            try {
                const result = await apiRequest('/api/v1/media/health');
                log('å­˜å‚¨å¥åº·æ£€æŸ¥æˆåŠŸ', 'success');
                displayResponse('mediaApiResponse', result);
            } catch (error) {
                log(`å­˜å‚¨å¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testUploadMedia() {
            const fileInput = document.getElementById('mediaFile');
            const file = fileInput.files[0];
            
            if (!file) {
                log('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('workspace_id', document.getElementById('workspaceId').value || '1');
            formData.append('drone_sn', document.getElementById('deviceSn').value || 'test');
            
            try {
                const apiUrl = document.getElementById('apiUrl').value;
                const token = document.getElementById('apiToken').value;
                
                const response = await fetch(`${apiUrl}/api/v1/media/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ', 'success');
                    displayResponse('mediaApiResponse', result);
                } else {
                    log(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${result.detail || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                log(`æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // DRCæ¨¡å¼APIæµ‹è¯•
        async function testEnterDRC() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/enter`, 'POST');
                log('è¿›å…¥DRCæ¨¡å¼æˆåŠŸ', 'success');
                displayResponse('drcApiResponse', result);
            } catch (error) {
                log(`è¿›å…¥DRCæ¨¡å¼å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testExitDRC() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/exit`, 'POST');
                log('é€€å‡ºDRCæ¨¡å¼æˆåŠŸ', 'success');
                displayResponse('drcApiResponse', result);
            } catch (error) {
                log(`é€€å‡ºDRCæ¨¡å¼å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testGetDRCStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/status`);
                log('è·å–DRCçŠ¶æ€æˆåŠŸ', 'success');
                displayResponse('drcApiResponse', result);
            } catch (error) {
                log(`è·å–DRCçŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æƒé™æ§åˆ¶APIæµ‹è¯•
        async function testGetFlightAuthority() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/flight`, 'POST');
                log('è·å–é£è¡Œæƒé™æˆåŠŸ', 'success');
                displayResponse('authorityApiResponse', result);
            } catch (error) {
                log(`è·å–é£è¡Œæƒé™å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testReleaseFlightAuthority() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/flight`, 'DELETE');
                log('é‡Šæ”¾é£è¡Œæƒé™æˆåŠŸ', 'success');
                displayResponse('authorityApiResponse', result);
            } catch (error) {
                log(`é‡Šæ”¾é£è¡Œæƒé™å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testGetAuthorityStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority`);
                log('è·å–æƒé™çŠ¶æ€æˆåŠŸ', 'success');
                displayResponse('authorityApiResponse', result);
            } catch (error) {
                log(`è·å–æƒé™çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å·¥ä½œç©ºé—´APIæµ‹è¯•
        async function testGetWorkspaces() {
            try {
                const result = await apiRequest('/api/v1/workspace/');
                log('è·å–å·¥ä½œç©ºé—´æˆåŠŸ', 'success');
                displayResponse('workspaceApiResponse', result);
            } catch (error) {
                log(`è·å–å·¥ä½œç©ºé—´å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testCreateWorkspace() {
            const name = prompt('è¯·è¾“å…¥å·¥ä½œç©ºé—´åç§°:');
            if (!name) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´åç§°', 'error');
                return;
            }
            
            try {
                const result = await apiRequest('/api/v1/workspace/', 'POST', {
                    name: name,
                    description: `æµ‹è¯•å·¥ä½œç©ºé—´ - ${new Date().toLocaleString()}`
                });
                log('åˆ›å»ºå·¥ä½œç©ºé—´æˆåŠŸ', 'success');
                displayResponse('workspaceApiResponse', result);
            } catch (error) {
                log(`åˆ›å»ºå·¥ä½œç©ºé—´å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testBindDevice() {
            const workspaceId = document.getElementById('workspaceId').value;
            const deviceSn = document.getElementById('deviceSn').value;
            
            if (!workspaceId || !deviceSn) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´IDå’Œè®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest('/api/v1/devices/bind', 'POST', {
                    workspace_id: parseInt(workspaceId),
                    device_sn: deviceSn
                });
                log('ç»‘å®šè®¾å¤‡æˆåŠŸ', 'success');
                displayResponse('workspaceApiResponse', result);
            } catch (error) {
                log(`ç»‘å®šè®¾å¤‡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // HMSç›¸å…³
        async function refreshHMS() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                // æ ¹æ®å½“å‰è§†å›¾æ¨¡å¼å†³å®šè·å–å“ªäº›æ¶ˆæ¯
                const queryParam = showAllHMS ? '' : '?is_read=false';
                const result = await apiRequest(`/api/v1/hms/devices/${deviceSn}/hms${queryParam}`);
                
                const container = document.getElementById('hmsContainer');
                const count = document.getElementById('hmsCount');
                
                if (result && result.length > 0) {
                    container.innerHTML = '';
                    
                    // æŒ‰å‘Šè­¦ç­‰çº§æ’åºï¼ˆè­¦å‘Š>æé†’>é€šçŸ¥ï¼‰
                    const sortedHms = result.sort((a, b) => (b.level || 0) - (a.level || 0));
                    
                    sortedHms.forEach(hms => {
                        const item = document.createElement('div');
                        item.className = 'hms-item';
                        
                        // æ ¹æ®DJIå®˜æ–¹æ–‡æ¡£å¤„ç†å‘Šè­¦ç­‰çº§
                        const levelInfo = getHmsLevelInfo(hms.level);
                        
                        // æ ¹æ®DJIå®˜æ–¹æ–‡æ¡£å¤„ç†äº‹ä»¶æ¨¡å—
                        const moduleInfo = getHmsModuleInfo(hms.module);
                        
                        // å¤„ç†é£è¡ŒçŠ¶æ€
                        const skyStatus = hms.in_the_sky === 1 ? 'é£è¡Œä¸­' : 'åœ°é¢';
                        const skyColor = hms.in_the_sky === 1 ? '#ff6b6b' : '#51cf66';
                        
                        // å¤„ç†åŠæ—¶æ€§
                        const imminentStatus = hms.imminent === 1 ? 'å®æ—¶' : 'å†å²';
                        const imminentBadge = hms.imminent === 1 ? 'bg-warning' : 'bg-secondary';
                        
                        // å¤„ç†æ¶ˆæ¯å†…å®¹
                        const message = hms.message_zh || hms.message_en || `å‘Šè­¦ç : ${hms.code || 'æœªçŸ¥'}`;
                        
                        // å¤„ç†å·²è¯»çŠ¶æ€
                        const isRead = hms.is_read || false;
                        const readBadge = isRead ? '<span class="badge bg-success ms-2">å·²è¯»</span>' : '';
                        const itemOpacity = isRead ? 'opacity: 0.7;' : '';
                        
                        // å¤„ç†æ—¶é—´æ ¼å¼
                        let timeStr = 'æœªçŸ¥æ—¶é—´';
                        if (hms.create_time) {
                            const timestamp = typeof hms.create_time === 'number' ? hms.create_time : parseInt(hms.create_time);
                            if (timestamp && !isNaN(timestamp)) {
                                const adjustedTimestamp = timestamp < 10000000000 ? timestamp * 1000 : timestamp;
                                timeStr = new Date(adjustedTimestamp).toLocaleString();
                            } else if (typeof hms.create_time === 'string') {
                                timeStr = new Date(hms.create_time).toLocaleString();
                            }
                        }
                        
                        item.innerHTML = `
                            <div style="border-left: 4px solid ${levelInfo.color}; padding: 10px; background: ${levelInfo.bgColor}; ${itemOpacity}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <span class="badge ${levelInfo.badgeClass} me-2">${levelInfo.text}</span>
                                        <span class="badge ${moduleInfo.badgeClass}">${moduleInfo.text}</span>
                                        ${readBadge}
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <strong>${message}</strong>
                                </div>
                                
                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <small><strong>å‘Šè­¦ç :</strong> <code>${hms.code || 'æœªçŸ¥'}</code></small>
                                    </div>
                                    <div class="col-6">
                                        <small><strong>è®¾å¤‡ç±»å‹:</strong> ${hms.device_type_display || hms.device_type || 'æœªçŸ¥'}</small>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge ${imminentBadge} me-1">${imminentStatus}</span>
                                        <span class="badge" style="background-color: ${skyColor}; color: white;">${skyStatus}</span>
                                    </div>
                                    <small class="text-muted">${timeStr}</small>
                                </div>
                            </div>
                        `;
                        container.appendChild(item);
                    });
                    
                    // ç»Ÿè®¡ä¸åŒç­‰çº§å’Œè¯»å–çŠ¶æ€çš„æ•°é‡
                    const levelCounts = { 0: 0, 1: 0, 2: 0 };
                    const readCounts = { read: 0, unread: 0 };
                    
                    result.forEach(hms => {
                        levelCounts[hms.level] = (levelCounts[hms.level] || 0) + 1;
                        if (hms.is_read) {
                            readCounts.read++;
                        } else {
                            readCounts.unread++;
                        }
                    });
                    
                    let countDisplay = `<span class="me-1">${result.length}</span>`;
                    
                    // å¦‚æœæ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯ï¼ŒåŒºåˆ†å·²è¯»/æœªè¯»æ•°é‡
                    if (showAllHMS && readCounts.read > 0) {
                        countDisplay += `<small class="text-success ms-1">å·²è¯»:${readCounts.read}</small>`;
                    }
                    if (readCounts.unread > 0) {
                        countDisplay += `<small class="text-primary ms-1">æœªè¯»:${readCounts.unread}</small>`;
                    }
                    
                    // æ˜¾ç¤ºç­‰çº§ç»Ÿè®¡
                    if (levelCounts[2] > 0) countDisplay += `<small class="text-danger ms-1">è­¦å‘Š:${levelCounts[2]}</small>`;
                    if (levelCounts[1] > 0) countDisplay += `<small class="text-warning ms-1">æé†’:${levelCounts[1]}</small>`;
                    if (levelCounts[0] > 0) countDisplay += `<small class="text-info ms-1">é€šçŸ¥:${levelCounts[0]}</small>`;
                    
                    count.innerHTML = countDisplay;
                } else {
                    if (showAllHMS) {
                        container.innerHTML = '<div class="text-muted text-center p-3">æš‚æ— å¥åº·å‘Šè­¦ä¿¡æ¯</div>';
                        count.innerHTML = '<span class="badge bg-secondary">0</span>';
                    } else {
                        container.innerHTML = '<div class="text-muted text-center p-3">æš‚æ— æœªè¯»å¥åº·å‘Šè­¦ä¿¡æ¯</div>';
                        count.innerHTML = '<span class="badge bg-success">0</span><small class="text-success ms-1">å…¨éƒ¨å·²è¯»</small>';
                    }
                }
                
                log('HMSä¿¡æ¯å·²æ›´æ–°', 'success');
            } catch (error) {
                log(`è·å–HMSä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ ¹æ®DJIå®˜æ–¹æ–‡æ¡£è·å–å‘Šè­¦ç­‰çº§ä¿¡æ¯
        function getHmsLevelInfo(level) {
            switch(level) {
                case 0:
                    return {
                        text: 'é€šçŸ¥',
                        color: '#17a2b8',
                        bgColor: '#e8f6f8',
                        badgeClass: 'bg-info'
                    };
                case 1:
                    return {
                        text: 'æé†’',
                        color: '#ffc107',
                        bgColor: '#fffbf0',
                        badgeClass: 'bg-warning'
                    };
                case 2:
                    return {
                        text: 'è­¦å‘Š',
                        color: '#dc3545',
                        bgColor: '#fdf2f2',
                        badgeClass: 'bg-danger'
                    };
                default:
                    return {
                        text: 'æœªçŸ¥',
                        color: '#6c757d',
                        bgColor: '#f8f9fa',
                        badgeClass: 'bg-secondary'
                    };
            }
        }
        
        // æ ¹æ®DJIå®˜æ–¹æ–‡æ¡£è·å–äº‹ä»¶æ¨¡å—ä¿¡æ¯
        function getHmsModuleInfo(module) {
            switch(module) {
                case 0:
                    return {
                        text: 'é£è¡Œä»»åŠ¡',
                        badgeClass: 'bg-primary'
                    };
                case 1:
                    return {
                        text: 'è®¾å¤‡ç®¡ç†',
                        badgeClass: 'bg-success'
                    };
                case 2:
                    return {
                        text: 'åª’ä½“',
                        badgeClass: 'bg-info'
                    };
                case 3:
                    return {
                        text: 'HMS',
                        badgeClass: 'bg-dark'
                    };
                default:
                    return {
                        text: 'æœªçŸ¥æ¨¡å—',
                        badgeClass: 'bg-secondary'
                    };
            }
        }

        async function markHMSRead() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                await apiRequest(`/api/v1/hms/devices/${deviceSn}/hms/mark-read`, 'POST');
                log('HMSæ¶ˆæ¯å·²æ ‡è®°ä¸ºå·²è¯»ï¼Œå·²è¯»æ¶ˆæ¯å°†ä¸å†æ˜¾ç¤º', 'success');
                refreshHMS();
            } catch (error) {
                log(`æ ‡è®°HMSå·²è¯»å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // HMSè§†å›¾åˆ‡æ¢åŠŸèƒ½
        let showAllHMS = false; // é»˜è®¤åªæ˜¾ç¤ºæœªè¯»æ¶ˆæ¯
        
        function toggleHMSView() {
            const toggleBtn = document.getElementById('hmsViewToggle');
            showAllHMS = !showAllHMS;
            
            if (showAllHMS) {
                toggleBtn.textContent = 'åªçœ‹æœªè¯»';
                toggleBtn.className = 'btn btn-sm btn-warning';
                log('å·²åˆ‡æ¢åˆ°æ˜¾ç¤ºæ‰€æœ‰HMSæ¶ˆæ¯', 'info');
            } else {
                toggleBtn.textContent = 'æŸ¥çœ‹æ‰€æœ‰';
                toggleBtn.className = 'btn btn-sm btn-outline-secondary';
                log('å·²åˆ‡æ¢åˆ°åªæ˜¾ç¤ºæœªè¯»HMSæ¶ˆæ¯', 'info');
            }
            
            refreshHMS(); // åˆ·æ–°æ˜¾ç¤º
        }

        // æœºåœºç¯å¢ƒæ•°æ®ç›¸å…³
        async function refreshEnvironmentData() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                // ä½¿ç”¨ç°æœ‰çš„è®¾å¤‡çŠ¶æ€æ¥å£è·å–æ•°æ®ï¼ˆåŒ…å«å®Œæ•´OSDç¯å¢ƒä¿¡æ¯ï¼‰
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/status`);
                
                if (result && result.data && result.data.osd && result.data.osd.data) {
                    updateEnvironmentDisplay(result.data.osd.data);
                    log('ç¯å¢ƒæ•°æ®å·²æ›´æ–°', 'success');
                } else {
                    log('è·å–ç¯å¢ƒæ•°æ®å¤±è´¥ï¼šæ— æœ‰æ•ˆæ•°æ®', 'warning');
                    updateEnvironmentDisplay(null);
                }
            } catch (error) {
                log(`è·å–ç¯å¢ƒæ•°æ®å¤±è´¥: ${error.message}`, 'error');
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                updateEnvironmentDisplay(null);
            }
        }

        function updateEnvironmentDisplay(data) {
            // é™é›¨é‡æšä¸¾æ˜ å°„
            const rainfallMap = {
                0: 'æ— é›¨',
                1: 'å°é›¨', 
                2: 'ä¸­é›¨',
                3: 'å¤§é›¨'
            };

            // å……ç”µçŠ¶æ€æšä¸¾æ˜ å°„
            const chargeStateMap = {
                0: 'ç©ºé—²',
                1: 'å……ç”µä¸­'
            };

            if (data) {
                // æ›´æ–°ç¯å¢ƒæ¸©åº¦
                if (data.environment_temperature !== undefined) {
                    document.getElementById('environmentTemp').textContent = `${data.environment_temperature}Â°C`;
                }

                // æ›´æ–°èˆ±å†…æ¸©åº¦
                if (data.temperature !== undefined) {
                    document.getElementById('dockTemp').textContent = `${data.temperature}Â°C`;
                }

                // æ›´æ–°é£é€Ÿ
                if (data.wind_speed !== undefined) {
                    document.getElementById('windSpeed').textContent = `${data.wind_speed} m/s`;
                }

                // æ›´æ–°æ¹¿åº¦
                if (data.humidity !== undefined) {
                    document.getElementById('humidity').textContent = `${data.humidity}%`;
                }

                // æ›´æ–°é™é›¨é‡
                if (data.rainfall !== undefined) {
                    const rainfallText = rainfallMap[data.rainfall] || `${data.rainfall}`;
                    document.getElementById('rainfall').textContent = rainfallText;
                }

                // æ›´æ–°é£è¡Œå™¨å……ç”µçŠ¶æ€
                if (data.drone_charge_state) {
                    const chargeState = data.drone_charge_state.state;
                    const batteryPercent = data.drone_charge_state.capacity_percent;
                    
                    // æ›´æ–°å……ç”µçŠ¶æ€
                    if (chargeState !== undefined) {
                        const chargeText = chargeStateMap[chargeState] || `çŠ¶æ€${chargeState}`;
                        document.getElementById('chargeStatus').textContent = chargeText;
                    }
                    
                    // æ›´æ–°ç”µæ± ç”µé‡
                    if (batteryPercent !== undefined) {
                        document.getElementById('batteryLevel').textContent = `${batteryPercent}%`;
                        
                        // æ ¹æ®ç”µé‡è°ƒæ•´é¢œè‰²
                        const batteryCard = document.getElementById('batteryLevel').closest('.card');
                        batteryCard.className = batteryCard.className.replace(/bg-(success|warning|danger)/, '');
                        if (batteryPercent >= 60) {
                            batteryCard.classList.add('bg-success');
                        } else if (batteryPercent >= 30) {
                            batteryCard.classList.add('bg-warning');
                        } else {
                            batteryCard.classList.add('bg-danger');
                        }
                    }
                } else {
                    document.getElementById('chargeStatus').textContent = '--';
                    document.getElementById('batteryLevel').textContent = '--%';
                }

                // æ›´æ–°æœ€åæ›´æ–°æ—¶é—´
                document.getElementById('environmentLastUpdate').textContent = 
                    `æœ€åæ›´æ–°: ${new Date().toLocaleString()}`;

            } else {
                // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
                document.getElementById('environmentTemp').textContent = '--Â°C';
                document.getElementById('dockTemp').textContent = '--Â°C';
                document.getElementById('windSpeed').textContent = '-- m/s';
                document.getElementById('humidity').textContent = '--%';
                document.getElementById('rainfall').textContent = '--';
                document.getElementById('chargeStatus').textContent = '--';
                document.getElementById('batteryLevel').textContent = '--%';
                document.getElementById('environmentLastUpdate').textContent = 'è·å–æ•°æ®å¤±è´¥';
            }
        }

        // è‡ªåŠ¨åˆ·æ–°ç¯å¢ƒæ•°æ®ï¼ˆæ¯30ç§’ï¼‰
        let environmentRefreshInterval;
        function startEnvironmentAutoRefresh() {
            // æ¸…é™¤å·²å­˜åœ¨çš„å®šæ—¶å™¨
            if (environmentRefreshInterval) {
                clearInterval(environmentRefreshInterval);
            }
            
            // è®¾ç½®30ç§’è‡ªåŠ¨åˆ·æ–°
            environmentRefreshInterval = setInterval(() => {
                const deviceSn = document.getElementById('deviceSn').value;
                if (deviceSn) {
                    refreshEnvironmentData();
                }
            }, 30000);
        }

        // åœæ­¢è‡ªåŠ¨åˆ·æ–°
        function stopEnvironmentAutoRefresh() {
            if (environmentRefreshInterval) {
                clearInterval(environmentRefreshInterval);
                environmentRefreshInterval = null;
            }
        }

        // è¾…åŠ©å‡½æ•°
        function displayResponse(elementId, data) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = JSON.stringify(data, null, 2);
            }
        }

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = {
                'success': 'text-success',
                'error': 'text-danger',
                'warning': 'text-warning',
                'info': 'text-info'
            }[type] || 'text-muted';
            
            const logEntry = document.createElement('div');
            logEntry.className = logClass;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="text-muted">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // DRCæ§åˆ¶ç›¸å…³å˜é‡
        let drcControlInterval = null;
        let drcControlActive = false;
        
        // DRCæ†é‡æ§åˆ¶
        function updateDRCValue(channel) {
            const slider = document.getElementById(`${channel}Slider`);
            const valueSpan = document.getElementById(`${channel}Value`);
            valueSpan.textContent = slider.value;
        }
        
        function resetDRCValues() {
            const channels = ['roll', 'pitch', 'throttle', 'yaw'];
            channels.forEach(channel => {
                const slider = document.getElementById(`${channel}Slider`);
                const valueSpan = document.getElementById(`${channel}Value`);
                slider.value = 1024;
                valueSpan.textContent = 1024;
            });
            log('DRCæ†é‡å·²é‡ç½®åˆ°ä¸­ä½', 'info');
        }
        
        async function startDRCControl() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            if (drcControlActive) {
                log('DRCæ§åˆ¶å·²åœ¨è¿è¡Œä¸­', 'warning');
                return;
            }
            
            drcControlActive = true;
            log('å¼€å§‹DRCæ†é‡æ§åˆ¶ (10Hz)', 'success');
            
            // æ¯100mså‘é€ä¸€æ¬¡æ§åˆ¶æŒ‡ä»¤ (10Hz)
            drcControlInterval = setInterval(async () => {
                const stickData = {
                    roll: parseInt(document.getElementById('rollSlider').value),
                    pitch: parseInt(document.getElementById('pitchSlider').value),
                    throttle: parseInt(document.getElementById('throttleSlider').value),
                    yaw: parseInt(document.getElementById('yawSlider').value)
                };
                
                try {
                    await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/control/stick`, 'POST', stickData);
                } catch (error) {
                    log(`DRCæ§åˆ¶å‘é€å¤±è´¥: ${error.message}`, 'error');
                }
            }, 100);
        }
        
        function stopDRCControl() {
            if (drcControlInterval) {
                clearInterval(drcControlInterval);
                drcControlInterval = null;
            }
            drcControlActive = false;
            resetDRCValues();
            log('DRCæ§åˆ¶å·²åœæ­¢', 'info');
        }
        
        // æ›´æ–°æœºåœºçŠ¶æ€é¢æ¿
        function updateDockStatusPanel(deviceStatus, showPanel = true) {
            const statusPanel = document.getElementById('dockStatusPanel');
            
            if (showPanel) {
                statusPanel.style.display = 'block';
            }
            
            // è·å–å®é™…çš„è®¾å¤‡æ•°æ®ï¼ˆå¯èƒ½åœ¨osd.dataä¸‹æˆ–ç›´æ¥åœ¨æ ¹çº§åˆ«ï¼‰
            const data = deviceStatus.osd?.data || deviceStatus;
            
            // æœºåœºçŠ¶æ€
            if (data.mode_code !== undefined) {
                const modeMap = {
                    '0': 'ğŸŸ¢ ç©ºé—²ä¸­', '1': 'ğŸŸ¡ ç°åœºè°ƒè¯•', '2': 'ğŸ”µ è¿œç¨‹è°ƒè¯•', 
                    '3': 'ğŸŸ  å›ºä»¶å‡çº§ä¸­', '4': 'ğŸ”´ ä½œä¸šä¸­', '5': 'ğŸŸ£ å¾…æ ‡å®š'
                };
                document.getElementById('dockModeStatus').innerHTML = modeMap[data.mode_code] || data.mode_code;
            }
            
            // ä»»åŠ¡çŠ¶æ€
            if (data.flighttask_step_code !== undefined) {
                const taskMap = {
                    '0': 'ä½œä¸šå‡†å¤‡ä¸­', '1': 'é£è¡Œä½œä¸šä¸­', '2': 'ä½œä¸šåçŠ¶æ€æ¢å¤',
                    '3': 'è‡ªå®šä¹‰é£è¡ŒåŒºæ›´æ–°ä¸­', '4': 'åœ°å½¢éšœç¢ç‰©æ›´æ–°ä¸­', '5': 'ä»»åŠ¡ç©ºé—²',
                    '255': 'é£è¡Œå™¨å¼‚å¸¸', '256': 'æœªçŸ¥çŠ¶æ€'
                };
                document.getElementById('dockTaskStatus').textContent = taskMap[data.flighttask_step_code] || data.flighttask_step_code;
            }
            
            // é£è¡Œå™¨åœ¨èˆ±çŠ¶æ€
            if (data.drone_in_dock !== undefined) {
                const inDockMap = {'0': 'ğŸš« èˆ±å¤–', '1': 'âœ… èˆ±å†…'};
                document.getElementById('droneInDockStatus').innerHTML = inDockMap[data.drone_in_dock];
            }
            
            // GPSçŠ¶æ€è¯¦æƒ…
            if (data.position_state) {
                const pos = data.position_state;
                const fixedMap = {'0': 'æœªå¼€å§‹', '1': 'æ”¶æ•›ä¸­', '2': 'âœ…æ”¶æ•›æˆåŠŸ', '3': 'âŒæ”¶æ•›å¤±è´¥'};
                const qualityMap = {'1': '1æ¡£', '2': '2æ¡£', '3': '3æ¡£', '4': '4æ¡£', '5': '5æ¡£', '10': 'ğŸŸ¢RTK Fixed'};
                const gpsDetail = `${fixedMap[pos.is_fixed] || 'æœªçŸ¥'} | ${qualityMap[pos.quality] || pos.quality + 'æ¡£'}`;
                document.getElementById('gpsStatusDetail').innerHTML = gpsDetail;
            }
            
            // èˆ±ç›–çŠ¶æ€
            if (data.cover_state !== undefined) {
                const coverMap = {'0': 'ğŸ”´ å…³é—­', '1': 'ğŸŸ¢ æ‰“å¼€', '2': 'ğŸŸ¡ åŠå¼€', '3': 'âŒ å¼‚å¸¸'};
                document.getElementById('coverStateStatus').innerHTML = coverMap[data.cover_state] || data.cover_state;
            }
            
            // ç´¯è®¡ä½œä¸šæ¬¡æ•°
            if (data.job_number !== undefined) {
                document.getElementById('jobNumberStatus').textContent = `${data.job_number} æ¬¡`;
            }
        }
        
        // è·å–è®¾å¤‡åæ ‡åŠŸèƒ½
        async function getDeviceCoordinates() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                log('æ­£åœ¨è·å–è®¾å¤‡åæ ‡...', 'info');
                
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/status`);
                
                // è°ƒè¯•ï¼šæ˜¾ç¤ºAPIè¿”å›ç»“æ„
                console.log('APIè¿”å›çš„å®Œæ•´æ•°æ®:', JSON.stringify(result, null, 2));
                log(`APIè¿”å›æ•°æ®ç»“æ„: ${Object.keys(result).join(', ')}`, 'info');
                
                // è·å–å®é™…çš„æ•°æ®éƒ¨åˆ†
                const deviceData = result.data || result;
                
                // è¯¦ç»†æ£€æŸ¥æ¯ä¸ªæ¡ä»¶
                log('=== æ¡ä»¶æ£€æŸ¥å¼€å§‹ ===', 'info');
                log(`æ¡ä»¶1: deviceData.longitude !== undefined = ${deviceData.longitude !== undefined}`, 'info');
                log(`æ¡ä»¶1: deviceData.latitude !== undefined = ${deviceData.latitude !== undefined}`, 'info');
                log(`æ¡ä»¶2: deviceData.osdå­˜åœ¨ = ${deviceData.osd !== undefined}`, 'info');
                log(`æ¡ä»¶2: deviceData.osd.dataå­˜åœ¨ = ${deviceData.osd && deviceData.osd.data !== undefined}`, 'info');
                log(`æ¡ä»¶2: deviceData.osd.data.latitudeå­˜åœ¨ = ${deviceData.osd && deviceData.osd.data && deviceData.osd.data.latitude !== undefined}`, 'info');
                log(`æ¡ä»¶2: deviceData.osd.data.longitudeå­˜åœ¨ = ${deviceData.osd && deviceData.osd.data && deviceData.osd.data.longitude !== undefined}`, 'info');
                if (deviceData.osd && deviceData.osd.data) {
                    log(`deviceData.osd.data.latitudeå€¼: ${deviceData.osd.data.latitude}`, 'info');
                    log(`deviceData.osd.data.longitudeå€¼: ${deviceData.osd.data.longitude}`, 'info');
                }
                log('=== æ¡ä»¶æ£€æŸ¥ç»“æŸ ===', 'info');
                
                // æ£€æŸ¥è®¾å¤‡çŠ¶æ€ä¸­çš„ä½ç½®ä¿¡æ¯
                let lat = 0, lng = 0, alt = 0;
                let dataSource = 'æœªçŸ¥';
                let gpsStatus = 'æœªçŸ¥';
                
                // ä¼˜å…ˆä»æœºåœºå±æ€§è·å–ä½ç½®ä¿¡æ¯ï¼ˆæ›´ç²¾ç¡®ï¼‰
                if (deviceData.longitude !== undefined && deviceData.latitude !== undefined) {
                    log('æ£€æµ‹åˆ°æœºåœºå±æ€§ä¸­çš„åæ ‡', 'info');
                    lat = parseFloat(deviceData.latitude);
                    lng = parseFloat(deviceData.longitude);
                    alt = parseFloat(deviceData.height || 0);
                    dataSource = 'æœºåœºå±æ€§';
                    
                    // è§£æGPS/RTKçŠ¶æ€
                    if (deviceData.position_state) {
                        const pos = deviceData.position_state;
                        const fixedMap = {'0': 'æœªå¼€å§‹', '1': 'æ”¶æ•›ä¸­', '2': 'æ”¶æ•›æˆåŠŸ', '3': 'æ”¶æ•›å¤±è´¥'};
                        const qualityMap = {'1': '1æ¡£', '2': '2æ¡£', '3': '3æ¡£', '4': '4æ¡£', '5': '5æ¡£', '10': 'RTK Fixed'};
                        gpsStatus = `${fixedMap[pos.is_fixed] || 'æœªçŸ¥'} | ${qualityMap[pos.quality] || pos.quality + 'æ¡£'} | GPS:${pos.gps_number || 0} RTK:${pos.rtk_number || 0}`;
                    }
                }
                // å¤‡ç”¨ï¼šä» OSD æ•°æ®è·å–ï¼ˆå®é™…APIè¿”å›çš„ç»“æ„ï¼‰
                else if (deviceData.osd && deviceData.osd.data && deviceData.osd.data.latitude !== undefined && deviceData.osd.data.longitude !== undefined) {
                    log('æ£€æµ‹åˆ°OSDæ•°æ®ä¸­çš„åæ ‡', 'info');
                    console.log('OSDæ•°æ®:', deviceData.osd.data);
                    lat = parseFloat(deviceData.osd.data.latitude);
                    lng = parseFloat(deviceData.osd.data.longitude);
                    alt = parseFloat(deviceData.osd.data.height || 0);
                    dataSource = 'OSDæ•°æ®';
                    
                    // è§£æGPS/RTKçŠ¶æ€
                    if (deviceData.osd.data.position_state) {
                        const pos = deviceData.osd.data.position_state;
                        const fixedMap = {'0': 'æœªå¼€å§‹', '1': 'æ”¶æ•›ä¸­', '2': 'æ”¶æ•›æˆåŠŸ', '3': 'æ”¶æ•›å¤±è´¥'};
                        const qualityMap = {'1': '1æ¡£', '2': '2æ¡£', '3': '3æ¡£', '4': '4æ¡£', '5': '5æ¡£', '10': 'RTK Fixed'};
                        gpsStatus = `${fixedMap[pos.is_fixed] || 'æœªçŸ¥'} | ${qualityMap[pos.quality] || pos.quality + 'æ¡£'} | GPS:${pos.gps_number || 0} RTK:${pos.rtk_number || 0}`;
                    }
                }
                // å…¼å®¹æ€§ï¼šä»æ—§çš„ OSD æ•°æ®ç»“æ„è·å–
                else if (deviceData.osd && deviceData.osd.latitude && deviceData.osd.longitude) {
                    log('æ£€æµ‹åˆ°OSDæ—§æ ¼å¼ä¸­çš„åæ ‡', 'info');
                    lat = parseFloat(deviceData.osd.latitude);
                    lng = parseFloat(deviceData.osd.longitude);
                    alt = parseFloat(deviceData.osd.height || deviceData.osd.elevation || 0);
                    dataSource = 'OSDæ•°æ®(æ—§æ ¼å¼)';
                    
                    if (deviceData.osd.position_state) {
                        const pos = deviceData.osd.position_state;
                        gpsStatus = `GPS:${pos.gps_number || 0} RTK:${pos.rtk_number || 0}`;
                    }
                } else {
                    log('æœªæ£€æµ‹åˆ°ä»»ä½•åæ ‡æ•°æ®', 'warning');
                    console.log('æ£€æŸ¥æ•°æ®ç»“æ„:');
                    console.log('- deviceData.longitude:', deviceData.longitude);
                    console.log('- deviceData.latitude:', deviceData.latitude);
                    console.log('- deviceData.osd:', deviceData.osd);
                    if (deviceData.osd) {
                        console.log('- deviceData.osd.data:', deviceData.osd.data);
                        if (deviceData.osd.data) {
                            console.log('- deviceData.osd.data.latitude:', deviceData.osd.data.latitude);
                            console.log('- deviceData.osd.data.longitude:', deviceData.osd.data.longitude);
                        }
                    }
                }
                
                // æ£€æŸ¥åæ ‡æ˜¯å¦æœ‰æ•ˆ
                if (lat !== 0 && lng !== 0) {
                    // å¡«å…¥åæ ‡æ•°æ®
                    document.getElementById('simLatitude').value = lat.toFixed(6);
                    document.getElementById('simLongitude').value = lng.toFixed(6);
                    document.getElementById('simAltitude').value = alt.toFixed(1);
                    
                    // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                    document.getElementById('latStatus').textContent = 'è‡ªåŠ¨';
                    document.getElementById('latStatus').className = 'input-group-text bg-success text-white';
                    document.getElementById('lngStatus').textContent = 'è‡ªåŠ¨';
                    document.getElementById('lngStatus').className = 'input-group-text bg-success text-white';
                    document.getElementById('altStatus').textContent = 'è‡ªåŠ¨';
                    document.getElementById('altStatus').className = 'input-group-text bg-success text-white';
                    
                    // æ›´æ–°ä¿¡æ¯æ˜¾ç¤º
                    const coordText = `${dataSource}: ${lat.toFixed(6)}, ${lng.toFixed(6)}, é«˜åº¦: ${alt.toFixed(1)}m`;
                    document.getElementById('coordinateInfo').textContent = coordText;
                    document.getElementById('coordinateInfo').className = 'text-success d-block';
                    
                    log(`æœºåœºåæ ‡å·²è·å–[æ•°æ®æº: ${dataSource}]: çº¬åº¦=${lat.toFixed(6)}, ç»åº¦=${lng.toFixed(6)}, é«˜åº¦=${alt.toFixed(1)}m`, 'success');
                    log(`GPS/RTKçŠ¶æ€: ${gpsStatus}`, 'info');
                    
                    // æ˜¾ç¤ºæœºåœºçŠ¶æ€ - ä¼˜å…ˆä»osd.dataè·å–ï¼Œå¤‡ç”¨ä»æ ¹çº§åˆ«è·å–
                    const statusData = deviceData.osd?.data || deviceData;
                    if (statusData.mode_code !== undefined) {
                        const modeMap = {'0': 'ç©ºé—²ä¸­', '1': 'ç°åœºè°ƒè¯•', '2': 'è¿œç¨‹è°ƒè¯•', '3': 'å›ºä»¶å‡çº§ä¸­', '4': 'ä½œä¸šä¸­', '5': 'å¾…æ ‡å®š'};
                        log(`æœºåœºçŠ¶æ€: ${modeMap[statusData.mode_code] || statusData.mode_code}`, 'info');
                    }
                    
                    // æ˜¾ç¤ºé£è¡Œå™¨çŠ¶æ€
                    if (statusData.drone_in_dock !== undefined) {
                        const inDockMap = {'0': 'èˆ±å¤–', '1': 'èˆ±å†…'};
                        log(`é£è¡Œå™¨ä½ç½®: ${inDockMap[statusData.drone_in_dock]}`, 'info');
                    }
                    
                    // æ›´æ–°æœºåœºçŠ¶æ€é¢æ¿
                    updateDockStatusPanel(deviceData);
                    
                } else {
                    log('è®¾å¤‡GPSä¿¡å·æœªé”å®šï¼Œåæ ‡ä¸º(0,0)', 'warning');
                    document.getElementById('coordinateInfo').textContent = `GPSä¿¡å·æœªé”å®š [${gpsStatus}] - è¯·ç­‰å¾…è®¾å¤‡è·å–GPSä¿¡å·`;
                    document.getElementById('coordinateInfo').className = 'text-warning d-block';
                    
                    // éšè—çŠ¶æ€é¢æ¿
                    document.getElementById('dockStatusPanel').style.display = 'none';
                    
                    // æ˜¾ç¤ºè¯¦ç»†GPSçŠ¶æ€å¸®åŠ©è¯Šæ–­
                    if (dataSource !== 'æœªçŸ¥') {
                        log(`æ•°æ®æº: ${dataSource}, GPSçŠ¶æ€: ${gpsStatus}`, 'info');
                        // æ›´æ–°éƒ¨åˆ†çŠ¶æ€ä¿¡æ¯
                        updateDockStatusPanel(deviceData, false);
                    } else {
                        log('è®¾å¤‡æœªä¸ŠæŠ¥ä½ç½®ä¿¡æ¯', 'warning');
                        document.getElementById('coordinateInfo').textContent = 'è®¾å¤‡æœªä¸ŠæŠ¥ä½ç½®ä¿¡æ¯ï¼Œè¯·æ£€æŸ¥è®¾å¤‡æ˜¯å¦åœ¨çº¿å’ŒGPSçŠ¶æ€';
                        document.getElementById('coordinateInfo').className = 'text-warning d-block';
                    }
                }
                
                // æ˜¾ç¤ºå®Œæ•´çš„APIå“åº”ä¾›è°ƒè¯•
                displayResponse('waylineApiResponse', deviceData);
                
            } catch (error) {
                log(`è·å–è®¾å¤‡åæ ‡å¤±è´¥: ${error.message}`, 'error');
                document.getElementById('coordinateInfo').textContent = 'è·å–åæ ‡å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾å¤‡è¿æ¥å’Œæƒé™';
                document.getElementById('coordinateInfo').className = 'text-danger d-block';
            }
        }
        
        // ========================================
        // èˆªçº¿ä»»åŠ¡å®Œæ•´æµç¨‹ç®¡ç†å‡½æ•°
        // ========================================
        
        // æ­¥éª¤1: ä¸Šä¼ èˆªçº¿æ–‡ä»¶
        async function uploadWaylineFile() {
            const workspaceId = document.getElementById('workspaceId').value;
            const fileInput = document.getElementById('waylineFile');
            const waylineName = document.getElementById('waylineName').value;
            const droneModelKey = document.getElementById('droneModelKey').value;
            
            if (!workspaceId) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´ID', 'error');
                return;
            }
            
            if (!fileInput.files[0]) {
                log('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„èˆªçº¿æ–‡ä»¶', 'error');
                return;
            }
            
            if (!waylineName) {
                log('è¯·è¾“å…¥èˆªçº¿åç§°', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            if (!file.name.endsWith('.kmz')) {
                log('è¯·é€‰æ‹©.kmzæ ¼å¼çš„èˆªçº¿æ–‡ä»¶', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', waylineName);
            formData.append('drone_model_key', droneModelKey);
            formData.append('template_types', '0'); // é»˜è®¤èˆªç‚¹é£è¡Œ
            formData.append('favorited', 'false');
            
            try {
                const apiUrl = document.getElementById('apiUrl').value;
                const token = document.getElementById('apiToken').value;
                
                log('å¼€å§‹ä¸Šä¼ èˆªçº¿æ–‡ä»¶...', 'info');
                
                const response = await fetch(`${apiUrl}/api/v1/wayline/workspaces/${workspaceId}/files/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.code === 0) {
                    log(`èˆªçº¿æ–‡ä»¶ä¸Šä¼ æˆåŠŸ: ${result.data.name}`, 'success');
                    displayResponse('waylineApiResponse', result);
                    // è‡ªåŠ¨åˆ·æ–°èˆªçº¿æ–‡ä»¶åˆ—è¡¨
                    await getWaylineFiles();
                } else {
                    log(`èˆªçº¿æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${result.message || result.detail || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                    displayResponse('waylineApiResponse', result);
                }
            } catch (error) {
                log(`èˆªçº¿æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // è·å–å·²ä¸Šä¼ çš„èˆªçº¿æ–‡ä»¶åˆ—è¡¨
        async function getWaylineFiles() {
            const workspaceId = document.getElementById('workspaceId').value;
            if (!workspaceId) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´ID', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/files`);
                log('è·å–èˆªçº¿æ–‡ä»¶åˆ—è¡¨æˆåŠŸ', 'success');
                displayResponse('waylineApiResponse', result);
                
                // è¯¦ç»†è°ƒè¯•APIå“åº”ç»“æ„
                console.log('=== APIå“åº”è°ƒè¯•ä¿¡æ¯ ===');
                console.log('å®Œæ•´å“åº”:', result);
                console.log('result.data:', result.data);
                if (result.data) {
                    console.log('result.data.data:', result.data.data);
                    console.log('result.dataç±»å‹:', typeof result.data);
                    console.log('result.dataæ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(result.data));
                }
                console.log('========================');
                
                // æ›´æ–°èˆªçº¿æ–‡ä»¶é€‰æ‹©ä¸‹æ‹‰æ¡†
                const waylineSelect = document.getElementById('waylineFileSelect');
                waylineSelect.innerHTML = '<option value="">é€‰æ‹©èˆªçº¿æ–‡ä»¶...</option>';
                
                // å¤„ç†ä¸åŒçš„æ•°æ®ç»“æ„
                let files = [];
                if (result.data) {
                    if (result.data.list && Array.isArray(result.data.list)) {
                        // æ–°å‘ç°çš„ç»“æ„ï¼š{list: Array, pagination: {...}}
                        files = result.data.list;
                        console.log('ä½¿ç”¨listç»“æ„ï¼Œæ–‡ä»¶æ•°é‡:', files.length);
                    } else if (result.data.data && Array.isArray(result.data.data)) {
                        files = result.data.data; // æœ‰åˆ†é¡µä¿¡æ¯çš„ç»“æ„
                        console.log('ä½¿ç”¨åˆ†é¡µç»“æ„ï¼Œæ–‡ä»¶æ•°é‡:', files.length);
                    } else if (Array.isArray(result.data)) {
                        files = result.data; // ç›´æ¥æ˜¯æ•°ç»„çš„ç»“æ„
                        console.log('ä½¿ç”¨æ•°ç»„ç»“æ„ï¼Œæ–‡ä»¶æ•°é‡:', files.length);
                    } else if (result.data.wayline_id) {
                        files = [result.data]; // å•ä¸ªæ–‡ä»¶çš„ç»“æ„
                        console.log('ä½¿ç”¨å•æ–‡ä»¶ç»“æ„');
                    } else {
                        console.log('æœªè¯†åˆ«çš„æ•°æ®ç»“æ„:', result.data);
                        // å°è¯•ç›´æ¥ä½¿ç”¨result.dataçš„æ‰€æœ‰å±æ€§
                        console.log('å°è¯•éå†result.dataçš„å±æ€§:');
                        for (let key in result.data) {
                            console.log(`  ${key}:`, result.data[key]);
                        }
                    }
                }
                
                console.log('æœ€ç»ˆè§£æåˆ°çš„æ–‡ä»¶åˆ—è¡¨:', files);
                
                if (files.length > 0) {
                    files.forEach(file => {
                        console.log('å¤„ç†æ–‡ä»¶:', file);
                        const option = document.createElement('option');
                        option.value = file.wayline_id;
                        option.textContent = `${file.name} (${file.drone_model_key || 'Unknown'})`;
                        waylineSelect.appendChild(option);
                    });
                    log(`å‘ç° ${files.length} ä¸ªèˆªçº¿æ–‡ä»¶`, 'info');
                } else {
                    log('æœªæ‰¾åˆ°ä»»ä½•èˆªçº¿æ–‡ä»¶ï¼Œè¯·å…ˆä¸Šä¼ èˆªçº¿æ–‡ä»¶', 'warning');
                    log('è¯·æŸ¥çœ‹æ§åˆ¶å°çš„è¯¦ç»†è°ƒè¯•ä¿¡æ¯æ¥ç¡®å®šæ•°æ®ç»“æ„', 'info');
                }
            } catch (error) {
                log(`è·å–èˆªçº¿æ–‡ä»¶åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
                console.error('APIè¯·æ±‚é”™è¯¯:', error);
            }
        }
        
        // æ­¥éª¤2: åˆ›å»ºèˆªçº¿ä»»åŠ¡
        async function createWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const deviceSn = document.getElementById('deviceSn').value;
            const waylineId = document.getElementById('waylineFileSelect').value;
            const taskType = parseInt(document.getElementById('taskType').value);
            
            console.log('åˆ›å»ºä»»åŠ¡å‚æ•°æ£€æŸ¥:', {
                workspaceId, deviceSn, waylineId, taskType
            });
            
            if (!workspaceId) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´ID', 'error');
                return;
            }
            
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            if (!waylineId) {
                log('è¯·é€‰æ‹©èˆªçº¿æ–‡ä»¶ï¼Œå¦‚æœåˆ—è¡¨ä¸ºç©ºè¯·å…ˆä¸Šä¼ èˆªçº¿æ–‡ä»¶', 'error');
                return;
            }
            
            const enableSim = document.getElementById('enableSimulation').checked;
            const taskData = {
                name: `èˆªçº¿ä»»åŠ¡_${Date.now()}`,
                dock_sn: deviceSn,
                file_id: waylineId,  // ä½¿ç”¨file_id
                task_type: taskType,
                out_of_control_action: 0,  // 0: è¿”èˆª
                rth_altitude: 100,  // è¿”èˆªé«˜åº¦100ç±³
                rth_mode: 1,  // 1: è®¾å®šé«˜åº¦æ¨¡å¼ï¼ˆMQTTéœ€è¦ï¼‰
                exit_wayline_when_rc_lost: 0,  // 0: ç»§ç»­æ‰§è¡Œèˆªçº¿ï¼ˆMQTTéœ€è¦ï¼‰
                wayline_precision_type: 1,  // 1: é«˜ç²¾åº¦RTKä»»åŠ¡ï¼ˆMQTTéœ€è¦ï¼‰
                begin_time: null,
                end_time: null
            };
            
            // å¦‚æœå¯ç”¨æ¨¡æ‹Ÿé£è¡Œ
            if (enableSim) {
                taskData.simulate_mission = {
                    is_enable: 1,
                    latitude: parseFloat(document.getElementById('simLatitude').value),
                    longitude: parseFloat(document.getElementById('simLongitude').value),
                    altitude: parseFloat(document.getElementById('simAltitude').value)
                };
            }
            
            // å¦‚æœæ˜¯å®šæ—¶ä»»åŠ¡ï¼Œæ·»åŠ æ‰§è¡Œæ—¶é—´
            if (taskType === 1) {
                const executeTime = prompt('è¯·è¾“å…¥æ‰§è¡Œæ—¶é—´ (æ ¼å¼: YYYY-MM-DD HH:mm:ss):');
                if (executeTime) {
                    taskData.execute_time = new Date(executeTime).getTime();
                }
            }
            
            try {
                log('å¼€å§‹åˆ›å»ºèˆªçº¿ä»»åŠ¡...', 'info');
                console.log('å‘é€çš„ä»»åŠ¡æ•°æ®:', taskData);
                
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/flight-tasks`, 'POST', taskData);
                log(`èˆªçº¿ä»»åŠ¡åˆ›å»ºæˆåŠŸ${enableSim ? ' (æ¨¡æ‹Ÿé£è¡Œæ¨¡å¼)' : ''}`, 'success');
                displayResponse('waylineApiResponse', result);
                
                // è‡ªåŠ¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                await refreshJobList();
            } catch (error) {
                log(`åˆ›å»ºèˆªçº¿ä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
                console.error('åˆ›å»ºä»»åŠ¡é”™è¯¯è¯¦æƒ…:', error);
                
                // æ˜¾ç¤ºæ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯åˆ°ç•Œé¢
                displayResponse('waylineApiResponse', {
                    error: error.message,
                    taskData: taskData
                });
            }
        }
        
        // åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å¹¶æ›´æ–°é€‰æ‹©æ¡†
        async function refreshJobList() {
            const workspaceId = document.getElementById('workspaceId').value;
            if (!workspaceId) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´ID', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs`);
                log('åˆ·æ–°ä»»åŠ¡åˆ—è¡¨æˆåŠŸ', 'success');
                displayResponse('waylineApiResponse', result);
                
                // ä½¿ç”¨é€šç”¨å‡½æ•°æ›´æ–°ä»»åŠ¡é€‰æ‹©ä¸‹æ‹‰æ¡†
                updateJobSelectDropdown(result);
                
            } catch (error) {
                log(`åˆ·æ–°ä»»åŠ¡åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ­¥éª¤3: æ‰§è¡Œèˆªçº¿ä»»åŠ¡
        async function executeWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const jobId = document.getElementById('jobSelect').value;
            
            if (!workspaceId || !jobId) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´IDå¹¶é€‰æ‹©è¦æ‰§è¡Œçš„ä»»åŠ¡', 'error');
                return;
            }
            
            // è·å–æ¨¡æ‹Ÿå™¨å‚æ•°
            const enableSim = document.getElementById('enableSimulation').checked;
            const dockLat = parseFloat(document.getElementById('simLatitude').value);
            const dockLng = parseFloat(document.getElementById('simLongitude').value);
            const dockAlt = parseFloat(document.getElementById('simAltitude').value);
            
            let requestData = {};
            
            // å¦‚æœå¯ç”¨æ¨¡æ‹Ÿå™¨ï¼Œæ·»åŠ æ¨¡æ‹Ÿå™¨å‚æ•°
            if (enableSim && !isNaN(dockLat) && !isNaN(dockLng) && !isNaN(dockAlt)) {
                requestData.simulate_mission = {
                    is_enable: 1,
                    latitude: dockLat,
                    longitude: dockLng,
                    altitude: dockAlt
                };
                log(`ä½¿ç”¨æ¨¡æ‹Ÿå™¨æ¨¡å¼æ‰§è¡Œèˆªçº¿ä»»åŠ¡: çº¬åº¦=${dockLat}, ç»åº¦=${dockLng}, é«˜åº¦=${dockAlt}m`, 'info');
            } else {
                log('ä½¿ç”¨çœŸå®é£è¡Œæ¨¡å¼æ‰§è¡Œèˆªçº¿ä»»åŠ¡', 'info');
            }
            
            try {
                log('å¼€å§‹æ‰§è¡Œèˆªçº¿ä»»åŠ¡...', 'info');
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}/execute`, 'POST', requestData);
                log(`èˆªçº¿ä»»åŠ¡æ‰§è¡ŒæŒ‡ä»¤å·²å‘é€${enableSim ? ' (æ¨¡æ‹Ÿå™¨æ¨¡å¼)' : ''}`, 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`æ‰§è¡Œèˆªçº¿ä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æš‚åœèˆªçº¿ä»»åŠ¡
        async function pauseWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const jobId = document.getElementById('jobSelect').value;
            
            if (!workspaceId || !jobId) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´IDå¹¶é€‰æ‹©è¦æš‚åœçš„ä»»åŠ¡', 'error');
                return;
            }
            
            try {
                log('å¼€å§‹æš‚åœèˆªçº¿ä»»åŠ¡...', 'info');
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}/pause`, 'POST');
                log('èˆªçº¿ä»»åŠ¡æš‚åœæŒ‡ä»¤å·²å‘é€', 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`æš‚åœèˆªçº¿ä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // å–æ¶ˆèˆªçº¿ä»»åŠ¡
        async function cancelWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const jobId = document.getElementById('jobSelect').value;
            
            if (!workspaceId || !jobId) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´IDå¹¶é€‰æ‹©è¦å–æ¶ˆçš„ä»»åŠ¡', 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¯¥èˆªçº¿ä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }
            
            try {
                log('å¼€å§‹å–æ¶ˆèˆªçº¿ä»»åŠ¡...', 'info');
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs?job_id=${jobId}`, 'DELETE');
                log('èˆªçº¿ä»»åŠ¡å–æ¶ˆæŒ‡ä»¤å·²å‘é€', 'success');
                displayResponse('waylineApiResponse', result);
                
                // è‡ªåŠ¨åˆ·æ–°ä»»åŠ¡åˆ—è¡¨
                await refreshJobList();
            } catch (error) {
                log(`å–æ¶ˆèˆªçº¿ä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ­¥éª¤4: è·å–ä»»åŠ¡è¯¦æƒ…
        async function getJobDetail() {
            const workspaceId = document.getElementById('workspaceId').value;
            const jobId = document.getElementById('jobSelect').value;
            
            if (!workspaceId || !jobId) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´IDå¹¶é€‰æ‹©è¦æŸ¥çœ‹çš„ä»»åŠ¡', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}`);
                log('è·å–ä»»åŠ¡è¯¦æƒ…æˆåŠŸ', 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`è·å–ä»»åŠ¡è¯¦æƒ…å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ¨¡æ‹Ÿé£è¡Œæµ‹è¯•
        async function testSimulateTakeoff() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            const enableSim = document.getElementById('enableSimulation').checked;
            const dockLat = parseFloat(document.getElementById('simLatitude').value);
            const dockLng = parseFloat(document.getElementById('simLongitude').value);
            const dockAlt = parseFloat(document.getElementById('simAltitude').value);
            
            // éªŒè¯åæ ‡æœ‰æ•ˆæ€§
            if (isNaN(dockLat) || isNaN(dockLng) || isNaN(dockAlt)) {
                log('åæ ‡æ•°æ®æ— æ•ˆï¼Œè¯·å…ˆè·å–è®¾å¤‡åæ ‡', 'error');
                return;
            }
            
            if (dockLat < -90 || dockLat > 90) {
                log('çº¬åº¦è¶…å‡ºæœ‰æ•ˆèŒƒå›´ (-90 åˆ° 90)', 'error');
                return;
            }
            
            if (dockLng < -180 || dockLng > 180) {
                log('ç»åº¦è¶…å‡ºæœ‰æ•ˆèŒƒå›´ (-180 åˆ° 180)', 'error');
                return;
            }
            
            log(`èµ·é£å‚æ•°: çº¬åº¦=${dockLat}, ç»åº¦=${dockLng}, é«˜åº¦=${dockAlt}m, æ¨¡æ‹Ÿæ¨¡å¼=${enableSim}`, 'info');
            
            const simData = enableSim ? {
                is_enable: 1,
                latitude: dockLat,   // ä½¿ç”¨æœºåœºåæ ‡ä½œä¸ºæ¨¡æ‹Ÿèµ·å§‹ç‚¹
                longitude: dockLng
            } : { is_enable: 0 };
            
            // ç›®æ ‡ç‚¹è®¾ç½®ä¸ºæœºåœºä¸Šæ–¹50ç±³
            const targetLat = dockLat;
            const targetLng = dockLng;
            const targetHeight = 30;  // é»˜è®¤èµ·é£åˆ°50ç±³
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/takeoff-to-point`, 'POST', {
                    target_latitude: targetLat,
                    target_longitude: targetLng,
                    target_height: targetHeight,
                    security_takeoff_height: Math.max(20, dockAlt + 10),  // å®‰å…¨èµ·é£é«˜åº¦ï¼šæœºåœºé«˜åº¦+10mï¼Œæœ€å°20m
                    rth_mode: 0,  // æ™ºèƒ½é«˜åº¦è¿”èˆª
                    rth_altitude: Math.max(50, dockAlt + 30),  // è¿”èˆªé«˜åº¦ï¼šæœºåœºé«˜åº¦+30mï¼Œæœ€å°50m
                    rc_lost_action: 2,  // é¥æ§å™¨å¤±æ§åŠ¨ä½œ: 0-æ‚¬åœ, 1-ç€é™†, 2-è¿”èˆª
                    commander_mode_lost_action: 1,  // æŒ‡ç‚¹é£è¡Œå¤±æ§åŠ¨ä½œ: 0-ç»§ç»­, 1-é€€å‡º
                    commander_flight_mode: 0,  // æŒ‡ç‚¹é£è¡Œæ¨¡å¼: 0-æ™ºèƒ½é«˜åº¦, 1-è®¾å®šé«˜åº¦
                    commander_flight_height: Math.max(100, dockAlt + 50),  // æŒ‡ç‚¹é£è¡Œé«˜åº¦
                    max_speed: parseInt(document.getElementById('maxSpeed').value) || 12,
                    simulate_mission: simData
                });
                
                log(`æ¨¡æ‹Ÿä¸€é”®èµ·é£æŒ‡ä»¤å·²å‘é€${enableSim ? ' (æ¨¡æ‹Ÿå™¨æ¨¡å¼)' : ''}`, 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`æ¨¡æ‹Ÿèµ·é£å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testSimulateFlyTo() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            const targetLat = parseFloat(document.getElementById('simLatitude').value) + 0.002; // ç›®æ ‡ç‚¹åç§»0.002åº¦
            const targetLng = parseFloat(document.getElementById('simLongitude').value) + 0.002;
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/fly-to-point`, 'POST', {
                    fly_to_id: `test_flyto_${Date.now()}`,
                    max_speed: parseInt(document.getElementById('maxSpeed').value),
                    points: [{
                        latitude: targetLat,
                        longitude: targetLng,
                        height: 80  // é£åˆ°80ç±³é«˜åº¦
                    }]
                });
                
                log('æ¨¡æ‹Ÿé£å‘ç›®æ ‡ç‚¹æŒ‡ä»¤å·²å‘é€', 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`æ¨¡æ‹Ÿé£å‘ç›®æ ‡ç‚¹å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åˆå§‹åŒ–
        window.onload = function() {
            loadConfig();
            log('é¡µé¢å·²åŠ è½½ï¼Œç³»ç»Ÿå°±ç»ª', 'success');
            
            // è‡ªåŠ¨åˆ·æ–°HMSå’Œç¯å¢ƒæ•°æ®ï¼ˆå¦‚æœæœ‰è®¾å¤‡SNï¼‰
            const deviceSn = document.getElementById('deviceSn').value;
            if (deviceSn) {
                refreshHMS();
                hmsRefreshInterval = setInterval(refreshHMS, 30000); // 30ç§’åˆ·æ–°ä¸€æ¬¡
                
                // åˆå§‹åŒ–ç¯å¢ƒæ•°æ®
                refreshEnvironmentData();
                startEnvironmentAutoRefresh(); // å¼€å§‹è‡ªåŠ¨åˆ·æ–°ç¯å¢ƒæ•°æ®
                
                // å°è¯•è‡ªåŠ¨è·å–æœºåœºåæ ‡
                setTimeout(() => {
                    getDeviceCoordinates();
                }, 2000); // å»¶æ—¶2ç§’è·å–ï¼Œç­‰å¾…ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ
            }
        };
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateTakeoffButtonText(); // åˆå§‹åŒ–æŒ‰é’®æ–‡å­—
            
            // å¦‚æœå·¥ä½œç©ºé—´IDå·²å¡«å†™ï¼Œè‡ªåŠ¨åŠ è½½èˆªçº¿æ–‡ä»¶åˆ—è¡¨
            const workspaceId = document.getElementById('workspaceId').value;
            if (workspaceId) {
                setTimeout(() => {
                    getWaylineFiles();
                }, 1000); // å»¶è¿Ÿ1ç§’åŠ è½½ï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
            }
        });

        window.onbeforeunload = function() {
            if (drcControlInterval) {
                clearInterval(drcControlInterval);
            }
            if (hmsRefreshInterval) {
                clearInterval(hmsRefreshInterval);
            }
            if (taskMonitorInterval) {
                clearInterval(taskMonitorInterval);
            }
            stopEnvironmentAutoRefresh(); // åœæ­¢ç¯å¢ƒæ•°æ®è‡ªåŠ¨åˆ·æ–°
        };

        // ä»»åŠ¡ç›‘æ§ç›¸å…³åŠŸèƒ½
        let taskMonitorInterval = null;
        let currentMonitorJobId = null;

        // çŠ¶æ€æ˜ å°„
        const taskStatusMap = {
            '-1': { text: 'æœªçŸ¥', class: 'bg-secondary' },
            '0': { text: 'å¾…æ‰§è¡Œ', class: 'bg-info' },
            '1': { text: 'å·²å‘é€', class: 'bg-primary' },
            '2': { text: 'æ‰§è¡Œä¸­', class: 'bg-warning' },
            '3': { text: 'å·²æš‚åœ', class: 'bg-warning' },
            '4': { text: 'å·²å–æ¶ˆ', class: 'bg-secondary' },
            '5': { text: 'å·²å®Œæˆ', class: 'bg-success' },
            '6': { text: 'æ‰§è¡Œå¤±è´¥', class: 'bg-danger' }
        };

        // é€šç”¨çš„æ›´æ–°ä»»åŠ¡ä¸‹æ‹‰é€‰æ‹©æ¡†å‡½æ•°
        function updateJobSelectDropdown(result) {
            const jobSelect = document.getElementById('jobSelect');
            jobSelect.innerHTML = '<option value="">é€‰æ‹©è¦æ‰§è¡Œçš„ä»»åŠ¡...</option>';
            
            // å¤„ç†ä»»åŠ¡åˆ—è¡¨æ•°æ®ç»“æ„
            let jobs = [];
            if (result.data) {
                if (result.data.list && Array.isArray(result.data.list)) {
                    jobs = result.data.list; // {list: Array, pagination: {...}} ç»“æ„
                } else if (result.data.data && Array.isArray(result.data.data)) {
                    jobs = result.data.data; // {data: Array} ç»“æ„
                } else if (Array.isArray(result.data)) {
                    jobs = result.data; // ç›´æ¥æ•°ç»„ç»“æ„
                }
            }
            
            console.log('æ›´æ–°ä¸‹æ‹‰æ¡†ï¼Œä»»åŠ¡åˆ—è¡¨æ•°æ®:', jobs);
            
            if (jobs.length > 0) {
                jobs.forEach(job => {
                    const option = document.createElement('option');
                    option.value = job.job_id;
                    
                    // è·å–çŠ¶æ€æ–‡æœ¬
                    const statusInfo = taskStatusMap[job.status] || taskStatusMap['-1'];
                    const statusText = statusInfo.text;
                    
                    // æˆªå–job_idæ˜¾ç¤ºå‰8ä½
                    const shortJobId = job.job_id ? job.job_id.substring(0, 8) + '...' : 'N/A';
                    
                    option.textContent = `${job.name || 'unnamed'} - ${statusText} (${shortJobId})`;
                    option.title = `å®Œæ•´ID: ${job.job_id}\nçŠ¶æ€: ${statusText}\nåˆ›å»ºæ—¶é—´: ${job.create_time ? new Date(job.create_time).toLocaleString() : 'N/A'}`;
                    
                    jobSelect.appendChild(option);
                });
                log(`å‘ç° ${jobs.length} ä¸ªä»»åŠ¡ï¼Œå·²æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨`, 'success');
            } else {
                log('æš‚æ— ä»»åŠ¡ï¼Œè¯·å…ˆåˆ›å»ºä»»åŠ¡', 'info');
            }
        }

        // æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€
        async function queryTaskStatus() {
            const workspaceId = document.getElementById('workspaceId').value;
            const deviceSn = document.getElementById('deviceSn').value;
            const jobId = document.getElementById('jobSelect').value;
            
            if (!workspaceId) {
                log('è¯·è¾“å…¥å·¥ä½œç©ºé—´ID', 'error');
                return;
            }
            
            if (!deviceSn) {
                log('è¯·è¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                // ä¼˜å…ˆä»Redisè·å–å®æ—¶è¿›åº¦
                const realtimeResult = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/docks/${deviceSn}/progress`);
                
                if (realtimeResult.data) {
                    // æœ‰å®æ—¶è¿›åº¦æ•°æ®
                    updateTaskMonitorUIFromRedis(realtimeResult.data);
                    log('è·å–å®æ—¶è¿›åº¦æˆåŠŸ', 'success');
                } else if (jobId) {
                    // æ²¡æœ‰å®æ—¶è¿›åº¦ï¼Œå›é€€åˆ°æ•°æ®åº“æŸ¥è¯¢
                    const dbResult = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}`);
                    updateTaskMonitorUI(dbResult.data);
                    log('æŸ¥è¯¢æ•°æ®åº“ä»»åŠ¡çŠ¶æ€æˆåŠŸ', 'info');
                } else {
                    // æ²¡æœ‰é€‰æ‹©ä»»åŠ¡ï¼ŒæŸ¥è¯¢æ‰€æœ‰ä»»åŠ¡
                    await refreshJobList();
                    log('æ— è¿è¡Œä¸­ä»»åŠ¡ï¼Œå·²åˆ·æ–°ä»»åŠ¡åˆ—è¡¨', 'info');
                }
                
            } catch (error) {
                log(`æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
                
                // å¦‚æœRedisæŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•æ•°æ®åº“æŸ¥è¯¢
                if (jobId) {
                    try {
                        const dbResult = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}`);
                        updateTaskMonitorUI(dbResult.data);
                        log('å›é€€åˆ°æ•°æ®åº“æŸ¥è¯¢æˆåŠŸ', 'warning');
                    } catch (dbError) {
                        log(`æ•°æ®åº“æŸ¥è¯¢ä¹Ÿå¤±è´¥: ${dbError.message}`, 'error');
                    }
                }
            }
        }

        // æ›´æ–°ä»»åŠ¡ç›‘æ§UIï¼ˆä»Rediså®æ—¶æ•°æ®ï¼‰
        function updateTaskMonitorUIFromRedis(progressData) {
            if (!progressData) return;
            
            currentMonitorJobId = progressData.job_id;
            
            // æ›´æ–°åŸºæœ¬ä¿¡æ¯
            document.getElementById('currentJobId').textContent = progressData.job_id || 'æš‚æ— ';
            
            // DJIçŠ¶æ€æ˜ å°„
            const djiStatusMap = {
                'sent': { text: 'å·²å‘é€', class: 'bg-primary' },
                'in_progress': { text: 'æ‰§è¡Œä¸­', class: 'bg-warning' },
                'ok': { text: 'å·²å®Œæˆ', class: 'bg-success' },
                'paused': { text: 'å·²æš‚åœ', class: 'bg-warning' },
                'rejected': { text: 'å·²æ‹’ç»', class: 'bg-danger' },
                'failed': { text: 'æ‰§è¡Œå¤±è´¥', class: 'bg-danger' },
                'canceled': { text: 'å·²å–æ¶ˆ', class: 'bg-secondary' },
                'timeout': { text: 'è¶…æ—¶', class: 'bg-danger' },
                'partially_done': { text: 'éƒ¨åˆ†å®Œæˆ', class: 'bg-info' }
            };
            
            // æ›´æ–°çŠ¶æ€
            const statusInfo = djiStatusMap[progressData.status] || { text: 'æœªçŸ¥', class: 'bg-secondary' };
            const statusElement = document.getElementById('currentJobStatus');
            statusElement.textContent = statusInfo.text;
            statusElement.className = `badge fs-6 ${statusInfo.class}`;
            
            // æ›´æ–°è¿›åº¦
            const progress = progressData.progress ? progressData.progress.percent : 0;
            const progressBar = document.getElementById('taskProgressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            progressText.textContent = `${progress}%`;
            
            // æ ¹æ®çŠ¶æ€è®¾ç½®è¿›åº¦æ¡æ ·å¼
            progressBar.className = 'progress-bar progress-bar-striped';
            if (progressData.status === 'in_progress') {
                progressBar.classList.add('progress-bar-animated', 'bg-warning');
            } else if (progressData.status === 'ok') {
                progressBar.classList.add('bg-success');
            } else if (progressData.status === 'failed') {
                progressBar.classList.add('bg-danger');
            } else {
                progressBar.classList.add('bg-info');
            }
            
            // æ›´æ–°æ‰©å±•ä¿¡æ¯
            const ext = progressData.ext || {};
            
            // æ›´æ–°è¯¦ç»†ä¿¡æ¯
            const detailsHtml = `
                <div class="row mt-3">
                    <div class="col-md-6">
                        <small><strong>æ‰§è¡Œæ­¥éª¤:</strong> ${progressData.progress ? progressData.progress.current_step : 0}</small><br>
                        <small><strong>å½“å‰èˆªç‚¹:</strong> ${ext.current_waypoint_index || 'N/A'}</small><br>
                        <small><strong>åª’ä½“æ–‡ä»¶:</strong> ${ext.media_count || 0}</small><br>
                    </div>
                    <div class="col-md-6">
                        <small><strong>èˆªçº¿çŠ¶æ€:</strong> ${getWaylineMissionStateText(ext.wayline_mission_state)}</small><br>
                        <small><strong>è½¨è¿¹ID:</strong> ${ext.track_id || 'N/A'}</small><br>
                        <small><strong>æ›´æ–°æ—¶é—´:</strong> ${new Date(progressData.timestamp).toLocaleString()}</small><br>
                    </div>
                </div>
            `;
            
            // æ›´æ–°æˆ–åˆ›å»ºè¯¦ç»†ä¿¡æ¯åŒºåŸŸ
            let detailsElement = document.getElementById('taskDetails');
            if (!detailsElement) {
                detailsElement = document.createElement('div');
                detailsElement.id = 'taskDetails';
                document.querySelector('.card-body').appendChild(detailsElement);
            }
            detailsElement.innerHTML = detailsHtml;
            
            // ç®¡ç†æŸ¥çœ‹åª’ä½“æ–‡ä»¶æŒ‰é’®
            const mediaCount = ext.media_count || 0;
            const mediaCountElement = detailsElement.querySelector('small:nth-child(3)');
            if (mediaCountElement) {
                const mediaContainer = mediaCountElement.parentElement;
                const existingBtn = document.getElementById('viewMediaBtn');
                
                console.log(`Redis Media count: ${mediaCount}, existing button: ${!!existingBtn}`);
                
                if (mediaCount > 0) {
                    if (!existingBtn) {
                        // åˆ›å»ºæŸ¥çœ‹åª’ä½“æ–‡ä»¶æŒ‰é’®
                        const viewBtn = document.createElement('button');
                        viewBtn.id = 'viewMediaBtn';
                        viewBtn.className = 'btn btn-sm btn-primary ms-2';
                        viewBtn.textContent = 'æŸ¥çœ‹åª’ä½“æ–‡ä»¶';
                        viewBtn.onclick = () => viewMediaFiles(progressData.job_id);
                        viewBtn.style.marginLeft = '10px';
                        mediaContainer.appendChild(viewBtn);
                        console.log('Created media files button from Redis data');
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰åª’ä½“æ–‡ä»¶ï¼Œç§»é™¤æŒ‰é’®
                    if (existingBtn) {
                        existingBtn.remove();
                        console.log('Removed media button from Redis data');
                    }
                }
            }
            
            // æ›´æ–°æ§åˆ¶æŒ‰é’®çŠ¶æ€
            updateTaskControlButtons(progressData.status);
            
            // æ·»åŠ å®æ—¶æ ‡è¯†
            const titleElement = document.querySelector('#taskMonitorCard .card-title');
            if (titleElement && !titleElement.textContent.includes('ğŸ”´')) {
                titleElement.textContent = 'ğŸ”´ å®æ—¶ä»»åŠ¡ç›‘æ§';
            }
        }
        
        // è·å–èˆªçº¿ä»»åŠ¡çŠ¶æ€æ–‡æœ¬
        function getWaylineMissionStateText(state) {
            const stateMap = {
                0: 'æ–­çº¿',
                1: 'ä¸æ”¯æŒèˆªç‚¹',
                2: 'å‡†å¤‡ä¸­',
                3: 'ä¸Šä¼ ä¸­',
                4: 'å‡†å¤‡èµ·é£',
                5: 'åˆ°è¾¾é¦–ä¸ªèˆªç‚¹',
                6: 'æ‰§è¡Œä¸­',
                7: 'ä¸­æ–­',
                8: 'æ¢å¤',
                9: 'ç»“æŸ'
            };
            return stateMap[state] || `æœªçŸ¥(${state})`;
        }
        
        // æ›´æ–°ä»»åŠ¡æ§åˆ¶æŒ‰é’®çŠ¶æ€
        function updateTaskControlButtons(status) {
            const pauseBtn = document.querySelector('button[onclick="pauseCurrentTask()"]');
            const resumeBtn = document.querySelector('button[onclick="resumeCurrentTask()"]');
            const cancelBtn = document.querySelector('button[onclick="cancelCurrentTask()"]');
            
            if (pauseBtn) pauseBtn.disabled = (status !== 'in_progress');
            if (resumeBtn) resumeBtn.disabled = (status !== 'paused');
            if (cancelBtn) cancelBtn.disabled = !['in_progress', 'paused', 'sent'].includes(status);
        }

        // æ›´æ–°ä»»åŠ¡ç›‘æ§UIï¼ˆä»æ•°æ®åº“æ•°æ®ï¼‰
        function updateTaskMonitorUI(jobData) {
            if (!jobData) return;
            
            currentMonitorJobId = jobData.job_id;
            
            // æ›´æ–°åŸºæœ¬ä¿¡æ¯
            document.getElementById('currentJobId').textContent = jobData.job_id || 'æš‚æ— ';
            
            // æ›´æ–°çŠ¶æ€
            const statusInfo = taskStatusMap[jobData.status] || taskStatusMap['-1'];
            const statusElement = document.getElementById('currentJobStatus');
            statusElement.textContent = statusInfo.text;
            statusElement.className = `badge fs-6 ${statusInfo.class}`;
            
            // æ›´æ–°è¿›åº¦
            const progress = jobData.progress || 0;
            const progressBar = document.getElementById('taskProgressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            progressText.textContent = `${progress}%`;
            
            // æ ¹æ®çŠ¶æ€è®¾ç½®è¿›åº¦æ¡æ ·å¼
            progressBar.className = 'progress-bar progress-bar-striped';
            if (jobData.status == 2) { // æ‰§è¡Œä¸­
                progressBar.classList.add('progress-bar-animated', 'bg-success');
            } else if (jobData.status == 5) { // å·²å®Œæˆ
                progressBar.classList.add('bg-success');
            } else if (jobData.status == 6) { // å¤±è´¥
                progressBar.classList.add('bg-danger');
            }
            
            // æ›´æ–°æ—¶é—´ä¿¡æ¯
            document.getElementById('executeTime').textContent = jobData.execute_time ? 
                new Date(jobData.execute_time).toLocaleString() : '-';
            document.getElementById('completedTime').textContent = jobData.completed_time ? 
                new Date(jobData.completed_time).toLocaleString() : '-';
            
            // æ›´æ–°åª’ä½“æ–‡ä»¶ä¿¡æ¯
            const mediaCount = jobData.media_count || 0;
            document.getElementById('mediaFileCount').textContent = mediaCount;
            
            // ç®¡ç†æŸ¥çœ‹åª’ä½“æ–‡ä»¶æŒ‰é’®
            const mediaContainer = document.getElementById('mediaFileCount').parentElement;
            const existingBtn = document.getElementById('viewMediaBtn');
            
            console.log(`Media count: ${mediaCount}, existing button: ${!!existingBtn}`);
            
            if (mediaCount > 0) {
                if (!existingBtn) {
                    // åˆ›å»ºæŸ¥çœ‹åª’ä½“æ–‡ä»¶æŒ‰é’®
                    const viewBtn = document.createElement('button');
                    viewBtn.id = 'viewMediaBtn';
                    viewBtn.className = 'btn btn-sm btn-primary ms-2';
                    viewBtn.textContent = 'æŸ¥çœ‹åª’ä½“æ–‡ä»¶';
                    viewBtn.onclick = () => viewMediaFiles(jobData.job_id);
                    mediaContainer.appendChild(viewBtn);
                    console.log('Created media files button');
                } else {
                    console.log('Media button already exists');
                }
            } else {
                // å¦‚æœæ²¡æœ‰åª’ä½“æ–‡ä»¶ï¼Œç§»é™¤æŒ‰é’®
                if (existingBtn) {
                    existingBtn.remove();
                    console.log('Removed media button');
                }
            }
            
            // æ›´æ–°ä»»åŠ¡è¯¦æƒ…
            const details = [
                `ä»»åŠ¡åç§°: ${jobData.name || 'æœªçŸ¥'}`,
                `æ–‡ä»¶ID: ${jobData.file_id || 'æœªçŸ¥'}`,
                `æœºåœºSN: ${jobData.dock_sn || 'æœªçŸ¥'}`,
                `ä»»åŠ¡ç±»å‹: ${getTaskTypeName(jobData.task_type)}`,
                `è¿”èˆªé«˜åº¦: ${jobData.rth_altitude || 0}m`,
                `åˆ›å»ºæ—¶é—´: ${jobData.create_time ? new Date(jobData.create_time).toLocaleString() : 'æœªçŸ¥'}`
            ];
            
            if (jobData.error_code) {
                details.push(`é”™è¯¯ç : ${jobData.error_code}`);
            }
            
            document.getElementById('taskDetails').innerHTML = details.join('<br>');
            
            // æ˜¾ç¤º/éšè—æ“ä½œæŒ‰é’®
            const taskActions = document.getElementById('taskActions');
            const pauseBtn = document.getElementById('pauseTaskBtn');
            const resumeBtn = document.getElementById('resumeTaskBtn');
            
            if (jobData.status == 2) { // æ‰§è¡Œä¸­ï¼Œæ˜¾ç¤ºæš‚åœæŒ‰é’®
                taskActions.style.display = 'block';
                pauseBtn.style.display = 'inline-block';
                resumeBtn.style.display = 'none';
            } else if (jobData.status == 3) { // æš‚åœä¸­ï¼Œæ˜¾ç¤ºæ¢å¤æŒ‰é’®
                taskActions.style.display = 'block';
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'inline-block';
            } else if (jobData.status == 0 || jobData.status == 1) { // å¾…æ‰§è¡Œæˆ–å·²å‘é€
                taskActions.style.display = 'block';
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'none';
            } else { // å…¶ä»–çŠ¶æ€éšè—æ“ä½œæŒ‰é’®
                taskActions.style.display = 'none';
            }
        }

        // è·å–ä»»åŠ¡ç±»å‹åç§°
        function getTaskTypeName(taskType) {
            const types = { 0: 'ç«‹å³æ‰§è¡Œ', 1: 'å®šæ—¶æ‰§è¡Œ', 2: 'æ¡ä»¶æ‰§è¡Œ' };
            return types[taskType] || 'æœªçŸ¥';
        }
        
        // æŸ¥çœ‹åª’ä½“æ–‡ä»¶
        async function viewMediaFiles(jobId) {
            try {
                const response = await apiRequest(`/api/v1/media/files?job_id=${jobId}`);
                if (response.code === 0 && response.data && response.data.data) {
                    showMediaFilesModal(response.data.data, jobId);
                } else {
                    log(`æŸ¥è¯¢åª’ä½“æ–‡ä»¶å¤±è´¥: ${response.message || 'æœªæ‰¾åˆ°åª’ä½“æ–‡ä»¶'}`, 'error');
                }
            } catch (error) {
                log(`æŸ¥è¯¢åª’ä½“æ–‡ä»¶å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ˜¾ç¤ºåª’ä½“æ–‡ä»¶æ¨¡æ€æ¡†
        function showMediaFilesModal(files, flightId) {
            // åˆ›å»ºæ¨¡æ€æ¡†HTML
            const modalHtml = `
                <div class="modal fade" id="mediaFilesModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">åª’ä½“æ–‡ä»¶åˆ—è¡¨ (èˆªçº¿ä»»åŠ¡: ${flightId})</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${files.length === 0 ? 
                                    '<p class="text-center text-muted">æš‚æ— åª’ä½“æ–‡ä»¶</p>' :
                                    `<div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>æ–‡ä»¶å</th>
                                                    <th>ç±»å‹</th>
                                                    <th>å¤§å°</th>
                                                    <th>æ‹æ‘„æ—¶é—´</th>
                                                    <th>æ“ä½œ</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${files.map(file => `
                                                    <tr>
                                                        <td>${file.file_name}</td>
                                                        <td>
                                                            <span class="badge bg-${file.file_type === 'photo' ? 'primary' : 'info'}">
                                                                ${file.file_type === 'photo' ? 'ç…§ç‰‡' : 'è§†é¢‘'}
                                                            </span>
                                                        </td>
                                                        <td>${formatFileSize(file.file_size || 0)}</td>
                                                        <td>${file.created_time ? new Date(file.created_time).toLocaleString() : '-'}</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-primary" onclick="downloadMediaFile('${file.file_id}', '${file.file_name}')">
                                                                ä¸‹è½½
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>`
                                }
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ç§»é™¤æ—§çš„æ¨¡æ€æ¡†
            const oldModal = document.getElementById('mediaFilesModal');
            if (oldModal) {
                oldModal.remove();
            }
            
            // æ·»åŠ æ–°æ¨¡æ€æ¡†åˆ°body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            const modal = new bootstrap.Modal(document.getElementById('mediaFilesModal'));
            modal.show();
        }
        
        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // ä¸‹è½½åª’ä½“æ–‡ä»¶
        async function downloadMediaFile(fileId, fileName) {
            try {
                const token = localStorage.getItem('access_token');
                const downloadUrl = `/api/v1/media/download/${fileId}`;
                
                // åˆ›å»ºä¸€ä¸ªéšè—çš„aæ ‡ç­¾æ¥è§¦å‘ä¸‹è½½
                const a = document.createElement('a');
                a.href = `${downloadUrl}?token=${token}`;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                log(`å¼€å§‹ä¸‹è½½: ${fileName}`, 'info');
            } catch (error) {
                log(`ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // åˆ‡æ¢è‡ªåŠ¨åˆ·æ–°
        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (taskMonitorInterval) {
                clearInterval(taskMonitorInterval);
                taskMonitorInterval = null;
                btn.textContent = 'å¯åŠ¨è‡ªåŠ¨åˆ·æ–°';
                btn.className = 'btn btn-outline-secondary';
                log('å·²åœæ­¢è‡ªåŠ¨åˆ·æ–°', 'info');
            } else {
                taskMonitorInterval = setInterval(queryTaskStatus, 3000); // æ¯3ç§’åˆ·æ–°
                btn.textContent = 'åœæ­¢è‡ªåŠ¨åˆ·æ–°';
                btn.className = 'btn btn-outline-danger';
                log('å·²å¯åŠ¨è‡ªåŠ¨åˆ·æ–° (æ¯3ç§’)', 'success');
                queryTaskStatus(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
            }
        }

        // æš‚åœå½“å‰ä»»åŠ¡
        async function pauseCurrentTask() {
            if (!currentMonitorJobId) {
                log('æ²¡æœ‰å½“å‰ç›‘æ§çš„ä»»åŠ¡', 'error');
                return;
            }
            
            const workspaceId = document.getElementById('workspaceId').value;
            try {
                await pauseWaylineJob();
                log('ä»»åŠ¡æš‚åœæŒ‡ä»¤å·²å‘é€', 'success');
                setTimeout(queryTaskStatus, 1000); // 1ç§’ååˆ·æ–°çŠ¶æ€
            } catch (error) {
                log(`æš‚åœä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æ¢å¤å½“å‰ä»»åŠ¡
        async function resumeCurrentTask() {
            if (!currentMonitorJobId) {
                log('æ²¡æœ‰å½“å‰ç›‘æ§çš„ä»»åŠ¡', 'error');
                return;
            }
            
            try {
                const workspaceId = document.getElementById('workspaceId').value;
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${currentMonitorJobId}/resume`, 'POST');
                log('ä»»åŠ¡æ¢å¤æŒ‡ä»¤å·²å‘é€', 'success');
                setTimeout(queryTaskStatus, 1000); // 1ç§’ååˆ·æ–°çŠ¶æ€
            } catch (error) {
                log(`æ¢å¤ä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // å–æ¶ˆå½“å‰ä»»åŠ¡
        async function cancelCurrentTask() {
            if (!currentMonitorJobId) {
                log('æ²¡æœ‰å½“å‰ç›‘æ§çš„ä»»åŠ¡', 'error');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦å–æ¶ˆå½“å‰ä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }
            
            try {
                await cancelWaylineJob();
                log('ä»»åŠ¡å–æ¶ˆæŒ‡ä»¤å·²å‘é€', 'success');
                setTimeout(queryTaskStatus, 1000); // 1ç§’ååˆ·æ–°çŠ¶æ€
            } catch (error) {
                log(`å–æ¶ˆä»»åŠ¡å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è®¾ç½®åª’ä½“ä¼˜å…ˆä¸Šä¼ 
        async function setMediaPriority() {
            if (!currentMonitorJobId) {
                log('æ²¡æœ‰å½“å‰ç›‘æ§çš„ä»»åŠ¡', 'error');
                return;
            }
            
            const workspaceId = document.getElementById('workspaceId').value;
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${currentMonitorJobId}/media-priority`, 'POST');
                log('åª’ä½“ä¼˜å…ˆä¸Šä¼ å·²è®¾ç½®', 'success');
            } catch (error) {
                log(`è®¾ç½®åª’ä½“ä¼˜å…ˆä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ä¿®æ”¹æ‰§è¡Œä»»åŠ¡å‡½æ•°ï¼Œæ‰§è¡Œåè‡ªåŠ¨å¼€å§‹ç›‘æ§
        const originalExecuteWaylineJob = executeWaylineJob;
        executeWaylineJob = async function() {
            await originalExecuteWaylineJob();
            
            // æ‰§è¡ŒæˆåŠŸåå¼€å§‹ç›‘æ§
            const jobId = document.getElementById('jobSelect').value;
            if (jobId) {
                currentMonitorJobId = jobId;
                setTimeout(() => {
                    queryTaskStatus();
                    if (!taskMonitorInterval) {
                        toggleAutoRefresh(); // è‡ªåŠ¨å¼€å¯ç›‘æ§
                    }
                }, 2000);
            }
        };

        // ==========================================
        // DRCæ§åˆ¶ç›¸å…³çš„JavaScriptå‡½æ•°
        // ==========================================

        // DRCçŠ¶æ€ç®¡ç†
        let drcWebSocket = null;
        let drcSessionInfo = null;
        let drcHeartbeatInterval = null;
        let drcTestMode = false;

        // DRCä¼šè¯ç®¡ç†å‡½æ•°
        async function enterDrcMode() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                drcLog('è¯·å…ˆè¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const osdFreq = parseInt(document.getElementById('drcOsdFreq').value);
                const hsiFreq = parseInt(document.getElementById('drcHsiFreq').value);
                
                drcLog(`æ­£åœ¨è¿›å…¥DRCæ¨¡å¼ (OSD:${osdFreq}Hz, HSI:${hsiFreq}Hz)...`, 'info');
                
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/enter`, 'POST', {
                    osd_frequency: osdFreq,
                    hsi_frequency: hsiFreq
                });
                
                if (result.code === 0) {
                    drcSessionInfo = result.data;
                    updateDrcSessionStatus('active', result.data);
                    drcLog('æˆåŠŸè¿›å…¥DRCæ¨¡å¼', 'success');
                    drcLog(`ä¼šè¯ID: ${result.data.session_id}`, 'info');
                    
                    // è‡ªåŠ¨è¿æ¥WebSocket
                    setTimeout(() => connectDrcWebSocket(), 1000);
                } else {
                    drcLog(`è¿›å…¥DRCæ¨¡å¼å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`è¿›å…¥DRCæ¨¡å¼å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function exitDrcMode() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                drcLog('è¯·å…ˆè¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                drcLog('æ­£åœ¨é€€å‡ºDRCæ¨¡å¼...', 'info');
                
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/exit`, 'POST');
                
                if (result.code === 0) {
                    updateDrcSessionStatus('inactive', null);
                    drcLog('æˆåŠŸé€€å‡ºDRCæ¨¡å¼', 'success');
                    
                    // æ–­å¼€WebSocketè¿æ¥
                    if (drcWebSocket) {
                        disconnectDrcWebSocket();
                    }
                } else {
                    drcLog(`é€€å‡ºDRCæ¨¡å¼å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`é€€å‡ºDRCæ¨¡å¼å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function getDrcStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                drcLog('è¯·å…ˆè¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/status`, 'GET');
                
                if (result.code === 0) {
                    const { drc_mode, session } = result.data;
                    updateDrcSessionStatus(drc_mode, session);
                    drcLog(`DRCçŠ¶æ€: ${drc_mode}`, 'info');
                    
                    if (session) {
                        drcLog(`ä¼šè¯è¯¦æƒ…: ${JSON.stringify(session, null, 2)}`, 'info');
                    }
                } else {
                    drcLog(`è·å–DRCçŠ¶æ€å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`è·å–DRCçŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function drcEmergencyStop() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                drcLog('è¯·å…ˆè¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            try {
                drcLog('å‘é€DRCç´§æ€¥åœæ­¢æŒ‡ä»¤...', 'warning');
                
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/control/emergency-stop`, 'POST');
                
                if (result.code === 0) {
                    drcLog('DRCç´§æ€¥åœæ­¢æŒ‡ä»¤å‘é€æˆåŠŸ', 'success');
                    drcLog(`æŒ‡ä»¤åºå·: ${result.data.seq}`, 'info');
                } else {
                    drcLog(`DRCç´§æ€¥åœæ­¢å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`DRCç´§æ€¥åœæ­¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // DRCæ†é‡æ§åˆ¶å‡½æ•°
        function updateDrcValue(channel) {
            const slider = document.getElementById(`${channel}Slider`);
            const valueSpan = document.getElementById(`${channel}Value`);
            valueSpan.textContent = slider.value;
            
            // å®æ—¶å‘é€æ§åˆ¶æŒ‡ä»¤ï¼ˆå¦‚æœåœ¨æµ‹è¯•æ¨¡å¼ä¸‹ï¼‰
            if (drcTestMode) {
                sendStickControl();
            }
        }

        async function sendStickControl() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                drcLog('è¯·å…ˆè¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            
            
            try {
                const stickData = {
                    roll: parseInt(document.getElementById('rollSlider').value),
                    pitch: parseInt(document.getElementById('pitchSlider').value),
                    throttle: parseInt(document.getElementById('throttleSlider').value),
                    yaw: parseInt(document.getElementById('yawSlider').value)
                };
                
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/control/stick`, 'POST', stickData);
                
                if (result.code === 0) {
                    drcLog(`æ†é‡æ§åˆ¶å‘é€æˆåŠŸ - Roll:${stickData.roll}, Pitch:${stickData.pitch}, Throttle:${stickData.throttle}, Yaw:${stickData.yaw}`, 'success');
                } else {
                    drcLog(`æ†é‡æ§åˆ¶å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`æ†é‡æ§åˆ¶å¤±è´¥: ${error.message}`, 'error');
            }
        }

        function resetAllSticks() {
            const channels = ['roll', 'pitch', 'throttle', 'yaw'];
            channels.forEach(channel => {
                const slider = document.getElementById(`${channel}Slider`);
                const valueSpan = document.getElementById(`${channel}Value`);
                slider.value = 1024;
                valueSpan.textContent = '1024';
            });
            drcLog('æ‰€æœ‰æ‘‡æ†å·²é‡ç½®åˆ°ä¸­ä½(1024) - ç¬¦åˆDJIå®˜æ–¹æ ‡å‡†', 'info');
        }

        function testStickControl() {
            drcTestMode = !drcTestMode;
            const button = event.target;
            
            if (drcTestMode) {
                button.textContent = 'é€€å‡ºæµ‹è¯•æ¨¡å¼';
                button.className = 'btn btn-warning btn-sm';
                drcLog('è¿›å…¥æµ‹è¯•æ¨¡å¼ - æ»‘åŠ¨æ‘‡æ†å°†å®æ—¶å‘é€æ§åˆ¶æŒ‡ä»¤', 'warning');
            } else {
                button.textContent = 'æµ‹è¯•æ¨¡å¼';
                button.className = 'btn btn-info btn-sm';
                drcLog('é€€å‡ºæµ‹è¯•æ¨¡å¼', 'info');
            }
        }

        // DRCå¿«æ·é¢„è®¾å‡½æ•°
        function presetTakeoff() {
            document.getElementById('throttleSlider').value = 1400; // ä¸Šå‡
            updateDrcValue('throttle');
            drcLog('é¢„è®¾: èµ·é£å§¿æ€', 'info');
        }

        function presetHover() {
            resetAllSticks();
            drcLog('é¢„è®¾: æ‚¬åœå§¿æ€', 'info');
        }

        function presetLand() {
            document.getElementById('throttleSlider').value = 600; // ä¸‹é™
            updateDrcValue('throttle');
            drcLog('é¢„è®¾: é™è½å§¿æ€', 'info');
        }

        function presetRotateLeft() {
            document.getElementById('yawSlider').value = 700; // å·¦è½¬
            updateDrcValue('yaw');
            drcLog('é¢„è®¾: å·¦è½¬å§¿æ€', 'info');
        }

        function presetRotateRight() {
            document.getElementById('yawSlider').value = 1300; // å³è½¬
            updateDrcValue('yaw');
            drcLog('é¢„è®¾: å³è½¬å§¿æ€', 'info');
        }

        // DRC WebSocketè¿æ¥å‡½æ•°
        function connectDrcWebSocket() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                drcLog('è¯·å…ˆè¾“å…¥è®¾å¤‡SN', 'error');
                return;
            }
            

            
            try {
                // æ­£ç¡®æ„å»ºWebSocket URL
                let apiUrl = document.getElementById('apiUrl').value || 'http://192.168.111.49:8000';
                apiUrl = apiUrl.replace(/\/$/, ''); // ç§»é™¤æœ«å°¾æ–œæ 
                
                // è½¬æ¢HTTP/HTTPSä¸ºWS/WSS
                const wsUrl = apiUrl.replace('http://', 'ws://').replace('https://', 'wss://') + `/api/v1/drc/devices/${deviceSn}/drc/ws`;
                
                console.log('APIåœ°å€:', apiUrl);
                console.log('WebSocket URL:', wsUrl);
                drcLog(`æ­£åœ¨è¿æ¥WebSocket: ${wsUrl}`, 'info');
                
                drcWebSocket = new WebSocket(wsUrl);
                
                drcWebSocket.onopen = function(event) {
                    drcLog('DRC WebSocketè¿æ¥å·²å»ºç«‹', 'success');
                    document.getElementById('wsConnectionStatus').textContent = 'å·²è¿æ¥';
                    document.getElementById('wsConnectionStatus').className = 'badge bg-success';
                    
                    // å‘é€è®¤è¯ä¿¡æ¯
                    const authData = {
                        token: document.getElementById('apiToken').value || 'test-token'
                    };
                    drcWebSocket.send(JSON.stringify(authData));
                };
                
                drcWebSocket.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        handleDrcWebSocketMessage(message);
                        
                        // æ›´æ–°æ¶ˆæ¯è®¡æ•°
                        const countSpan = document.getElementById('wsMessageCount');
                        countSpan.textContent = parseInt(countSpan.textContent) + 1;
                        
                    } catch (error) {
                        drcLog(`WebSocketæ¶ˆæ¯è§£æå¤±è´¥: ${error.message}`, 'error');
                    }
                };
                
                drcWebSocket.onclose = function(event) {
                    drcLog('DRC WebSocketè¿æ¥å·²å…³é—­', 'warning');
                    document.getElementById('wsConnectionStatus').textContent = 'å·²æ–­å¼€';
                    document.getElementById('wsConnectionStatus').className = 'badge bg-secondary';
                };
                
                drcWebSocket.onerror = function(error) {
                    console.error('WebSocketé”™è¯¯è¯¦æƒ…:', error);
                    drcLog(`DRC WebSocketé”™è¯¯: è¿æ¥å¤±è´¥`, 'error');
                    document.getElementById('wsConnectionStatus').textContent = 'è¿æ¥å¤±è´¥';
                    document.getElementById('wsConnectionStatus').className = 'badge bg-danger';
                };
                
            } catch (error) {
                console.error('WebSocketåˆ›å»ºå¤±è´¥:', error);
                drcLog(`è¿æ¥DRC WebSocketå¤±è´¥: ${error.message}`, 'error');
                drcLog(`è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒæœåŠ¡å™¨çŠ¶æ€`, 'warning');
                
                // æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯
                const apiUrl = document.getElementById('apiUrl').value;
                drcLog(`å½“å‰APIåœ°å€: ${apiUrl}`, 'info');
                drcLog(`å¦‚æœä½¿ç”¨ZeroTierï¼Œè¯·ç¡®ä¿ç½‘ç»œè¿é€šæ€§`, 'info');
            }
        }

        function disconnectDrcWebSocket() {
            if (drcWebSocket) {
                drcWebSocket.close();
                drcWebSocket = null;
                drcLog('DRC WebSocketè¿æ¥å·²æ–­å¼€', 'info');
            }
        }

        // DRC WebSocketæ¶ˆæ¯å¤„ç†
        function handleDrcWebSocketMessage(message) {
            const { type, data, method } = message;
            
            switch (type) {
                case 'session':
                    drcLog(`WebSocketä¼šè¯å»ºç«‹: ${JSON.stringify(data)}`, 'info');
                    break;
                    
                case 'heartbeat':
                    // ä¸è®°å½•å¿ƒè·³æ—¥å¿—ï¼Œé¿å…åˆ·å±
                    document.getElementById('drcLastHeartbeat').textContent = new Date().toLocaleTimeString();
                    break;
                    
                case 'drc_up_message':
                    handleDrcUpMessage(method, data);
                    break;
                    
                case 'drc_status_notify':
                    drcLog(`DRCçŠ¶æ€é€šçŸ¥: ${JSON.stringify(data)}`, 'info');
                    break;
                    
                case 'drone_state':
                    drcLog(`æ— äººæœºçŠ¶æ€: ${JSON.stringify(data)}`, 'debug');
                    updateOsdDisplay(data);
                    break;
                    
                case 'high_frequency_osd':
                    // é«˜é¢‘OSDä¿¡æ¯ï¼Œæ›´æ–°å®æ—¶æ•°æ®æ˜¾ç¤ºä½†ä¸è®°å½•æ—¥å¿—é¿å…åˆ·å±
                    updateOsdDisplay(data);
                    break;
                    
                case 'osd_data':
                    // OSDå®æ—¶æ•°æ®ï¼Œæ›´æ–°æ˜¾ç¤ºä½†ä¸è®°å½•æ—¥å¿—é¿å…åˆ·å±
                    updateOsdDisplay(data);
                    break;
                    
                case 'delay_info':
                    drcLog(`å»¶æ—¶ä¿¡æ¯: ${JSON.stringify(data)}`, 'debug');
                    updateDelayDisplay(data);
                    break;
                    
                case 'obstacle_avoidance':
                    drcLog(`é¿éšœä¿¡æ¯: ${JSON.stringify(data)}`, 'debug');
                    updateHsiDisplay(data);
                    break;
                    
                case 'error':
                    drcLog(`WebSocketé”™è¯¯: ${message.message}`, 'error');
                    break;
                    
                default:
                    drcLog(`æœªçŸ¥WebSocketæ¶ˆæ¯ç±»å‹: ${type}`, 'warning');
            }
        }

        // DRCä¸Šè¡Œæ¶ˆæ¯å¤„ç†
        function handleDrcUpMessage(method, data) {
            switch (method) {
                case 'osd_info_push':
                    updateOsdDisplay(data);
                    break;
                    
                case 'hsi_info_push':
                    updateHsiDisplay(data);
                    break;
                    
                case 'delay_info_push':
                    updateDelayDisplay(data);
                    break;
                    
                case 'drc_status_notify':
                    drcLog(`DRCçŠ¶æ€é€šçŸ¥: ${JSON.stringify(data)}`, 'info');
                    break;
                    
                case 'joystick_invalid_notify':
                    drcLog(`æ‘‡æ†æ§åˆ¶æ— æ•ˆ: ${JSON.stringify(data)}`, 'warning');
                    break;
                    
                default:
                    drcLog(`æœªçŸ¥DRCä¸Šè¡Œæ¶ˆæ¯: ${method}`, 'info');
            }
        }

        // æ›´æ–°æ˜¾ç¤ºå‡½æ•°
        function updateOsdDisplay(data) {
            document.getElementById('drcPosition').textContent = 
                `${data.latitude?.toFixed(6) || 0}, ${data.longitude?.toFixed(6) || 0}`;
            document.getElementById('drcHeight').textContent = data.height?.toFixed(1) || '0';
            document.getElementById('drcAttitude').textContent = data.attitude_head?.toFixed(1) || '0';
            document.getElementById('drcVelocity').textContent = 
                Math.sqrt((data.speed_x || 0)**2 + (data.speed_y || 0)**2 + (data.speed_z || 0)**2).toFixed(1);
            document.getElementById('drcGimbalP').textContent = data.gimbal_pitch?.toFixed(1) || '0';
            document.getElementById('drcGimbalY').textContent = data.gimbal_yaw?.toFixed(1) || '0';
        }

        function updateHsiDisplay(data) {
            const updateHsiStatus = (elementId, distance, working) => {
                const element = document.getElementById(elementId);
                if (working && distance < 5000) { // 5ç±³è­¦å‘Š
                    element.textContent = `${(distance/1000).toFixed(1)}m`;
                    element.className = 'badge bg-warning';
                } else if (working) {
                    element.textContent = 'æ­£å¸¸';
                    element.className = 'badge bg-success';
                } else {
                    element.textContent = 'å…³é—­';
                    element.className = 'badge bg-secondary';
                }
            };
            
            updateHsiStatus('hsiUp', data.up_distance, data.up_work);
            updateHsiStatus('hsiDown', data.down_distance, data.down_work);
            updateHsiStatus('hsiFront', 0, data.front_work);
            updateHsiStatus('hsiBack', 0, data.back_work);
            updateHsiStatus('hsiSide', 0, data.left_work || data.right_work);
        }

        function updateDelayDisplay(data) {
            document.getElementById('cmdDelay').textContent = data.sdr_cmd_delay || '0';
            
            const videoDelays = data.liveview_delay_list || [];
            const avgDelay = videoDelays.length > 0 ? 
                videoDelays.reduce((sum, item) => sum + (item.delay || 0), 0) / videoDelays.length : 0;
            document.getElementById('videoDelay').textContent = avgDelay.toFixed(0);
            
            // å»¶æ—¶é¢œè‰²æŒ‡ç¤º
            const cmdDelayElement = document.getElementById('cmdDelay');
            const videoDelayElement = document.getElementById('videoDelay');
            
            cmdDelayElement.className = data.sdr_cmd_delay > 200 ? 'badge bg-warning' : 'badge bg-success';
            videoDelayElement.className = avgDelay > 150 ? 'badge bg-warning' : 'badge bg-success';
        }

        function updateDrcSessionStatus(status, sessionData) {
            const statusElement = document.getElementById('drcSessionStatus');
            const sessionIdElement = document.getElementById('drcSessionId');
            
            if (status === 'active') {
                statusElement.textContent = 'å·²æ¿€æ´»';
                statusElement.className = 'badge bg-success';
                sessionIdElement.textContent = sessionData?.session_id || '-';
                drcSessionInfo = sessionData;
            } else {
                statusElement.textContent = 'æœªæ¿€æ´»';
                statusElement.className = 'badge bg-secondary';
                sessionIdElement.textContent = '-';
                drcSessionInfo = null;
            }
        }

        // ==========================================
        // ç®€åŒ–DRCæ§åˆ¶å‡½æ•°
        // ==========================================
        
        // ä½¿ç”¨å·²å­˜åœ¨çš„drcControlIntervalå˜é‡ï¼Œæ·»åŠ æ–°çš„æ§åˆ¶çŠ¶æ€å˜é‡
        let currentDrcControl = { forward: 0, right: 0, up: 0, turn_right: 0 };
        
        // è¿›å…¥DRCæ¨¡å¼
        async function enterDrcMode() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/enter`, 'POST', {
                    osd_frequency: 10,
                    hsi_frequency: 4
                });
                if (result.code === 0) {
                    document.getElementById('drcStatus').textContent = 'å·²æ¿€æ´»';
                    document.getElementById('drcSimpleControl').style.display = 'block';
                    drcLog(`DRCæ¨¡å¼å·²æ¿€æ´»: ${JSON.stringify(result.data)}`, 'success');
                } else {
                    alert(`è¿›å…¥DRCæ¨¡å¼å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                    drcLog(`è¿›å…¥DRCæ¨¡å¼å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                alert(`è¿›å…¥DRCæ¨¡å¼å¤±è´¥: ${error.message}`);
                drcLog(`è¿›å…¥DRCæ¨¡å¼å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é€€å‡ºDRCæ¨¡å¼
        async function exitDrcMode() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/exit`, 'POST');
                if (result.code === 0) {
                    document.getElementById('drcStatus').textContent = 'æœªæ¿€æ´»';
                    document.getElementById('drcSimpleControl').style.display = 'none';
                    drcLog('DRCæ¨¡å¼å·²é€€å‡º', 'success');
                    
                    // åœæ­¢æ§åˆ¶
                    stopDrcControl();
                } else {
                    alert(`é€€å‡ºDRCæ¨¡å¼å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                    drcLog(`é€€å‡ºDRCæ¨¡å¼å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                alert(`é€€å‡ºDRCæ¨¡å¼å¤±è´¥: ${error.message}`);
                drcLog(`é€€å‡ºDRCæ¨¡å¼å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // è·å–DRCçŠ¶æ€
        async function getDrcStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/status`, 'GET');
                if (result.code === 0) {
                    const isActive = result.data.drc_mode === 'active';
                    document.getElementById('drcStatus').textContent = isActive ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»';
                    document.getElementById('drcSimpleControl').style.display = isActive ? 'block' : 'none';
                    drcLog(`DRCçŠ¶æ€: ${result.data.drc_mode}`, 'info');
                } else {
                    drcLog(`è·å–DRCçŠ¶æ€å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`è·å–DRCçŠ¶æ€å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // å¼€å§‹DRCæ§åˆ¶
        function startDrcControl(direction, speed) {
            // é‡ç½®æ‰€æœ‰æ§åˆ¶å€¼
            currentDrcControl = { forward: 0, right: 0, up: 0, turn_right: 0 };
            
            // è®¾ç½®å¯¹åº”æ–¹å‘çš„æ§åˆ¶å€¼
            switch(direction) {
                case 'forward':
                    currentDrcControl.forward = speed;
                    break;
                case 'backward':
                    currentDrcControl.forward = -speed;
                    break;
                case 'left':
                    currentDrcControl.right = -speed;
                    break;
                case 'right':
                    currentDrcControl.right = speed;
                    break;
                case 'up':
                    currentDrcControl.up = speed;
                    break;
                case 'down':
                    currentDrcControl.up = -speed;
                    break;
                case 'turn_left':
                    currentDrcControl.turn_right = -speed;
                    break;
                case 'turn_right':
                    currentDrcControl.turn_right = speed;
                    break;
            }
            
            // å¼€å§‹å‘é€æ§åˆ¶æŒ‡ä»¤ (10Hzé¢‘ç‡)
            if (drcControlInterval) {
                clearInterval(drcControlInterval);
            }
            
            drcControlInterval = setInterval(() => {
                sendSimpleDrcControl(currentDrcControl);
            }, 100); // 100ms = 10Hz
            
            // ç«‹å³å‘é€ä¸€æ¬¡
            sendSimpleDrcControl(currentDrcControl);
        }
        
        // åœæ­¢DRCæ§åˆ¶
        function stopDrcControl() {
            if (drcControlInterval) {
                clearInterval(drcControlInterval);
                drcControlInterval = null;
            }
            
            // å‘é€åœæ­¢æŒ‡ä»¤
            const stopControl = { forward: 0, right: 0, up: 0, turn_right: 0 };
            sendSimpleDrcControl(stopControl);
            currentDrcControl = stopControl;
        }
        
        // å‘é€ç®€åŒ–DRCæ§åˆ¶æŒ‡ä»¤
        async function sendSimpleDrcControl(controlData) {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) return;
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/control/simple`, 'POST', controlData);
                if (result.code === 0) {
                    // æ›´æ–°æ§åˆ¶çŠ¶æ€æ˜¾ç¤º
                    const statusText = `æ§åˆ¶æŒ‡ä»¤: forward=${controlData.forward}, right=${controlData.right}, up=${controlData.up}, turn_right=${controlData.turn_right}
DJIæ†é‡: ${JSON.stringify(result.data.converted_stick_data, null, 2)}
å‘é€æ—¶é—´: ${new Date().toLocaleTimeString()}`;
                    document.getElementById('drcControlStatus').textContent = statusText;
                } else {
                    drcLog(`DRCæ§åˆ¶å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`DRCæ§åˆ¶å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ›´æ–°DRCé€Ÿåº¦å€¼æ˜¾ç¤º
        function updateDrcSpeedValue(type) {
            const slider = document.getElementById(`${type}SpeedSlider`);
            const valueDisplay = document.getElementById(`${type}SpeedValue`);
            valueDisplay.textContent = slider.value;
        }
        
        // å‘é€DRCæ§åˆ¶æŒ‡ä»¤ (åŸºäºæ»‘æ†)
        function sendDrcControl() {
            const controlData = {
                forward: parseFloat(document.getElementById('forwardSpeedSlider').value),
                right: parseFloat(document.getElementById('rightSpeedSlider').value),
                up: parseFloat(document.getElementById('upSpeedSlider').value),
                turn_right: parseFloat(document.getElementById('turnRightSpeedSlider').value)
            };
            
            sendSimpleDrcControl(controlData);
        }
        
        // é‡ç½®DRCé€Ÿåº¦
        function resetDrcSpeeds() {
            document.getElementById('forwardSpeedSlider').value = 0;
            document.getElementById('rightSpeedSlider').value = 0;
            document.getElementById('upSpeedSlider').value = 0;
            document.getElementById('turnRightSpeedSlider').value = 0;
            
            updateDrcSpeedValue('forward');
            updateDrcSpeedValue('right');
            updateDrcSpeedValue('up');
            updateDrcSpeedValue('turn_right');
            
            // å‘é€åœæ­¢æŒ‡ä»¤
            const stopControl = { forward: 0, right: 0, up: 0, turn_right: 0 };
            sendSimpleDrcControl(stopControl);
        }
        
        // ç´§æ€¥åœæ­¢
        async function emergencyStop() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                alert('è¯·å…ˆé€‰æ‹©è®¾å¤‡');
                return;
            }
            
            // åœæ­¢æ‰€æœ‰æ§åˆ¶å¾ªç¯
            stopDrcControl();
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/control/emergency-stop`, 'POST');
                if (result.code === 0) {
                    drcLog('ç´§æ€¥åœæ­¢æŒ‡ä»¤å·²å‘é€', 'warning');
                    document.getElementById('drcControlStatus').textContent = 'ç´§æ€¥åœæ­¢æŒ‡ä»¤å·²å‘é€\nå‘é€æ—¶é—´: ' + new Date().toLocaleTimeString();
                } else {
                    alert(`ç´§æ€¥åœæ­¢å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                    drcLog(`ç´§æ€¥åœæ­¢å¤±è´¥: ${result.message}`, 'error');
                }
            } catch (error) {
                alert(`ç´§æ€¥åœæ­¢å¤±è´¥: ${error.message}`);
                drcLog(`ç´§æ€¥åœæ­¢å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // DRCæ—¥å¿—å‡½æ•°
        function drcLog(message, type = 'info') {
            // å¦‚æœæœ‰ä¸“é—¨çš„DRCæ—¥å¿—å®¹å™¨å°±ç”¨ï¼Œå¦åˆ™è¾“å‡ºåˆ°æ§åˆ¶å°
            const container = document.getElementById('drcLogContainer');
            if (!container) {
                console.log(`[DRC ${type.toUpperCase()}] ${message}`);
                return;
            }
            
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const typeColors = {
                'success': '#28a745',
                'error': '#dc3545', 
                'warning': '#ffc107',
                'info': '#17a2b8'
            };
            
            logEntry.innerHTML = `
                <span style="color: #666;">[${timestamp}]</span> 
                <span style="color: ${typeColors[type] || '#333'};">[${type.toUpperCase()}]</span> 
                ${message}
            `;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            // é™åˆ¶æ—¥å¿—æ¡æ•°
            while (container.children.length > 100) {
                container.removeChild(container.firstChild);
            }
        }

        function clearDrcLog() {
            const container = document.getElementById('drcLogContainer');
            if (container) {
                container.innerHTML = '<div class="text-muted">æ—¥å¿—å·²æ¸…ç©º</div>';
            }
        }

        function exportDrcLog() {
            const container = document.getElementById('drcLogContainer');
            if (!container) return;
            
            const logText = Array.from(container.children)
                .map(entry => entry.textContent)
                .join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `drc_log_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            drcLog('æ—¥å¿—å·²å¯¼å‡º', 'success');
        }

        // åŠ è½½è®¾å¤‡ç±»å‹é€‰é¡¹
        async function loadDeviceTypeOptions() {
            try {
                const result = await apiRequest('/api/v1/device-dictionary/options');
                const select = document.getElementById('deviceType');
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™ç¬¬ä¸€ä¸ªç©ºé€‰é¡¹ï¼‰
                const firstOption = select.firstElementChild;
                select.innerHTML = '';
                select.appendChild(firstOption);
                
                // æ·»åŠ æ–°é€‰é¡¹
                result.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.label;
                    if (option.value === '3-3-0') { // é»˜è®¤é€‰æ‹©DJI Dock
                        optionElement.selected = true;
                    }
                    select.appendChild(optionElement);
                });
                
                log('è®¾å¤‡ç±»å‹é€‰é¡¹å·²åŠ è½½', 'success');
            } catch (error) {
                log(`åŠ è½½è®¾å¤‡ç±»å‹é€‰é¡¹å¤±è´¥: ${error.message}`, 'warning');
                // ä½¿ç”¨é™æ€é€‰é¡¹ä½œä¸ºå¤‡ç”¨
            }
        }

        // è·å–å½“å‰é€‰æ‹©çš„è®¾å¤‡ç±»å‹ä¿¡æ¯
        async function getSelectedDeviceTypeInfo() {
            const deviceType = document.getElementById('deviceType').value;
            if (!deviceType) return null;
            
            try {
                const result = await apiRequest(`/api/v1/device-dictionary/parse/${deviceType}`);
                return result;
            } catch (error) {
                console.warn('è·å–è®¾å¤‡ç±»å‹ä¿¡æ¯å¤±è´¥:', error);
                return null;
            }
        }

        // ä¿å­˜é…ç½®
        function saveConfig() {
            const apiUrl = document.getElementById('apiUrl').value;
            const token = document.getElementById('apiToken').value;
            const deviceSn = document.getElementById('deviceSn').value;
            const deviceType = document.getElementById('deviceType').value;
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('lightpatrol_config', JSON.stringify({
                apiUrl,
                token,
                deviceSn,
                deviceType,
                savedAt: new Date().toISOString()
            }));
            
            log('é…ç½®å·²ä¿å­˜', 'success');
        }

        // åŠ è½½é…ç½®
        function loadConfig() {
            try {
                const savedConfig = localStorage.getItem('lightpatrol_config');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('apiUrl').value = config.apiUrl || '';
                    document.getElementById('apiToken').value = config.token || '';
                    document.getElementById('deviceSn').value = config.deviceSn || '';
                    document.getElementById('deviceType').value = config.deviceType || '';
                    log('é…ç½®å·²åŠ è½½', 'info');
                }
            } catch (error) {
                console.warn('åŠ è½½é…ç½®å¤±è´¥:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åŠ è½½ä¿å­˜çš„é…ç½®
            loadConfig();
            
            // åŠ è½½è®¾å¤‡ç±»å‹é€‰é¡¹
            loadDeviceTypeOptions();
            
            // æ£€æŸ¥DRCå…ƒç´ æ˜¯å¦å­˜åœ¨
            if (document.getElementById('drcLogContainer')) {
                drcLog('DRCæ§åˆ¶é¢æ¿å·²åˆå§‹åŒ–', 'info');
                
                // è®¾ç½®å®šæ—¶å¿ƒè·³æ£€æŸ¥
                setInterval(() => {
                    if (drcSessionInfo && drcWebSocket && drcWebSocket.readyState === WebSocket.OPEN) {
                        // å‘é€pingä¿æŒè¿æ¥
                        drcWebSocket.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000); // 30ç§’å¿ƒè·³
            }
        });
        
    </script>
</body>
</html>