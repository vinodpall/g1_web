<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>无人机API测试页面</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .control-panel {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .stream-control-container {
            background-color: #f8f9fa;
            min-height: 200px;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        .gimbal-control {
            text-align: center;
            padding: 20px;
        }
        .gimbal-joystick {
            width: 200px;
            height: 200px;
            border: 2px solid #333;
            border-radius: 50%;
            position: relative;
            margin: 20px auto;
            background-color: #f0f0f0;
        }
        .gimbal-center {
            width: 20px;
            height: 20px;
            background-color: #333;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .log-container {
            height: 200px;
            overflow-y: auto;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .hms-item {
            margin-bottom: 12px;
            border-radius: 8px;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .hms-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        .hms-item .badge {
            font-size: 10px;
            font-weight: 500;
            padding: 4px 8px;
        }
        .hms-level-warning {
            border-left-color: #dc3545 !important;
            background-color: #fdf2f2 !important;
        }
        .hms-level-caution {
            border-left-color: #ffc107 !important;
            background-color: #fffbf0 !important;
        }
        .hms-level-notice {
            border-left-color: #17a2b8 !important;
            background-color: #e8f6f8 !important;
        }
        .hms-container {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }
        .api-test-panel {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .api-test-header {
            background-color: #e9ecef;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
        }
        .api-test-body {
            padding: 15px;
        }
        .form-row {
            margin-bottom: 10px;
        }
        .btn-test {
            margin-right: 5px;
            margin-bottom: 5px;
        }
        .response-area {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
        .drc-control-panel {
            background-color: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
        }
        .simulation-panel {
            background-color: #fff8dc;
            border: 1px solid #ffd700;
            border-radius: 6px;
            padding: 15px;
            margin-top: 10px;
        }
        .drc-slider-container {
            margin-bottom: 10px;
        }
        .drc-slider-container label {
            font-size: 12px;
            font-weight: bold;
            color: #333;
        }
        .form-range {
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-3">
        <h1 class="text-center mb-4">无人机API测试页面</h1>
        
        <!-- 配置区域 -->
        <div class="control-panel">
            <h3>系统配置</h3>
            <div class="row">
                <div class="col-md-3">
                    <label>API地址:</label>
                    <input type="text" id="apiUrl" class="form-control" value="http://192.168.111.49:8000" />
                </div>
                <div class="col-md-3">
                    <label>Token:</label>
                    <input type="text" id="apiToken" class="form-control" placeholder="输入认证Token" />
                </div>
                <div class="col-md-2">
                    <label>设备SN:</label>
                    <input type="text" id="deviceSn" class="form-control" placeholder="设备序列号" />
                </div>
                <div class="col-md-3">
                    <label>设备类型:</label>
                    <select id="deviceType" class="form-control">
                        <option value="">选择设备类型</option>
                        <option value="0-67-1">DJI M3E (飞机类)</option>
                        <option value="0-89-1">DJI M3T (飞机类)</option>
                        <option value="0-90-1">DJI M3M (飞机类)</option>
                        <option value="1-142-2">DJI M30 (飞机类)</option>
                        <option value="1-142-3">DJI M30T (飞机类)</option>
                        <option value="0-92-1">DJI M300 RTK (飞机类)</option>
                        <option value="3-3-0" selected>DJI Dock (机场类)</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary form-control" onclick="saveConfig()">保存配置</button>
                </div>
            </div>
        </div>

        <!-- 登录区域 -->
        <div class="control-panel">
            <h3>用户登录</h3>
            <div class="row">
                <div class="col-md-3">
                    <label>用户名:</label>
                    <input type="text" id="loginUsername" class="form-control" placeholder="输入用户名" />
                </div>
                <div class="col-md-3">
                    <label>密码:</label>
                    <input type="password" id="loginPassword" class="form-control" placeholder="输入密码" />
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label>
                    <button class="btn btn-success form-control" onclick="login()">登录</button>
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label>
                    <button class="btn btn-secondary form-control" onclick="logout()">登出</button>
                </div>
                <div class="col-md-2">
                    <label>登录状态:</label>
                    <div><span class="status-indicator status-offline" id="loginStatus"></span><span id="loginStatusText">未登录</span></div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- 左侧：控制面板 -->
            <div class="col-md-4">
                <!-- 直播推流控制 -->
                <div class="control-panel">
                    <h4>直播推流控制</h4>
                    <div id="selectedVideoInfo" class="mb-2" style="display: none;">
                        <div class="alert alert-success p-2">
                            <small><strong>已选择视频流：</strong></small>
                            <div id="selectedVideoDetails" class="mt-1"></div>
                            <button class="btn btn-xs btn-outline-secondary mt-1" onclick="clearVideoSelection()">清除选择</button>
                        </div>
                    </div>
                    <div class="alert alert-info alert-sm p-2 mb-2">
                        <small><strong>说明：</strong>推流到RTMP服务器，支持页面内直播和VLC播放器观看。先从下方直播能力中选择视频流。</small>
                    </div>
                    <div class="row mb-2">
                        <div class="col-4">
                            <select id="streamType" class="form-control">
                                <option value="rtmp" selected>RTMP (推荐)</option>
                                <option value="webrtc">WebRTC</option>
                            </select>
                        </div>
                        <div class="col-4">
                            <select id="streamQuality" class="form-control">
                                <option value="0">自适应</option>
                                <option value="1">流畅</option>
                                <option value="2">标清</option>
                                <option value="3">高清</option>
                                <option value="4">超清</option>
                            </select>
                        </div>
                        <div class="col-4">
                            <button class="btn btn-primary btn-sm" onclick="startLivestreamWithSelected()">智能推流</button>
                            <button class="btn btn-outline-success btn-sm" onclick="startLivestream()">手动推流</button>
                            <button class="btn btn-danger btn-sm" onclick="stopLivestream()">停止推流</button>
                        </div>
                    </div>
                    <!-- 直播镜头切换 -->
                    <div class="mb-2" id="lensChangeControl" style="display: none;">
                        <div class="row align-items-center mb-2">
                            <div class="col-6">
                                <small>直播镜头切换: </small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">当前: <span id="currentLensType">未知</span></small>
                            </div>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="changeLens('normal')">默认</button>
                            <button class="btn btn-outline-primary" onclick="changeLens('wide')">广角</button>
                            <button class="btn btn-outline-primary" onclick="changeLens('zoom')">变焦</button>
                            <button class="btn btn-outline-primary" onclick="changeLens('ir')">红外</button>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">推流中可实时切换镜头类型，支持默认/广角/变焦/红外</small>
                        </div>
                    </div>
                    
                    <!-- 动态清晰度切换 -->
                    <div class="mb-2" id="dynamicQualityControl" style="display: none;">
                        <div class="row align-items-center">
                            <div class="col-6">
                                <small>动态切换清晰度: </small>
                            </div>
                            <div class="col-6">
                                <select id="dynamicQuality" class="form-select form-select-sm" onchange="changeLiveQuality()">
                                    <option value="0">自适应</option>
                                    <option value="1">流畅 (512Kbps)</option>
                                    <option value="2">标清 (1Mbps)</option>
                                    <option value="3">高清 (1.5Mbps)</option>
                                    <option value="4">超清 (8Mbps)</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">推流中可实时切换清晰度，无需重启推流</small>
                        </div>
                    </div>

                    <div class="stream-control-container">
                        <div id="streamInfo">
                            <h6 class="text-muted mb-3">推流信息</h6>
                            <p class="mb-2"><strong>推流状态:</strong> <span id="streamStatus">未启动</span></p>
                            <p class="mb-2"><strong>推流协议:</strong> <span id="streamProtocol">-</span></p>
                            <p class="mb-2"><strong>推流地址 (push_url):</strong></p>
                            <div class="bg-light p-2 border rounded" style="max-height: 100px; overflow-y: auto;">
                                <code id="vlcUrl" class="text-break">等待推流启动...</code>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">复制上述地址到VLC播放器中观看直播</small>
                            </div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="copyVlcUrl()">复制地址</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearStreamInfo()">清空信息</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 直播能力查询 -->
                <div class="control-panel">
                    <h4>直播能力查询</h4>
                    <div class="text-center mb-3">
                        <button class="btn btn-info btn-sm" onclick="getLivestreamCapacity()">获取所有设备直播能力</button>
                        <button class="btn btn-outline-info btn-sm" onclick="getDeviceLivestreamCapacity()">获取当前设备直播能力</button>
                    </div>
                    <div class="livestream-capacity-info">
                        <div class="card">
                            <div class="card-body p-2">
                                <h6 class="text-muted mb-2">直播能力信息</h6>
                                <div id="livestreamCapacityResult" class="small">
                                    <div class="text-muted">点击上方按钮获取直播能力信息</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 相机控制 -->
                <div class="control-panel">
                    <h4>相机控制</h4>
                    
                    <!-- 相机模式切换 -->
                    <div class="mb-3">
                        <h6>相机模式</h6>
                        <div class="row">
                            <div class="col-md-8">
                                <select class="form-control" id="cameraMode">
                                    <option value="0">普通拍照</option>
                                    <option value="1">录像</option>
                                    <option value="2">智能低光</option>
                                    <option value="3">全景拍照</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary btn-test w-100" onclick="switchCameraMode()">切换模式</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 拍照/录像控制 -->
                    <div class="text-center">
                        <button class="btn btn-info btn-test" onclick="takePhoto()">拍照</button>
                        <button class="btn btn-primary btn-test" onclick="startRecording()">开始录像</button>
                        <button class="btn btn-secondary btn-test" onclick="stopRecording()">停止录像</button>
                    </div>
                </div>

                <!-- 云台控制 -->
                <div class="control-panel">
                    <h4>云台控制</h4>
                    
                    <!-- 方向控制按钮 -->
                    <div class="mb-3">
                        <h6>方向控制</h6>
                        <div class="gimbal-direction-control">
                            <div class="text-center mb-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="gimbalDirectionControl('down')">▲ 上</button>
                            </div>
                            <div class="d-flex justify-content-center gap-2 mb-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="gimbalDirectionControl('left')">◄ 左</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="gimbalStop()">停止</button>
                                <button class="btn btn-sm btn-outline-primary" onclick="gimbalDirectionControl('right')">► 右</button>
                            </div>
                            <div class="text-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="gimbalDirectionControl('up')">▼ 下</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 精确角度控制 -->
                    <div class="mb-3">
                        <h6>精确角度控制</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">俯仰角(Pitch):</label>
                                <input type="number" class="form-control form-control-sm" id="gimbalPitch" placeholder="-90 到 30" min="-90" max="30" step="1">
                            </div>
                            <div class="col-6">
                                <label class="form-label">偏航角(Yaw):</label>
                                <input type="number" class="form-control form-control-sm" id="gimbalYaw" placeholder="-180 到 180" min="-180" max="180" step="1">
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary mt-2" onclick="gimbalSetAngle()">设置角度</button>
                    </div>
                    
                    <!-- 拖拽速度控制 -->
                    <div class="mb-3">
                        <h6>拖拽速度控制</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">俯仰速度: <span id="pitchSpeedValue">0</span></label>
                                <input type="range" class="form-range" min="-100" max="100" value="0" id="pitchSpeedSlider" onchange="updateSpeedValue('pitch')">
                            </div>
                            <div class="col-6">
                                <label class="form-label">偏航速度: <span id="yawSpeedValue">0</span></label>
                                <input type="range" class="form-range" min="-100" max="100" value="0" id="yawSpeedSlider" onchange="updateSpeedValue('yaw')">
                            </div>
                        </div>
                        <div class="text-center mt-2">
                            <button class="btn btn-sm btn-success" onclick="startGimbalDrag()">开始拖拽</button>
                            <button class="btn btn-sm btn-danger" onclick="stopGimbalDrag()">停止拖拽</button>
                        </div>
                    </div>
                    
                    <!-- Look At 坐标控制 -->
                    <div class="mb-3">
                        <h6>Look At 坐标控制</h6>
                        <div class="row g-2">
                            <div class="col-4">
                                <label class="form-label">纬度:</label>
                                <input type="number" class="form-control form-control-sm" id="lookAtLat" placeholder="纬度" step="0.000001">
                            </div>
                            <div class="col-4">
                                <label class="form-label">经度:</label>
                                <input type="number" class="form-control form-control-sm" id="lookAtLng" placeholder="经度" step="0.000001">
                            </div>
                            <div class="col-4">
                                <label class="form-label">高度:</label>
                                <input type="number" class="form-control form-control-sm" id="lookAtAlt" placeholder="高度(m)" step="0.1">
                            </div>
                        </div>
                        <button class="btn btn-sm btn-info mt-2" onclick="gimbalLookAt()">Look At</button>
                    </div>
                    
                    <!-- 基础控制 -->
                    <div class="text-center">
                        <button class="btn btn-sm btn-outline-primary" onclick="gimbalReset()">复位</button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="gimbalStop()">停止</button>
                        <button class="btn btn-sm btn-outline-info" onclick="getGimbalStatus()">获取状态</button>
                        <button class="btn btn-sm btn-outline-success" onclick="showCurrentCameraIndex()">显示Camera索引</button>
                    </div>
                    
                    <!-- 云台状态显示 -->
                    <div class="mt-3">
                        <h6>云台状态</h6>
                        <pre id="gimbalStatusDisplay" class="bg-light p-2 small" style="max-height: 100px; overflow-y: auto;">点击"获取状态"查看</pre>
                    </div>
                </div>

                <!-- DRC无人机控制 -->
                <div class="control-panel">
                    <h4>DRC无人机控制</h4>
                    
                    <!-- DRC模式控制 -->
                    <div class="mb-3">
                        <h6>DRC模式</h6>
                        <div class="d-flex gap-2 mb-2">
                            <button class="btn btn-sm btn-success" onclick="enterDrcMode()">进入DRC模式</button>
                            <button class="btn btn-sm btn-danger" onclick="exitDrcMode()">退出DRC模式</button>
                            <button class="btn btn-sm btn-info" onclick="getDrcStatus()">获取状态</button>
                        </div>
                        <div class="alert alert-info alert-sm p-2 mb-2">
                            <small><strong>DRC状态:</strong> <span id="drcStatus">未知</span></small>
                        </div>
                    </div>
                    
                    <!-- 简化飞行控制 -->
                    <div class="mb-3" id="drcSimpleControl" style="display: none;">
                        <h6>简化飞行控制</h6>
                        <div class="alert alert-warning alert-sm p-2 mb-2">
                            <small><strong>说明:</strong> 直观的前后左右上下控制，自动转换为DJI杆量数据</small>
                        </div>
                        
                        <!-- 方向控制按钮 -->
                        <div class="drc-direction-control mb-3">
                            <div class="text-center mb-2">
                                <button class="btn btn-sm btn-primary" 
                                        onmousedown="startDrcControl('forward', 0.5)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">▲ 前进</button>
                            </div>
                            <div class="d-flex justify-content-center gap-2 mb-2">
                                <button class="btn btn-sm btn-primary" 
                                        onmousedown="startDrcControl('left', 0.5)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">◄ 左移</button>
                                <button class="btn btn-sm btn-secondary" onclick="emergencyStop()">紧急停止</button>
                                <button class="btn btn-sm btn-primary" 
                                        onmousedown="startDrcControl('right', 0.5)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">► 右移</button>
                            </div>
                            <div class="text-center mb-2">
                                <button class="btn btn-sm btn-primary" 
                                        onmousedown="startDrcControl('backward', 0.5)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">▼ 后退</button>
                            </div>
                            <div class="d-flex justify-content-center gap-2">
                                <button class="btn btn-sm btn-success" 
                                        onmousedown="startDrcControl('up', 0.5)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">↑ 上升</button>
                                <button class="btn btn-sm btn-warning" 
                                        onmousedown="startDrcControl('down', 0.5)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">↓ 下降</button>
                                <button class="btn btn-sm btn-info" 
                                        onmousedown="startDrcControl('turn_left', 0.3)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">↺ 左转</button>
                                <button class="btn btn-sm btn-info" 
                                        onmousedown="startDrcControl('turn_right', 0.3)" 
                                        onmouseup="stopDrcControl()" 
                                        onmouseleave="stopDrcControl()">↻ 右转</button>
                            </div>
                        </div>
                        
                        <!-- 精确速度控制 -->
                        <div class="mb-3">
                            <h6>精确速度控制</h6>
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label">前后速度: <span id="forwardSpeedValue">0</span></label>
                                    <input type="range" class="form-range" min="-1" max="1" value="0" step="0.1" id="forwardSpeedSlider" onchange="updateDrcSpeedValue('forward')">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">左右速度: <span id="rightSpeedValue">0</span></label>
                                    <input type="range" class="form-range" min="-1" max="1" value="0" step="0.1" id="rightSpeedSlider" onchange="updateDrcSpeedValue('right')">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">升降速度: <span id="upSpeedValue">0</span></label>
                                    <input type="range" class="form-range" min="-1" max="1" value="0" step="0.1" id="upSpeedSlider" onchange="updateDrcSpeedValue('up')">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">旋转速度: <span id="turnSpeedValue">0</span></label>
                                    <input type="range" class="form-range" min="-1" max="1" value="0" step="0.1" id="turnRightSpeedSlider" onchange="updateDrcSpeedValue('turn_right')">
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <button class="btn btn-sm btn-success" onclick="sendDrcControl()">发送控制指令</button>
                                <button class="btn btn-sm btn-secondary" onclick="resetDrcSpeeds()">重置速度</button>
                            </div>
                        </div>
                        
                        <!-- 控制状态显示 -->
                        <div class="mt-3">
                            <h6>控制状态</h6>
                            <pre id="drcControlStatus" class="bg-light p-2 small" style="max-height: 100px; overflow-y: auto;">等待控制指令...</pre>
                        </div>
                    </div>
                </div>

                
            </div>

            <!-- 中间：API测试区域 -->
            <div class="col-md-4">
                <!-- 设备管理API测试 -->
                <div class="api-test-panel">
                    <div class="api-test-header">设备管理API</div>
                    <div class="api-test-body">
                        <button class="btn btn-sm btn-primary btn-test" onclick="testGetDevices()">获取设备列表</button>
                        <button class="btn btn-sm btn-info btn-test" onclick="testGetDeviceStatus()">获取设备状态</button>
                        <button class="btn btn-sm btn-secondary btn-test" onclick="testDeviceCount()">设备总数</button>
                        <div class="response-area" id="deviceApiResponse">API响应显示区域</div>
                    </div>
                </div>

                <!-- 航线任务API测试 -->
                <div class="api-test-panel">
                    <div class="api-test-header">航线任务完整流程测试</div>
                    <div class="api-test-body">
                        <div class="form-row mb-2">
                            <input type="text" id="workspaceId" class="form-control" placeholder="工作空间ID" value="1">
                        </div>
                        
                        <!-- 第一步：航线文件上传 -->
                        <div class="wayline-step mb-3">
                            <h6 class="text-primary">📁 步骤1: 航线文件上传</h6>
                            <div class="mb-2">
                                <input type="file" id="waylineFile" class="form-control form-control-sm" accept=".kmz">
                                <small class="text-muted">请选择从司空2导出的.kmz航线文件</small>
                            </div>
                            <div class="row g-2 mb-2">
                                <div class="col-8">
                                    <input type="text" id="waylineName" class="form-control form-control-sm" placeholder="航线名称">
                                </div>
                                <div class="col-4">
                                    <select id="droneModelKey" class="form-select form-select-sm">
                                        <option value="0-67-1">DJI M3E</option>
                                        <option value="0-89-1">DJI M3T</option>
                                        <option value="0-90-1">DJI M3M</option>
                                        <option value="1-142-2">DJI M30</option>
                                        <option value="1-142-3">DJI M30T</option>
                                        <option value="0-92-1">DJI M300 RTK</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="uploadWaylineFile()">上传航线文件</button>
                            <button class="btn btn-sm btn-info" onclick="getWaylineFiles()">查看已上传文件</button>
                        </div>
                        
                        <!-- 第二步：创建任务 -->
                        <div class="wayline-step mb-3">
                            <h6 class="text-primary">🚀 步骤2: 创建航线任务</h6>
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <select id="waylineFileSelect" class="form-select form-select-sm">
                                        <option value="">选择航线文件...</option>
                                    </select>
                                </div>
                                <div class="col-6">
                                    <select id="taskType" class="form-select form-select-sm">
                                        <option value="0">立即执行</option>
                                        <option value="1">定时执行</option>
                                        <option value="2">条件执行</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-success" onclick="createWaylineJob()">创建任务</button>
                            <button class="btn btn-sm btn-info" onclick="testGetWaylineJobs()">查看任务列表</button>
                        </div>
                        
                        <!-- 第三步：任务执行 -->
                        <div class="wayline-step mb-3">
                            <h6 class="text-primary">▶️ 步骤3: 任务执行控制</h6>
                            <div class="mb-2">
                                <select id="jobSelect" class="form-select form-select-sm">
                                    <option value="">选择要执行的任务...</option>
                                </select>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-success" onclick="executeWaylineJob()">执行任务</button>
                                <button class="btn btn-warning" onclick="pauseWaylineJob()">暂停任务</button>
                                <button class="btn btn-danger" onclick="cancelWaylineJob()">取消任务</button>
                            </div>
                        </div>
                        
                        <!-- 第四步：任务监控 -->
                        <div class="wayline-step">
                            <h6 class="text-primary">📊 步骤4: 任务状态监控</h6>
                            
                            <!-- 任务状态监控面板 -->
                            <div class="card mb-3" id="taskMonitorPanel">
                                <div class="card-header py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 text-success">实时任务监控</h6>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="queryTaskStatus()">查询状态</button>
                                            <button class="btn btn-outline-secondary" onclick="toggleAutoRefresh()" id="autoRefreshBtn">启动自动刷新</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body py-2">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="mb-2">
                                                <small class="text-muted">当前任务ID:</small><br>
                                                <span id="currentJobId" class="badge bg-secondary fs-6">暂无任务</span>
                                            </div>
                                            <div class="mb-2">
                                                <small class="text-muted">任务状态:</small><br>
                                                <span id="currentJobStatus" class="badge bg-info fs-6">待执行</span>
                                            </div>
                                            <div class="mb-2">
                                                <small class="text-muted">执行时间:</small><br>
                                                <span id="executeTime" class="text-sm">-</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="mb-2">
                                                <small class="text-muted">执行进度:</small><br>
                                                <div class="progress" style="height: 24px;">
                                                    <div id="taskProgressBar" class="progress-bar progress-bar-striped" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                                        <span id="progressText">0%</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <small class="text-muted">媒体文件:</small>
                                                <span id="mediaFileCount" class="ms-1 badge bg-light text-dark">0</span>
                                                <small class="text-muted">完成时间:</small>
                                                <span id="completedTime" class="text-sm">-</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <small class="text-muted">任务详情:</small><br>
                                            <div id="taskDetails" class="text-sm bg-light p-2 rounded" style="min-height: 60px; max-height: 120px; overflow-y: auto;">
                                                <div class="text-center text-muted">暂无任务执行 - 请先创建并执行航线任务</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row mt-2" id="taskActions" style="display: none;">
                                        <div class="col-12">
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-warning" onclick="pauseCurrentTask()" id="pauseTaskBtn">暂停任务</button>
                                                <button class="btn btn-success" onclick="resumeCurrentTask()" id="resumeTaskBtn" style="display: none;">恢复任务</button>
                                                <button class="btn btn-danger" onclick="cancelCurrentTask()" id="cancelTaskBtn">取消任务</button>
                                                <button class="btn btn-info" onclick="setMediaPriority()" id="mediaPriorityBtn">媒体优先上传</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-info" onclick="getJobDetail()">获取任务详情</button>
                                <button class="btn btn-secondary" onclick="refreshJobList()">刷新任务状态</button>
                            </div>
                        </div>
                        
                        <div class="simulation-panel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="text-warning mb-0">模拟飞行测试</h6>
                                <button class="btn btn-sm btn-success" onclick="getDeviceCoordinates()">
                                    <small>获取机场坐标</small>
                                </button>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="enableSimulation" checked onchange="updateTakeoffButtonText()">
                                <label class="form-check-label">启用模拟飞行模式 (室内测试)</label>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <label class="form-label">机场纬度:</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="simLatitude" class="form-control" value="22.1223" step="0.0001">
                                        <span class="input-group-text" id="latStatus">手动</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">机场经度:</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="simLongitude" class="form-control" value="113.2222" step="0.0001">
                                        <span class="input-group-text" id="lngStatus">手动</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">机场高度(m):</label>
                                    <div class="input-group input-group-sm">
                                        <input type="number" id="simAltitude" class="form-control" value="66.6" step="0.1">
                                        <span class="input-group-text" id="altStatus">手动</span>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label">最大速度(m/s):</label>
                                    <input type="number" id="maxSpeed" class="form-control form-control-sm" value="10" min="1" max="15">
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12">
                                    <small class="text-info d-block" id="coordinateInfo">点击“获取机场坐标”自动填入当前机场位置</small>
                                </div>
                            </div>
                            <div class="row mt-2" id="dockStatusPanel" style="display: none;">
                                <div class="col-12">
                                    <div class="card card-body py-2 bg-light">
                                        <h6 class="card-title mb-2 text-primary">机场状态信息</h6>
                                        <div class="row text-sm">
                                            <div class="col-6">
                                                <small><strong>机场状态:</strong> <span id="dockModeStatus">-</span></small><br>
                                                <small><strong>任务状态:</strong> <span id="dockTaskStatus">-</span></small><br>
                                                <small><strong>飞行器:</strong> <span id="droneInDockStatus">-</span></small>
                                            </div>
                                            <div class="col-6">
                                                <small><strong>GPS状态:</strong> <span id="gpsStatusDetail">-</span></small><br>
                                                <small><strong>舱盖状态:</strong> <span id="coverStateStatus">-</span></small><br>
                                                <small><strong>累计作业:</strong> <span id="jobNumberStatus">-</span></small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-3">
                                <button class="btn btn-sm btn-info me-2" id="takeoffButton" onclick="testSimulateTakeoff()">模拟一键起飞</button>
                                <button class="btn btn-sm btn-primary" id="flyToButton" onclick="testSimulateFlyTo()">模拟飞向目标点</button>
                            </div>
                            <small class="text-muted d-block mt-2" id="simulationDescription">模拟模式下飞行器不会实际起飞，但会正常执行准备工作</small>
                        </div>
                        
                        <div class="response-area" id="waylineApiResponse">API响应显示区域</div>
                    </div>
                </div>

                <!-- 媒体管理API测试 -->
                <div class="api-test-panel">
                    <div class="api-test-header">媒体管理API</div>
                    <div class="api-test-body">
                        <button class="btn btn-sm btn-primary btn-test" onclick="testGetMediaFiles()">获取媒体列表</button>
                        <button class="btn btn-sm btn-info btn-test" onclick="testMediaStatistics()">媒体统计</button>
                        <button class="btn btn-sm btn-secondary btn-test" onclick="testStorageHealth()">存储健康检查</button>
                        <div class="form-row">
                            <input type="file" id="mediaFile" class="form-control">
                            <button class="btn btn-sm btn-success mt-1" onclick="testUploadMedia()">上传文件</button>
                        </div>
                        <div class="response-area" id="mediaApiResponse">API响应显示区域</div>
                    </div>
                </div>
                
                <!-- DRC控制面板 -->
                <div class="control-panel">
                    <h4>🎮 DRC指令飞行控制</h4>
                    
                    <!-- DRC会话管理 -->
                    <div class="mb-3">
                        <h6>DRC会话管理</h6>
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <button class="btn btn-sm btn-success" onclick="enterDrcMode()">进入DRC模式</button>
                                <button class="btn btn-sm btn-danger" onclick="exitDrcMode()">退出DRC模式</button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-sm btn-info" onclick="getDrcStatus()">查看DRC状态</button>
                                <button class="btn btn-sm btn-warning" onclick="drcEmergencyStop()">DRC紧急停止</button>
                            </div>
                        </div>
                        
                        <!-- DRC配置 -->
                        <div class="row g-2 mb-2">
                            <div class="col-6">
                                <label class="form-label">OSD频率(Hz):</label>
                                <select id="drcOsdFreq" class="form-select form-select-sm">
                                    <option value="5">5Hz</option>
                                    <option value="10" selected>10Hz</option>
                                    <option value="20">20Hz</option>
                                    <option value="30">30Hz</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">HSI频率(Hz):</label>
                                <select id="drcHsiFreq" class="form-select form-select-sm">
                                    <option value="2">2Hz</option>
                                    <option value="4" selected>4Hz</option>
                                    <option value="6">6Hz</option>
                                    <option value="10">10Hz</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- DRC状态显示 -->
                        <div class="alert alert-secondary p-2 mb-2">
                            <small><strong>DRC状态:</strong> <span id="drcSessionStatus" class="badge bg-secondary">未激活</span></small><br>
                            <small><strong>会话ID:</strong> <span id="drcSessionId">-</span></small><br>
                            <small><strong>最后心跳:</strong> <span id="drcLastHeartbeat">-</span></small>
                        </div>
                    </div>
                    
                    <!-- DRC杆量控制 -->
                    <div class="drc-control-panel mb-3">
                        <h6>🕹️ 杆量控制 (DJI标准格式)</h6>
                        <div class="row g-2">
                            <!-- 左侧摇杆 (油门+偏航) -->
                            <div class="col-6">
                                <div class="card">
                                    <div class="card-header py-1">
                                        <small><strong>左摇杆</strong> (油门+偏航)</small>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="drc-slider-container">
                                            <label>升降(Throttle): <span id="throttleValue">1024</span></label>
                                            <input type="range" class="form-range" min="364" max="1684" value="1024" id="throttleSlider" oninput="updateDrcValue('throttle')">
                                        </div>
                                        <div class="drc-slider-container">
                                            <label>偏航(Yaw): <span id="yawValue">1024</span></label>
                                            <input type="range" class="form-range" min="364" max="1684" value="1024" id="yawSlider" oninput="updateDrcValue('yaw')">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 右侧摇杆 (俯仰+横滚) -->
                            <div class="col-6">
                                <div class="card">
                                    <div class="card-header py-1">
                                        <small><strong>右摇杆</strong> (俯仰+横滚)</small>
                                    </div>
                                    <div class="card-body p-2">
                                        <div class="drc-slider-container">
                                            <label>俯仰(Pitch): <span id="pitchValue">1024</span></label>
                                            <input type="range" class="form-range" min="364" max="1684" value="1024" id="pitchSlider" oninput="updateDrcValue('pitch')">
                                        </div>
                                        <div class="drc-slider-container">
                                            <label>横滚(Roll): <span id="rollValue">1024</span></label>
                                            <input type="range" class="form-range" min="364" max="1684" value="1024" id="rollSlider" oninput="updateDrcValue('roll')">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- 控制按钮 -->
                        <div class="text-center mt-3">
                            <button class="btn btn-primary btn-sm" onclick="sendStickControl()">发送杆量控制</button>
                            <button class="btn btn-secondary btn-sm" onclick="resetAllSticks()">重置所有摇杆</button>
                            <button class="btn btn-info btn-sm" onclick="testStickControl()">测试模式</button>
                        </div>
                        
                        <!-- 快捷控制预设 -->
                        <div class="mt-2">
                            <small class="text-muted">快捷预设:</small><br>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success" onclick="presetTakeoff()">起飞</button>
                                <button class="btn btn-outline-primary" onclick="presetHover()">悬停</button>
                                <button class="btn btn-outline-info" onclick="presetLand()">降落</button>
                                <button class="btn btn-outline-warning" onclick="presetRotateLeft()">左转</button>
                                <button class="btn btn-outline-warning" onclick="presetRotateRight()">右转</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DRC实时数据监控 -->
                    <div class="mb-3">
                        <h6>📊 实时数据监控</h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="card">
                                    <div class="card-header py-1">
                                        <small><strong>OSD数据</strong> (高频)</small>
                                    </div>
                                    <div class="card-body p-2">
                                        <div style="font-size: 11px;">
                                            <div>位置: <span id="drcPosition">等待数据...</span></div>
                                            <div>高度: <span id="drcHeight">-</span>m</div>
                                            <div>姿态: <span id="drcAttitude">-</span>°</div>
                                            <div>速度: <span id="drcVelocity">-</span>m/s</div>
                                            <div>云台: P:<span id="drcGimbalP">-</span>° Y:<span id="drcGimbalY">-</span>°</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card">
                                    <div class="card-header py-1">
                                        <small><strong>HSI数据</strong> (避障)</small>
                                    </div>
                                    <div class="card-body p-2">
                                        <div style="font-size: 11px;">
                                            <div>上方: <span id="hsiUp" class="badge bg-success">正常</span></div>
                                            <div>下方: <span id="hsiDown" class="badge bg-success">正常</span></div>
                                            <div>前方: <span id="hsiFront" class="badge bg-success">正常</span></div>
                                            <div>后方: <span id="hsiBack" class="badge bg-success">正常</span></div>
                                            <div>左右: <span id="hsiSide" class="badge bg-success">正常</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 延时信息 -->
                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header py-1">
                                        <small><strong>延时监控</strong></small>
                                    </div>
                                    <div class="card-body p-2">
                                        <div style="font-size: 11px;">
                                            <div class="row">
                                                <div class="col-6">指令延时: <span id="cmdDelay" class="badge bg-info">-</span>ms</div>
                                                <div class="col-6">视频延时: <span id="videoDelay" class="badge bg-info">-</span>ms</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DRC WebSocket连接状态 -->
                    <div class="mb-3">
                        <h6>🔗 WebSocket连接</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-sm btn-success" onclick="connectDrcWebSocket()">连接WebSocket</button>
                                <button class="btn btn-sm btn-danger" onclick="disconnectDrcWebSocket()">断开连接</button>
                            </div>
                            <div class="col-6">
                                <small>连接状态: <span id="wsConnectionStatus" class="badge bg-secondary">未连接</span></small><br>
                                <small>消息计数: <span id="wsMessageCount">0</span></small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- DRC操作日志 -->
                    <div class="mb-3">
                        <h6>📝 DRC操作日志</h6>
                        <div class="log-container" id="drcLogContainer" style="height: 150px;">
                            <div class="text-muted">DRC操作日志将在这里显示...</div>
                        </div>
                        <div class="text-center mt-2">
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearDrcLog()">清空日志</button>
                            <button class="btn btn-sm btn-outline-info" onclick="exportDrcLog()">导出日志</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：HMS健康监控和日志 -->
            <div class="col-md-4">
                <!-- HMS健康监控 -->
                <div class="control-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h4 class="mb-1">HMS健康监控</h4>
                            <div id="hmsCount">
                                <span class="badge bg-secondary">0</span>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="refreshHMS()">刷新</button>
                    </div>
                    <div id="hmsContainer" class="hms-container" style="max-height: 250px; overflow-y: auto;">
                        <div class="text-muted text-center">暂无警告信息</div>
                    </div>
                    <div class="d-flex gap-2 mt-2">
                        <button class="btn btn-sm btn-success" onclick="markHMSRead()">标记已读</button>
                        <button class="btn btn-sm btn-outline-secondary" id="hmsViewToggle" onclick="toggleHMSView()">查看所有</button>
                    </div>
                </div>

                <!-- 机场环境监控 -->
                <div class="control-panel">
                    <h4>机场环境监控 
                        <button class="btn btn-sm btn-secondary float-end" onclick="refreshEnvironmentData()">刷新</button>
                    </h4>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <div class="card bg-primary text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1">环境温度</h6>
                                    <div class="h5 mb-0" id="environmentTemp">--°C</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-info text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1">舱内温度</h6>
                                    <div class="h5 mb-0" id="dockTemp">--°C</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-4">
                            <div class="card bg-success text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1 small">风速</h6>
                                    <div class="h6 mb-0" id="windSpeed">-- m/s</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-warning text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1 small">湿度</h6>
                                    <div class="h6 mb-0" id="humidity">--%</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="card bg-secondary text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1 small">降雨</h6>
                                    <div class="h6 mb-0" id="rainfall">--</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row g-2 mb-2">
                        <div class="col-6">
                            <div class="card bg-dark text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1 small">充电状态</h6>
                                    <div class="h6 mb-0" id="chargeStatus">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="card bg-success text-white">
                                <div class="card-body p-2 text-center">
                                    <h6 class="card-title mb-1 small">电池电量</h6>
                                    <div class="h6 mb-0" id="batteryLevel">--%</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-muted small text-center">
                        <span id="environmentLastUpdate">暂无数据</span>
                    </div>
                </div>
                <!-- 飞行控制 -->
                <div class="control-panel">
                    <h4>飞行控制</h4>
                    
                    <!-- 权限控制 -->
                    <div class="mb-3">
                        <h6>控制权管理</h6>
                        <div class="text-center mb-2">
                            <button class="btn btn-sm btn-success" onclick="grabFlightAuthority()">获取飞行控制权</button>
                            <button class="btn btn-sm btn-success" onclick="grabPayloadAuthority()">获取负载控制权</button>
                        </div>
                        <div class="text-center mb-2">
                            <button class="btn btn-sm btn-warning" onclick="releaseFlightAuthority()">释放飞行控制权</button>
                            <button class="btn btn-sm btn-warning" onclick="releasePayloadAuthority()">释放负载控制权</button>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-sm btn-info" onclick="checkAuthorityStatus()">查看权限状态</button>
                        </div>
                    </div>
                    
                    <!-- 飞行操作 -->
                    <div class="text-center">
                        <!-- <button class="btn btn-success btn-test" onclick="takeoff()">起飞</button> -->
                        <button class="btn btn-warning btn-test" onclick="returnHome()">返航</button>
                        <button class="btn btn-danger btn-test" onclick="emergencyStop()">紧急停止</button>
                    </div>
                    
                    <!-- 权限状态显示 -->
                    <div class="mt-3">
                        <h6>权限状态</h6>
                        <pre id="authorityStatusDisplay" class="bg-light p-2 small" style="max-height: 150px; overflow-y: auto;">点击"查看权限状态"查看</pre>
                    </div>
                </div>
                <!-- 工作空间API测试 -->
                <div class="api-test-panel">
                    <div class="api-test-header">工作空间管理API</div>
                    <div class="api-test-body">
                        <button class="btn btn-sm btn-primary btn-test" onclick="testGetWorkspaces()">获取工作空间</button>
                        <button class="btn btn-sm btn-success btn-test" onclick="testCreateWorkspace()">创建工作空间</button>
                        <!-- <button class="btn btn-sm btn-info btn-test" onclick="testBindDevice()">绑定设备</button> -->
                        <div class="response-area" id="workspaceApiResponse">API响应显示区域</div>
                    </div>
                </div>

                <!-- 系统日志 -->
                <div class="control-panel">
                    <h4>系统日志</h4>
                    <div id="logContainer" class="log-container">
                        <div class="text-muted">系统就绪，等待操作...</div>
                    </div>
                    <button class="btn btn-sm btn-secondary mt-2" onclick="clearLogs()">清空日志</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 视频直播区域 - 全宽显示 -->
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-video me-2"></i>实时视频直播
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshVideo()">
                                <i class="fas fa-sync-alt me-1"></i>刷新
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="toggleFullscreen()">
                                <i class="fas fa-expand me-1"></i>全屏
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="stopVideoPlayback()">
                                <i class="fas fa-stop me-1"></i>停止
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="video-player-container position-relative">
                            <video id="livestreamVideo" 
                                   style="width: 100%; height: 400px; background: #000;" 
                                   controls 
                                   muted 
                                   autoplay 
                                   playsinline>
                                您的浏览器不支持视频播放
                            </video>
                            <div id="videoOverlay" class="position-absolute top-50 start-50 translate-middle text-white text-center" style="pointer-events: none;">
                                <div class="bg-dark bg-opacity-75 p-4 rounded">
                                    <i class="fas fa-play-circle fa-3x mb-3"></i>
                                    <h6>等待直播启动...</h6>
                                    <small class="text-muted">请先在上方"直播推流控制"区域启动推流</small>
                                </div>
                            </div>
                        </div>
                        <div class="px-3 py-2 bg-light border-top d-flex justify-content-between align-items-center">
                            <div>
                                <strong>状态:</strong> 
                                <span id="videoInfo" class="ms-1">请先启动推流</span>
                            </div>
                            <div class="text-muted">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    通过SRS服务器转换RTMP流为WebRTC播放
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 全局变量
        let currentVideoId = null;
        let hmsRefreshInterval = null;
        
        // 配置管理
        function saveConfig() {
            const config = {
                apiUrl: document.getElementById('apiUrl').value,
                apiToken: document.getElementById('apiToken').value,
                deviceSn: document.getElementById('deviceSn').value,
                deviceType: document.getElementById('deviceType').value
            };
            localStorage.setItem('droneApiConfig', JSON.stringify(config));
            log('配置已保存', 'success');
            
            // 生成video_id
            if (config.deviceSn) {
                currentVideoId = generateVideoId(config.deviceSn);
                log(`已生成video_id: ${currentVideoId}`, 'info');
                
                // 尝试自动获取机场坐标
                setTimeout(() => {
                    getDeviceCoordinates();
                }, 1000);
            }
        }

        // 加载配置
        function loadConfig() {
            const config = localStorage.getItem('droneApiConfig');
            if (config) {
                const parsed = JSON.parse(config);
                document.getElementById('apiUrl').value = parsed.apiUrl || 'http://192.168.111.49:8000';
                document.getElementById('apiToken').value = parsed.apiToken || '';
                document.getElementById('deviceSn').value = parsed.deviceSn || '';
                document.getElementById('deviceType').value = parsed.deviceType || 'dock';
                
                if (parsed.deviceSn) {
                    currentVideoId = generateVideoId(parsed.deviceSn);
                }
            }
        }

        // 生成video_id
        function generateVideoId(deviceSn) {
            if (!deviceSn) return null;
            
            const deviceType = document.getElementById('deviceType').value;
            let cameraIndex, videoIndex;
            
            if (deviceType === 'dock') {
                cameraIndex = '165-0-7';  // 机场FPV相机
                videoIndex = 'normal-0';  // 正常镜头
            } else {
                cameraIndex = '39-0-7';   // 飞行器FPV相机
                videoIndex = 'normal-0';   // 正常镜头
            }
            
            return `${deviceSn}/${cameraIndex}/${videoIndex}`;
        }

        // 此函数已不再需要，直接显示push_url
        
        // 复制推流地址
        function copyVlcUrl() {
            const vlcUrl = document.getElementById('vlcUrl').textContent;
            if (vlcUrl && vlcUrl !== '等待推流启动...' && vlcUrl !== '后台未返回推流地址') {
                navigator.clipboard.writeText(vlcUrl).then(() => {
                    log('推流地址已复制到剪切板', 'success');
                }).catch(() => {
                    log('复制失败，请手动复制', 'error');
                });
            } else {
                log('暂无可复制的推流地址', 'warning');
            }
        }
        
        // 清空推流信息
        function clearStreamInfo() {
            document.getElementById('streamStatus').textContent = '未启动';
            document.getElementById('streamProtocol').textContent = '-';
            document.getElementById('vlcUrl').textContent = '等待推流启动...';
            log('推流信息已清空', 'info');
        }

        // API请求函数
        async function apiRequest(endpoint, method = 'GET', data = null) {
            let apiUrl = document.getElementById('apiUrl').value || 'http://192.168.111.49:8000';
            
            // 确保URL格式正确
            if (!apiUrl.startsWith('http://') && !apiUrl.startsWith('https://')) {
                apiUrl = 'http://' + apiUrl;
            }
            
            // 移除末尾的斜杠
            apiUrl = apiUrl.replace(/\/$/, '');
            
            const token = document.getElementById('apiToken').value;
            
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const config = {
                method,
                headers
            };
            
            if (data && method !== 'GET') {
                config.body = JSON.stringify(data);
            }
            
            try {
                const fullUrl = `${apiUrl}${endpoint}`;
                console.log(`API请求: ${method} ${fullUrl}`);
                
                const response = await fetch(fullUrl, config);
                const result = await response.json();
                
                // 处理认证错误
                if (response.status === 401) {
                    log('认证失败：请先登录或检查Token是否有效', 'error');
                    if (result.detail && result.detail.includes('无法验证凭据')) {
                        log('提示：点击左上角的"登录"按钮进行身份验证', 'warning');
                    }
                    throw new Error(`认证失败 (${response.status}): ${result.detail || '无法验证凭据'}`);
                }
                
                // 处理其他HTTP错误
                if (!response.ok) {
                    const errorMsg = result.detail || result.message || `HTTP ${response.status}`;
                    log(`API请求失败 (${response.status}): ${errorMsg}`, 'error');
                    throw new Error(errorMsg);
                }
                
                return result;
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    log(`网络请求失败: 无法连接到服务器 ${apiUrl}`, 'error');
                    throw new Error('网络连接失败，请检查服务器是否运行');
                }
                throw error;
            }
        }

        // 登录相关
        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                log('请输入用户名和密码', 'error');
                return;
            }
            
            try {
                const data = new FormData();
                data.append('username', username);
                data.append('password', password);
                
                const response = await fetch(`${document.getElementById('apiUrl').value}/api/v1/login/access-token`, {
                    method: 'POST',
                    body: data
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    document.getElementById('apiToken').value = result.access_token;
                    document.getElementById('loginStatus').className = 'status-indicator status-online';
                    document.getElementById('loginStatusText').textContent = '已登录';
                    log('登录成功', 'success');
                } else {
                    log(`登录失败: ${result.detail || '未知错误'}`, 'error');
                }
            } catch (error) {
                log(`登录请求失败: ${error.message}`, 'error');
            }
        }

        async function logout() {
            document.getElementById('apiToken').value = '';
            document.getElementById('loginStatus').className = 'status-indicator status-offline';
            document.getElementById('loginStatusText').textContent = '未登录';
            log('已登出', 'info');
        }

        // 直播控制
        async function startLivestream() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            if (!currentVideoId) {
                currentVideoId = generateVideoId(deviceSn);
                log(`使用video_id: ${currentVideoId}`, 'info');
            }
            
            const streamType = document.getElementById('streamType').value;
            const quality = document.getElementById('streamQuality').value;
            
            // RTMP = 1, WebRTC = 4
            const urlType = streamType === 'rtmp' ? 1 : 4;
            
            try {
                log(`开始${streamType.toUpperCase()}推流...`, 'info');
                
                const result = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/livestream/start`, 'POST', {
                    url_type: urlType,
                    video_id: currentVideoId,
                    video_quality: parseInt(quality),
                    url: null  // 可选字段，由后台自动生成
                });
                
                // 更新界面显示
                document.getElementById('streamStatus').textContent = '推流中';
                document.getElementById('streamProtocol').textContent = streamType.toUpperCase();
                
                // 显示后台返回的推流地址
                if (result.push_url) {
                    document.getElementById('vlcUrl').textContent = result.push_url;
                    log(`推流地址: ${result.push_url}`, 'success');
                    
                    // 自动启动视频播放
                    startVideoPlayback(result.push_url, streamType);
                } else {
                    document.getElementById('vlcUrl').textContent = '后台未返回推流地址';
                    log('后台未返回push_url', 'warning');
                }
                
                log('推流启动成功', 'success');
                log(`推流ID: ${result.bid || 'N/A'}`, 'info');
                
                // 显示动态清晰度切换控制
                document.getElementById('dynamicQualityControl').style.display = 'block';
                document.getElementById('dynamicQuality').value = quality;
                
                // 显示镜头切换控制
                document.getElementById('lensChangeControl').style.display = 'block';
                document.getElementById('currentLensType').textContent = '默认';
                
                // 显示完整响应
                displayResponse('streamApiResponse', result);
            } catch (error) {
                log(`推流启动失败: ${error.message}`, 'error');
                document.getElementById('streamStatus').textContent = '启动失败';
            }
        }

        async function stopLivestream() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            if (!currentVideoId) {
                log('请先启动推流', 'warning');
                return;
            }
            
            try {
                log('停止推流...', 'info');
                
                const result = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/livestream/stop`, 'POST', {
                    video_id: currentVideoId
                });
                
                // 更新界面显示
                document.getElementById('streamStatus').textContent = '已停止';
                document.getElementById('streamProtocol').textContent = '-';
                document.getElementById('vlcUrl').textContent = '推流已停止';
                
                // 停止视频播放
                stopVideoPlayback();
                
                // 隐藏动态清晰度切换控制
                document.getElementById('dynamicQualityControl').style.display = 'none';
                
                // 隐藏镜头切换控制
                document.getElementById('lensChangeControl').style.display = 'none';
                
                log('推流已停止', 'success');
                log(`停止ID: ${result.bid || 'N/A'}`, 'info');
                
                displayResponse('streamApiResponse', result);
            } catch (error) {
                log(`停止推流失败: ${error.message}`, 'error');
                document.getElementById('streamStatus').textContent = '停止失败';
            }
        }

        // 切换直播镜头
        async function changeLens(lensType) {
            const deviceSn = document.getElementById('deviceSn').value;
            
            if (!deviceSn) {
                log('请先输入设备SN', 'error');
                return;
            }
            
            if (!currentVideoId) {
                log('请先启动直播推流', 'error');
                return;
            }
            
            const lensNames = {
                'normal': '默认',
                'wide': '广角', 
                'zoom': '变焦',
                'ir': '红外'
            };
            
            try {
                log(`正在切换镜头到: ${lensNames[lensType]}...`, 'info');
                
                const result = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/livestream/lens-change`, 'POST', {
                    video_id: currentVideoId,
                    video_type: lensType
                });
                
                // 更新当前镜头状态显示
                document.getElementById('currentLensType').textContent = lensNames[lensType];
                
                // 更新按钮状态 - 高亮当前选中的镜头
                const buttons = document.querySelectorAll('#lensChangeControl .btn');
                buttons.forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                
                log(`镜头已切换到: ${lensNames[lensType]}`, 'success');
                log(`切换ID: ${result.bid || 'N/A'}`, 'info');
                
                displayResponse('streamApiResponse', result);
            } catch (error) {
                log(`镜头切换失败: ${error.message}`, 'error');
            }
        }

        // 动态切换直播清晰度
        async function changeLiveQuality() {
            const deviceSn = document.getElementById('deviceSn').value;
            const newQuality = parseInt(document.getElementById('dynamicQuality').value);
            
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            if (!currentVideoId) {
                log('请先启动直播推流', 'error');
                return;
            }
            
            const qualityNames = {
                0: '自适应',
                1: '流畅 (512Kbps)',
                2: '标清 (1Mbps)', 
                3: '高清 (1.5Mbps)',
                4: '超清 (8Mbps)'
            };
            
            try {
                log(`正在切换清晰度到: ${qualityNames[newQuality]}...`, 'info');
                
                const result = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/livestream/set-quality`, 'POST', {
                    video_id: currentVideoId,
                    video_quality: newQuality
                });
                
                log(`清晰度已切换到: ${qualityNames[newQuality]}`, 'success');
                log(`切换ID: ${result.bid || 'N/A'}`, 'info');
                
                displayResponse('streamApiResponse', result);
            } catch (error) {
                log(`清晰度切换失败: ${error.message}`, 'error');
                // 发生错误时重置选择框到之前的值
                const currentQuality = document.getElementById('streamQuality').value;
                document.getElementById('dynamicQuality').value = currentQuality;
            }
        }

        // 录像控制
        async function startRecording() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/camera/recording/start`, 'POST', {
                    payload_index: payloadIndex
                });
                log('录像已开始', 'success');
                displayResponse('recordingApiResponse', result);
            } catch (error) {
                log(`开始录像失败: ${error.message}`, 'error');
            }
        }

        async function stopRecording() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/camera/recording/stop`, 'POST', {
                    payload_index: payloadIndex
                });
                log('录像已停止', 'success');
                displayResponse('recordingApiResponse', result);
            } catch (error) {
                log(`停止录像失败: ${error.message}`, 'error');
            }
        }

        async function switchCameraMode() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            const cameraMode = parseInt(document.getElementById('cameraMode').value);
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/camera/mode`, 'POST', {
                    payload_index: payloadIndex,
                    camera_mode: cameraMode
                });
                log(`相机模式已切换到: ${document.getElementById('cameraMode').options[document.getElementById('cameraMode').selectedIndex].text}`, 'success');
                displayResponse('recordingApiResponse', result);
            } catch (error) {
                log(`切换相机模式失败: ${error.message}`, 'error');
            }
        }

        async function takePhoto() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/camera/photo`, 'POST', {
                    payload_index: payloadIndex
                });
                log('拍照成功', 'success');
                displayResponse('recordingApiResponse', result);
            } catch (error) {
                log(`拍照失败: ${error.message}`, 'error');
            }
        }

        // 获取所有设备直播能力
        async function getLivestreamCapacity() {
            try {
                log('获取所有设备直播能力...', 'info');
                
                const result = await apiRequest('/api/v1/livestream/capacity', 'GET');
                
                // 格式化显示结果
                let html = `<div class="mb-2"><strong>直播能力统计</strong></div>`;
                html += `<div class="row mb-2">`;
                html += `<div class="col-4"><small>设备数: ${result.total_devices}</small></div>`;
                html += `<div class="col-4"><small>摄像头: ${result.total_cameras}</small></div>`;
                html += `<div class="col-4"><small>视频流: ${result.total_videos}</small></div>`;
                html += `</div>`;
                
                if (result.available_devices.length > 0) {
                    html += `<div class="mb-2"><strong>可直播设备:</strong></div>`;
                    result.available_devices.forEach(device => {
                        html += `<div class="card mb-2">`;
                        html += `<div class="card-body p-2">`;
                        html += `<div class="d-flex justify-content-between align-items-center mb-1">`;
                        html += `<small><strong>${device.sn}</strong></small>`;
                        html += `<small class="text-muted">视频流: ${device.available_video_number}/${device.coexist_video_number_max}</small>`;
                        html += `</div>`;
                        
                        device.camera_list.forEach(camera => {
                            html += `<div class="border-left pl-2 ml-2 mb-1">`;
                            html += `<div class="d-flex justify-content-between align-items-center">`;
                            html += `<small class="text-primary">📹 ${camera.camera_index}</small>`;
                            html += `<small class="text-muted">${camera.available_video_number}/${camera.coexist_video_number_max}</small>`;
                            html += `</div>`;
                            html += `<div class="ml-2">`;
                            camera.video_list.forEach(video => {
                                const videoId = `${device.sn}/${camera.camera_index}/${video.video_index}`;
                                html += `<div class="d-flex justify-content-between align-items-center mb-1">`;
                                html += `<small>• ${video.video_index} (${video.video_type})</small>`;
                                html += `<button class="btn btn-xs btn-outline-success" onclick="selectVideoForLivestream('${videoId}', '${device.sn}', '${camera.camera_index}', '${video.video_index}', '${video.video_type}')" style="font-size: 10px; padding: 1px 6px;">选择直播</button>`;
                                html += `</div>`;
                                if (video.switchable_video_types.length > 1) {
                                    html += `<small class="text-muted d-block ml-3">可切换: ${video.switchable_video_types.join(', ')}</small>`;
                                }
                            });
                            html += `</div></div>`;
                        });
                        
                        html += `</div></div>`;
                    });
                } else {
                    html += `<div class="text-muted">暂无可直播设备</div>`;
                }
                
                document.getElementById('livestreamCapacityResult').innerHTML = html;
                log('直播能力获取成功', 'success');
                
            } catch (error) {
                log(`获取直播能力失败: ${error.message}`, 'error');
                document.getElementById('livestreamCapacityResult').innerHTML = 
                    `<div class="text-danger">获取失败: ${error.message}</div>`;
            }
        }

        // 获取当前设备直播能力
        async function getDeviceLivestreamCapacity() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                log(`获取设备 ${deviceSn} 直播能力...`, 'info');
                
                const result = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/capacity`, 'GET');
                
                let html = `<div class="mb-2"><strong>设备: ${deviceSn}</strong></div>`;
                
                if (result.capacity) {
                    html += `<div class="row mb-2">`;
                    html += `<div class="col-6"><small>摄像头数: ${result.camera_count}</small></div>`;
                    html += `<div class="col-6"><small>视频流数: ${result.video_count}</small></div>`;
                    html += `</div>`;
                    
                    html += `<div class="mb-2"><small>可用视频流: ${result.capacity.available_video_number}/${result.capacity.coexist_video_number_max}</small></div>`;
                    
                    if (result.capacity.camera_list.length > 0) {
                        html += `<div class="mb-2"><strong>摄像头列表:</strong></div>`;
                        result.capacity.camera_list.forEach(camera => {
                            html += `<div class="card mb-2">`;
                            html += `<div class="card-body p-2">`;
                            html += `<div class="mb-1"><small><strong>📹 ${camera.camera_index}</strong></small></div>`;
                            html += `<div class="ml-2">`;
                            camera.video_list.forEach(video => {
                                const videoId = `${deviceSn}/${camera.camera_index}/${video.video_index}`;
                                html += `<div class="d-flex justify-content-between align-items-center mb-1">`;
                                html += `<small>• ${video.video_index} (${video.video_type})</small>`;
                                html += `<button class="btn btn-xs btn-outline-success" onclick="selectVideoForLivestream('${videoId}', '${deviceSn}', '${camera.camera_index}', '${video.video_index}', '${video.video_type}')" style="font-size: 10px; padding: 1px 6px;">选择直播</button>`;
                                html += `</div>`;
                                if (video.switchable_video_types.length > 1) {
                                    html += `<small class="text-muted d-block ml-3">可切换: ${video.switchable_video_types.join(', ')}</small>`;
                                }
                            });
                            html += `</div></div></div>`;
                        });
                    } else {
                        html += `<div class="text-muted">无可用摄像头</div>`;
                    }
                } else {
                    html += `<div class="text-warning">${result.message}</div>`;
                }
                
                document.getElementById('livestreamCapacityResult').innerHTML = html;
                log('设备直播能力获取成功', 'success');
                
            } catch (error) {
                log(`获取设备直播能力失败: ${error.message}`, 'error');
                document.getElementById('livestreamCapacityResult').innerHTML = 
                    `<div class="text-danger">获取失败: ${error.message}</div>`;
            }
        }

        // 选择视频流进行直播
        function selectVideoForLivestream(videoId, deviceSn, cameraIndex, videoIndex, videoType) {
            // 获取当前网关设备SN (不改变)
            const gatewayDeviceSn = document.getElementById('deviceSn').value;
            
            // 存储选择的视频流信息，但使用网关设备SN
            window.selectedVideoStream = {
                videoId: videoId,
                sourceDeviceSn: deviceSn,  // 视频流来源设备
                deviceSn: gatewayDeviceSn,  // 网关设备SN (用于控制)
                cameraIndex: cameraIndex,
                videoIndex: videoIndex,
                videoType: videoType
            };
            
            // 不更新设备SN输入框，保持机场网关SN
            
            // 显示选中的视频流信息
            const detailsHtml = `
                <small class="d-block"><strong>视频源设备:</strong> ${deviceSn}</small>
                <small class="d-block"><strong>控制网关:</strong> ${gatewayDeviceSn}</small>
                <small class="d-block"><strong>摄像头:</strong> ${cameraIndex}</small>
                <small class="d-block"><strong>视频流:</strong> ${videoIndex} (${videoType})</small>
                <small class="d-block"><strong>Video ID:</strong> ${videoId}</small>
                <small class="d-block text-info"><strong>💡 提示:</strong> 云台控制将使用此摄像头 (${cameraIndex})</small>
            `;
            
            document.getElementById('selectedVideoDetails').innerHTML = detailsHtml;
            document.getElementById('selectedVideoInfo').style.display = 'block';
            
            log(`已选择视频流: ${videoId} (来源: ${deviceSn}, 控制: ${gatewayDeviceSn})`, 'info');
        }

        // 清除视频流选择
        function clearVideoSelection() {
            window.selectedVideoStream = null;
            document.getElementById('selectedVideoInfo').style.display = 'none';
            log('已清除视频流选择', 'info');
        }

        // 增强的开始直播函数
        async function startLivestreamWithSelected() {
            if (!window.selectedVideoStream) {
                log('请先选择要直播的视频流', 'error');
                return;
            }
            
            const deviceSn = window.selectedVideoStream.deviceSn;
            const videoId = window.selectedVideoStream.videoId;
            const streamType = document.getElementById('streamType').value;
            const quality = parseInt(document.getElementById('streamQuality').value);
            
            try {
                log(`开始${streamType.toUpperCase()}推流: ${videoId}`, 'info');
                
                const payload = {
                    video_id: videoId,
                    video_quality: quality,
                    url_type: streamType === 'rtmp' ? 1 : 4
                };
                
                const result = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/livestream/start`, 'POST', payload);
                
                // 更新界面显示
                document.getElementById('streamStatus').textContent = '推流中';
                document.getElementById('streamProtocol').textContent = streamType.toUpperCase();
                
                // 显示后台返回的推流地址
                if (result.push_url) {
                    document.getElementById('vlcUrl').textContent = result.push_url;
                    log(`推流地址: ${result.push_url}`, 'success');
                    
                    // 自动启动视频播放
                    startVideoPlayback(result.push_url, streamType);
                } else {
                    document.getElementById('vlcUrl').textContent = '后台未返回推流地址';
                }
                
                currentVideoId = videoId;
                log('推流启动成功', 'success');
                log(`推流ID: ${result.bid || 'N/A'}`, 'info');
                
                // 显示动态清晰度切换控制  
                document.getElementById('dynamicQualityControl').style.display = 'block';
                document.getElementById('dynamicQuality').value = quality.toString();
                
                // 显示镜头切换控制
                document.getElementById('lensChangeControl').style.display = 'block';
                document.getElementById('currentLensType').textContent = '默认';
                
                displayResponse('streamApiResponse', result);
            } catch (error) {
                log(`推流启动失败: ${error.message}`, 'error');
                document.getElementById('streamStatus').textContent = '启动失败';
            }
        }

        // 获取云台控制使用的 payload_index (优先使用选择的摄像头)
        async function getGimbalPayloadIndex(deviceSn) {
            // 优先使用选择的摄像头的camera_index
            if (window.selectedVideoStream && window.selectedVideoStream.cameraIndex) {
                log(`使用选择的摄像头索引: ${window.selectedVideoStream.cameraIndex}`, 'info');
                return window.selectedVideoStream.cameraIndex;
            }
            
            // 如果没有选择摄像头，则自动获取
            try {
                const statusResult = await apiRequest(`/api/v1/control/devices/${deviceSn}/status`, 'GET');
                
                // 从设备状态中查找摄像头信息
                if (statusResult.data && statusResult.data.cameras) {
                    const cameras = statusResult.data.cameras;
                    
                    // 获取第一个可用的camera_index作为云台控制索引
                    for (const cameraIndex in cameras) {
                        const camera = cameras[cameraIndex];
                        if (camera && camera.camera_index) {
                            log(`自动获取摄像头索引: ${camera.camera_index}`, 'info');
                            return camera.camera_index;
                        }
                    }
                }
                
                // 如果没有找到摄像头，尝试从直播能力中获取
                try {
                    const capacityResult = await apiRequest(`/api/v1/livestream/devices/${deviceSn}/capacity`, 'GET');
                    if (capacityResult.data && capacityResult.data.cameras && capacityResult.data.cameras.length > 0) {
                        const firstCamera = capacityResult.data.cameras[0];
                        log(`从直播能力获取摄像头索引: ${firstCamera.camera_index}`, 'info');
                        return firstCamera.camera_index;
                    }
                } catch (capacityError) {
                    log(`获取直播能力失败: ${capacityError.message}`, 'warning');
                }
                
                // 如果都没有找到，使用默认值
                log('未找到摄像头索引，使用默认camera_index', 'warning');
                return "52-0-0";
                
            } catch (error) {
                log(`获取camera_index失败，使用默认值: ${error.message}`, 'warning');
                return "52-0-0";
            }
        }

        // 云台控制
        async function gimbalReset() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/reset`, 'POST', {
                    payload_index: payloadIndex
                });
                log('云台已复位', 'success');
                displayResponse('gimbalApiResponse', result);
            } catch (error) {
                log(`云台复位失败: ${error.message}`, 'error');
            }
        }

        async function gimbalStop() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/stop`, 'POST', {
                    payload_index: payloadIndex
                });
                log('云台已停止', 'success');
                displayResponse('gimbalApiResponse', result);
            } catch (error) {
                log(`云台停止失败: ${error.message}`, 'error');
            }
        }

        // 云台方向控制
        async function gimbalDirectionControl(direction) {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/direction-control`, 'POST', {
                    payload_index: payloadIndex,
                    direction: direction
                });
                log(`云台${direction}控制成功`, 'success');
                displayResponse('gimbalApiResponse', result);
            } catch (error) {
                log(`云台${direction}控制失败: ${error.message}`, 'error');
            }
        }

        // 精确角度控制
        async function gimbalSetAngle() {
            const deviceSn = document.getElementById('deviceSn').value;
            const pitch = document.getElementById('gimbalPitch').value;
            const yaw = document.getElementById('gimbalYaw').value;
            
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            if (!pitch && !yaw) {
                log('请输入俯仰角或偏航角', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const resetData = {
                    payload_index: payloadIndex
                };
                
                if (pitch !== '') {
                    resetData.pitch = parseInt(pitch);
                }
                if (yaw !== '') {
                    resetData.yaw = parseInt(yaw);
                }
                
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/reset`, 'POST', resetData);
                log(`云台角度设置成功: pitch=${pitch}°, yaw=${yaw}°`, 'success');
                displayResponse('gimbalApiResponse', result);
            } catch (error) {
                log(`云台角度设置失败: ${error.message}`, 'error');
            }
        }

        // 拖拽速度滑块更新
        function updateSpeedValue(type) {
            const slider = document.getElementById(`${type}SpeedSlider`);
            const valueSpan = document.getElementById(`${type}SpeedValue`);
            valueSpan.textContent = slider.value;
        }

        // 云台拖拽控制变量
        let gimbalDragInterval = null;

        // 开始云台拖拽控制
        async function startGimbalDrag() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            if (gimbalDragInterval) {
                log('云台拖拽控制已在运行中', 'warning');
                return;
            }
            
            // 获取payload_index
            const payloadIndex = await getGimbalPayloadIndex(deviceSn);
            log('开始云台拖拽控制', 'success');
            
            // 每100ms发送一次控制指令
            gimbalDragInterval = setInterval(async () => {
                const pitchSpeed = parseInt(document.getElementById('pitchSpeedSlider').value);
                const yawSpeed = parseInt(document.getElementById('yawSpeedSlider').value);
                
                if (pitchSpeed === 0 && yawSpeed === 0) {
                    return; // 速度为0时不发送指令
                }
                
                try {
                    await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/drag-control`, 'POST', {
                        payload_index: payloadIndex,
                        pitch_speed: pitchSpeed,
                        yaw_speed: yawSpeed
                    });
                } catch (error) {
                    log(`云台拖拽控制失败: ${error.message}`, 'error');
                }
            }, 100);
        }

        // 停止云台拖拽控制
        function stopGimbalDrag() {
            if (gimbalDragInterval) {
                clearInterval(gimbalDragInterval);
                gimbalDragInterval = null;
                log('云台拖拽控制已停止', 'info');
                
                // 重置速度滑块
                document.getElementById('pitchSpeedSlider').value = 0;
                document.getElementById('yawSpeedSlider').value = 0;
                updateSpeedValue('pitch');
                updateSpeedValue('yaw');
            }
        }

        // Look At 坐标控制
        async function gimbalLookAt() {
            const deviceSn = document.getElementById('deviceSn').value;
            const latitude = document.getElementById('lookAtLat').value;
            const longitude = document.getElementById('lookAtLng').value;
            const altitude = document.getElementById('lookAtAlt').value;
            
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            if (!latitude || !longitude || !altitude) {
                log('请输入完整的坐标信息（纬度、经度、高度）', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/look-at`, 'POST', {
                    payload_index: payloadIndex,
                    target_latitude: parseFloat(latitude),
                    target_longitude: parseFloat(longitude),
                    target_altitude: parseFloat(altitude)
                });
                log(`云台Look At成功: (${latitude}, ${longitude}, ${altitude})`, 'success');
                displayResponse('gimbalApiResponse', result);
            } catch (error) {
                log(`云台Look At失败: ${error.message}`, 'error');
            }
        }

        // 获取云台状态
        async function getGimbalStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/gimbal/status`, 'GET');
                log('云台状态获取成功', 'success');
                document.getElementById('gimbalStatusDisplay').textContent = JSON.stringify(result.data, null, 2);
            } catch (error) {
                log(`获取云台状态失败: ${error.message}`, 'error');
                document.getElementById('gimbalStatusDisplay').textContent = `获取失败: ${error.message}`;
            }
        }

        // 显示当前使用的camera_index
        async function showCurrentCameraIndex() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const cameraIndex = await getGimbalPayloadIndex(deviceSn);
                log(`当前云台控制使用的Camera索引: ${cameraIndex}`, 'info');
                document.getElementById('gimbalStatusDisplay').textContent = `当前使用的Camera索引: ${cameraIndex}`;
            } catch (error) {
                log(`获取Camera索引失败: ${error.message}`, 'error');
            }
        }

        // 获取飞行控制权
        async function grabFlightAuthority() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/flight`, 'POST');
                log('飞行控制权获取成功', 'success');
                displayResponse('authorityStatusDisplay', result);
            } catch (error) {
                log(`获取飞行控制权失败: ${error.message}`, 'error');
            }
        }

        // 获取负载控制权
        async function grabPayloadAuthority() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/payload`, 'POST', {
                    payload_index: payloadIndex
                });
                log(`负载控制权获取成功: ${payloadIndex}`, 'success');
                displayResponse('authorityStatusDisplay', result);
            } catch (error) {
                log(`获取负载控制权失败: ${error.message}`, 'error');
            }
        }

        // 释放飞行控制权
        async function releaseFlightAuthority() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/flight`, 'DELETE');
                log('飞行控制权释放成功', 'success');
                displayResponse('authorityStatusDisplay', result);
            } catch (error) {
                log(`释放飞行控制权失败: ${error.message}`, 'error');
            }
        }

        // 释放负载控制权
        async function releasePayloadAuthority() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const payloadIndex = await getGimbalPayloadIndex(deviceSn);
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/payload/${payloadIndex}`, 'DELETE');
                log(`负载控制权释放成功: ${payloadIndex}`, 'success');
                displayResponse('authorityStatusDisplay', result);
            } catch (error) {
                log(`释放负载控制权失败: ${error.message}`, 'error');
            }
        }

        // 查看权限状态
        async function checkAuthorityStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority`, 'GET');
                log('权限状态获取成功', 'success');
                
                // 格式化显示权限信息
                let authorityInfo = '=== 设备权限状态 ===\n';
                
                // 飞行控制权
                if (result.data.flight_authority) {
                    const flight = result.data.flight_authority;
                    authorityInfo += `飞行控制权: ${flight.username} (${flight.user_id})\n`;
                    authorityInfo += `获取时间: ${new Date(flight.obtained_at * 1000).toLocaleString()}\n`;
                } else {
                    authorityInfo += '飞行控制权: 无人占用\n';
                }
                
                // 负载控制权
                authorityInfo += '\n负载控制权:\n';
                if (result.data.payload_authorities && Object.keys(result.data.payload_authorities).length > 0) {
                    for (const [payloadIndex, payload] of Object.entries(result.data.payload_authorities)) {
                        authorityInfo += `  ${payloadIndex}: ${payload.username} (${payload.user_id})\n`;
                        authorityInfo += `  获取时间: ${new Date(payload.obtained_at * 1000).toLocaleString()}\n`;
                    }
                } else {
                    authorityInfo += '  无负载被占用\n';
                }
                
                document.getElementById('authorityStatusDisplay').textContent = authorityInfo;
            } catch (error) {
                log(`获取权限状态失败: ${error.message}`, 'error');
                document.getElementById('authorityStatusDisplay').textContent = `获取权限状态失败: ${error.message}`;
            }
        }

        // 视频播放器控制
        let currentStreamUrl = '';
        
        // 启动视频播放
        async function startVideoPlayback(streamUrl, streamType) {
            const video = document.getElementById('livestreamVideo');
            const overlay = document.getElementById('videoOverlay');
            const videoInfo = document.getElementById('videoInfo');
            
            currentStreamUrl = streamUrl;
            
            // 显示正在连接状态
            overlay.style.display = 'block';
            overlay.innerHTML = `
                <div class="bg-dark bg-opacity-75 p-3 rounded">
                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                    正在连接视频流...
                    <div class="mt-2"><small>流地址: ${streamUrl}</small></div>
                    <div><small>类型: ${streamType.toUpperCase()}</small></div>
                </div>
            `;
            
            // 根据流类型播放视频流，支持重试
            let retryCount = 0;
            const maxRetries = 3;
            
            while (retryCount <= maxRetries) {
                try {
                    if (retryCount > 0) {
                        // 显示重试状态
                        overlay.innerHTML = `
                            <div class="bg-dark bg-opacity-75 p-3 rounded">
                                <div class="spinner-border spinner-border-sm text-warning me-2"></div>
                                正在重试连接视频流... (${retryCount}/${maxRetries})
                                <div class="mt-2"><small>流地址: ${streamUrl}</small></div>
                                <div><small>类型: ${streamType.toUpperCase()}</small></div>
                            </div>
                        `;
                        
                        // 等待2秒后重试
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        log(`第${retryCount}次重试WebRTC连接...`, 'info');
                    }
                    
                    await playWebRTCStream(video, streamUrl);
                    
                    // 成功连接
                    overlay.style.display = 'none';
                    videoInfo.innerHTML = `
                        <div class="text-success mb-1">✓ 视频流播放中</div>
                        <div><small>流地址: ${streamUrl}</small></div>
                        <div><small>类型: ${streamType.toUpperCase()}</small></div>
                        ${retryCount > 0 ? `<div><small>重试${retryCount}次后成功</small></div>` : ''}
                    `;
                    log(`WebRTC流连接成功: ${streamUrl}${retryCount > 0 ? ` (重试${retryCount}次)` : ''}`, 'success');
                    return; // 成功后退出循环
                    
                } catch (error) {
                    retryCount++;
                    log(`WebRTC播放失败 (尝试${retryCount}/${maxRetries + 1}): ${error.message}`, 'warning');
                    
                    if (retryCount > maxRetries) {
                        // 最终失败
                        log(`WebRTC播放最终失败: ${error.message}`, 'error');
                        showPlaybackError(overlay, videoInfo, `WebRTC播放失败: ${error.message}。已重试${maxRetries}次`);
                        return;
                    }
                }
            }
        }
        
        // 检查流是否存在
        async function checkStreamExists(streamUrl) {
            try {
                const apiUrl = await findSrsApiUrl(streamUrl);
                const streamName = extractStreamName(streamUrl);
                
                // 检查SRS streams API
                const streamsResponse = await fetch(`${apiUrl}/api/v1/streams/`);
                if (streamsResponse.ok) {
                    const streamsData = await streamsResponse.json();
                    console.log('当前活跃流列表:', streamsData);
                    
                    if (streamsData.streams && Array.isArray(streamsData.streams)) {
                        const activeStream = streamsData.streams.find(stream => 
                            stream.name === streamName || stream.url === streamUrl
                        );
                        
                        if (activeStream) {
                            console.log('找到活跃流:', activeStream);
                            return true;
                        } else {
                            console.warn(`流 ${streamName} 不在活跃流列表中`);
                            return false;
                        }
                    }
                }
                
                return false;
            } catch (error) {
                console.warn('检查流状态失败:', error);
                return false; // 检查失败时假设流不存在
            }
        }

        // WebRTC流播放
        let pc = null;
        
        async function playWebRTCStream(video, streamUrl) {
            // 如果是RTMP流，转换为WebRTC播放地址
            let webrtcUrl;
            if (streamUrl.startsWith('rtmp://')) {
                webrtcUrl = convertRtmpToWebrtc(streamUrl);
            } else {
                webrtcUrl = streamUrl;
            }
            
            // 先检查流是否存在
            console.log('检查流是否存在...');
            const streamExists = await checkStreamExists(streamUrl);
            if (!streamExists) {
                throw new Error('流不存在或尚未开始推送。请确保设备正在推流，然后重试');
            }
            
            // 关闭之前的连接
            if (pc) {
                pc.close();
                pc = null;
            }
            
            // 创建RTCPeerConnection
            pc = new RTCPeerConnection({
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }
                ]
            });
            
            // 处理远程流
            return new Promise(async (resolve, reject) => {
                let hasResolved = false;
                
                pc.ontrack = (e) => {
                    console.log('收到远程流:', e.streams[0]);
                    video.srcObject = e.streams[0];
                    video.play().catch(err => console.error('播放失败:', err));
                };
                
                // ICE连接状态监听
                pc.oniceconnectionstatechange = () => {
                    console.log('ICE连接状态:', pc.iceConnectionState);
                    if (pc.iceConnectionState === 'connected' && !hasResolved) {
                        hasResolved = true;
                        resolve();
                    } else if (pc.iceConnectionState === 'failed' && !hasResolved) {
                        hasResolved = true;
                        reject(new Error('WebRTC连接失败'));
                    }
                };
                
                try {
                    // 创建offer
                    const offer = await pc.createOffer({
                        offerToReceiveAudio: true,
                        offerToReceiveVideo: true
                    });
                    
                    await pc.setLocalDescription(offer);
                    
                    // 找到可用的SRS API地址
                    const apiUrl = await findSrsApiUrl(webrtcUrl);
                    console.log('SRS API地址:', apiUrl);
                    console.log('WebRTC播放地址:', webrtcUrl);
                    
                    console.log('发送到SRS的请求体:', {
                        sdp: offer.sdp,
                        streamurl: webrtcUrl
                    });
                    
                    const response = await fetch(`${apiUrl}/rtc/v1/play/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            sdp: offer.sdp,
                            streamurl: webrtcUrl
                        })
                    });
                    
                    console.log('SRS响应状态:', response.status, response.statusText);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('SRS服务器错误响应:', errorText);
                        throw new Error(`SRS服务器响应错误: ${response.status} - ${response.statusText}. 响应内容: ${errorText}`);
                    }
                    
                    const data = await response.json();
                    console.log('SRS完整响应数据:', JSON.stringify(data, null, 2));
                    
                    if (data.code !== 0) {
                        throw new Error(`SRS错误(code:${data.code}): ${data.msg || data.message || '未知错误'}`);
                    }
                    
                    // 验证SDP数据
                    if (!data.sdp) {
                        console.error('SRS响应结构:', Object.keys(data));
                        console.error('完整响应内容:', data);
                        throw new Error(`SRS返回的数据中没有SDP信息。响应包含的字段: ${Object.keys(data).join(', ')}`);
                    }
                    
                    // 检查SDP格式
                    if (!data.sdp.startsWith('v=')) {
                        console.error('无效的SDP格式:', data.sdp);
                        throw new Error('SRS返回的SDP格式无效，缺少v=行');
                    }
                    
                    console.log('接收到的SDP:', data.sdp);
                    
                    // 设置远程描述
                    try {
                        await pc.setRemoteDescription({
                            type: 'answer',
                            sdp: data.sdp
                        });
                        console.log('远程SDP设置成功');
                    } catch (sdpError) {
                        console.error('SDP设置失败:', sdpError);
                        console.error('问题SDP内容:', data.sdp);
                        throw new Error(`SDP设置失败: ${sdpError.message}`);
                    }
                    
                    console.log('WebRTC连接建立成功');
                    
                    // 设置超时
                    setTimeout(() => {
                        if (!hasResolved) {
                            hasResolved = true;
                            reject(new Error('连接超时'));
                        }
                    }, 10000);
                    
                } catch (error) {
                    if (!hasResolved) {
                        hasResolved = true;
                        reject(error);
                    }
                }
            });
        }
        
        // 根据API地址调整目标服务器地址（通用函数）
        function adjustServerAddress(originalUrl, targetProtocol = null, targetPort = null) {
            try {
                // 获取当前API地址作为目标服务器
                const apiUrl = document.getElementById('apiUrl').value || 'http://192.168.111.49:8000';
                const apiUrlObj = new URL(apiUrl);
                const targetServer = apiUrlObj.hostname;
                
                // 解析原始URL
                const originalUrlObj = new URL(originalUrl);
                
                // 构建新URL
                const protocol = targetProtocol || originalUrlObj.protocol.slice(0, -1); // 移除冒号
                const port = targetPort || originalUrlObj.port || '';
                const portStr = port ? `:${port}` : '';
                const pathname = originalUrlObj.pathname;
                const search = originalUrlObj.search;
                
                const newUrl = `${protocol}://${targetServer}${portStr}${pathname}${search}`;
                
                if (originalUrlObj.hostname !== targetServer) {
                    console.log(`服务器地址调整: ${originalUrl} -> ${newUrl}`);
                }
                
                return newUrl;
            } catch (error) {
                console.error('服务器地址调整失败:', error);
                return originalUrl;
            }
        }

        // 转换RTMP地址为WebRTC地址 - 根据API地址动态调整
        function convertRtmpToWebrtc(rtmpUrl) {
            try {
                // 解析RTMP URL: rtmp://server:port/app/stream
                const url = new URL(rtmpUrl);
                const pathParts = url.pathname.split('/').filter(part => part.length > 0);
                
                if (pathParts.length < 2) {
                    // 使用通用函数调整服务器地址，WebRTC端口是8000
                    return adjustServerAddress('webrtc://placeholder:8000/live/stream', 'webrtc', '8000');
                }
                
                // 构建基础WebRTC URL然后调整服务器地址
                const app = pathParts[0];
                const stream = pathParts.slice(1).join('/');
                const baseWebrtcUrl = `webrtc://${url.hostname}:8000/${app}/${stream}`;
                
                // 使用通用函数调整服务器地址，WebRTC端口是8000
                const webrtcUrl = adjustServerAddress(baseWebrtcUrl, 'webrtc', '8000');
                console.log(`RTMP转WebRTC: ${rtmpUrl} -> ${webrtcUrl}`);
                
                return webrtcUrl;
            } catch (error) {
                console.error('RTMP地址转换失败:', error);
                // 简单替换作为后备方案，WebRTC端口是8000
                return rtmpUrl.replace('rtmp://', 'webrtc://').replace(':1935', ':8000');
            }
        }
        
        // 构建SRS API地址 - 根据API地址动态调整，支持多端口尝试
        function buildSrsApiUrl(webrtcUrl) {
            // 获取目标服务器地址
            const apiUrl = document.getElementById('apiUrl').value || 'http://192.168.111.49:8000';
            const apiUrlObj = new URL(apiUrl);
            const targetServer = apiUrlObj.hostname;
            
            // 返回主要的API地址（通常是1985端口）
            return `http://${targetServer}:1985`;
        }
        
        // 尝试多个SRS API端口
        async function findSrsApiUrl(webrtcUrl) {
            const apiUrl = document.getElementById('apiUrl').value || 'http://192.168.111.49:8000';
            const apiUrlObj = new URL(apiUrl);
            const targetServer = apiUrlObj.hostname;
            
            // 常见的SRS API端口
            const possiblePorts = [1985, 8080, 8000, 1990];
            
            for (const port of possiblePorts) {
                const testUrl = `http://${targetServer}:${port}`;
                try {
                    console.log(`尝试SRS API端口: ${port}`);
                    // 测试端口是否可用
                    const response = await fetch(`${testUrl}/api/v1/summaries`, { 
                        method: 'GET',
                        timeout: 2000
                    });
                    
                    if (response.ok) {
                        console.log(`找到可用的SRS API端口: ${port}`);
                        return testUrl;
                    }
                } catch (error) {
                    console.log(`端口 ${port} 不可用:`, error.message);
                }
            }
            
            // 如果都不可用，返回默认的1985端口
            console.warn('未找到可用的SRS API端口，使用默认1985');
            return `http://${targetServer}:1985`;
        }
        
        // 显示播放错误
        function showPlaybackError(overlay, videoInfo, errorMessage) {
            overlay.style.display = 'block';
            overlay.innerHTML = `
                <div class="bg-dark bg-opacity-75 p-3 rounded">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2 text-warning"></i>
                    <div>${errorMessage}</div>
                    <small class="text-muted mt-2 d-block">请检查SRS服务器配置或使用VLC播放器</small>
                </div>
            `;
            videoInfo.textContent = '播放失败';
            log(errorMessage, 'error');
        }
        
        // 停止视频播放
        function stopVideoPlayback() {
            const video = document.getElementById('livestreamVideo');
            const overlay = document.getElementById('videoOverlay');
            const videoInfo = document.getElementById('videoInfo');
            
            video.pause();
            video.src = '';
            video.load();
            
            overlay.style.display = 'block';
            overlay.innerHTML = `
                <div class="bg-dark bg-opacity-75 p-3 rounded">
                    <i class="fas fa-stop-circle fa-2x mb-2"></i>
                    <div>直播已停止</div>
                </div>
            `;
            videoInfo.textContent = '直播已停止';
            currentStreamUrl = '';
            
            log('视频播放已停止', 'info');
        }
        
        // 从RTMP URL中提取流名称
        function extractStreamName(rtmpUrl) {
            // 从类似 "rtmp://localhost:1935/live/stream123" 中提取 "stream123"
            const parts = rtmpUrl.split('/');
            return parts[parts.length - 1] || 'default';
        }
        
        // 刷新视频
        function refreshVideo() {
            if (currentStreamUrl) {
                const streamType = document.getElementById('streamType').value;
                startVideoPlayback(currentStreamUrl, streamType);
                log('视频流已刷新', 'info');
            } else {
                log('没有可刷新的视频流', 'warning');
            }
        }
        
        // 全屏播放
        function toggleFullscreen() {
            const video = document.getElementById('livestreamVideo');
            
            if (video.requestFullscreen) {
                video.requestFullscreen();
            } else if (video.webkitRequestFullscreen) {
                video.webkitRequestFullscreen();
            } else if (video.msRequestFullscreen) {
                video.msRequestFullscreen();
            } else {
                log('浏览器不支持全屏功能', 'warning');
            }
        }

        // 更新起飞按钮文字和描述
        function updateTakeoffButtonText() {
            const enableSim = document.getElementById('enableSimulation').checked;
            const takeoffButton = document.getElementById('takeoffButton');
            const flyToButton = document.getElementById('flyToButton');
            const description = document.getElementById('simulationDescription');
            
            if (enableSim) {
                takeoffButton.textContent = '模拟一键起飞';
                flyToButton.textContent = '模拟飞向目标点';
                description.textContent = '模拟模式下飞行器不会实际起飞，但会正常执行准备工作';
            } else {
                takeoffButton.textContent = '一键起飞';
                flyToButton.textContent = '飞向目标点';
                description.textContent = '真实飞行模式：飞行器将实际执行起飞和飞行任务';
            }
        }

        // 飞行控制
        async function takeoff() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/takeoff-to-point`, 'POST', {
                    height: 50  // 默认高度50米
                });
                log('起飞指令已发送', 'success');
                displayResponse('flightApiResponse', result);
            } catch (error) {
                log(`起飞失败: ${error.message}`, 'error');
            }
        }

        async function returnHome() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                // 先尝试获取飞行控制权
                try {
                    log('尝试获取飞行控制权...', 'info');
                    await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/flight`, 'POST');
                    log('飞行控制权获取成功', 'success');
                } catch (authError) {
                    log(`获取飞行控制权失败: ${authError.message}，继续尝试返航...`, 'warning');
                }
                
                // 执行返航
                log('发送返航指令...', 'info');
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/return-home`, 'POST');
                log('返航指令已发送', 'success');
                displayResponse('flightApiResponse', result);
            } catch (error) {
                log(`返航失败: ${error.message}`, 'error');
                
                // 如果是权限问题，提供解决建议
                if (error.message.includes('权限') || error.message.includes('authority')) {
                    log('建议：请先点击"获取飞行控制权"按钮，然后再尝试返航', 'warning');
                }
            }
        }

        async function emergencyStop() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/emergency-stop`, 'POST');
                log('紧急停止指令已发送', 'success');
                displayResponse('flightApiResponse', result);
            } catch (error) {
                log(`紧急停止失败: ${error.message}`, 'error');
            }
        }

        // API测试函数
        async function testGetDevices() {
            try {
                const result = await apiRequest('/api/v1/devices/');
                log('获取设备列表成功', 'success');
                displayResponse('deviceApiResponse', result);
            } catch (error) {
                log(`获取设备列表失败: ${error.message}`, 'error');
            }
        }

        async function testGetDeviceStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/status`);
                log('获取设备状态成功', 'success');
                displayResponse('deviceApiResponse', result);
            } catch (error) {
                log(`获取设备状态失败: ${error.message}`, 'error');
            }
        }

        async function testDeviceCount() {
            try {
                const result = await apiRequest('/api/v1/devices/count/total');
                log('获取设备总数成功', 'success');
                displayResponse('deviceApiResponse', result);
            } catch (error) {
                log(`获取设备总数失败: ${error.message}`, 'error');
            }
        }

        // 航线任务API测试
        async function testGetWaylineJobs() {
            const workspaceId = document.getElementById('workspaceId').value;
            if (!workspaceId) {
                log('请输入工作空间ID', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs`);
                log('获取任务列表成功', 'success');
                displayResponse('waylineApiResponse', result);
                
                // 更新任务选择下拉框
                updateJobSelectDropdown(result);
                
            } catch (error) {
                log(`获取任务列表失败: ${error.message}`, 'error');
            }
        }

        async function testCreateWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const deviceSn = document.getElementById('deviceSn').value;
            
            if (!workspaceId || !deviceSn) {
                log('请输入工作空间ID和设备SN', 'error');
                return;
            }
            
            const enableSim = document.getElementById('enableSimulation').checked;
            const taskData = {
                name: `测试任务_${Date.now()}`,
                dock_sn: deviceSn,
                wayline_id: 1,  // 示例航线ID
                task_type: 0,   // 0:立即执行
                max_speed: parseInt(document.getElementById('maxSpeed').value)
            };
            
            // 如果启用模拟飞行
            if (enableSim) {
                taskData.simulate_mission = {
                    is_enable: 1,
                    latitude: parseFloat(document.getElementById('simLatitude').value),
                    longitude: parseFloat(document.getElementById('simLongitude').value),
                    altitude: parseFloat(document.getElementById('simAltitude').value)
                };
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/flight-tasks`, 'POST', taskData);
                log(`创建任务成功${enableSim ? ' (模拟飞行模式)' : ''}`, 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`创建任务失败: ${error.message}`, 'error');
            }
        }

        async function testPauseWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const jobId = prompt('请输入任务ID:');
            
            if (!workspaceId || !jobId) {
                log('请输入工作空间ID和任务ID', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}/pause`, 'POST');
                log('暂停任务成功', 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`暂停任务失败: ${error.message}`, 'error');
            }
        }

        async function testStopWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const jobId = prompt('请输入任务ID:');
            
            if (!workspaceId || !jobId) {
                log('请输入工作空间ID和任务ID', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}/stop`, 'POST');
                log('停止任务成功', 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`停止任务失败: ${error.message}`, 'error');
            }
        }

        // 媒体管理API测试
        async function testGetMediaFiles() {
            try {
                const result = await apiRequest('/api/v1/media/files');
                log('获取媒体列表成功', 'success');
                displayResponse('mediaApiResponse', result);
            } catch (error) {
                log(`获取媒体列表失败: ${error.message}`, 'error');
            }
        }

        async function testMediaStatistics() {
            try {
                const result = await apiRequest('/api/v1/media/statistics');
                log('获取媒体统计成功', 'success');
                displayResponse('mediaApiResponse', result);
            } catch (error) {
                log(`获取媒体统计失败: ${error.message}`, 'error');
            }
        }

        async function testStorageHealth() {
            try {
                const result = await apiRequest('/api/v1/media/health');
                log('存储健康检查成功', 'success');
                displayResponse('mediaApiResponse', result);
            } catch (error) {
                log(`存储健康检查失败: ${error.message}`, 'error');
            }
        }

        async function testUploadMedia() {
            const fileInput = document.getElementById('mediaFile');
            const file = fileInput.files[0];
            
            if (!file) {
                log('请选择要上传的文件', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('workspace_id', document.getElementById('workspaceId').value || '1');
            formData.append('drone_sn', document.getElementById('deviceSn').value || 'test');
            
            try {
                const apiUrl = document.getElementById('apiUrl').value;
                const token = document.getElementById('apiToken').value;
                
                const response = await fetch(`${apiUrl}/api/v1/media/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    log('文件上传成功', 'success');
                    displayResponse('mediaApiResponse', result);
                } else {
                    log(`文件上传失败: ${result.detail || '未知错误'}`, 'error');
                }
            } catch (error) {
                log(`文件上传失败: ${error.message}`, 'error');
            }
        }

        // DRC模式API测试
        async function testEnterDRC() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/enter`, 'POST');
                log('进入DRC模式成功', 'success');
                displayResponse('drcApiResponse', result);
            } catch (error) {
                log(`进入DRC模式失败: ${error.message}`, 'error');
            }
        }

        async function testExitDRC() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/exit`, 'POST');
                log('退出DRC模式成功', 'success');
                displayResponse('drcApiResponse', result);
            } catch (error) {
                log(`退出DRC模式失败: ${error.message}`, 'error');
            }
        }

        async function testGetDRCStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/status`);
                log('获取DRC状态成功', 'success');
                displayResponse('drcApiResponse', result);
            } catch (error) {
                log(`获取DRC状态失败: ${error.message}`, 'error');
            }
        }

        // 权限控制API测试
        async function testGetFlightAuthority() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/flight`, 'POST');
                log('获取飞行权限成功', 'success');
                displayResponse('authorityApiResponse', result);
            } catch (error) {
                log(`获取飞行权限失败: ${error.message}`, 'error');
            }
        }

        async function testReleaseFlightAuthority() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority/flight`, 'DELETE');
                log('释放飞行权限成功', 'success');
                displayResponse('authorityApiResponse', result);
            } catch (error) {
                log(`释放飞行权限失败: ${error.message}`, 'error');
            }
        }

        async function testGetAuthorityStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/authority`);
                log('获取权限状态成功', 'success');
                displayResponse('authorityApiResponse', result);
            } catch (error) {
                log(`获取权限状态失败: ${error.message}`, 'error');
            }
        }

        // 工作空间API测试
        async function testGetWorkspaces() {
            try {
                const result = await apiRequest('/api/v1/workspace/');
                log('获取工作空间成功', 'success');
                displayResponse('workspaceApiResponse', result);
            } catch (error) {
                log(`获取工作空间失败: ${error.message}`, 'error');
            }
        }

        async function testCreateWorkspace() {
            const name = prompt('请输入工作空间名称:');
            if (!name) {
                log('请输入工作空间名称', 'error');
                return;
            }
            
            try {
                const result = await apiRequest('/api/v1/workspace/', 'POST', {
                    name: name,
                    description: `测试工作空间 - ${new Date().toLocaleString()}`
                });
                log('创建工作空间成功', 'success');
                displayResponse('workspaceApiResponse', result);
            } catch (error) {
                log(`创建工作空间失败: ${error.message}`, 'error');
            }
        }

        async function testBindDevice() {
            const workspaceId = document.getElementById('workspaceId').value;
            const deviceSn = document.getElementById('deviceSn').value;
            
            if (!workspaceId || !deviceSn) {
                log('请输入工作空间ID和设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest('/api/v1/devices/bind', 'POST', {
                    workspace_id: parseInt(workspaceId),
                    device_sn: deviceSn
                });
                log('绑定设备成功', 'success');
                displayResponse('workspaceApiResponse', result);
            } catch (error) {
                log(`绑定设备失败: ${error.message}`, 'error');
            }
        }

        // HMS相关
        async function refreshHMS() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                // 根据当前视图模式决定获取哪些消息
                const queryParam = showAllHMS ? '' : '?is_read=false';
                const result = await apiRequest(`/api/v1/hms/devices/${deviceSn}/hms${queryParam}`);
                
                const container = document.getElementById('hmsContainer');
                const count = document.getElementById('hmsCount');
                
                if (result && result.length > 0) {
                    container.innerHTML = '';
                    
                    // 按告警等级排序（警告>提醒>通知）
                    const sortedHms = result.sort((a, b) => (b.level || 0) - (a.level || 0));
                    
                    sortedHms.forEach(hms => {
                        const item = document.createElement('div');
                        item.className = 'hms-item';
                        
                        // 根据DJI官方文档处理告警等级
                        const levelInfo = getHmsLevelInfo(hms.level);
                        
                        // 根据DJI官方文档处理事件模块
                        const moduleInfo = getHmsModuleInfo(hms.module);
                        
                        // 处理飞行状态
                        const skyStatus = hms.in_the_sky === 1 ? '飞行中' : '地面';
                        const skyColor = hms.in_the_sky === 1 ? '#ff6b6b' : '#51cf66';
                        
                        // 处理及时性
                        const imminentStatus = hms.imminent === 1 ? '实时' : '历史';
                        const imminentBadge = hms.imminent === 1 ? 'bg-warning' : 'bg-secondary';
                        
                        // 处理消息内容
                        const message = hms.message_zh || hms.message_en || `告警码: ${hms.code || '未知'}`;
                        
                        // 处理已读状态
                        const isRead = hms.is_read || false;
                        const readBadge = isRead ? '<span class="badge bg-success ms-2">已读</span>' : '';
                        const itemOpacity = isRead ? 'opacity: 0.7;' : '';
                        
                        // 处理时间格式
                        let timeStr = '未知时间';
                        if (hms.create_time) {
                            const timestamp = typeof hms.create_time === 'number' ? hms.create_time : parseInt(hms.create_time);
                            if (timestamp && !isNaN(timestamp)) {
                                const adjustedTimestamp = timestamp < 10000000000 ? timestamp * 1000 : timestamp;
                                timeStr = new Date(adjustedTimestamp).toLocaleString();
                            } else if (typeof hms.create_time === 'string') {
                                timeStr = new Date(hms.create_time).toLocaleString();
                            }
                        }
                        
                        item.innerHTML = `
                            <div style="border-left: 4px solid ${levelInfo.color}; padding: 10px; background: ${levelInfo.bgColor}; ${itemOpacity}">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <span class="badge ${levelInfo.badgeClass} me-2">${levelInfo.text}</span>
                                        <span class="badge ${moduleInfo.badgeClass}">${moduleInfo.text}</span>
                                        ${readBadge}
                                    </div>
                                </div>
                                
                                <div class="mb-2">
                                    <strong>${message}</strong>
                                </div>
                                
                                <div class="row g-2 mb-2">
                                    <div class="col-6">
                                        <small><strong>告警码:</strong> <code>${hms.code || '未知'}</code></small>
                                    </div>
                                    <div class="col-6">
                                        <small><strong>设备类型:</strong> ${hms.device_type_display || hms.device_type || '未知'}</small>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="badge ${imminentBadge} me-1">${imminentStatus}</span>
                                        <span class="badge" style="background-color: ${skyColor}; color: white;">${skyStatus}</span>
                                    </div>
                                    <small class="text-muted">${timeStr}</small>
                                </div>
                            </div>
                        `;
                        container.appendChild(item);
                    });
                    
                    // 统计不同等级和读取状态的数量
                    const levelCounts = { 0: 0, 1: 0, 2: 0 };
                    const readCounts = { read: 0, unread: 0 };
                    
                    result.forEach(hms => {
                        levelCounts[hms.level] = (levelCounts[hms.level] || 0) + 1;
                        if (hms.is_read) {
                            readCounts.read++;
                        } else {
                            readCounts.unread++;
                        }
                    });
                    
                    let countDisplay = `<span class="me-1">${result.length}</span>`;
                    
                    // 如果显示所有消息，区分已读/未读数量
                    if (showAllHMS && readCounts.read > 0) {
                        countDisplay += `<small class="text-success ms-1">已读:${readCounts.read}</small>`;
                    }
                    if (readCounts.unread > 0) {
                        countDisplay += `<small class="text-primary ms-1">未读:${readCounts.unread}</small>`;
                    }
                    
                    // 显示等级统计
                    if (levelCounts[2] > 0) countDisplay += `<small class="text-danger ms-1">警告:${levelCounts[2]}</small>`;
                    if (levelCounts[1] > 0) countDisplay += `<small class="text-warning ms-1">提醒:${levelCounts[1]}</small>`;
                    if (levelCounts[0] > 0) countDisplay += `<small class="text-info ms-1">通知:${levelCounts[0]}</small>`;
                    
                    count.innerHTML = countDisplay;
                } else {
                    if (showAllHMS) {
                        container.innerHTML = '<div class="text-muted text-center p-3">暂无健康告警信息</div>';
                        count.innerHTML = '<span class="badge bg-secondary">0</span>';
                    } else {
                        container.innerHTML = '<div class="text-muted text-center p-3">暂无未读健康告警信息</div>';
                        count.innerHTML = '<span class="badge bg-success">0</span><small class="text-success ms-1">全部已读</small>';
                    }
                }
                
                log('HMS信息已更新', 'success');
            } catch (error) {
                log(`获取HMS信息失败: ${error.message}`, 'error');
            }
        }
        
        // 根据DJI官方文档获取告警等级信息
        function getHmsLevelInfo(level) {
            switch(level) {
                case 0:
                    return {
                        text: '通知',
                        color: '#17a2b8',
                        bgColor: '#e8f6f8',
                        badgeClass: 'bg-info'
                    };
                case 1:
                    return {
                        text: '提醒',
                        color: '#ffc107',
                        bgColor: '#fffbf0',
                        badgeClass: 'bg-warning'
                    };
                case 2:
                    return {
                        text: '警告',
                        color: '#dc3545',
                        bgColor: '#fdf2f2',
                        badgeClass: 'bg-danger'
                    };
                default:
                    return {
                        text: '未知',
                        color: '#6c757d',
                        bgColor: '#f8f9fa',
                        badgeClass: 'bg-secondary'
                    };
            }
        }
        
        // 根据DJI官方文档获取事件模块信息
        function getHmsModuleInfo(module) {
            switch(module) {
                case 0:
                    return {
                        text: '飞行任务',
                        badgeClass: 'bg-primary'
                    };
                case 1:
                    return {
                        text: '设备管理',
                        badgeClass: 'bg-success'
                    };
                case 2:
                    return {
                        text: '媒体',
                        badgeClass: 'bg-info'
                    };
                case 3:
                    return {
                        text: 'HMS',
                        badgeClass: 'bg-dark'
                    };
                default:
                    return {
                        text: '未知模块',
                        badgeClass: 'bg-secondary'
                    };
            }
        }

        async function markHMSRead() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                await apiRequest(`/api/v1/hms/devices/${deviceSn}/hms/mark-read`, 'POST');
                log('HMS消息已标记为已读，已读消息将不再显示', 'success');
                refreshHMS();
            } catch (error) {
                log(`标记HMS已读失败: ${error.message}`, 'error');
            }
        }

        // HMS视图切换功能
        let showAllHMS = false; // 默认只显示未读消息
        
        function toggleHMSView() {
            const toggleBtn = document.getElementById('hmsViewToggle');
            showAllHMS = !showAllHMS;
            
            if (showAllHMS) {
                toggleBtn.textContent = '只看未读';
                toggleBtn.className = 'btn btn-sm btn-warning';
                log('已切换到显示所有HMS消息', 'info');
            } else {
                toggleBtn.textContent = '查看所有';
                toggleBtn.className = 'btn btn-sm btn-outline-secondary';
                log('已切换到只显示未读HMS消息', 'info');
            }
            
            refreshHMS(); // 刷新显示
        }

        // 机场环境数据相关
        async function refreshEnvironmentData() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                // 使用现有的设备状态接口获取数据（包含完整OSD环境信息）
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/status`);
                
                if (result && result.data && result.data.osd && result.data.osd.data) {
                    updateEnvironmentDisplay(result.data.osd.data);
                    log('环境数据已更新', 'success');
                } else {
                    log('获取环境数据失败：无有效数据', 'warning');
                    updateEnvironmentDisplay(null);
                }
            } catch (error) {
                log(`获取环境数据失败: ${error.message}`, 'error');
                // 显示错误状态
                updateEnvironmentDisplay(null);
            }
        }

        function updateEnvironmentDisplay(data) {
            // 降雨量枚举映射
            const rainfallMap = {
                0: '无雨',
                1: '小雨', 
                2: '中雨',
                3: '大雨'
            };

            // 充电状态枚举映射
            const chargeStateMap = {
                0: '空闲',
                1: '充电中'
            };

            if (data) {
                // 更新环境温度
                if (data.environment_temperature !== undefined) {
                    document.getElementById('environmentTemp').textContent = `${data.environment_temperature}°C`;
                }

                // 更新舱内温度
                if (data.temperature !== undefined) {
                    document.getElementById('dockTemp').textContent = `${data.temperature}°C`;
                }

                // 更新风速
                if (data.wind_speed !== undefined) {
                    document.getElementById('windSpeed').textContent = `${data.wind_speed} m/s`;
                }

                // 更新湿度
                if (data.humidity !== undefined) {
                    document.getElementById('humidity').textContent = `${data.humidity}%`;
                }

                // 更新降雨量
                if (data.rainfall !== undefined) {
                    const rainfallText = rainfallMap[data.rainfall] || `${data.rainfall}`;
                    document.getElementById('rainfall').textContent = rainfallText;
                }

                // 更新飞行器充电状态
                if (data.drone_charge_state) {
                    const chargeState = data.drone_charge_state.state;
                    const batteryPercent = data.drone_charge_state.capacity_percent;
                    
                    // 更新充电状态
                    if (chargeState !== undefined) {
                        const chargeText = chargeStateMap[chargeState] || `状态${chargeState}`;
                        document.getElementById('chargeStatus').textContent = chargeText;
                    }
                    
                    // 更新电池电量
                    if (batteryPercent !== undefined) {
                        document.getElementById('batteryLevel').textContent = `${batteryPercent}%`;
                        
                        // 根据电量调整颜色
                        const batteryCard = document.getElementById('batteryLevel').closest('.card');
                        batteryCard.className = batteryCard.className.replace(/bg-(success|warning|danger)/, '');
                        if (batteryPercent >= 60) {
                            batteryCard.classList.add('bg-success');
                        } else if (batteryPercent >= 30) {
                            batteryCard.classList.add('bg-warning');
                        } else {
                            batteryCard.classList.add('bg-danger');
                        }
                    }
                } else {
                    document.getElementById('chargeStatus').textContent = '--';
                    document.getElementById('batteryLevel').textContent = '--%';
                }

                // 更新最后更新时间
                document.getElementById('environmentLastUpdate').textContent = 
                    `最后更新: ${new Date().toLocaleString()}`;

            } else {
                // 显示错误状态
                document.getElementById('environmentTemp').textContent = '--°C';
                document.getElementById('dockTemp').textContent = '--°C';
                document.getElementById('windSpeed').textContent = '-- m/s';
                document.getElementById('humidity').textContent = '--%';
                document.getElementById('rainfall').textContent = '--';
                document.getElementById('chargeStatus').textContent = '--';
                document.getElementById('batteryLevel').textContent = '--%';
                document.getElementById('environmentLastUpdate').textContent = '获取数据失败';
            }
        }

        // 自动刷新环境数据（每30秒）
        let environmentRefreshInterval;
        function startEnvironmentAutoRefresh() {
            // 清除已存在的定时器
            if (environmentRefreshInterval) {
                clearInterval(environmentRefreshInterval);
            }
            
            // 设置30秒自动刷新
            environmentRefreshInterval = setInterval(() => {
                const deviceSn = document.getElementById('deviceSn').value;
                if (deviceSn) {
                    refreshEnvironmentData();
                }
            }, 30000);
        }

        // 停止自动刷新
        function stopEnvironmentAutoRefresh() {
            if (environmentRefreshInterval) {
                clearInterval(environmentRefreshInterval);
                environmentRefreshInterval = null;
            }
        }

        // 辅助函数
        function displayResponse(elementId, data) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = JSON.stringify(data, null, 2);
            }
        }

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = {
                'success': 'text-success',
                'error': 'text-danger',
                'warning': 'text-warning',
                'info': 'text-info'
            }[type] || 'text-muted';
            
            const logEntry = document.createElement('div');
            logEntry.className = logClass;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '<div class="text-muted">日志已清空</div>';
        }

        // DRC控制相关变量
        let drcControlInterval = null;
        let drcControlActive = false;
        
        // DRC杆量控制
        function updateDRCValue(channel) {
            const slider = document.getElementById(`${channel}Slider`);
            const valueSpan = document.getElementById(`${channel}Value`);
            valueSpan.textContent = slider.value;
        }
        
        function resetDRCValues() {
            const channels = ['roll', 'pitch', 'throttle', 'yaw'];
            channels.forEach(channel => {
                const slider = document.getElementById(`${channel}Slider`);
                const valueSpan = document.getElementById(`${channel}Value`);
                slider.value = 1024;
                valueSpan.textContent = 1024;
            });
            log('DRC杆量已重置到中位', 'info');
        }
        
        async function startDRCControl() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            if (drcControlActive) {
                log('DRC控制已在运行中', 'warning');
                return;
            }
            
            drcControlActive = true;
            log('开始DRC杆量控制 (10Hz)', 'success');
            
            // 每100ms发送一次控制指令 (10Hz)
            drcControlInterval = setInterval(async () => {
                const stickData = {
                    roll: parseInt(document.getElementById('rollSlider').value),
                    pitch: parseInt(document.getElementById('pitchSlider').value),
                    throttle: parseInt(document.getElementById('throttleSlider').value),
                    yaw: parseInt(document.getElementById('yawSlider').value)
                };
                
                try {
                    await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/control/stick`, 'POST', stickData);
                } catch (error) {
                    log(`DRC控制发送失败: ${error.message}`, 'error');
                }
            }, 100);
        }
        
        function stopDRCControl() {
            if (drcControlInterval) {
                clearInterval(drcControlInterval);
                drcControlInterval = null;
            }
            drcControlActive = false;
            resetDRCValues();
            log('DRC控制已停止', 'info');
        }
        
        // 更新机场状态面板
        function updateDockStatusPanel(deviceStatus, showPanel = true) {
            const statusPanel = document.getElementById('dockStatusPanel');
            
            if (showPanel) {
                statusPanel.style.display = 'block';
            }
            
            // 获取实际的设备数据（可能在osd.data下或直接在根级别）
            const data = deviceStatus.osd?.data || deviceStatus;
            
            // 机场状态
            if (data.mode_code !== undefined) {
                const modeMap = {
                    '0': '🟢 空闲中', '1': '🟡 现场调试', '2': '🔵 远程调试', 
                    '3': '🟠 固件升级中', '4': '🔴 作业中', '5': '🟣 待标定'
                };
                document.getElementById('dockModeStatus').innerHTML = modeMap[data.mode_code] || data.mode_code;
            }
            
            // 任务状态
            if (data.flighttask_step_code !== undefined) {
                const taskMap = {
                    '0': '作业准备中', '1': '飞行作业中', '2': '作业后状态恢复',
                    '3': '自定义飞行区更新中', '4': '地形障碍物更新中', '5': '任务空闲',
                    '255': '飞行器异常', '256': '未知状态'
                };
                document.getElementById('dockTaskStatus').textContent = taskMap[data.flighttask_step_code] || data.flighttask_step_code;
            }
            
            // 飞行器在舱状态
            if (data.drone_in_dock !== undefined) {
                const inDockMap = {'0': '🚫 舱外', '1': '✅ 舱内'};
                document.getElementById('droneInDockStatus').innerHTML = inDockMap[data.drone_in_dock];
            }
            
            // GPS状态详情
            if (data.position_state) {
                const pos = data.position_state;
                const fixedMap = {'0': '未开始', '1': '收敛中', '2': '✅收敛成功', '3': '❌收敛失败'};
                const qualityMap = {'1': '1档', '2': '2档', '3': '3档', '4': '4档', '5': '5档', '10': '🟢RTK Fixed'};
                const gpsDetail = `${fixedMap[pos.is_fixed] || '未知'} | ${qualityMap[pos.quality] || pos.quality + '档'}`;
                document.getElementById('gpsStatusDetail').innerHTML = gpsDetail;
            }
            
            // 舱盖状态
            if (data.cover_state !== undefined) {
                const coverMap = {'0': '🔴 关闭', '1': '🟢 打开', '2': '🟡 半开', '3': '❌ 异常'};
                document.getElementById('coverStateStatus').innerHTML = coverMap[data.cover_state] || data.cover_state;
            }
            
            // 累计作业次数
            if (data.job_number !== undefined) {
                document.getElementById('jobNumberStatus').textContent = `${data.job_number} 次`;
            }
        }
        
        // 获取设备坐标功能
        async function getDeviceCoordinates() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                log('正在获取设备坐标...', 'info');
                
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/status`);
                
                // 调试：显示API返回结构
                console.log('API返回的完整数据:', JSON.stringify(result, null, 2));
                log(`API返回数据结构: ${Object.keys(result).join(', ')}`, 'info');
                
                // 获取实际的数据部分
                const deviceData = result.data || result;
                
                // 详细检查每个条件
                log('=== 条件检查开始 ===', 'info');
                log(`条件1: deviceData.longitude !== undefined = ${deviceData.longitude !== undefined}`, 'info');
                log(`条件1: deviceData.latitude !== undefined = ${deviceData.latitude !== undefined}`, 'info');
                log(`条件2: deviceData.osd存在 = ${deviceData.osd !== undefined}`, 'info');
                log(`条件2: deviceData.osd.data存在 = ${deviceData.osd && deviceData.osd.data !== undefined}`, 'info');
                log(`条件2: deviceData.osd.data.latitude存在 = ${deviceData.osd && deviceData.osd.data && deviceData.osd.data.latitude !== undefined}`, 'info');
                log(`条件2: deviceData.osd.data.longitude存在 = ${deviceData.osd && deviceData.osd.data && deviceData.osd.data.longitude !== undefined}`, 'info');
                if (deviceData.osd && deviceData.osd.data) {
                    log(`deviceData.osd.data.latitude值: ${deviceData.osd.data.latitude}`, 'info');
                    log(`deviceData.osd.data.longitude值: ${deviceData.osd.data.longitude}`, 'info');
                }
                log('=== 条件检查结束 ===', 'info');
                
                // 检查设备状态中的位置信息
                let lat = 0, lng = 0, alt = 0;
                let dataSource = '未知';
                let gpsStatus = '未知';
                
                // 优先从机场属性获取位置信息（更精确）
                if (deviceData.longitude !== undefined && deviceData.latitude !== undefined) {
                    log('检测到机场属性中的坐标', 'info');
                    lat = parseFloat(deviceData.latitude);
                    lng = parseFloat(deviceData.longitude);
                    alt = parseFloat(deviceData.height || 0);
                    dataSource = '机场属性';
                    
                    // 解析GPS/RTK状态
                    if (deviceData.position_state) {
                        const pos = deviceData.position_state;
                        const fixedMap = {'0': '未开始', '1': '收敛中', '2': '收敛成功', '3': '收敛失败'};
                        const qualityMap = {'1': '1档', '2': '2档', '3': '3档', '4': '4档', '5': '5档', '10': 'RTK Fixed'};
                        gpsStatus = `${fixedMap[pos.is_fixed] || '未知'} | ${qualityMap[pos.quality] || pos.quality + '档'} | GPS:${pos.gps_number || 0} RTK:${pos.rtk_number || 0}`;
                    }
                }
                // 备用：从 OSD 数据获取（实际API返回的结构）
                else if (deviceData.osd && deviceData.osd.data && deviceData.osd.data.latitude !== undefined && deviceData.osd.data.longitude !== undefined) {
                    log('检测到OSD数据中的坐标', 'info');
                    console.log('OSD数据:', deviceData.osd.data);
                    lat = parseFloat(deviceData.osd.data.latitude);
                    lng = parseFloat(deviceData.osd.data.longitude);
                    alt = parseFloat(deviceData.osd.data.height || 0);
                    dataSource = 'OSD数据';
                    
                    // 解析GPS/RTK状态
                    if (deviceData.osd.data.position_state) {
                        const pos = deviceData.osd.data.position_state;
                        const fixedMap = {'0': '未开始', '1': '收敛中', '2': '收敛成功', '3': '收敛失败'};
                        const qualityMap = {'1': '1档', '2': '2档', '3': '3档', '4': '4档', '5': '5档', '10': 'RTK Fixed'};
                        gpsStatus = `${fixedMap[pos.is_fixed] || '未知'} | ${qualityMap[pos.quality] || pos.quality + '档'} | GPS:${pos.gps_number || 0} RTK:${pos.rtk_number || 0}`;
                    }
                }
                // 兼容性：从旧的 OSD 数据结构获取
                else if (deviceData.osd && deviceData.osd.latitude && deviceData.osd.longitude) {
                    log('检测到OSD旧格式中的坐标', 'info');
                    lat = parseFloat(deviceData.osd.latitude);
                    lng = parseFloat(deviceData.osd.longitude);
                    alt = parseFloat(deviceData.osd.height || deviceData.osd.elevation || 0);
                    dataSource = 'OSD数据(旧格式)';
                    
                    if (deviceData.osd.position_state) {
                        const pos = deviceData.osd.position_state;
                        gpsStatus = `GPS:${pos.gps_number || 0} RTK:${pos.rtk_number || 0}`;
                    }
                } else {
                    log('未检测到任何坐标数据', 'warning');
                    console.log('检查数据结构:');
                    console.log('- deviceData.longitude:', deviceData.longitude);
                    console.log('- deviceData.latitude:', deviceData.latitude);
                    console.log('- deviceData.osd:', deviceData.osd);
                    if (deviceData.osd) {
                        console.log('- deviceData.osd.data:', deviceData.osd.data);
                        if (deviceData.osd.data) {
                            console.log('- deviceData.osd.data.latitude:', deviceData.osd.data.latitude);
                            console.log('- deviceData.osd.data.longitude:', deviceData.osd.data.longitude);
                        }
                    }
                }
                
                // 检查坐标是否有效
                if (lat !== 0 && lng !== 0) {
                    // 填入坐标数据
                    document.getElementById('simLatitude').value = lat.toFixed(6);
                    document.getElementById('simLongitude').value = lng.toFixed(6);
                    document.getElementById('simAltitude').value = alt.toFixed(1);
                    
                    // 更新状态指示器
                    document.getElementById('latStatus').textContent = '自动';
                    document.getElementById('latStatus').className = 'input-group-text bg-success text-white';
                    document.getElementById('lngStatus').textContent = '自动';
                    document.getElementById('lngStatus').className = 'input-group-text bg-success text-white';
                    document.getElementById('altStatus').textContent = '自动';
                    document.getElementById('altStatus').className = 'input-group-text bg-success text-white';
                    
                    // 更新信息显示
                    const coordText = `${dataSource}: ${lat.toFixed(6)}, ${lng.toFixed(6)}, 高度: ${alt.toFixed(1)}m`;
                    document.getElementById('coordinateInfo').textContent = coordText;
                    document.getElementById('coordinateInfo').className = 'text-success d-block';
                    
                    log(`机场坐标已获取[数据源: ${dataSource}]: 纬度=${lat.toFixed(6)}, 经度=${lng.toFixed(6)}, 高度=${alt.toFixed(1)}m`, 'success');
                    log(`GPS/RTK状态: ${gpsStatus}`, 'info');
                    
                    // 显示机场状态 - 优先从osd.data获取，备用从根级别获取
                    const statusData = deviceData.osd?.data || deviceData;
                    if (statusData.mode_code !== undefined) {
                        const modeMap = {'0': '空闲中', '1': '现场调试', '2': '远程调试', '3': '固件升级中', '4': '作业中', '5': '待标定'};
                        log(`机场状态: ${modeMap[statusData.mode_code] || statusData.mode_code}`, 'info');
                    }
                    
                    // 显示飞行器状态
                    if (statusData.drone_in_dock !== undefined) {
                        const inDockMap = {'0': '舱外', '1': '舱内'};
                        log(`飞行器位置: ${inDockMap[statusData.drone_in_dock]}`, 'info');
                    }
                    
                    // 更新机场状态面板
                    updateDockStatusPanel(deviceData);
                    
                } else {
                    log('设备GPS信号未锁定，坐标为(0,0)', 'warning');
                    document.getElementById('coordinateInfo').textContent = `GPS信号未锁定 [${gpsStatus}] - 请等待设备获取GPS信号`;
                    document.getElementById('coordinateInfo').className = 'text-warning d-block';
                    
                    // 隐藏状态面板
                    document.getElementById('dockStatusPanel').style.display = 'none';
                    
                    // 显示详细GPS状态帮助诊断
                    if (dataSource !== '未知') {
                        log(`数据源: ${dataSource}, GPS状态: ${gpsStatus}`, 'info');
                        // 更新部分状态信息
                        updateDockStatusPanel(deviceData, false);
                    } else {
                        log('设备未上报位置信息', 'warning');
                        document.getElementById('coordinateInfo').textContent = '设备未上报位置信息，请检查设备是否在线和GPS状态';
                        document.getElementById('coordinateInfo').className = 'text-warning d-block';
                    }
                }
                
                // 显示完整的API响应供调试
                displayResponse('waylineApiResponse', deviceData);
                
            } catch (error) {
                log(`获取设备坐标失败: ${error.message}`, 'error');
                document.getElementById('coordinateInfo').textContent = '获取坐标失败，请检查设备连接和权限';
                document.getElementById('coordinateInfo').className = 'text-danger d-block';
            }
        }
        
        // ========================================
        // 航线任务完整流程管理函数
        // ========================================
        
        // 步骤1: 上传航线文件
        async function uploadWaylineFile() {
            const workspaceId = document.getElementById('workspaceId').value;
            const fileInput = document.getElementById('waylineFile');
            const waylineName = document.getElementById('waylineName').value;
            const droneModelKey = document.getElementById('droneModelKey').value;
            
            if (!workspaceId) {
                log('请输入工作空间ID', 'error');
                return;
            }
            
            if (!fileInput.files[0]) {
                log('请选择要上传的航线文件', 'error');
                return;
            }
            
            if (!waylineName) {
                log('请输入航线名称', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            if (!file.name.endsWith('.kmz')) {
                log('请选择.kmz格式的航线文件', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('name', waylineName);
            formData.append('drone_model_key', droneModelKey);
            formData.append('template_types', '0'); // 默认航点飞行
            formData.append('favorited', 'false');
            
            try {
                const apiUrl = document.getElementById('apiUrl').value;
                const token = document.getElementById('apiToken').value;
                
                log('开始上传航线文件...', 'info');
                
                const response = await fetch(`${apiUrl}/api/v1/wayline/workspaces/${workspaceId}/files/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (response.ok && result.code === 0) {
                    log(`航线文件上传成功: ${result.data.name}`, 'success');
                    displayResponse('waylineApiResponse', result);
                    // 自动刷新航线文件列表
                    await getWaylineFiles();
                } else {
                    log(`航线文件上传失败: ${result.message || result.detail || '未知错误'}`, 'error');
                    displayResponse('waylineApiResponse', result);
                }
            } catch (error) {
                log(`航线文件上传失败: ${error.message}`, 'error');
            }
        }
        
        // 获取已上传的航线文件列表
        async function getWaylineFiles() {
            const workspaceId = document.getElementById('workspaceId').value;
            if (!workspaceId) {
                log('请输入工作空间ID', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/files`);
                log('获取航线文件列表成功', 'success');
                displayResponse('waylineApiResponse', result);
                
                // 详细调试API响应结构
                console.log('=== API响应调试信息 ===');
                console.log('完整响应:', result);
                console.log('result.data:', result.data);
                if (result.data) {
                    console.log('result.data.data:', result.data.data);
                    console.log('result.data类型:', typeof result.data);
                    console.log('result.data是否为数组:', Array.isArray(result.data));
                }
                console.log('========================');
                
                // 更新航线文件选择下拉框
                const waylineSelect = document.getElementById('waylineFileSelect');
                waylineSelect.innerHTML = '<option value="">选择航线文件...</option>';
                
                // 处理不同的数据结构
                let files = [];
                if (result.data) {
                    if (result.data.list && Array.isArray(result.data.list)) {
                        // 新发现的结构：{list: Array, pagination: {...}}
                        files = result.data.list;
                        console.log('使用list结构，文件数量:', files.length);
                    } else if (result.data.data && Array.isArray(result.data.data)) {
                        files = result.data.data; // 有分页信息的结构
                        console.log('使用分页结构，文件数量:', files.length);
                    } else if (Array.isArray(result.data)) {
                        files = result.data; // 直接是数组的结构
                        console.log('使用数组结构，文件数量:', files.length);
                    } else if (result.data.wayline_id) {
                        files = [result.data]; // 单个文件的结构
                        console.log('使用单文件结构');
                    } else {
                        console.log('未识别的数据结构:', result.data);
                        // 尝试直接使用result.data的所有属性
                        console.log('尝试遍历result.data的属性:');
                        for (let key in result.data) {
                            console.log(`  ${key}:`, result.data[key]);
                        }
                    }
                }
                
                console.log('最终解析到的文件列表:', files);
                
                if (files.length > 0) {
                    files.forEach(file => {
                        console.log('处理文件:', file);
                        const option = document.createElement('option');
                        option.value = file.wayline_id;
                        option.textContent = `${file.name} (${file.drone_model_key || 'Unknown'})`;
                        waylineSelect.appendChild(option);
                    });
                    log(`发现 ${files.length} 个航线文件`, 'info');
                } else {
                    log('未找到任何航线文件，请先上传航线文件', 'warning');
                    log('请查看控制台的详细调试信息来确定数据结构', 'info');
                }
            } catch (error) {
                log(`获取航线文件列表失败: ${error.message}`, 'error');
                console.error('API请求错误:', error);
            }
        }
        
        // 步骤2: 创建航线任务
        async function createWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const deviceSn = document.getElementById('deviceSn').value;
            const waylineId = document.getElementById('waylineFileSelect').value;
            const taskType = parseInt(document.getElementById('taskType').value);
            
            console.log('创建任务参数检查:', {
                workspaceId, deviceSn, waylineId, taskType
            });
            
            if (!workspaceId) {
                log('请输入工作空间ID', 'error');
                return;
            }
            
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            if (!waylineId) {
                log('请选择航线文件，如果列表为空请先上传航线文件', 'error');
                return;
            }
            
            const enableSim = document.getElementById('enableSimulation').checked;
            const taskData = {
                name: `航线任务_${Date.now()}`,
                dock_sn: deviceSn,
                file_id: waylineId,  // 使用file_id
                task_type: taskType,
                out_of_control_action: 0,  // 0: 返航
                rth_altitude: 100,  // 返航高度100米
                rth_mode: 1,  // 1: 设定高度模式（MQTT需要）
                exit_wayline_when_rc_lost: 0,  // 0: 继续执行航线（MQTT需要）
                wayline_precision_type: 1,  // 1: 高精度RTK任务（MQTT需要）
                begin_time: null,
                end_time: null
            };
            
            // 如果启用模拟飞行
            if (enableSim) {
                taskData.simulate_mission = {
                    is_enable: 1,
                    latitude: parseFloat(document.getElementById('simLatitude').value),
                    longitude: parseFloat(document.getElementById('simLongitude').value),
                    altitude: parseFloat(document.getElementById('simAltitude').value)
                };
            }
            
            // 如果是定时任务，添加执行时间
            if (taskType === 1) {
                const executeTime = prompt('请输入执行时间 (格式: YYYY-MM-DD HH:mm:ss):');
                if (executeTime) {
                    taskData.execute_time = new Date(executeTime).getTime();
                }
            }
            
            try {
                log('开始创建航线任务...', 'info');
                console.log('发送的任务数据:', taskData);
                
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/flight-tasks`, 'POST', taskData);
                log(`航线任务创建成功${enableSim ? ' (模拟飞行模式)' : ''}`, 'success');
                displayResponse('waylineApiResponse', result);
                
                // 自动刷新任务列表
                await refreshJobList();
            } catch (error) {
                log(`创建航线任务失败: ${error.message}`, 'error');
                console.error('创建任务错误详情:', error);
                
                // 显示更详细的错误信息到界面
                displayResponse('waylineApiResponse', {
                    error: error.message,
                    taskData: taskData
                });
            }
        }
        
        // 刷新任务列表并更新选择框
        async function refreshJobList() {
            const workspaceId = document.getElementById('workspaceId').value;
            if (!workspaceId) {
                log('请输入工作空间ID', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs`);
                log('刷新任务列表成功', 'success');
                displayResponse('waylineApiResponse', result);
                
                // 使用通用函数更新任务选择下拉框
                updateJobSelectDropdown(result);
                
            } catch (error) {
                log(`刷新任务列表失败: ${error.message}`, 'error');
            }
        }
        
        // 步骤3: 执行航线任务
        async function executeWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const jobId = document.getElementById('jobSelect').value;
            
            if (!workspaceId || !jobId) {
                log('请输入工作空间ID并选择要执行的任务', 'error');
                return;
            }
            
            // 获取模拟器参数
            const enableSim = document.getElementById('enableSimulation').checked;
            const dockLat = parseFloat(document.getElementById('simLatitude').value);
            const dockLng = parseFloat(document.getElementById('simLongitude').value);
            const dockAlt = parseFloat(document.getElementById('simAltitude').value);
            
            let requestData = {};
            
            // 如果启用模拟器，添加模拟器参数
            if (enableSim && !isNaN(dockLat) && !isNaN(dockLng) && !isNaN(dockAlt)) {
                requestData.simulate_mission = {
                    is_enable: 1,
                    latitude: dockLat,
                    longitude: dockLng,
                    altitude: dockAlt
                };
                log(`使用模拟器模式执行航线任务: 纬度=${dockLat}, 经度=${dockLng}, 高度=${dockAlt}m`, 'info');
            } else {
                log('使用真实飞行模式执行航线任务', 'info');
            }
            
            try {
                log('开始执行航线任务...', 'info');
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}/execute`, 'POST', requestData);
                log(`航线任务执行指令已发送${enableSim ? ' (模拟器模式)' : ''}`, 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`执行航线任务失败: ${error.message}`, 'error');
            }
        }
        
        // 暂停航线任务
        async function pauseWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const jobId = document.getElementById('jobSelect').value;
            
            if (!workspaceId || !jobId) {
                log('请输入工作空间ID并选择要暂停的任务', 'error');
                return;
            }
            
            try {
                log('开始暂停航线任务...', 'info');
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}/pause`, 'POST');
                log('航线任务暂停指令已发送', 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`暂停航线任务失败: ${error.message}`, 'error');
            }
        }
        
        // 取消航线任务
        async function cancelWaylineJob() {
            const workspaceId = document.getElementById('workspaceId').value;
            const jobId = document.getElementById('jobSelect').value;
            
            if (!workspaceId || !jobId) {
                log('请输入工作空间ID并选择要取消的任务', 'error');
                return;
            }
            
            if (!confirm('确定要取消该航线任务吗？')) {
                return;
            }
            
            try {
                log('开始取消航线任务...', 'info');
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs?job_id=${jobId}`, 'DELETE');
                log('航线任务取消指令已发送', 'success');
                displayResponse('waylineApiResponse', result);
                
                // 自动刷新任务列表
                await refreshJobList();
            } catch (error) {
                log(`取消航线任务失败: ${error.message}`, 'error');
            }
        }
        
        // 步骤4: 获取任务详情
        async function getJobDetail() {
            const workspaceId = document.getElementById('workspaceId').value;
            const jobId = document.getElementById('jobSelect').value;
            
            if (!workspaceId || !jobId) {
                log('请输入工作空间ID并选择要查看的任务', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}`);
                log('获取任务详情成功', 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`获取任务详情失败: ${error.message}`, 'error');
            }
        }
        
        // 模拟飞行测试
        async function testSimulateTakeoff() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            const enableSim = document.getElementById('enableSimulation').checked;
            const dockLat = parseFloat(document.getElementById('simLatitude').value);
            const dockLng = parseFloat(document.getElementById('simLongitude').value);
            const dockAlt = parseFloat(document.getElementById('simAltitude').value);
            
            // 验证坐标有效性
            if (isNaN(dockLat) || isNaN(dockLng) || isNaN(dockAlt)) {
                log('坐标数据无效，请先获取设备坐标', 'error');
                return;
            }
            
            if (dockLat < -90 || dockLat > 90) {
                log('纬度超出有效范围 (-90 到 90)', 'error');
                return;
            }
            
            if (dockLng < -180 || dockLng > 180) {
                log('经度超出有效范围 (-180 到 180)', 'error');
                return;
            }
            
            log(`起飞参数: 纬度=${dockLat}, 经度=${dockLng}, 高度=${dockAlt}m, 模拟模式=${enableSim}`, 'info');
            
            const simData = enableSim ? {
                is_enable: 1,
                latitude: dockLat,   // 使用机场坐标作为模拟起始点
                longitude: dockLng
            } : { is_enable: 0 };
            
            // 目标点设置为机场上方50米
            const targetLat = dockLat;
            const targetLng = dockLng;
            const targetHeight = 30;  // 默认起飞到50米
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/takeoff-to-point`, 'POST', {
                    target_latitude: targetLat,
                    target_longitude: targetLng,
                    target_height: targetHeight,
                    security_takeoff_height: Math.max(20, dockAlt + 10),  // 安全起飞高度：机场高度+10m，最小20m
                    rth_mode: 0,  // 智能高度返航
                    rth_altitude: Math.max(50, dockAlt + 30),  // 返航高度：机场高度+30m，最小50m
                    rc_lost_action: 2,  // 遥控器失控动作: 0-悬停, 1-着陆, 2-返航
                    commander_mode_lost_action: 1,  // 指点飞行失控动作: 0-继续, 1-退出
                    commander_flight_mode: 0,  // 指点飞行模式: 0-智能高度, 1-设定高度
                    commander_flight_height: Math.max(100, dockAlt + 50),  // 指点飞行高度
                    max_speed: parseInt(document.getElementById('maxSpeed').value) || 12,
                    simulate_mission: simData
                });
                
                log(`模拟一键起飞指令已发送${enableSim ? ' (模拟器模式)' : ''}`, 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`模拟起飞失败: ${error.message}`, 'error');
            }
        }
        
        async function testSimulateFlyTo() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            const targetLat = parseFloat(document.getElementById('simLatitude').value) + 0.002; // 目标点偏移0.002度
            const targetLng = parseFloat(document.getElementById('simLongitude').value) + 0.002;
            
            try {
                const result = await apiRequest(`/api/v1/control/devices/${deviceSn}/fly-to-point`, 'POST', {
                    fly_to_id: `test_flyto_${Date.now()}`,
                    max_speed: parseInt(document.getElementById('maxSpeed').value),
                    points: [{
                        latitude: targetLat,
                        longitude: targetLng,
                        height: 80  // 飞到80米高度
                    }]
                });
                
                log('模拟飞向目标点指令已发送', 'success');
                displayResponse('waylineApiResponse', result);
            } catch (error) {
                log(`模拟飞向目标点失败: ${error.message}`, 'error');
            }
        }
        
        // 页面初始化
        window.onload = function() {
            loadConfig();
            log('页面已加载，系统就绪', 'success');
            
            // 自动刷新HMS和环境数据（如果有设备SN）
            const deviceSn = document.getElementById('deviceSn').value;
            if (deviceSn) {
                refreshHMS();
                hmsRefreshInterval = setInterval(refreshHMS, 30000); // 30秒刷新一次
                
                // 初始化环境数据
                refreshEnvironmentData();
                startEnvironmentAutoRefresh(); // 开始自动刷新环境数据
                
                // 尝试自动获取机场坐标
                setTimeout(() => {
                    getDeviceCoordinates();
                }, 2000); // 延时2秒获取，等待系统初始化完成
            }
        };
        
        // 页面卸载时清理
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateTakeoffButtonText(); // 初始化按钮文字
            
            // 如果工作空间ID已填写，自动加载航线文件列表
            const workspaceId = document.getElementById('workspaceId').value;
            if (workspaceId) {
                setTimeout(() => {
                    getWaylineFiles();
                }, 1000); // 延迟1秒加载，确保页面完全加载
            }
        });

        window.onbeforeunload = function() {
            if (drcControlInterval) {
                clearInterval(drcControlInterval);
            }
            if (hmsRefreshInterval) {
                clearInterval(hmsRefreshInterval);
            }
            if (taskMonitorInterval) {
                clearInterval(taskMonitorInterval);
            }
            stopEnvironmentAutoRefresh(); // 停止环境数据自动刷新
        };

        // 任务监控相关功能
        let taskMonitorInterval = null;
        let currentMonitorJobId = null;

        // 状态映射
        const taskStatusMap = {
            '-1': { text: '未知', class: 'bg-secondary' },
            '0': { text: '待执行', class: 'bg-info' },
            '1': { text: '已发送', class: 'bg-primary' },
            '2': { text: '执行中', class: 'bg-warning' },
            '3': { text: '已暂停', class: 'bg-warning' },
            '4': { text: '已取消', class: 'bg-secondary' },
            '5': { text: '已完成', class: 'bg-success' },
            '6': { text: '执行失败', class: 'bg-danger' }
        };

        // 通用的更新任务下拉选择框函数
        function updateJobSelectDropdown(result) {
            const jobSelect = document.getElementById('jobSelect');
            jobSelect.innerHTML = '<option value="">选择要执行的任务...</option>';
            
            // 处理任务列表数据结构
            let jobs = [];
            if (result.data) {
                if (result.data.list && Array.isArray(result.data.list)) {
                    jobs = result.data.list; // {list: Array, pagination: {...}} 结构
                } else if (result.data.data && Array.isArray(result.data.data)) {
                    jobs = result.data.data; // {data: Array} 结构
                } else if (Array.isArray(result.data)) {
                    jobs = result.data; // 直接数组结构
                }
            }
            
            console.log('更新下拉框，任务列表数据:', jobs);
            
            if (jobs.length > 0) {
                jobs.forEach(job => {
                    const option = document.createElement('option');
                    option.value = job.job_id;
                    
                    // 获取状态文本
                    const statusInfo = taskStatusMap[job.status] || taskStatusMap['-1'];
                    const statusText = statusInfo.text;
                    
                    // 截取job_id显示前8位
                    const shortJobId = job.job_id ? job.job_id.substring(0, 8) + '...' : 'N/A';
                    
                    option.textContent = `${job.name || 'unnamed'} - ${statusText} (${shortJobId})`;
                    option.title = `完整ID: ${job.job_id}\n状态: ${statusText}\n创建时间: ${job.create_time ? new Date(job.create_time).toLocaleString() : 'N/A'}`;
                    
                    jobSelect.appendChild(option);
                });
                log(`发现 ${jobs.length} 个任务，已更新下拉列表`, 'success');
            } else {
                log('暂无任务，请先创建任务', 'info');
            }
        }

        // 查询任务状态
        async function queryTaskStatus() {
            const workspaceId = document.getElementById('workspaceId').value;
            const deviceSn = document.getElementById('deviceSn').value;
            const jobId = document.getElementById('jobSelect').value;
            
            if (!workspaceId) {
                log('请输入工作空间ID', 'error');
                return;
            }
            
            if (!deviceSn) {
                log('请输入设备SN', 'error');
                return;
            }
            
            try {
                // 优先从Redis获取实时进度
                const realtimeResult = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/docks/${deviceSn}/progress`);
                
                if (realtimeResult.data) {
                    // 有实时进度数据
                    updateTaskMonitorUIFromRedis(realtimeResult.data);
                    log('获取实时进度成功', 'success');
                } else if (jobId) {
                    // 没有实时进度，回退到数据库查询
                    const dbResult = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}`);
                    updateTaskMonitorUI(dbResult.data);
                    log('查询数据库任务状态成功', 'info');
                } else {
                    // 没有选择任务，查询所有任务
                    await refreshJobList();
                    log('无运行中任务，已刷新任务列表', 'info');
                }
                
            } catch (error) {
                log(`查询任务状态失败: ${error.message}`, 'error');
                
                // 如果Redis查询失败，尝试数据库查询
                if (jobId) {
                    try {
                        const dbResult = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${jobId}`);
                        updateTaskMonitorUI(dbResult.data);
                        log('回退到数据库查询成功', 'warning');
                    } catch (dbError) {
                        log(`数据库查询也失败: ${dbError.message}`, 'error');
                    }
                }
            }
        }

        // 更新任务监控UI（从Redis实时数据）
        function updateTaskMonitorUIFromRedis(progressData) {
            if (!progressData) return;
            
            currentMonitorJobId = progressData.job_id;
            
            // 更新基本信息
            document.getElementById('currentJobId').textContent = progressData.job_id || '暂无';
            
            // DJI状态映射
            const djiStatusMap = {
                'sent': { text: '已发送', class: 'bg-primary' },
                'in_progress': { text: '执行中', class: 'bg-warning' },
                'ok': { text: '已完成', class: 'bg-success' },
                'paused': { text: '已暂停', class: 'bg-warning' },
                'rejected': { text: '已拒绝', class: 'bg-danger' },
                'failed': { text: '执行失败', class: 'bg-danger' },
                'canceled': { text: '已取消', class: 'bg-secondary' },
                'timeout': { text: '超时', class: 'bg-danger' },
                'partially_done': { text: '部分完成', class: 'bg-info' }
            };
            
            // 更新状态
            const statusInfo = djiStatusMap[progressData.status] || { text: '未知', class: 'bg-secondary' };
            const statusElement = document.getElementById('currentJobStatus');
            statusElement.textContent = statusInfo.text;
            statusElement.className = `badge fs-6 ${statusInfo.class}`;
            
            // 更新进度
            const progress = progressData.progress ? progressData.progress.percent : 0;
            const progressBar = document.getElementById('taskProgressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            progressText.textContent = `${progress}%`;
            
            // 根据状态设置进度条样式
            progressBar.className = 'progress-bar progress-bar-striped';
            if (progressData.status === 'in_progress') {
                progressBar.classList.add('progress-bar-animated', 'bg-warning');
            } else if (progressData.status === 'ok') {
                progressBar.classList.add('bg-success');
            } else if (progressData.status === 'failed') {
                progressBar.classList.add('bg-danger');
            } else {
                progressBar.classList.add('bg-info');
            }
            
            // 更新扩展信息
            const ext = progressData.ext || {};
            
            // 更新详细信息
            const detailsHtml = `
                <div class="row mt-3">
                    <div class="col-md-6">
                        <small><strong>执行步骤:</strong> ${progressData.progress ? progressData.progress.current_step : 0}</small><br>
                        <small><strong>当前航点:</strong> ${ext.current_waypoint_index || 'N/A'}</small><br>
                        <small><strong>媒体文件:</strong> ${ext.media_count || 0}</small><br>
                    </div>
                    <div class="col-md-6">
                        <small><strong>航线状态:</strong> ${getWaylineMissionStateText(ext.wayline_mission_state)}</small><br>
                        <small><strong>轨迹ID:</strong> ${ext.track_id || 'N/A'}</small><br>
                        <small><strong>更新时间:</strong> ${new Date(progressData.timestamp).toLocaleString()}</small><br>
                    </div>
                </div>
            `;
            
            // 更新或创建详细信息区域
            let detailsElement = document.getElementById('taskDetails');
            if (!detailsElement) {
                detailsElement = document.createElement('div');
                detailsElement.id = 'taskDetails';
                document.querySelector('.card-body').appendChild(detailsElement);
            }
            detailsElement.innerHTML = detailsHtml;
            
            // 管理查看媒体文件按钮
            const mediaCount = ext.media_count || 0;
            const mediaCountElement = detailsElement.querySelector('small:nth-child(3)');
            if (mediaCountElement) {
                const mediaContainer = mediaCountElement.parentElement;
                const existingBtn = document.getElementById('viewMediaBtn');
                
                console.log(`Redis Media count: ${mediaCount}, existing button: ${!!existingBtn}`);
                
                if (mediaCount > 0) {
                    if (!existingBtn) {
                        // 创建查看媒体文件按钮
                        const viewBtn = document.createElement('button');
                        viewBtn.id = 'viewMediaBtn';
                        viewBtn.className = 'btn btn-sm btn-primary ms-2';
                        viewBtn.textContent = '查看媒体文件';
                        viewBtn.onclick = () => viewMediaFiles(progressData.job_id);
                        viewBtn.style.marginLeft = '10px';
                        mediaContainer.appendChild(viewBtn);
                        console.log('Created media files button from Redis data');
                    }
                } else {
                    // 如果没有媒体文件，移除按钮
                    if (existingBtn) {
                        existingBtn.remove();
                        console.log('Removed media button from Redis data');
                    }
                }
            }
            
            // 更新控制按钮状态
            updateTaskControlButtons(progressData.status);
            
            // 添加实时标识
            const titleElement = document.querySelector('#taskMonitorCard .card-title');
            if (titleElement && !titleElement.textContent.includes('🔴')) {
                titleElement.textContent = '🔴 实时任务监控';
            }
        }
        
        // 获取航线任务状态文本
        function getWaylineMissionStateText(state) {
            const stateMap = {
                0: '断线',
                1: '不支持航点',
                2: '准备中',
                3: '上传中',
                4: '准备起飞',
                5: '到达首个航点',
                6: '执行中',
                7: '中断',
                8: '恢复',
                9: '结束'
            };
            return stateMap[state] || `未知(${state})`;
        }
        
        // 更新任务控制按钮状态
        function updateTaskControlButtons(status) {
            const pauseBtn = document.querySelector('button[onclick="pauseCurrentTask()"]');
            const resumeBtn = document.querySelector('button[onclick="resumeCurrentTask()"]');
            const cancelBtn = document.querySelector('button[onclick="cancelCurrentTask()"]');
            
            if (pauseBtn) pauseBtn.disabled = (status !== 'in_progress');
            if (resumeBtn) resumeBtn.disabled = (status !== 'paused');
            if (cancelBtn) cancelBtn.disabled = !['in_progress', 'paused', 'sent'].includes(status);
        }

        // 更新任务监控UI（从数据库数据）
        function updateTaskMonitorUI(jobData) {
            if (!jobData) return;
            
            currentMonitorJobId = jobData.job_id;
            
            // 更新基本信息
            document.getElementById('currentJobId').textContent = jobData.job_id || '暂无';
            
            // 更新状态
            const statusInfo = taskStatusMap[jobData.status] || taskStatusMap['-1'];
            const statusElement = document.getElementById('currentJobStatus');
            statusElement.textContent = statusInfo.text;
            statusElement.className = `badge fs-6 ${statusInfo.class}`;
            
            // 更新进度
            const progress = jobData.progress || 0;
            const progressBar = document.getElementById('taskProgressBar');
            const progressText = document.getElementById('progressText');
            
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            progressText.textContent = `${progress}%`;
            
            // 根据状态设置进度条样式
            progressBar.className = 'progress-bar progress-bar-striped';
            if (jobData.status == 2) { // 执行中
                progressBar.classList.add('progress-bar-animated', 'bg-success');
            } else if (jobData.status == 5) { // 已完成
                progressBar.classList.add('bg-success');
            } else if (jobData.status == 6) { // 失败
                progressBar.classList.add('bg-danger');
            }
            
            // 更新时间信息
            document.getElementById('executeTime').textContent = jobData.execute_time ? 
                new Date(jobData.execute_time).toLocaleString() : '-';
            document.getElementById('completedTime').textContent = jobData.completed_time ? 
                new Date(jobData.completed_time).toLocaleString() : '-';
            
            // 更新媒体文件信息
            const mediaCount = jobData.media_count || 0;
            document.getElementById('mediaFileCount').textContent = mediaCount;
            
            // 管理查看媒体文件按钮
            const mediaContainer = document.getElementById('mediaFileCount').parentElement;
            const existingBtn = document.getElementById('viewMediaBtn');
            
            console.log(`Media count: ${mediaCount}, existing button: ${!!existingBtn}`);
            
            if (mediaCount > 0) {
                if (!existingBtn) {
                    // 创建查看媒体文件按钮
                    const viewBtn = document.createElement('button');
                    viewBtn.id = 'viewMediaBtn';
                    viewBtn.className = 'btn btn-sm btn-primary ms-2';
                    viewBtn.textContent = '查看媒体文件';
                    viewBtn.onclick = () => viewMediaFiles(jobData.job_id);
                    mediaContainer.appendChild(viewBtn);
                    console.log('Created media files button');
                } else {
                    console.log('Media button already exists');
                }
            } else {
                // 如果没有媒体文件，移除按钮
                if (existingBtn) {
                    existingBtn.remove();
                    console.log('Removed media button');
                }
            }
            
            // 更新任务详情
            const details = [
                `任务名称: ${jobData.name || '未知'}`,
                `文件ID: ${jobData.file_id || '未知'}`,
                `机场SN: ${jobData.dock_sn || '未知'}`,
                `任务类型: ${getTaskTypeName(jobData.task_type)}`,
                `返航高度: ${jobData.rth_altitude || 0}m`,
                `创建时间: ${jobData.create_time ? new Date(jobData.create_time).toLocaleString() : '未知'}`
            ];
            
            if (jobData.error_code) {
                details.push(`错误码: ${jobData.error_code}`);
            }
            
            document.getElementById('taskDetails').innerHTML = details.join('<br>');
            
            // 显示/隐藏操作按钮
            const taskActions = document.getElementById('taskActions');
            const pauseBtn = document.getElementById('pauseTaskBtn');
            const resumeBtn = document.getElementById('resumeTaskBtn');
            
            if (jobData.status == 2) { // 执行中，显示暂停按钮
                taskActions.style.display = 'block';
                pauseBtn.style.display = 'inline-block';
                resumeBtn.style.display = 'none';
            } else if (jobData.status == 3) { // 暂停中，显示恢复按钮
                taskActions.style.display = 'block';
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'inline-block';
            } else if (jobData.status == 0 || jobData.status == 1) { // 待执行或已发送
                taskActions.style.display = 'block';
                pauseBtn.style.display = 'none';
                resumeBtn.style.display = 'none';
            } else { // 其他状态隐藏操作按钮
                taskActions.style.display = 'none';
            }
        }

        // 获取任务类型名称
        function getTaskTypeName(taskType) {
            const types = { 0: '立即执行', 1: '定时执行', 2: '条件执行' };
            return types[taskType] || '未知';
        }
        
        // 查看媒体文件
        async function viewMediaFiles(jobId) {
            try {
                const response = await apiRequest(`/api/v1/media/files?job_id=${jobId}`);
                if (response.code === 0 && response.data && response.data.data) {
                    showMediaFilesModal(response.data.data, jobId);
                } else {
                    log(`查询媒体文件失败: ${response.message || '未找到媒体文件'}`, 'error');
                }
            } catch (error) {
                log(`查询媒体文件失败: ${error.message}`, 'error');
            }
        }
        
        // 显示媒体文件模态框
        function showMediaFilesModal(files, flightId) {
            // 创建模态框HTML
            const modalHtml = `
                <div class="modal fade" id="mediaFilesModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">媒体文件列表 (航线任务: ${flightId})</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                ${files.length === 0 ? 
                                    '<p class="text-center text-muted">暂无媒体文件</p>' :
                                    `<div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>文件名</th>
                                                    <th>类型</th>
                                                    <th>大小</th>
                                                    <th>拍摄时间</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${files.map(file => `
                                                    <tr>
                                                        <td>${file.file_name}</td>
                                                        <td>
                                                            <span class="badge bg-${file.file_type === 'photo' ? 'primary' : 'info'}">
                                                                ${file.file_type === 'photo' ? '照片' : '视频'}
                                                            </span>
                                                        </td>
                                                        <td>${formatFileSize(file.file_size || 0)}</td>
                                                        <td>${file.created_time ? new Date(file.created_time).toLocaleString() : '-'}</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-primary" onclick="downloadMediaFile('${file.file_id}', '${file.file_name}')">
                                                                下载
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>`
                                }
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // 移除旧的模态框
            const oldModal = document.getElementById('mediaFilesModal');
            if (oldModal) {
                oldModal.remove();
            }
            
            // 添加新模态框到body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('mediaFilesModal'));
            modal.show();
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 下载媒体文件
        async function downloadMediaFile(fileId, fileName) {
            try {
                const token = localStorage.getItem('access_token');
                const downloadUrl = `/api/v1/media/download/${fileId}`;
                
                // 创建一个隐藏的a标签来触发下载
                const a = document.createElement('a');
                a.href = `${downloadUrl}?token=${token}`;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                log(`开始下载: ${fileName}`, 'info');
            } catch (error) {
                log(`下载失败: ${error.message}`, 'error');
            }
        }

        // 切换自动刷新
        function toggleAutoRefresh() {
            const btn = document.getElementById('autoRefreshBtn');
            
            if (taskMonitorInterval) {
                clearInterval(taskMonitorInterval);
                taskMonitorInterval = null;
                btn.textContent = '启动自动刷新';
                btn.className = 'btn btn-outline-secondary';
                log('已停止自动刷新', 'info');
            } else {
                taskMonitorInterval = setInterval(queryTaskStatus, 3000); // 每3秒刷新
                btn.textContent = '停止自动刷新';
                btn.className = 'btn btn-outline-danger';
                log('已启动自动刷新 (每3秒)', 'success');
                queryTaskStatus(); // 立即执行一次
            }
        }

        // 暂停当前任务
        async function pauseCurrentTask() {
            if (!currentMonitorJobId) {
                log('没有当前监控的任务', 'error');
                return;
            }
            
            const workspaceId = document.getElementById('workspaceId').value;
            try {
                await pauseWaylineJob();
                log('任务暂停指令已发送', 'success');
                setTimeout(queryTaskStatus, 1000); // 1秒后刷新状态
            } catch (error) {
                log(`暂停任务失败: ${error.message}`, 'error');
            }
        }

        // 恢复当前任务
        async function resumeCurrentTask() {
            if (!currentMonitorJobId) {
                log('没有当前监控的任务', 'error');
                return;
            }
            
            try {
                const workspaceId = document.getElementById('workspaceId').value;
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${currentMonitorJobId}/resume`, 'POST');
                log('任务恢复指令已发送', 'success');
                setTimeout(queryTaskStatus, 1000); // 1秒后刷新状态
            } catch (error) {
                log(`恢复任务失败: ${error.message}`, 'error');
            }
        }

        // 取消当前任务
        async function cancelCurrentTask() {
            if (!currentMonitorJobId) {
                log('没有当前监控的任务', 'error');
                return;
            }
            
            if (!confirm('确定要取消当前任务吗？')) {
                return;
            }
            
            try {
                await cancelWaylineJob();
                log('任务取消指令已发送', 'success');
                setTimeout(queryTaskStatus, 1000); // 1秒后刷新状态
            } catch (error) {
                log(`取消任务失败: ${error.message}`, 'error');
            }
        }

        // 设置媒体优先上传
        async function setMediaPriority() {
            if (!currentMonitorJobId) {
                log('没有当前监控的任务', 'error');
                return;
            }
            
            const workspaceId = document.getElementById('workspaceId').value;
            try {
                const result = await apiRequest(`/api/v1/wayline/workspaces/${workspaceId}/jobs/${currentMonitorJobId}/media-priority`, 'POST');
                log('媒体优先上传已设置', 'success');
            } catch (error) {
                log(`设置媒体优先上传失败: ${error.message}`, 'error');
            }
        }

        // 修改执行任务函数，执行后自动开始监控
        const originalExecuteWaylineJob = executeWaylineJob;
        executeWaylineJob = async function() {
            await originalExecuteWaylineJob();
            
            // 执行成功后开始监控
            const jobId = document.getElementById('jobSelect').value;
            if (jobId) {
                currentMonitorJobId = jobId;
                setTimeout(() => {
                    queryTaskStatus();
                    if (!taskMonitorInterval) {
                        toggleAutoRefresh(); // 自动开启监控
                    }
                }, 2000);
            }
        };

        // ==========================================
        // DRC控制相关的JavaScript函数
        // ==========================================

        // DRC状态管理
        let drcWebSocket = null;
        let drcSessionInfo = null;
        let drcHeartbeatInterval = null;
        let drcTestMode = false;

        // DRC会话管理函数
        async function enterDrcMode() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                drcLog('请先输入设备SN', 'error');
                return;
            }
            
            try {
                const osdFreq = parseInt(document.getElementById('drcOsdFreq').value);
                const hsiFreq = parseInt(document.getElementById('drcHsiFreq').value);
                
                drcLog(`正在进入DRC模式 (OSD:${osdFreq}Hz, HSI:${hsiFreq}Hz)...`, 'info');
                
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/enter`, 'POST', {
                    osd_frequency: osdFreq,
                    hsi_frequency: hsiFreq
                });
                
                if (result.code === 0) {
                    drcSessionInfo = result.data;
                    updateDrcSessionStatus('active', result.data);
                    drcLog('成功进入DRC模式', 'success');
                    drcLog(`会话ID: ${result.data.session_id}`, 'info');
                    
                    // 自动连接WebSocket
                    setTimeout(() => connectDrcWebSocket(), 1000);
                } else {
                    drcLog(`进入DRC模式失败: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`进入DRC模式失败: ${error.message}`, 'error');
            }
        }

        async function exitDrcMode() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                drcLog('请先输入设备SN', 'error');
                return;
            }
            
            try {
                drcLog('正在退出DRC模式...', 'info');
                
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/exit`, 'POST');
                
                if (result.code === 0) {
                    updateDrcSessionStatus('inactive', null);
                    drcLog('成功退出DRC模式', 'success');
                    
                    // 断开WebSocket连接
                    if (drcWebSocket) {
                        disconnectDrcWebSocket();
                    }
                } else {
                    drcLog(`退出DRC模式失败: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`退出DRC模式失败: ${error.message}`, 'error');
            }
        }

        async function getDrcStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                drcLog('请先输入设备SN', 'error');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/status`, 'GET');
                
                if (result.code === 0) {
                    const { drc_mode, session } = result.data;
                    updateDrcSessionStatus(drc_mode, session);
                    drcLog(`DRC状态: ${drc_mode}`, 'info');
                    
                    if (session) {
                        drcLog(`会话详情: ${JSON.stringify(session, null, 2)}`, 'info');
                    }
                } else {
                    drcLog(`获取DRC状态失败: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`获取DRC状态失败: ${error.message}`, 'error');
            }
        }

        async function drcEmergencyStop() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                drcLog('请先输入设备SN', 'error');
                return;
            }
            
            try {
                drcLog('发送DRC紧急停止指令...', 'warning');
                
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/control/emergency-stop`, 'POST');
                
                if (result.code === 0) {
                    drcLog('DRC紧急停止指令发送成功', 'success');
                    drcLog(`指令序号: ${result.data.seq}`, 'info');
                } else {
                    drcLog(`DRC紧急停止失败: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`DRC紧急停止失败: ${error.message}`, 'error');
            }
        }

        // DRC杆量控制函数
        function updateDrcValue(channel) {
            const slider = document.getElementById(`${channel}Slider`);
            const valueSpan = document.getElementById(`${channel}Value`);
            valueSpan.textContent = slider.value;
            
            // 实时发送控制指令（如果在测试模式下）
            if (drcTestMode) {
                sendStickControl();
            }
        }

        async function sendStickControl() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                drcLog('请先输入设备SN', 'error');
                return;
            }
            
            
            try {
                const stickData = {
                    roll: parseInt(document.getElementById('rollSlider').value),
                    pitch: parseInt(document.getElementById('pitchSlider').value),
                    throttle: parseInt(document.getElementById('throttleSlider').value),
                    yaw: parseInt(document.getElementById('yawSlider').value)
                };
                
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/control/stick`, 'POST', stickData);
                
                if (result.code === 0) {
                    drcLog(`杆量控制发送成功 - Roll:${stickData.roll}, Pitch:${stickData.pitch}, Throttle:${stickData.throttle}, Yaw:${stickData.yaw}`, 'success');
                } else {
                    drcLog(`杆量控制失败: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`杆量控制失败: ${error.message}`, 'error');
            }
        }

        function resetAllSticks() {
            const channels = ['roll', 'pitch', 'throttle', 'yaw'];
            channels.forEach(channel => {
                const slider = document.getElementById(`${channel}Slider`);
                const valueSpan = document.getElementById(`${channel}Value`);
                slider.value = 1024;
                valueSpan.textContent = '1024';
            });
            drcLog('所有摇杆已重置到中位(1024) - 符合DJI官方标准', 'info');
        }

        function testStickControl() {
            drcTestMode = !drcTestMode;
            const button = event.target;
            
            if (drcTestMode) {
                button.textContent = '退出测试模式';
                button.className = 'btn btn-warning btn-sm';
                drcLog('进入测试模式 - 滑动摇杆将实时发送控制指令', 'warning');
            } else {
                button.textContent = '测试模式';
                button.className = 'btn btn-info btn-sm';
                drcLog('退出测试模式', 'info');
            }
        }

        // DRC快捷预设函数
        function presetTakeoff() {
            document.getElementById('throttleSlider').value = 1400; // 上升
            updateDrcValue('throttle');
            drcLog('预设: 起飞姿态', 'info');
        }

        function presetHover() {
            resetAllSticks();
            drcLog('预设: 悬停姿态', 'info');
        }

        function presetLand() {
            document.getElementById('throttleSlider').value = 600; // 下降
            updateDrcValue('throttle');
            drcLog('预设: 降落姿态', 'info');
        }

        function presetRotateLeft() {
            document.getElementById('yawSlider').value = 700; // 左转
            updateDrcValue('yaw');
            drcLog('预设: 左转姿态', 'info');
        }

        function presetRotateRight() {
            document.getElementById('yawSlider').value = 1300; // 右转
            updateDrcValue('yaw');
            drcLog('预设: 右转姿态', 'info');
        }

        // DRC WebSocket连接函数
        function connectDrcWebSocket() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                drcLog('请先输入设备SN', 'error');
                return;
            }
            

            
            try {
                // 正确构建WebSocket URL
                let apiUrl = document.getElementById('apiUrl').value || 'http://192.168.111.49:8000';
                apiUrl = apiUrl.replace(/\/$/, ''); // 移除末尾斜杠
                
                // 转换HTTP/HTTPS为WS/WSS
                const wsUrl = apiUrl.replace('http://', 'ws://').replace('https://', 'wss://') + `/api/v1/drc/devices/${deviceSn}/drc/ws`;
                
                console.log('API地址:', apiUrl);
                console.log('WebSocket URL:', wsUrl);
                drcLog(`正在连接WebSocket: ${wsUrl}`, 'info');
                
                drcWebSocket = new WebSocket(wsUrl);
                
                drcWebSocket.onopen = function(event) {
                    drcLog('DRC WebSocket连接已建立', 'success');
                    document.getElementById('wsConnectionStatus').textContent = '已连接';
                    document.getElementById('wsConnectionStatus').className = 'badge bg-success';
                    
                    // 发送认证信息
                    const authData = {
                        token: document.getElementById('apiToken').value || 'test-token'
                    };
                    drcWebSocket.send(JSON.stringify(authData));
                };
                
                drcWebSocket.onmessage = function(event) {
                    try {
                        const message = JSON.parse(event.data);
                        handleDrcWebSocketMessage(message);
                        
                        // 更新消息计数
                        const countSpan = document.getElementById('wsMessageCount');
                        countSpan.textContent = parseInt(countSpan.textContent) + 1;
                        
                    } catch (error) {
                        drcLog(`WebSocket消息解析失败: ${error.message}`, 'error');
                    }
                };
                
                drcWebSocket.onclose = function(event) {
                    drcLog('DRC WebSocket连接已关闭', 'warning');
                    document.getElementById('wsConnectionStatus').textContent = '已断开';
                    document.getElementById('wsConnectionStatus').className = 'badge bg-secondary';
                };
                
                drcWebSocket.onerror = function(error) {
                    console.error('WebSocket错误详情:', error);
                    drcLog(`DRC WebSocket错误: 连接失败`, 'error');
                    document.getElementById('wsConnectionStatus').textContent = '连接失败';
                    document.getElementById('wsConnectionStatus').className = 'badge bg-danger';
                };
                
            } catch (error) {
                console.error('WebSocket创建失败:', error);
                drcLog(`连接DRC WebSocket失败: ${error.message}`, 'error');
                drcLog(`请检查网络连接和服务器状态`, 'warning');
                
                // 显示诊断信息
                const apiUrl = document.getElementById('apiUrl').value;
                drcLog(`当前API地址: ${apiUrl}`, 'info');
                drcLog(`如果使用ZeroTier，请确保网络连通性`, 'info');
            }
        }

        function disconnectDrcWebSocket() {
            if (drcWebSocket) {
                drcWebSocket.close();
                drcWebSocket = null;
                drcLog('DRC WebSocket连接已断开', 'info');
            }
        }

        // DRC WebSocket消息处理
        function handleDrcWebSocketMessage(message) {
            const { type, data, method } = message;
            
            switch (type) {
                case 'session':
                    drcLog(`WebSocket会话建立: ${JSON.stringify(data)}`, 'info');
                    break;
                    
                case 'heartbeat':
                    // 不记录心跳日志，避免刷屏
                    document.getElementById('drcLastHeartbeat').textContent = new Date().toLocaleTimeString();
                    break;
                    
                case 'drc_up_message':
                    handleDrcUpMessage(method, data);
                    break;
                    
                case 'drc_status_notify':
                    drcLog(`DRC状态通知: ${JSON.stringify(data)}`, 'info');
                    break;
                    
                case 'drone_state':
                    drcLog(`无人机状态: ${JSON.stringify(data)}`, 'debug');
                    updateOsdDisplay(data);
                    break;
                    
                case 'high_frequency_osd':
                    // 高频OSD信息，更新实时数据显示但不记录日志避免刷屏
                    updateOsdDisplay(data);
                    break;
                    
                case 'osd_data':
                    // OSD实时数据，更新显示但不记录日志避免刷屏
                    updateOsdDisplay(data);
                    break;
                    
                case 'delay_info':
                    drcLog(`延时信息: ${JSON.stringify(data)}`, 'debug');
                    updateDelayDisplay(data);
                    break;
                    
                case 'obstacle_avoidance':
                    drcLog(`避障信息: ${JSON.stringify(data)}`, 'debug');
                    updateHsiDisplay(data);
                    break;
                    
                case 'error':
                    drcLog(`WebSocket错误: ${message.message}`, 'error');
                    break;
                    
                default:
                    drcLog(`未知WebSocket消息类型: ${type}`, 'warning');
            }
        }

        // DRC上行消息处理
        function handleDrcUpMessage(method, data) {
            switch (method) {
                case 'osd_info_push':
                    updateOsdDisplay(data);
                    break;
                    
                case 'hsi_info_push':
                    updateHsiDisplay(data);
                    break;
                    
                case 'delay_info_push':
                    updateDelayDisplay(data);
                    break;
                    
                case 'drc_status_notify':
                    drcLog(`DRC状态通知: ${JSON.stringify(data)}`, 'info');
                    break;
                    
                case 'joystick_invalid_notify':
                    drcLog(`摇杆控制无效: ${JSON.stringify(data)}`, 'warning');
                    break;
                    
                default:
                    drcLog(`未知DRC上行消息: ${method}`, 'info');
            }
        }

        // 更新显示函数
        function updateOsdDisplay(data) {
            document.getElementById('drcPosition').textContent = 
                `${data.latitude?.toFixed(6) || 0}, ${data.longitude?.toFixed(6) || 0}`;
            document.getElementById('drcHeight').textContent = data.height?.toFixed(1) || '0';
            document.getElementById('drcAttitude').textContent = data.attitude_head?.toFixed(1) || '0';
            document.getElementById('drcVelocity').textContent = 
                Math.sqrt((data.speed_x || 0)**2 + (data.speed_y || 0)**2 + (data.speed_z || 0)**2).toFixed(1);
            document.getElementById('drcGimbalP').textContent = data.gimbal_pitch?.toFixed(1) || '0';
            document.getElementById('drcGimbalY').textContent = data.gimbal_yaw?.toFixed(1) || '0';
        }

        function updateHsiDisplay(data) {
            const updateHsiStatus = (elementId, distance, working) => {
                const element = document.getElementById(elementId);
                if (working && distance < 5000) { // 5米警告
                    element.textContent = `${(distance/1000).toFixed(1)}m`;
                    element.className = 'badge bg-warning';
                } else if (working) {
                    element.textContent = '正常';
                    element.className = 'badge bg-success';
                } else {
                    element.textContent = '关闭';
                    element.className = 'badge bg-secondary';
                }
            };
            
            updateHsiStatus('hsiUp', data.up_distance, data.up_work);
            updateHsiStatus('hsiDown', data.down_distance, data.down_work);
            updateHsiStatus('hsiFront', 0, data.front_work);
            updateHsiStatus('hsiBack', 0, data.back_work);
            updateHsiStatus('hsiSide', 0, data.left_work || data.right_work);
        }

        function updateDelayDisplay(data) {
            document.getElementById('cmdDelay').textContent = data.sdr_cmd_delay || '0';
            
            const videoDelays = data.liveview_delay_list || [];
            const avgDelay = videoDelays.length > 0 ? 
                videoDelays.reduce((sum, item) => sum + (item.delay || 0), 0) / videoDelays.length : 0;
            document.getElementById('videoDelay').textContent = avgDelay.toFixed(0);
            
            // 延时颜色指示
            const cmdDelayElement = document.getElementById('cmdDelay');
            const videoDelayElement = document.getElementById('videoDelay');
            
            cmdDelayElement.className = data.sdr_cmd_delay > 200 ? 'badge bg-warning' : 'badge bg-success';
            videoDelayElement.className = avgDelay > 150 ? 'badge bg-warning' : 'badge bg-success';
        }

        function updateDrcSessionStatus(status, sessionData) {
            const statusElement = document.getElementById('drcSessionStatus');
            const sessionIdElement = document.getElementById('drcSessionId');
            
            if (status === 'active') {
                statusElement.textContent = '已激活';
                statusElement.className = 'badge bg-success';
                sessionIdElement.textContent = sessionData?.session_id || '-';
                drcSessionInfo = sessionData;
            } else {
                statusElement.textContent = '未激活';
                statusElement.className = 'badge bg-secondary';
                sessionIdElement.textContent = '-';
                drcSessionInfo = null;
            }
        }

        // ==========================================
        // 简化DRC控制函数
        // ==========================================
        
        // 使用已存在的drcControlInterval变量，添加新的控制状态变量
        let currentDrcControl = { forward: 0, right: 0, up: 0, turn_right: 0 };
        
        // 进入DRC模式
        async function enterDrcMode() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                alert('请先选择设备');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/enter`, 'POST', {
                    osd_frequency: 10,
                    hsi_frequency: 4
                });
                if (result.code === 0) {
                    document.getElementById('drcStatus').textContent = '已激活';
                    document.getElementById('drcSimpleControl').style.display = 'block';
                    drcLog(`DRC模式已激活: ${JSON.stringify(result.data)}`, 'success');
                } else {
                    alert(`进入DRC模式失败: ${result.message || '未知错误'}`);
                    drcLog(`进入DRC模式失败: ${result.message}`, 'error');
                }
            } catch (error) {
                alert(`进入DRC模式失败: ${error.message}`);
                drcLog(`进入DRC模式失败: ${error.message}`, 'error');
            }
        }
        
        // 退出DRC模式
        async function exitDrcMode() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                alert('请先选择设备');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/exit`, 'POST');
                if (result.code === 0) {
                    document.getElementById('drcStatus').textContent = '未激活';
                    document.getElementById('drcSimpleControl').style.display = 'none';
                    drcLog('DRC模式已退出', 'success');
                    
                    // 停止控制
                    stopDrcControl();
                } else {
                    alert(`退出DRC模式失败: ${result.message || '未知错误'}`);
                    drcLog(`退出DRC模式失败: ${result.message}`, 'error');
                }
            } catch (error) {
                alert(`退出DRC模式失败: ${error.message}`);
                drcLog(`退出DRC模式失败: ${error.message}`, 'error');
            }
        }
        
        // 获取DRC状态
        async function getDrcStatus() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                alert('请先选择设备');
                return;
            }
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/status`, 'GET');
                if (result.code === 0) {
                    const isActive = result.data.drc_mode === 'active';
                    document.getElementById('drcStatus').textContent = isActive ? '已激活' : '未激活';
                    document.getElementById('drcSimpleControl').style.display = isActive ? 'block' : 'none';
                    drcLog(`DRC状态: ${result.data.drc_mode}`, 'info');
                } else {
                    drcLog(`获取DRC状态失败: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`获取DRC状态失败: ${error.message}`, 'error');
            }
        }
        
        // 开始DRC控制
        function startDrcControl(direction, speed) {
            // 重置所有控制值
            currentDrcControl = { forward: 0, right: 0, up: 0, turn_right: 0 };
            
            // 设置对应方向的控制值
            switch(direction) {
                case 'forward':
                    currentDrcControl.forward = speed;
                    break;
                case 'backward':
                    currentDrcControl.forward = -speed;
                    break;
                case 'left':
                    currentDrcControl.right = -speed;
                    break;
                case 'right':
                    currentDrcControl.right = speed;
                    break;
                case 'up':
                    currentDrcControl.up = speed;
                    break;
                case 'down':
                    currentDrcControl.up = -speed;
                    break;
                case 'turn_left':
                    currentDrcControl.turn_right = -speed;
                    break;
                case 'turn_right':
                    currentDrcControl.turn_right = speed;
                    break;
            }
            
            // 开始发送控制指令 (10Hz频率)
            if (drcControlInterval) {
                clearInterval(drcControlInterval);
            }
            
            drcControlInterval = setInterval(() => {
                sendSimpleDrcControl(currentDrcControl);
            }, 100); // 100ms = 10Hz
            
            // 立即发送一次
            sendSimpleDrcControl(currentDrcControl);
        }
        
        // 停止DRC控制
        function stopDrcControl() {
            if (drcControlInterval) {
                clearInterval(drcControlInterval);
                drcControlInterval = null;
            }
            
            // 发送停止指令
            const stopControl = { forward: 0, right: 0, up: 0, turn_right: 0 };
            sendSimpleDrcControl(stopControl);
            currentDrcControl = stopControl;
        }
        
        // 发送简化DRC控制指令
        async function sendSimpleDrcControl(controlData) {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) return;
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/control/simple`, 'POST', controlData);
                if (result.code === 0) {
                    // 更新控制状态显示
                    const statusText = `控制指令: forward=${controlData.forward}, right=${controlData.right}, up=${controlData.up}, turn_right=${controlData.turn_right}
DJI杆量: ${JSON.stringify(result.data.converted_stick_data, null, 2)}
发送时间: ${new Date().toLocaleTimeString()}`;
                    document.getElementById('drcControlStatus').textContent = statusText;
                } else {
                    drcLog(`DRC控制失败: ${result.message}`, 'error');
                }
            } catch (error) {
                drcLog(`DRC控制失败: ${error.message}`, 'error');
            }
        }
        
        // 更新DRC速度值显示
        function updateDrcSpeedValue(type) {
            const slider = document.getElementById(`${type}SpeedSlider`);
            const valueDisplay = document.getElementById(`${type}SpeedValue`);
            valueDisplay.textContent = slider.value;
        }
        
        // 发送DRC控制指令 (基于滑杆)
        function sendDrcControl() {
            const controlData = {
                forward: parseFloat(document.getElementById('forwardSpeedSlider').value),
                right: parseFloat(document.getElementById('rightSpeedSlider').value),
                up: parseFloat(document.getElementById('upSpeedSlider').value),
                turn_right: parseFloat(document.getElementById('turnRightSpeedSlider').value)
            };
            
            sendSimpleDrcControl(controlData);
        }
        
        // 重置DRC速度
        function resetDrcSpeeds() {
            document.getElementById('forwardSpeedSlider').value = 0;
            document.getElementById('rightSpeedSlider').value = 0;
            document.getElementById('upSpeedSlider').value = 0;
            document.getElementById('turnRightSpeedSlider').value = 0;
            
            updateDrcSpeedValue('forward');
            updateDrcSpeedValue('right');
            updateDrcSpeedValue('up');
            updateDrcSpeedValue('turn_right');
            
            // 发送停止指令
            const stopControl = { forward: 0, right: 0, up: 0, turn_right: 0 };
            sendSimpleDrcControl(stopControl);
        }
        
        // 紧急停止
        async function emergencyStop() {
            const deviceSn = document.getElementById('deviceSn').value;
            if (!deviceSn) {
                alert('请先选择设备');
                return;
            }
            
            // 停止所有控制循环
            stopDrcControl();
            
            try {
                const result = await apiRequest(`/api/v1/drc/devices/${deviceSn}/drc/control/emergency-stop`, 'POST');
                if (result.code === 0) {
                    drcLog('紧急停止指令已发送', 'warning');
                    document.getElementById('drcControlStatus').textContent = '紧急停止指令已发送\n发送时间: ' + new Date().toLocaleTimeString();
                } else {
                    alert(`紧急停止失败: ${result.message || '未知错误'}`);
                    drcLog(`紧急停止失败: ${result.message}`, 'error');
                }
            } catch (error) {
                alert(`紧急停止失败: ${error.message}`);
                drcLog(`紧急停止失败: ${error.message}`, 'error');
            }
        }

        // DRC日志函数
        function drcLog(message, type = 'info') {
            // 如果有专门的DRC日志容器就用，否则输出到控制台
            const container = document.getElementById('drcLogContainer');
            if (!container) {
                console.log(`[DRC ${type.toUpperCase()}] ${message}`);
                return;
            }
            
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            
            const typeColors = {
                'success': '#28a745',
                'error': '#dc3545', 
                'warning': '#ffc107',
                'info': '#17a2b8'
            };
            
            logEntry.innerHTML = `
                <span style="color: #666;">[${timestamp}]</span> 
                <span style="color: ${typeColors[type] || '#333'};">[${type.toUpperCase()}]</span> 
                ${message}
            `;
            
            container.appendChild(logEntry);
            container.scrollTop = container.scrollHeight;
            
            // 限制日志条数
            while (container.children.length > 100) {
                container.removeChild(container.firstChild);
            }
        }

        function clearDrcLog() {
            const container = document.getElementById('drcLogContainer');
            if (container) {
                container.innerHTML = '<div class="text-muted">日志已清空</div>';
            }
        }

        function exportDrcLog() {
            const container = document.getElementById('drcLogContainer');
            if (!container) return;
            
            const logText = Array.from(container.children)
                .map(entry => entry.textContent)
                .join('\n');
            
            const blob = new Blob([logText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `drc_log_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            drcLog('日志已导出', 'success');
        }

        // 加载设备类型选项
        async function loadDeviceTypeOptions() {
            try {
                const result = await apiRequest('/api/v1/device-dictionary/options');
                const select = document.getElementById('deviceType');
                
                // 清空现有选项（保留第一个空选项）
                const firstOption = select.firstElementChild;
                select.innerHTML = '';
                select.appendChild(firstOption);
                
                // 添加新选项
                result.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.label;
                    if (option.value === '3-3-0') { // 默认选择DJI Dock
                        optionElement.selected = true;
                    }
                    select.appendChild(optionElement);
                });
                
                log('设备类型选项已加载', 'success');
            } catch (error) {
                log(`加载设备类型选项失败: ${error.message}`, 'warning');
                // 使用静态选项作为备用
            }
        }

        // 获取当前选择的设备类型信息
        async function getSelectedDeviceTypeInfo() {
            const deviceType = document.getElementById('deviceType').value;
            if (!deviceType) return null;
            
            try {
                const result = await apiRequest(`/api/v1/device-dictionary/parse/${deviceType}`);
                return result;
            } catch (error) {
                console.warn('获取设备类型信息失败:', error);
                return null;
            }
        }

        // 保存配置
        function saveConfig() {
            const apiUrl = document.getElementById('apiUrl').value;
            const token = document.getElementById('apiToken').value;
            const deviceSn = document.getElementById('deviceSn').value;
            const deviceType = document.getElementById('deviceType').value;
            
            // 保存到localStorage
            localStorage.setItem('lightpatrol_config', JSON.stringify({
                apiUrl,
                token,
                deviceSn,
                deviceType,
                savedAt: new Date().toISOString()
            }));
            
            log('配置已保存', 'success');
        }

        // 加载配置
        function loadConfig() {
            try {
                const savedConfig = localStorage.getItem('lightpatrol_config');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    document.getElementById('apiUrl').value = config.apiUrl || '';
                    document.getElementById('apiToken').value = config.token || '';
                    document.getElementById('deviceSn').value = config.deviceSn || '';
                    document.getElementById('deviceType').value = config.deviceType || '';
                    log('配置已加载', 'info');
                }
            } catch (error) {
                console.warn('加载配置失败:', error);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载保存的配置
            loadConfig();
            
            // 加载设备类型选项
            loadDeviceTypeOptions();
            
            // 检查DRC元素是否存在
            if (document.getElementById('drcLogContainer')) {
                drcLog('DRC控制面板已初始化', 'info');
                
                // 设置定时心跳检查
                setInterval(() => {
                    if (drcSessionInfo && drcWebSocket && drcWebSocket.readyState === WebSocket.OPEN) {
                        // 发送ping保持连接
                        drcWebSocket.send(JSON.stringify({ type: 'ping' }));
                    }
                }, 30000); // 30秒心跳
            }
        });
        
    </script>
</body>
</html>